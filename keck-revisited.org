#+STARTUP:   lognotestate
#+SEQ_TODO: TODO(t!) STARTED(s!) WAITING(w@) | DONE(d) CANCELED(c@)


* [1/5] High-level overview April 2013
:LOGBOOK:
CLOCK: [2013-04-18 Thu 10:51]--[2013-04-18 Thu 16:12] =>  5:21
CLOCK: [2013-04-18 Thu 10:49]--[2013-04-18 Thu 10:49] =>  0:00
:END:

What is done?  What remains to be done?  With emphasis on finishing a first paper on 244-440

** TODO [7/9] General pipeline
+ [X] Cosmic rays: solved in principle, but need to do for each slit
+ [X] Order extraction
+ [X] Rectification
  + [X] Horizontal tilt
  + [X] Vertical tilt - not really, but can be done afterwords 
+ [-] Continuum subtraction - this could be improved by not considering each row separately.  But is it worth it?
+ [X] Nebular subtraction
+ [X] Flat-fielding: fixed this now
+ [X] Heliocentric correction
+ [X] Stray light
+ [ ] What else?
  + [ ] Error propagation

** DONE [2/2] 244-440 in particular
CLOSED: [2013-04-19 Fri 23:55]
:LOGBOOK:
CLOCK: [2013-04-18 Thu 16:12]--[2013-04-18 Thu 18:12] =>  2:00
CLOCK: [2013-04-18 Thu 10:51]--[2013-04-18 Thu 10:51] =>  0:00
- State "STARTED"    from "TODO"       [2013-04-18 Thu 10:46]
:END:
+ [X] Slit p84
+ [X] Other slits
  + [X] p85 (see [[id:EC89C7DB-BE2E-415A-A516-FA29AD3B2A54][worked example]] below)
    + [X] Cosmetic defects, bad columns
    + [X] Cosmic rays
    + [X] Order extraction
    + [X] Remove stray light
    + [X] Overlap
    + [X] Extract postage stamp of each line
    + [X] Remove continuum
    + [X] Deconvolve doublets
    + [X] Remove nebular line
** TODO [0/1] Extras
+ [ ] Deuterium
  + Need to remove the H-line wings
** TODO [0/4] Other proplyds, etc
+ [ ] 177-341
+ [ ] 180-331
+ [ ] 170-334
+ [ ] jets




* Density diagnostics
:LOGBOOK:
CLOCK: [2013-04-26 Fri 11:45]--[2013-04-26 Fri 13:45] =>  2:00
:END:
:PROPERTIES:
:EXPORT_FILE_NAME: density-diagnostics-244440
:END:
It is maybe a bit rash to do this before we have the flux calibration and flat field, but never mind.

** [S II] 
** STARTED [Cl III] 
:LOGBOOK:
- State "STARTED"    from ""           [2013-04-26 Fri 15:15]
:END:

+ The uncertainty given in the nebular ratios is rather large, since we are using the estimated uncertainties in the nebular component fits.
  + However, I think these are really too large - we should maybe fit the sum of the nebula part. 
+ [ ] For slit p84 there seems to be a rogue CR removal that removed some of the proplyd signal from the 5518 line!
  + [ ] Need to add it to the protect file and redo the CR removal
  + But we can still measure the lower bit of the proplyd emission
*** Flat fielding
:LOGBOOK:
CLOCK: [2013-04-26 Fri 17:26]--[2013-04-26 Fri 17:36] =>  0:10
:END:
+ We need to to this properly, but for the moment just assume continuum is flat between 5518 and 5538
+ The observed continuum is given in the following table
+ So we need to divide the raw observed ratios by this number =0.68 +/- 0.03=
| Slit         | 5518 continuum | 5538 continuum |         Ratio |
|--------------+----------------+----------------+---------------|
| p85 proplyd  |             13 |             19 |          0.68 |
| p85 nebula   |              8 |             11 |          0.73 |
| p85 neb-prop |              5 |              8 |          0.63 |
|--------------+----------------+----------------+---------------|
|              |                |                | 0.68 +/- 0.03 |
#+TBLFM: $4=$2/$3 ; f2::@4$2..@4$3=@-2 - @-1::@5$4=vmeane(@I..@II); f2
*** Theoretical [Cl III] 5518/5538 ratios
Using the NIST data from [[id:059F129A-524D-4712-A4A7-72DD546A9842][here]], there are significant E2 and M1 contributions to the A-values.  
|      Wav | A_{ki} (M1) | A_{ki} (E2) | J_{k}  | g_{k} = 2 J_{k} + 1 |     A_{ki} g_{k} |
|----------+----------+----------+-----+---------------+------------|
| 5517.709 | 1.46e-04 |  8.6e-04 | 5/2 |            6. |    0.00604 |
| 5537.873 |  6.5e-03 |  5.5e-04 | 3/2 |            4. |    0.02820 |
|----------+----------+----------+-----+---------------+------------|
|          |          |          |     |           1.5 | 0.21418440 |
#+TBLFM: $5=(2 $4) + 1::$6=($2 + $3) $5; f5::@4$5..@4$6=@2/@3
So the limiting ratios are:
+ Low density :: 1.5
+ High density :: 0.214

Keenan et al ([[http://adsabs.harvard.edu/abs/2000PNAS...97.4551K][2000PNAS...97.4551K]]) have a useful paper that shows the line ratio as function of (n_{e}, T_{e}) 

*** Measured [Cl III] 5518/5538 ratios
In the following table, the ratio is flat-field corrected (see above). 
| Slit | Component    | I(5518)    | I(5538)    | Corrected Ratio | log_{10} R        | Density |
|------+--------------+------------+------------+-----------------+----------------+---------|
| p85  | Neb A (main) | 206 +/- 72 | 251 +/- 47 | 1.207 +/- 0.482 | 0.08 +/- 0.17  |    1000 |
| p85  | Neb C (blue) | 93 +/- 26  | 121 +/- 37 | 1.130 +/- 0.471 | 0.05 +/- 0.18  |    1000 |
| p85  | Proplyd blue | 6 +/- 1    | 16 +/- 2   | 0.551 +/- 0.117 | -0.26 +/- 0.09 |   10000 |
| p85  | Proplyd red  | 2.5 +/- 1  | 8 +/- 1    | 0.460 +/- 0.194 | -0.34 +/- 0.18 |   10000 |
|      | Neb blue     | 11 +/- 1   | 14 +/- 1   | 1.155 +/- 0.143 | 0.06 +/- 0.05  |         |
|      | Neb red      | 13 +/- 1   | 23 +/- 1   | 0.831 +/- 0.082 | -0.08 +/- 0.04 |         |
|------+--------------+------------+------------+-----------------+----------------+---------|
| p84  | Neb A (main) | 230 +/- 62 | 306 +/- 78 | 1.105 +/- 0.413 | 0.04 +/- 0.16  |    1000 |
| p84  | Neb C (blue) | 157 +/- 32 | 169 +/- 18 | 1.366 +/- 0.320 | 0.14 +/- 0.10  |     100 |
#+TBLFM: $5=$3/$4 (0.68 +/- 0.03) ; f3::$6=log10($-1);f2
+ The ratio from the proplyd model is 0.59, which is quite a way from the high-density limit.
  + This means that the [Cl III] density is not so useless after all!
+ I have removed nebular component B (the broad red component), since it is so poorly determined as to be useless. 
+ We can estimate nominal densities from the Keenan paper, using the observed ratios, assuming T=8000

* Lining up the velocities



* STARTED Worked example of full pipeline: slit p85
:LOGBOOK:
- State "STARTED"    from ""           [2013-04-19 Fri 08:36]
:END:
CLOCK: [2013-04-19 Fri 08:26]--[2013-04-19 Fri 23:55] => 15:29
:PROPERTIES:
:ID:       EC89C7DB-BE2E-415A-A516-FA29AD3B2A54
:results:  verbatim
:END:
Here I gather together all the scattered steps, so I can have a simple cookbook for doing the other slits.  Maybe I could even automate the whole shebang.  
** Remove bias voltage
Where is this done?
** Cosmetic defects
[[id:cosmetic][See this section below]].  It is mainly some bad columns on the chip, which seem to be the same for all the exposures. 
** Cosmic rays
Removed using spotless.py, as [[id:557B6ED2-7946-4F97-9EF0-C94D6E3F139E][shown down here]].  This is mainly automatic, but it is necessary to manually create two region files in ds9:  
1. One to protect regions from spurious CR removal
   - [[file:Keck1/p85-protect.reg][file:~/Dropbox/KeckProplyd/Keck1/p85-protect.reg]]
2. Second to force removal of the few CRs that the automatic process misses
   - [[file:Keck1/p85-badpix.reg][file:~/Dropbox/KeckProplyd/Keck1/p85-badpix.reg]]
*** TODO [#A] I just noticed that the D\alpha line got zapped - must fix
:LOGBOOK:
- State "TODO"       from ""           [2013-05-02 Thu 23:25]
:END:

** Extract orders and wavelength calibrate
*** Command to extract the orders
Important to use the final corrected order boxes contained in [[file:Keck1/t70-orders-final.reg][file:~/Dropbox/KeckProplyd/Keck1/t70-orders-final.reg]], as discussed [[id:AD19406C-8713-4AB4-9CCF-77F0A42FDC67][here]]

#+BEGIN_SRC sh :results verbatim
python hires-extract/extract-orders.py Keck1/p85b-cr Calibration/wav0070 Keck1/t70-orders-final
#+END_SRC

#+RESULTS:
| WARNING: | Overwriting     | existing        | file       | 'orders-labels.fits'.           | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'orders-labels.fits'.           |        |            |      |    |         |        |
| Number   | of              | order           | boxes      | found:                          | 26                              |        |            |      |    |         |        |
| Number   | of              | objects         | found:     | 24                              |                                 |        |            |      |    |         |        |
| Order    | 51:             | 6909.79-7011.71 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 24:             | 6909.78-7011.72 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 77452,  | 16387) |
| WARNING: | RuntimeWarning: | invalid         | value      | encountered                     | in                              | divide | [__main__] |      |    |         |        |
| astropy: | WARNING:        | RuntimeWarning: | invalid    | value                           | encountered                     | in     | divide     |      |    |         |        |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order51.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order51.fits'. |        |            |      |    |         |        |
| Order    | 52:             | 6776.92-6876.91 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 23:             | 6776.91-6876.92 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 77445,  | 16386) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order52.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order52.fits'. |        |            |      |    |         |        |
| Order    | 53:             | 6649.06-6747.20 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 22:             | 6649.05-6747.21 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 77439,  | 16384) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order53.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order53.fits'. |        |            |      |    |         |        |
| Order    | 54:             | 6525.95-6622.29 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 21:             | 6525.94-6622.30 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 77448,  | 16386) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order54.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order54.fits'. |        |            |      |    |         |        |
| Order    | 55:             | 6407.31-6501.92 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 20:             | 6407.30-6501.93 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 77463,  | 16387) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order55.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order55.fits'. |        |            |      |    |         |        |
| Order    | 56:             | 6292.91-6385.85 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 19:             | 6292.90-6385.86 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 77496,  | 16386) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order56.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order56.fits'. |        |            |      |    |         |        |
| Order    | 57:             | 6182.53-6273.85 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 18:             | 6182.52-6273.86 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 77520,  | 16385) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order57.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order57.fits'. |        |            |      |    |         |        |
| Order    | 58:             | 6075.96-6165.71 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 17:             | 6075.95-6165.72 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 77560,  | 16386) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order58.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order58.fits'. |        |            |      |    |         |        |
| Order    | 59:             | 5973.00-6061.23 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 16:             | 5972.99-6061.24 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 77605,  | 16387) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order59.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order59.fits'. |        |            |      |    |         |        |
| Order    | 60:             | 5873.47-5960.23 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 15:             | 5873.46-5960.24 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 77664,  | 16387) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order60.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order60.fits'. |        |            |      |    |         |        |
| Order    | 61:             | 5777.21-5862.55 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 14:             | 5593.85-5862.56 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 101483, | 16386) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order61.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order61.fits'. |        |            |      |    |         |        |
| Order    | 62:             | 5684.05-5768.01 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 14:             | 5593.85-5862.56 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 124510, | 16386) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order62.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order62.fits'. |        |            |      |    |         |        |
| Order    | 63:             | 5593.86-5676.47 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 14:             | 5593.85-5862.56 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 98095,  | 16385) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order63.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order63.fits'. |        |            |      |    |         |        |
| Order    | 64:             | 5506.48-5587.79 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 13:             | 5506.47-5587.80 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 68313,  | 16387) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order64.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order64.fits'. |        |            |      |    |         |        |
| Order    | 65:             | 5421.79-5501.84 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 12:             | 5421.78-5501.85 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 63342,  | 16387) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order65.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order65.fits'. |        |            |      |    |         |        |
| Order    | 66:             | 5339.66-5418.49 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 11:             | 5339.66-5418.50 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 58401,  | 16384) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order66.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order66.fits'. |        |            |      |    |         |        |
| Order    | 67:             | 5259.99-5337.62 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 10:             | 5259.99-5337.63 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 53483,  | 16390) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order67.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order67.fits'. |        |            |      |    |         |        |
| Order    | 68:             | 5182.66-5259.13 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 9:              | 5182.66-5259.14 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 48495,  | 16386) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order68.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order68.fits'. |        |            |      |    |         |        |
| Order    | 69:             | 5107.58-5182.92 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 8:              | 5107.58-5182.93 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 43471,  | 16386) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order69.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order69.fits'. |        |            |      |    |         |        |
| Order    | 70:             | 5034.63-5108.88 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 7:              | 5034.63-5108.89 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 38332,  | 14801) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order70.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order70.fits'. |        |            |      |    |         |        |
| Order    | 71:             | 4963.75-5036.92 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 6:              | 4963.75-5036.93 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 33049,  |  6536) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order71.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order71.fits'. |        |            |      |    |         |        |
| Order    | 72:             | 4894.83-4966.96 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 5:              | 4894.83-4966.97 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 27583,  |  1489) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order72.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order72.fits'. |        |            |      |    |         |        |
| Order    | 73:             | No              | valid      | wavelengths                     | found                           |        |            |      |    |         |        |
| Label    | 4:              | 4827.80-4898.92 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 21908,  | 21908) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order73.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order73.fits'. |        |            |      |    |         |        |
| Order    | 74:             | 4704.58-4768.27 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 3:              | 4762.58-4832.71 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 15977,  | 15977) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order74.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order74.fits'. |        |            |      |    |         |        |
| Order    | 75:             | 4637.28-4705.52 |            |                                 |                                 |        |            |      |    |         |        |
| Label    | 2:              | 4699.09-4768.27 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 9768,   |  9768) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order75.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order75.fits'. |        |            |      |    |         |        |
| Order    | 76:             | No              | valid      | wavelengths                     | found                           |        |            |      |    |         |        |
| Label    | 1:              | 4637.28-4705.52 |            |                                 |                                 |        |            |      |    |         |        |
|          |                 |                 |            |                                 |                                 |        |            |      |    |         |        |
| ('Number | of              | good            | wavelength | pixels                          | found                           | in     | order      | box: | ', | 2146,   |  2146) |
| WARNING: | Overwriting     | existing        | file       | 'Extract/p85b-cr-order76.fits'. | [astropy.io.fits.hdu.hdulist]   |        |            |      |    |         |        |
| astropy: | WARNING:        | Overwriting     | existing   | file                            | 'Extract/p85b-cr-order76.fits'. |        |            |      |    |         |        |


*** Command to load all the orders into ds9
Script is [[id:715877DD-07F2-42BC-A656-3038DD845675][down here]]
#+call: display-extracted-orders("p85b-cr")

#+RESULTS: display-extracted-orders("p85b-cr")
: result silenced

** Remove stray light
This is done by [[file:hires-extract/remove-stray-light.py][remove-stray-light.py]]
#+BEGIN_SRC sh :results output 
python hires-extract/remove-stray-light.py p85
#+END_SRC

#+RESULTS:
#+begin_example
Processing  51
WARNING: Overwriting existing file 'Extract/p85s-order51.fits'. [astropy.io.fits.hdu.hdulist]
Processing  52
WARNING: Overwriting existing file 'Extract/p85s-order52.fits'. [astropy.io.fits.hdu.hdulist]
Processing  53
WARNING: Overwriting existing file 'Extract/p85s-order53.fits'. [astropy.io.fits.hdu.hdulist]
Processing  54
WARNING: Overwriting existing file 'Extract/p85s-order54.fits'. [astropy.io.fits.hdu.hdulist]
Processing  55
WARNING: Overwriting existing file 'Extract/p85s-order55.fits'. [astropy.io.fits.hdu.hdulist]
Processing  56
WARNING: Overwriting existing file 'Extract/p85s-order56.fits'. [astropy.io.fits.hdu.hdulist]
Processing  57
WARNING: Overwriting existing file 'Extract/p85s-order57.fits'. [astropy.io.fits.hdu.hdulist]
Processing  58
WARNING: Overwriting existing file 'Extract/p85s-order58.fits'. [astropy.io.fits.hdu.hdulist]
Processing  59
WARNING: Overwriting existing file 'Extract/p85s-order59.fits'. [astropy.io.fits.hdu.hdulist]
Processing  60
WARNING: Overwriting existing file 'Extract/p85s-order60.fits'. [astropy.io.fits.hdu.hdulist]
Processing  61
WARNING: Overwriting existing file 'Extract/p85s-order61.fits'. [astropy.io.fits.hdu.hdulist]
Processing  62
WARNING: Overwriting existing file 'Extract/p85s-order62.fits'. [astropy.io.fits.hdu.hdulist]
Processing  63
WARNING: Overwriting existing file 'Extract/p85s-order63.fits'. [astropy.io.fits.hdu.hdulist]
Processing  64
WARNING: Overwriting existing file 'Extract/p85s-order64.fits'. [astropy.io.fits.hdu.hdulist]
Processing  65
WARNING: Overwriting existing file 'Extract/p85s-order65.fits'. [astropy.io.fits.hdu.hdulist]
Processing  66
WARNING: Overwriting existing file 'Extract/p85s-order66.fits'. [astropy.io.fits.hdu.hdulist]
Processing  67
WARNING: Overwriting existing file 'Extract/p85s-order67.fits'. [astropy.io.fits.hdu.hdulist]
Processing  68
WARNING: Overwriting existing file 'Extract/p85s-order68.fits'. [astropy.io.fits.hdu.hdulist]
Processing  69
WARNING: Overwriting existing file 'Extract/p85s-order69.fits'. [astropy.io.fits.hdu.hdulist]
Processing  70
WARNING: Overwriting existing file 'Extract/p85s-order70.fits'. [astropy.io.fits.hdu.hdulist]
Processing  71
WARNING: Overwriting existing file 'Extract/p85s-order71.fits'. [astropy.io.fits.hdu.hdulist]
Processing  72
WARNING: Overwriting existing file 'Extract/p85s-order72.fits'. [astropy.io.fits.hdu.hdulist]
Processing  73
WARNING: Overwriting existing file 'Extract/p85s-order73.fits'. [astropy.io.fits.hdu.hdulist]
Processing  74
WARNING: Overwriting existing file 'Extract/p85s-order74.fits'. [astropy.io.fits.hdu.hdulist]
Processing  75
WARNING: Overwriting existing file 'Extract/p85s-order75.fits'. [astropy.io.fits.hdu.hdulist]
Processing  76
WARNING: Overwriting existing file 'Extract/p85s-order76.fits'. [astropy.io.fits.hdu.hdulist]
#+end_example

Results are written to p85s-order??.fits

#+call: display-extracted-orders("p85s")

#+RESULTS: display-extracted-orders("p85s")
: result silenced

** Remove overlap
#+BEGIN_SRC sh :results output 
python hires-extract/remove-overlap.py p85
#+END_SRC

Results are written to p85o-order??.fits

#+call: display-extracted-orders("p85o")

#+RESULTS: display-extracted-orders("p85o")
: result silenced

** DONE Flat field correction
CLOSED: [2013-05-02 Thu 23:21]
:LOGBOOK:
CLOCK: [2013-05-02 Thu 18:48]--[2013-05-02 Thu 23:21] =>  4:33
CLOCK: [2013-05-02 Thu 16:02]--[2013-05-02 Thu 17:10] =>  1:08
CLOCK: [2013-05-02 Thu 13:21]--[2013-05-02 Thu 13:48] =>  0:27
:END:
+ We will do this by dividing each extracted order by the quartz lamp image of the same order.  
+ This is after both have been corrected for order.
  + [ ] Maybe it would also work to do it before correcting the order overlap
+ Looking at all the quartz orders:
  #+name: display-all-orders
  #+BEGIN_SRC sh :results silent :var spec="q69o"
    xpaset -p ds9 cd $PWD
    for f in Extract/${spec}-order??.fits; do
        xpaset -p ds9 frame new
        xpaset -p ds9 file $f
    done
  #+END_SRC
  #+RESULTS:
  
  + It turns out that the q69o files have different sizes
  + [X] Try to run the order extraction and overlap programs again
    #+BEGIN_SRC sh :results verbatim
      python hires-extract/extract-orders.py Keck1/q69b Calibration/wav0070 Keck1/t70-orders-final
    #+END_SRC
    That seems to have worked
    #+BEGIN_SRC sh :results verbatim
python hires-extract/remove-overlap.py q96
    #+END_SRC
+ Now we can do the flat-field correction, using the new [[file:hires-extract/correct-flat-field.py][correct-flat-field.py]]
  #+BEGIN_SRC sh
    python hires-extract/correct-flat-field.py p85
  #+END_SRC
+ And we can look at the results:
  #+call: display-all-orders(spec="p85f") :results silent
  + Better to look at one order at a time, comparing the stages
    #+name: compare-pre-post-flat
    #+BEGIN_SRC sh :results silent :var order=51
      for spec in q69o p85o p85f; do
          xpaset -p ds9 frame new
          xpaset -p ds9 file Extract/${spec}-order${order}.fits
      done
    #+END_SRC
    #+call: compare-pre-post-flat(53) :results silent
    #+call: compare-pre-post-flat(63) :results silent
  + The results are quite good in the dispersion direction, but bad in the spatial direction
    + The problem is that the quartz profile falls of a bit slower than the object spectrum at the ends of the slit.  As a result, the flat-fielded profile has little spikes at the ends.
    + *Moral:* average the flat profile along the spatial axis before dividing by it.
+ Yes that looks a lot better now
  + Final results are in =Extract/p85f-order??.fits=





** Extract postage stamps
#+BEGIN_SRC sh :results verbatim
python hires-extract/extract-stamps.py p85
#+END_SRC

#+RESULTS:
#+begin_example
[Fe III] 4881
Filename: Extract/p85o-order73.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 69)   float64   
2    WAV         ImageHDU         8   (2067, 69)   float64   
None
1100.6329557 -3267.72490599
1100.6329557
Si II 5958
Filename: Extract/p85o-order60.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
134.386093355 -4231.27958258
134.386093355
[O III] 4931
Filename: Extract/p85o-order72.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 69)   float64   
2    WAV         ImageHDU         8   (2067, 69)   float64   
None
2172.31208567 -2212.87503963
2172.31208567
Si II 6347
Filename: Extract/p85o-order56.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
1829.6206226 -2559.6588688
1829.6206226
[Fe II] 5273
Filename: Extract/p85o-order67.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
3653.96842507 -759.057803222
3653.96842507
[N II] 6583
Filename: Extract/p85o-order54.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 66)   float64   
2    WAV         ImageHDU         8   (2067, 66)   float64   
None
1768.54918534 -2618.2801818
1768.54918534
[O I] 5577
Filename: Extract/p85o-order64.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 69)   float64   
2    WAV         ImageHDU         8   (2067, 69)   float64   
None
561.726015253 -3808.79162827
561.726015253
Si II 5056
Filename: Extract/p85o-order70.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
3136.12398497 -1265.84434807
3136.12398497
[Fe II] 5159
Filename: Extract/p85o-order69.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
1402.70185047 -2975.33902704
1402.70185047
[O III] 5007
Filename: Extract/p85o-order71.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
1800.80628999 -2580.4166366
1800.80628999
O I 6046
Filename: Extract/p85o-order59.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
736.344774272 -3638.04623853
736.344774272
[S III] 6312
Filename: Extract/p85o-order56.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
3504.48649138 -909.166064619
3504.48649138
He I S 4922
Filename: Extract/p85o-order72.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 69)   float64   
2    WAV         ImageHDU         8   (2067, 69)   float64   
None
2742.62981314 -1650.83956957
2742.62981314
[Fe III] 4755
Filename: Extract/p85o-order75.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
856.085144873 -3505.51784258
856.085144873
O I 5959
Filename: Extract/p85o-order60.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
85.8775173709 -4279.08207896
85.8775173709
[N I] 5200
Filename: Extract/p85o-order68.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
3394.04015305 -1014.1236613
3394.04015305
[Fe III] 5085
Filename: Extract/p85o-order70.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
1421.17873454 -2955.86908874
1421.17873454
[Fe III] 4931
Filename: Extract/p85o-order72.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 69)   float64   
2    WAV         ImageHDU         8   (2067, 69)   float64   
None
2214.38654344 -2171.41159476
2214.38654344
[S II] 6731
Filename: Extract/p85o-order53.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 65)   float64   
2    WAV         ImageHDU         8   (2067, 65)   float64   
None
729.611533968 -3641.07532925
729.611533968
[Fe II] 4815
Filename: Extract/p85o-order74.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
1131.87742138 -3235.35466688
1131.87742138
Co I 5147
Filename: Extract/p85o-order69.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
2106.60357604 -2281.66890854
2106.60357604
[Fe III] 4734
Filename: Extract/p85o-order75.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
2175.8138103 -2204.93489603
2175.8138103
[O III] 4959
Filename: Extract/p85o-order72.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 69)   float64   
2    WAV         ImageHDU         8   (2067, 69)   float64   
None
486.540210539 -3874.16583002
486.540210539
O I 7002
Filename: Extract/p85o-order51.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 52)   float64   
2    WAV         ImageHDU         8   (2067, 52)   float64   
None
410.277471882 -3953.08405275
410.277471882
Si II 5979
Filename: Extract/p85o-order59.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
4126.49412071 -297.242707518
4126.49412071
[Cl III] 5538
Filename: Extract/p85o-order64.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 69)   float64   
2    WAV         ImageHDU         8   (2067, 69)   float64   
None
2702.20271454 -1699.46146091
2702.20271454
He I T 5876
Filename: Extract/p85o-order60.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
4317.04281648 -109.504641963
4317.04281648
He I S 5016
Filename: Extract/p85o-order71.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
1269.55677796 -3103.94872646
1269.55677796
Si II 6371
Filename: Extract/p85o-order56.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
681.146804973 -3691.41980984
681.146804973
[Fe III] 5011
Filename: Extract/p85o-order71.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
1534.97744687 -2842.38380388
1534.97744687
Si II 5041
Filename: Extract/p85o-order70.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
4035.11029936 -379.921539488
4035.11029936
He I S 6678
Filename: Extract/p85o-order53.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 65)   float64   
2    WAV         ImageHDU         8   (2067, 65)   float64   
None
3099.54638084 -1305.60797795
3099.54638084
[Fe II] 5262
Filename: Extract/p85o-order67.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
4330.19174029 -92.6688144855
4330.19174029
C II 6578
Filename: Extract/p85o-order54.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 66)   float64   
2    WAV         ImageHDU         8   (2067, 66)   float64   
None
2016.10422655 -2374.32634134
2016.10422655
[Fe III] 4769
Filename: Extract/p85o-order74.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
3977.69996405 -430.832763811
3977.69996405
O I 5299
Filename: Extract/p85o-order67.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
2186.85080041 -2204.83911283
2186.85080041
[S II] 6716
Filename: Extract/p85o-order53.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 65)   float64   
2    WAV         ImageHDU         8   (2067, 65)   float64   
None
1372.85486996 -3007.1870972
1372.85486996
[Cl III] 5518
Filename: Extract/p85o-order64.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 69)   float64   
2    WAV         ImageHDU         8   (2067, 69)   float64   
None
3807.64382037 -610.105863826
3807.64382037
D b 4860
Filename: Extract/p85o-order73.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 69)   float64   
2    WAV         ImageHDU         8   (2067, 69)   float64   
None
2406.43430745 -1980.88114341
2406.43430745
[N II] 6548
Filename: Extract/p85o-order54.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 66)   float64   
2    WAV         ImageHDU         8   (2067, 66)   float64   
None
3398.84517489 -1011.70022368
3398.84517489
O I 5555
Filename: Extract/p85o-order64.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 69)   float64   
2    WAV         ImageHDU         8   (2067, 69)   float64   
None
1772.16653954 -2615.96448162
1772.16653954
[Fe III] 4702
Filename: Extract/p85o-order76.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 44)   float64   
2    WAV         ImageHDU         8   (2067, 44)   float64   
None
-845.596701481 -4096.96235565
-845.596701481
,**** Error....  couldn't solve linear  equation
,**** Skipping [Fe III] 4702
[Fe III] 5270
Filename: Extract/p85o-order67.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
3823.60340651 -591.889826029
3823.60340651
[N I] 5198
Filename: Extract/p85o-order68.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
3531.40407472 -878.756935002
3531.40407472
[Fe III] 5412
Filename: Extract/p85o-order66.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
360.319236737 -4005.76056338
360.319236737
He I S 5048
Filename: Extract/p85o-order70.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
3630.9589735 -778.199991524
3630.9589735
[N II] 5755
Filename: Extract/p85o-order62.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 68)   float64   
2    WAV         ImageHDU         8   (2067, 68)   float64   
None
698.954120729 -3674.52335294
698.954120729
D a 6561
Filename: Extract/p85o-order54.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 66)   float64   
2    WAV         ImageHDU         8   (2067, 66)   float64   
None
2802.40789118 -1599.46109191
2802.40789118
[O I] 6364
Filename: Extract/p85o-order56.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
1039.70696719 -3338.07750426
1039.70696719
[O I] 6300
Filename: Extract/p85o-order56.fits
No.    Name         Type      Cards   Dimensions   Format
0    PRIMARY     PrimaryHDU       4   ()           uint8   
1    SCI         ImageHDU         8   (2067, 67)   float64   
2    WAV         ImageHDU         8   (2067, 67)   float64   
None
4070.42090969 -351.467264689
4070.42090969
#+end_example

Display results:
#+BEGIN_SRC sh
  for f in Stamps/p85-*-stamp.fits; do
      xpaset -p ds9 frame new
      xpaset -p ds9 file $f
  done

  
#+END_SRC

#+RESULTS:

** Remove continuum

Most lines work with the default vrange of [-20, 60]
#+BEGIN_SRC sh :results verbatim
python hires-extract/remove_continuum_all.py p85
#+END_SRC

#+RESULTS:
#+begin_example
Removing continuum from  p85-C_II_6578
Removing continuum from  p85-Cl_III_5518
Removing continuum from  p85-Cl_III_5538
Removing continuum from  p85-Co_I_5147
Removing continuum from  p85-D_a_6561
Removing continuum from  p85-D_b_4860
Removing continuum from  p85-Fe_II_4815
Removing continuum from  p85-Fe_II_5159
Removing continuum from  p85-Fe_II_5262
Removing continuum from  p85-Fe_II_5273
Removing continuum from  p85-Fe_III_4734
Removing continuum from  p85-Fe_III_4755
Removing continuum from  p85-Fe_III_4769
Removing continuum from  p85-Fe_III_4881
Removing continuum from  p85-Fe_III_4931
Removing continuum from  p85-Fe_III_5011
Removing continuum from  p85-Fe_III_5085
Removing continuum from  p85-Fe_III_5270
Removing continuum from  p85-Fe_III_5412
Removing continuum from  p85-He_I_S_4922
Removing continuum from  p85-He_I_S_5016
Removing continuum from  p85-He_I_S_5048
Removing continuum from  p85-He_I_S_6678
Removing continuum from  p85-He_I_T_5876
Removing continuum from  p85-N_I_5198
Removing continuum from  p85-N_I_5200
Removing continuum from  p85-N_II_5755
Removing continuum from  p85-N_II_6548
Removing continuum from  p85-N_II_6583
Removing continuum from  p85-O_I_5299
Removing continuum from  p85-O_I_5555
Removing continuum from  p85-O_I_5577
Removing continuum from  p85-O_I_5959
Removing continuum from  p85-O_I_6046
Removing continuum from  p85-O_I_6300
Removing continuum from  p85-O_I_6364
Removing continuum from  p85-O_I_7002
Removing continuum from  p85-O_III_4931
Removing continuum from  p85-O_III_4959
Removing continuum from  p85-O_III_5007
Removing continuum from  p85-S_II_6716
Removing continuum from  p85-S_II_6731
Removing continuum from  p85-S_III_6312
Removing continuum from  p85-Si_II_5041
Removing continuum from  p85-Si_II_5056
Removing continuum from  p85-Si_II_5958
Removing continuum from  p85-Si_II_5979
Removing continuum from  p85-Si_II_6347
Removing continuum from  p85-Si_II_6371
#+end_example

But some lines need to be done by hand because of a second line that falls within the window. 

#+BEGIN_SRC sh :results verbatim
python hires-extract/remove_continuum.py p85-O_I_5959 --vrange -50 45
#+END_SRC

#+RESULTS:
: WARNING: Overwriting existing file 'Stamps/p85-O_I_5959-stamp-nc.fits'. [astropy.io.fits.hdu.hdulist]

#+BEGIN_SRC sh :results verbatim
python hires-extract/remove_continuum.py p85-Si_II_5958 --vrange -5 85
#+END_SRC

#+RESULTS:
: WARNING: Overwriting existing file 'Stamps/p85-Si_II_5958-stamp-nc.fits'. [astropy.io.fits.hdu.hdulist]

Then there is the jet component that gets in the way of the [O I] and the [S II] lines: 

#+BEGIN_SRC sh :results verbatim
for line in O_I_6300 O_I_6364 S_II_6716 S_II_6731; do
    python hires-extract/remove_continuum.py p85-$line --vrange -70 50
done
#+END_SRC

#+RESULTS:
: WARNING: Overwriting existing file 'Stamps/p85-O_I_6300-stamp-nc.fits'. [astropy.io.fits.hdu.hdulist]
: WARNING: Overwriting existing file 'Stamps/p85-O_I_6364-stamp-nc.fits'. [astropy.io.fits.hdu.hdulist]
: WARNING: Overwriting existing file 'Stamps/p85-S_II_6716-stamp-nc.fits'. [astropy.io.fits.hdu.hdulist]
: WARNING: Overwriting existing file 'Stamps/p85-S_II_6731-stamp-nc.fits'. [astropy.io.fits.hdu.hdulist]

There are still issues with the following lines: 
1. Both deuterium lines - obviously
2. [O III] 4959 and He I 4922, but both these have a stronger counterpart so we can ignore them.  They both have a problem with the wavelength calibration. 
3. Some weak lines of Fe III that may not even be there. 

Display results:
#+BEGIN_SRC sh :results none
  for f in Stamps/p85-*-stamp-nc.fits; do
      xpaset -p ds9 frame new
      xpaset -p ds9 file $f
  done
#+END_SRC

** Deconvolve doublets
Currently, we only do the two strongest multiplets: 7002 and 6046
#+BEGIN_SRC sh :results verbatim
python hires-extract/deconvolve-doublets.py p85
#+END_SRC

#+RESULTS:
: Doublet parameters: a = 0.500558511597, x0 = -6.64360588462
: Using  14  terms
: Doublet parameters: a = 0.498084291188, x0 = -5.20932036534
: Using  18  terms

** Remove nebula
This needs to be done by hand for each line
#+BEGIN_SRC sh :results verbatim
python hires-extract/fit-nebula.py --help
#+END_SRC

#+RESULTS:
#+begin_example
usage: fit-nebula.py [-h] [--vrange VRANGE VRANGE] [--ylo YLO YLO]
                     [--yhi YHI YHI] [--stampdir STAMPDIR]
                     [--extra-suffix EXTRA_SUFFIX]
                     [--min-fraction MIN_FRACTION] [--ncomp NCOMP]
                     [--compA COMPA COMPA COMPA] [--compB COMPB COMPB COMPB]
                     [--compC COMPC COMPC COMPC]
                     [--linear-components LINEAR_COMPONENTS]
                     [--linear-intensity-components LINEAR_INTENSITY_COMPONENTS]
                     stampname

Fit and remove nebular component

positional arguments:
  stampname             Prefix of stamp file (e.g., p84-N_I_5200)

optional arguments:
  -h, --help            show this help message and exit
  --vrange VRANGE VRANGE
                        Range of velocities to use for calculating moments
                        (default: [-10.0, 40.0])
  --ylo YLO YLO         Range of positions for lower BG sample (default:
                        [-6.5, -5.0])
  --yhi YHI YHI         Range of positions for upper BG sample (default: [5.0,
                        7.0])
  --stampdir STAMPDIR   Directory for placing the results (default: Stamps)
  --extra-suffix EXTRA_SUFFIX
                        Extra suffix for images (e.g., dd) (default: )
  --min-fraction MIN_FRACTION
                        Minimum fraction of peak brightness in order that a
                        pixel should contribute to the velocity moments
                        (default: 0.05)
  --ncomp NCOMP         Number of nebular components to fit (default: 2)
  --compA COMPA COMPA COMPA
                        Intensity, velocity, width of component A (default:
                        None)
  --compB COMPB COMPB COMPB
                        Intensity, velocity, width of component B (default:
                        None)
  --compC COMPC COMPC COMPC
                        Intensity, velocity, width of component C (default:
                        None)
  --linear-components LINEAR_COMPONENTS
                        Which components have non-linear velocity terms fixed
                        at zero (e.g., AB) (default: )
  --linear-intensity-components LINEAR_INTENSITY_COMPONENTS
                        Which components have non-linear intensity terms fixed
                        at zero (e.g., AB) (default: )
#+end_example

*** O I permitted lines
#+BEGIN_SRC sh :results verbatim
 python hires-extract/fit-nebula.py p85-O_I_6046 --extra-suffix dd --min-fraction 0.1 --ylo -7 -3.5 --yhi 5 7 --ncomp 1 --compA 250.0 25.0 3.5 --linear-components A
#+END_SRC

#+RESULTS:
#+begin_example
[ True  True  True  True  True  True  True  True  True False False False
 False False False False False False False False False False False False
 False False False False False False False  True  True  True  True  True]
[-6.685 -6.303 -5.921 -5.539 -5.157 -4.775 -4.393 -4.011 -3.629  5.157
  5.539  5.921  6.303  6.685]
I1
[ 71.67001313  90.47621616  92.56534045  96.80491144  89.63315961
  85.81313759  74.40023029  72.13354205  88.68823095  97.90521995
  66.99162483  85.84062309  57.39140006  58.90258055]
v1
[ 25.96784362  24.7690867   28.14043825  25.75417927  25.97214567
  26.13266474  26.88627086  25.74970875  24.93765659  25.35725706
  19.47064011  25.19221567  27.25097398  26.69267258]
v2
[ 10.93227967   0.9347331    9.74282591   5.16826393   3.69644169
   9.27395737  15.51970382  16.97450798   2.58953596   2.31580361
  30.95922541   5.9745988   16.70191065  15.18426769]
I2
[ 12.898664     9.73236777  26.95560439  22.45572649  11.47312418
  22.29106474  30.16648289  25.00484886   9.14482172  18.98611247
  39.93353498  13.26588547  39.75775207  23.28516415]
Parameters([('A_i0', <Parameter 'A_i0', 250.0, bounds=[None:None]>), ('A_i1', <Parameter 'A_i1', 0.0, bounds=[None:None]>), ('A_i2', <Parameter 'A_i2', 0.0, bounds=[None:None]>), ('A_u0', <Parameter 'A_u0', 25.0, bounds=[None:None]>), ('A_u1', <Parameter 'A_u1', 0.0, bounds=[None:None]>), ('A_u2', <Parameter 'A_u2', value=1e-08 (fixed), bounds=[None:None]>), ('A_w0', <Parameter 'A_w0', 3.5, bounds=[1.5:15.0]>), ('A_w1', <Parameter 'A_w1', 0.0, bounds=[-1.0:1.0]>), ('A_w2', <Parameter 'A_w2', value=1e-08 (fixed), bounds=[None:None]>)])
Tolerance seems to be too small.
  A_i0:     188.207159 +/- 4.820704 (2.56%) initial =  250.000000
  A_i1:    -2.330118 +/- 5.493068 (235.74%) initial =  0.000000
  A_i2:    -18.291818 +/- 8.691510 (47.52%) initial =  0.000000
  A_u0:     24.564621 +/- 0.084879 (0.35%) initial =  25.000000
  A_u1:    -0.377850 +/- 0.109615 (29.01%) initial =  0.000000
  A_u2:    fixed
  A_w0:     3.108709 +/- 0.086398 (2.78%) initial =  3.500000
  A_w1:     0.075355 +/- 0.111560 (148.05%) initial =  0.000000
  A_w2:    fixed
Correlations:
    C(A_i1, A_w1)                =  0.562 
    C(A_i0, A_w0)                =  0.516 
    C(A_i0, A_i2)                = -0.487 
    C(A_u0, A_u1)                =  0.312 
    C(A_w0, A_w1)                =  0.311 
    C(A_i0, A_i1)                =  0.309 
    C(A_i1, A_i2)                = -0.223 
    C(A_i1, A_w0)                =  0.161 
    C(A_i0, A_w1)                =  0.137 
    C(A_i2, A_w0)                = -0.026 
    C(A_i2, A_w1)                =  0.000 
    C(A_u0, A_w1)                = -0.000 
    C(A_i1, A_u0)                = -0.000 
    C(A_u0, A_w0)                = -0.000 
    C(A_i1, A_u1)                = -0.000 
    C(A_u1, A_w1)                = -0.000 
    C(A_i2, A_u0)                =  0.000 
    C(A_i0, A_u0)                = -0.000 
    C(A_i2, A_u1)                =  0.000 
    C(A_i0, A_u1)                = -0.000 
    C(A_u1, A_w0)                =  0.000 
#+end_example

#+BEGIN_SRC sh
 python hires-extract/fit-nebula.py p85-O_I_7002 --extra-suffix dd --min-fraction 0.1 --ylo -7 -3.5 --yhi 5 7 --ncomp 1 --compA 250.0 25.0 3.5 --linear-components A
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     178.273930 +/- 5.308159 (2.98%) initial =  250.000000
  A_i1:     2.327546 +/- 6.047716 (259.83%) initial =  0.000000
  A_i2:    -18.703964 +/- 9.544172 (51.03%) initial =  0.000000
  A_u0:     23.604494 +/- 0.131024 (0.56%) initial =  25.000000
  A_u1:    -0.290962 +/- 0.169293 (58.18%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.166373 +/- 0.132296 (3.18%) initial =  3.500000
  A_w1:     0.144857 +/- 0.170869 (117.96%) initial =  0.000000
  A_w2:    fixed
Correlations:
    C(A_i1, A_w1)                =  0.562 
    C(A_i0, A_w0)                =  0.517 
    C(A_i0, A_i2)                = -0.486 
    C(A_i0, A_i1)                =  0.314 
    C(A_u0, A_u1)                =  0.299 
    C(A_w0, A_w1)                =  0.298 
    C(A_i1, A_i2)                = -0.218 
    C(A_i1, A_w0)                =  0.160 
    C(A_i0, A_w1)                =  0.134 
    C(A_i2, A_w0)                = -0.027 
    C(A_i2, A_w1)                =  0.004 
    C(A_u0, A_w0)                =  0.000 
    C(A_u1, A_w1)                =  0.000 
    C(A_u0, A_w1)                =  0.000 
    C(A_u1, A_w0)                =  0.000 
    C(A_i1, A_u1)                =  0.000 
    C(A_i0, A_u0)                =  0.000 
    C(A_i1, A_u0)                =  0.000 
    C(A_i0, A_u1)                =  0.000 
    C(A_i2, A_u1)                =  0.000 
    C(A_i2, A_u0)                = -0.000 
#+end_example

*** [N I] lines
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-N_I_5198 --min-fraction 0.1  --vrange -30 50 --ylo -6.5 -4 --yhi 4 7 --ncomp 3 --compA 350.0 26.0 5.0 --compB 100.0 18.0 5.0 --compC 100.0 0.0 3.0 --linear-components BC --linear-intensity-components BC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     282.494377 +/- 12.630090 (4.47%) initial =  350.000000
  A_i1:    -19.485830 +/- 15.059297 (77.28%) initial =  0.000000
  A_i2:    -8.274207 +/- 8.198690 (99.09%) initial =  0.000000
  A_u0:     25.737623 +/- 0.038666 (0.15%) initial =  26.000000
  A_u1:     0.028497 +/- 0.046516 (163.23%) initial =  0.000000
  A_u2:    -0.109716 +/- 0.092035 (83.88%) initial =  0.000000
  A_w0:     2.527800 +/- 0.064091 (2.54%) initial =  5.000000
  A_w1:     0.118896 +/- 0.076665 (64.48%) initial =  0.000000
  A_w2:    -0.110493 +/- 0.089355 (80.87%) initial =  0.000000
  B_i0:     123.075567 +/- 14.074054 (11.44%) initial =  100.000000
  B_i1:    -7.067684 +/- 17.503907 (247.66%) initial =  0.000000
  B_i2:    fixed
  B_u0:     20.822051 +/- 0.826713 (3.97%) initial =  18.000000
  B_u1:    -3.998985 +/- 1.010439 (25.27%) initial =  0.000000
  B_u2:    fixed
  B_w0:     7.178681 +/- 0.765445 (10.66%) initial =  5.000000
  B_w1:    -1.000000 +/- 1.325361 (132.54%) initial =  0.000000
  B_w2:    fixed
  C_i0:     36.178707 +/- 5.216626 (14.42%) initial =  100.000000
  C_i1:    -1.638952 +/- 6.930555 (422.87%) initial =  0.000000
  C_i2:    fixed
  C_u0:    -0.562889 +/- 0.743617 (132.11%) initial =  0.000000
  C_u1:    -1.326033 +/- 0.983848 (74.19%) initial =  0.000000
  C_u2:    fixed
  C_w0:     4.756282 +/- 0.752118 (15.81%) initial =  3.000000
  C_w1:    -0.434714 +/- 0.990595 (227.87%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(A_i0, B_i0)                = -0.893 
    C(A_i0, A_w0)                =  0.888 
    C(A_i1, A_w1)                =  0.884 
    C(A_i1, B_i1)                = -0.879 
    C(A_i0, B_u0)                = -0.860 
    C(A_i0, B_w1)                =  0.836 
    C(A_i1, B_u1)                = -0.834 
    C(A_i1, B_w0)                = -0.808 
    C(A_w0, B_i0)                = -0.787 
    C(A_w1, B_i1)                = -0.777 
    C(B_i0, B_u0)                =  0.769 
    C(C_i1, C_w1)                =  0.743 
    C(C_i0, C_w0)                =  0.740 
    C(B_i1, B_u1)                =  0.739 
    C(A_w0, B_u0)                = -0.736 
    C(B_i0, B_w1)                = -0.725 
    C(B_u0, B_w1)                = -0.722 
    C(A_w1, B_u1)                = -0.718 
    C(A_w0, B_w1)                =  0.679 
    C(B_i1, B_w0)                =  0.657 
    C(B_u1, B_w0)                =  0.652 
    C(A_w1, B_w0)                = -0.636 
    C(B_w1, C_i1)                =  0.599 
    C(B_w0, C_i0)                = -0.582 
    C(A_i2, A_w2)                =  0.574 
    C(B_w1, C_u1)                =  0.537 
    C(B_i1, B_u0)                =  0.525 
    C(B_i0, B_u1)                =  0.523 
    C(B_w0, C_u0)                = -0.521 
    C(B_i0, B_i1)                =  0.509 
    C(B_w1, C_w1)                =  0.491 
    C(B_i1, B_w1)                = -0.485 
    C(B_w0, C_w0)                = -0.480 
    C(A_i0, B_i1)                = -0.425 
    C(B_u0, B_u1)                =  0.418 
    C(A_i0, C_i1)                =  0.412 
    C(A_i0, B_u1)                = -0.411 
    C(C_i1, C_u1)                =  0.410 
    C(A_i1, B_i0)                = -0.405 
    C(C_i0, C_u0)                =  0.397 
    C(A_i1, B_u0)                = -0.396 
    C(B_i0, B_w0)                =  0.390 
    C(A_u0, A_u2)                = -0.379 
    C(A_w1, B_u0)                = -0.373 
    C(A_i0, C_u1)                =  0.372 
    C(A_w0, B_u1)                = -0.371 
    C(A_i1, C_i0)                =  0.364 
    C(B_u0, C_i1)                = -0.362 
    C(C_u1, C_w1)                =  0.361 
    C(A_w0, B_i1)                = -0.352 
    C(C_u0, C_w0)                =  0.351 
    C(A_w1, B_i0)                = -0.349 
    C(B_i0, C_i1)                = -0.334 
    C(A_i1, A_u2)                = -0.333 
    C(B_u0, C_u1)                = -0.328 
    C(A_i1, C_u0)                =  0.327 
    C(A_w0, C_i1)                =  0.319 
    C(A_i0, C_w1)                =  0.313 
    C(A_u2, B_w0)                =  0.313 
    C(A_u2, B_u1)                =  0.307 
    C(B_i0, C_u1)                = -0.298 
    C(B_u1, C_i0)                = -0.293 
    C(A_u2, B_i1)                =  0.289 
    C(A_w0, C_u1)                =  0.289 
    C(B_u0, C_w1)                = -0.284 
    C(A_u0, B_w0)                = -0.284 
    C(A_u2, A_w1)                = -0.281 
    C(A_i1, C_w0)                =  0.272 
    C(A_w1, C_i0)                =  0.265 
    C(B_i1, C_i0)                = -0.264 
    C(B_u1, C_u0)                = -0.264 
    C(B_u1, B_w1)                = -0.263 
    C(A_w0, A_w1)                =  0.258 
    C(A_i0, A_i1)                =  0.250 
    C(A_i0, A_w1)                =  0.247 
    C(B_i0, C_w1)                = -0.243 
    C(B_i1, C_i1)                = -0.240 
    C(A_w0, C_w1)                =  0.238 
    C(A_w1, C_u0)                =  0.238 
    C(C_u0, C_u1)                = -0.237 
    C(B_i1, C_u0)                = -0.232 
    C(C_w0, C_w1)                = -0.229 
    C(A_i1, A_w0)                =  0.227 
    C(B_u1, C_w0)                = -0.227 
    C(A_u1, B_u0)                =  0.226 
    C(B_i1, C_u1)                = -0.207 
    C(B_i1, C_w1)                = -0.200 
    C(A_w1, C_w0)                =  0.192 
    C(B_u0, C_w0)                =  0.191 
    C(C_i0, C_i1)                = -0.185 
    C(B_i1, C_w0)                = -0.184 
    C(A_w0, A_w2)                = -0.183 
    C(A_i2, B_w1)                =  0.175 
    C(B_u0, B_w0)                =  0.167 
    C(A_u0, A_u1)                =  0.167 
    C(A_i1, B_w1)                =  0.167 
    C(A_u0, C_i0)                =  0.165 
    C(A_w1, B_w1)                =  0.165 
    C(B_u0, C_i0)                =  0.162 
    C(C_i1, C_w0)                = -0.161 
    C(C_i0, C_w1)                = -0.158 
    C(A_u2, B_i0)                =  0.155 
    C(B_u0, C_u0)                =  0.149 
    C(B_i0, C_i0)                = -0.149 
    C(A_u0, C_u0)                =  0.148 
    C(A_u2, C_i0)                = -0.147 
    C(A_u1, A_w1)                = -0.142 
    C(A_u2, B_u0)                =  0.137 
    C(A_i2, B_i0)                = -0.137 
    C(A_i2, B_u1)                = -0.137 
    C(A_u0, A_w0)                = -0.132 
    C(A_u2, C_u0)                = -0.132 
    C(B_u1, C_w1)                =  0.131 
    C(A_u0, C_w0)                =  0.129 
    C(A_i0, A_u0)                = -0.127 
    C(A_i1, A_u1)                = -0.125 
    C(A_i2, B_i1)                = -0.124 
    C(B_w1, C_w0)                = -0.123 
    C(B_i0, C_u0)                = -0.123 
    C(B_w1, C_i0)                = -0.121 
    C(B_i0, C_w0)                = -0.121 
    C(B_w1, C_u0)                = -0.120 
    C(A_u2, C_w0)                = -0.113 
    C(A_i2, B_u0)                = -0.105 
    C(A_u1, A_w0)                = -0.103 
    C(A_i1, A_u0)                =  0.102 
    C(A_i0, C_w0)                = -0.101 
    C(C_i1, C_u0)                = -0.101 
    C(C_i0, C_u1)                = -0.101 
    C(A_u1, C_w0)                =  0.098 
    C(B_w0, C_w1)                =  0.098 
    C(C_u1, C_w0)                = -0.096 
    C(B_w0, C_u1)                =  0.096 
    C(A_i0, C_i0)                = -0.096 
    C(A_i0, C_u0)                = -0.095 
    C(B_w0, C_i1)                =  0.094 
    C(A_u1, C_i0)                =  0.094 
    C(C_u0, C_w1)                = -0.094 
    C(A_u1, B_w1)                =  0.092 
    C(A_w2, B_u1)                = -0.090 
    C(B_u1, C_i1)                =  0.088 
    C(A_i0, A_u2)                = -0.086 
    C(A_i0, A_u1)                = -0.085 
    C(A_i0, B_w0)                = -0.085 
    C(A_u1, B_i1)                =  0.083 
    C(B_u1, C_u1)                =  0.082 
    C(A_u1, C_u0)                =  0.082 
    C(A_w0, B_w0)                = -0.080 
    C(A_u2, A_w0)                = -0.079 
    C(A_i2, C_i1)                =  0.077 
    C(A_w0, C_w0)                = -0.077 
    C(A_u0, B_u1)                =  0.076 
    C(A_w2, B_i1)                = -0.075 
    C(A_w0, C_i0)                = -0.073 
    C(A_w0, C_u0)                = -0.073 
    C(A_u0, B_i1)                = -0.073 
    C(A_u1, C_i1)                =  0.070 
    C(A_i2, C_u1)                =  0.069 
    C(A_u1, B_i0)                =  0.068 
    C(A_u1, C_u1)                =  0.061 
    C(A_u0, B_w1)                = -0.060 
    C(A_i1, A_w2)                =  0.060 
    C(A_i2, B_w0)                = -0.058 
    C(A_u1, B_u1)                =  0.056 
    C(A_i2, C_w1)                =  0.055 
    C(A_u1, C_w1)                =  0.054 
    C(A_w2, B_w0)                = -0.054 
    C(A_i1, A_i2)                =  0.051 
    C(A_i2, A_u1)                =  0.048 
    C(A_w2, B_u0)                = -0.048 
    C(A_w2, B_i0)                = -0.047 
    C(A_u0, B_i0)                =  0.046 
    C(A_u0, A_w1)                =  0.045 
    C(A_i0, A_i2)                =  0.044 
    C(A_u0, C_w1)                =  0.042 
    C(A_u2, C_w1)                =  0.038 
    C(A_i1, C_w1)                = -0.038 
    C(A_w2, B_w1)                =  0.037 
    C(A_i2, A_w1)                =  0.035 
    C(A_u1, A_u2)                = -0.035 
    C(A_u2, B_w1)                = -0.034 
    C(A_u2, C_i1)                =  0.033 
    C(A_u2, C_u1)                =  0.033 
    C(A_u0, C_i1)                =  0.032 
    C(A_u0, B_u0)                =  0.030 
    C(A_i2, A_u2)                = -0.029 
    C(A_i1, C_u1)                = -0.028 
    C(A_u2, A_w2)                = -0.027 
    C(A_u0, C_u1)                =  0.024 
    C(A_i2, C_i0)                =  0.024 
    C(A_i1, C_i1)                = -0.022 
    C(B_w0, B_w1)                =  0.021 
    C(A_i2, C_u0)                =  0.020 
    C(A_w2, C_i0)                =  0.019 
    C(A_w1, C_w1)                = -0.019 
    C(A_i2, C_w0)                =  0.018 
    C(A_w2, C_u0)                =  0.017 
    C(A_i0, A_w2)                = -0.015 
    C(A_w1, A_w2)                =  0.014 
    C(A_w2, C_w0)                =  0.013 
    C(A_i2, A_u0)                = -0.011 
    C(A_i2, A_w0)                = -0.011 
    C(A_w1, C_u1)                = -0.011 
    C(A_u1, B_w0)                =  0.010 
    C(A_u0, A_w2)                = -0.006 
    C(A_w1, C_i1)                = -0.005 
    C(A_u1, A_w2)                = -0.004 
    C(A_w2, C_w1)                = -0.002 
    C(A_w2, C_i1)                =  0.002 
    C(A_w2, C_u1)                =  0.002 
#+end_example

#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-N_I_5200 --min-fraction 0.1 --ylo -6.5 -4 --yhi 4 7  --vrange -30 50 --ncomp 3 --compA 200.0 26.0 5.0 --compB 40.0 18.0 5.0 --compC 20.0 0.0 3.0 --linear-components BC --linear-intensity-components BC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     159.390789 +/- 11.327190 (7.11%) initial =  200.000000
  A_i1:    -43.374105 +/- 13.820537 (31.86%) initial =  0.000000
  A_i2:     1.095413 +/- 8.455223 (771.88%) initial =  0.000000
  A_u0:     25.931351 +/- 0.080165 (0.31%) initial =  26.000000
  A_u1:     0.092128 +/- 0.098636 (107.06%) initial =  0.000000
  A_u2:    -0.104655 +/- 0.163452 (156.18%) initial =  0.000000
  A_w0:     2.582562 +/- 0.109976 (4.26%) initial =  5.000000
  A_w1:    -0.242129 +/- 0.137085 (56.62%) initial =  0.000000
  A_w2:     0.057731 +/- 0.165938 (287.43%) initial =  0.000000
  B_i0:     89.254533 +/- 11.145460 (12.49%) initial =  40.000000
  B_i1:     39.880718 +/- 14.532213 (36.44%) initial =  0.000000
  B_i2:    fixed
  B_u0:     20.937431 +/- 1.708760 (8.16%) initial =  18.000000
  B_u1:     0.063750 +/- 2.120588 (3326.43%) initial =  0.000000
  B_u2:    fixed
  B_w0:     7.022317 +/- 1.133203 (16.14%) initial =  5.000000
  B_w1:    -0.945453 +/- 1.440498 (152.36%) initial =  0.000000
  B_w2:    fixed
  C_i0:     38.937375 +/- 7.086437 (18.20%) initial =  20.000000
  C_i1:     12.643941 +/- 8.902492 (70.41%) initial =  0.000000
  C_i2:    fixed
  C_u0:    -0.710454 +/- 1.260713 (177.45%) initial =  0.000000
  C_u1:    -1.259754 +/- 1.592398 (126.41%) initial =  0.000000
  C_u2:    fixed
  C_w0:     6.198198 +/- 1.213472 (19.58%) initial =  3.000000
  C_w1:     1.000000 +/- 0.858343 (85.83%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(A_i0, A_w0)                =  0.871 
    C(A_i1, A_w1)                =  0.870 
    C(B_w0, B_w1)                = -0.864 
    C(A_i0, B_u0)                = -0.840 
    C(C_i0, C_w0)                =  0.813 
    C(B_u0, B_u1)                = -0.807 
    C(A_i1, B_i1)                = -0.804 
    C(C_i1, C_w1)                = -0.799 
    C(A_i1, B_u1)                = -0.793 
    C(A_i0, B_i0)                = -0.778 
    C(A_w1, B_i1)                = -0.735 
    C(A_w0, B_i0)                = -0.715 
    C(B_w0, C_i0)                = -0.683 
    C(B_w0, C_u0)                = -0.664 
    C(B_w1, C_i1)                = -0.652 
    C(A_w0, B_u0)                = -0.647 
    C(B_w1, C_u1)                = -0.637 
    C(B_u0, C_i0)                =  0.624 
    C(B_u0, C_u0)                =  0.609 
    C(C_i0, C_u0)                =  0.603 
    C(A_i2, A_w2)                =  0.589 
    C(A_w1, B_u1)                = -0.589 
    C(B_u1, C_i1)                =  0.586 
    C(B_u0, B_w0)                = -0.579 
    C(B_u1, C_u1)                =  0.576 
    C(B_w0, C_w0)                = -0.575 
    C(C_i1, C_u1)                =  0.567 
    C(B_u1, B_w1)                = -0.564 
    C(B_u0, C_w0)                =  0.559 
    C(B_u0, B_w1)                =  0.559 
    C(B_u1, B_w0)                =  0.558 
    C(C_u0, C_w0)                =  0.545 
    C(B_w1, C_w1)                =  0.543 
    C(B_w1, C_u0)                =  0.524 
    C(B_u1, C_w1)                = -0.521 
    C(B_w1, C_i0)                =  0.521 
    C(A_u0, B_w0)                = -0.519 
    C(C_u1, C_w1)                = -0.512 
    C(B_i0, B_u0)                =  0.505 
    C(A_i0, B_u1)                =  0.498 
    C(B_w0, C_u1)                =  0.496 
    C(B_i1, B_u1)                =  0.487 
    C(B_w0, C_i1)                =  0.486 
    C(B_u1, C_u0)                = -0.478 
    C(B_u1, C_i0)                = -0.468 
    C(B_u0, C_u1)                = -0.450 
    C(A_u1, B_w1)                = -0.450 
    C(A_i0, C_i0)                = -0.447 
    C(A_i0, C_u0)                = -0.434 
    C(B_u0, C_i1)                = -0.433 
    C(C_u0, C_u1)                = -0.422 
    C(B_w1, C_w0)                =  0.422 
    C(A_i0, B_w1)                = -0.419 
    C(A_i1, B_u0)                =  0.415 
    C(A_i0, B_w0)                =  0.413 
    C(B_u1, C_w0)                = -0.401 
    C(B_w0, C_w1)                = -0.386 
    C(A_i0, C_w0)                = -0.379 
    C(A_i1, C_i1)                = -0.378 
    C(A_i1, C_u1)                = -0.368 
    C(B_u0, C_w1)                =  0.364 
    C(A_i2, B_u1)                = -0.363 
    C(A_i1, B_w0)                = -0.358 
    C(A_i1, B_w1)                =  0.342 
    C(A_w0, B_u1)                =  0.319 
    C(A_w0, C_i0)                = -0.318 
    C(A_i1, C_w1)                =  0.317 
    C(A_u0, A_u2)                = -0.316 
    C(A_u0, B_w1)                =  0.312 
    C(C_i0, C_u1)                = -0.309 
    C(A_u0, C_i0)                =  0.308 
    C(A_w0, C_u0)                = -0.307 
    C(C_i1, C_u0)                = -0.303 
    C(A_u0, C_u0)                =  0.294 
    C(A_w0, B_w1)                = -0.287 
    C(C_w0, C_w1)                =  0.285 
    C(A_i2, B_u0)                =  0.281 
    C(A_i2, B_w1)                =  0.281 
    C(A_w0, B_w0)                =  0.277 
    C(C_i0, C_i1)                = -0.267 
    C(A_w0, C_w0)                = -0.266 
    C(A_u1, C_i1)                =  0.264 
    C(A_i2, B_w0)                = -0.260 
    C(A_i0, A_i2)                = -0.258 
    C(A_i2, C_i1)                = -0.257 
    C(A_i0, C_u1)                =  0.256 
    C(C_u1, C_w0)                = -0.254 
    C(A_w1, C_i1)                = -0.252 
    C(A_i2, C_u1)                = -0.250 
    C(A_u1, C_u1)                =  0.249 
    C(C_i1, C_w0)                = -0.249 
    C(A_i1, A_i2)                =  0.246 
    C(C_u0, C_w1)                =  0.245 
    C(C_i0, C_w1)                =  0.244 
    C(A_w1, C_u1)                = -0.243 
    C(A_u0, C_w0)                =  0.241 
    C(A_i0, C_i1)                =  0.239 
    C(A_w0, A_w2)                = -0.236 
    C(A_w1, B_u0)                =  0.229 
    C(A_i2, C_w1)                =  0.227 
    C(A_u2, B_w1)                = -0.226 
    C(A_i1, C_u0)                =  0.218 
    C(A_w1, B_w0)                = -0.218 
    C(A_i2, A_w0)                = -0.212 
    C(A_w1, C_w1)                =  0.208 
    C(A_u1, B_w0)                =  0.208 
    C(A_i1, C_i0)                =  0.205 
    C(A_u1, C_w1)                = -0.205 
    C(A_i0, A_u0)                = -0.203 
    C(A_w1, B_w1)                =  0.200 
    C(B_i0, B_u1)                = -0.200 
    C(A_i2, C_u0)                =  0.190 
    C(A_i2, C_i0)                =  0.186 
    C(A_i2, A_w1)                =  0.175 
    C(A_i0, C_w1)                = -0.175 
    C(A_w2, B_u1)                = -0.175 
    C(B_i1, B_u0)                = -0.169 
    C(A_u0, A_w0)                = -0.167 
    C(A_u0, B_u0)                =  0.166 
    C(A_i1, A_u1)                = -0.165 
    C(A_u2, B_w0)                =  0.164 
    C(A_w0, C_u1)                =  0.156 
    C(A_i2, C_w0)                =  0.155 
    C(A_i0, A_i1)                = -0.152 
    C(A_i1, C_w0)                =  0.147 
    C(A_w2, B_w1)                =  0.143 
    C(A_w0, C_i1)                =  0.142 
    C(A_w0, A_w1)                =  0.142 
    C(A_u1, A_w1)                = -0.140 
    C(A_i1, A_w2)                =  0.140 
    C(A_i2, B_i1)                = -0.140 
    C(A_u2, C_i1)                =  0.136 
    C(B_i1, B_w1)                =  0.133 
    C(A_u0, B_u1)                = -0.133 
    C(A_u2, C_u1)                =  0.131 
    C(A_w2, B_w0)                = -0.130 
    C(A_w2, C_i1)                = -0.125 
    C(A_u0, A_u1)                =  0.124 
    C(A_w2, B_u0)                =  0.122 
    C(A_w2, C_u1)                = -0.121 
    C(A_i0, A_w2)                = -0.119 
    C(A_u1, B_u1)                =  0.115 
    C(B_i0, B_w0)                =  0.112 
    C(A_u2, C_w1)                = -0.111 
    C(A_w2, C_w1)                =  0.108 
    C(A_w1, C_u0)                =  0.108 
    C(A_u0, C_u1)                = -0.101 
    C(A_w1, B_i0)                = -0.098 
    C(A_w1, C_i0)                =  0.097 
    C(A_w0, C_w1)                = -0.096 
    C(A_i1, A_u0)                =  0.092 
    C(A_w2, B_i1)                = -0.091 
    C(A_u0, C_i1)                = -0.090 
    C(A_i2, A_u1)                = -0.089 
    C(A_w2, C_u0)                =  0.086 
    C(A_w2, C_i0)                =  0.083 
    C(A_u1, B_u0)                = -0.083 
    C(A_u2, C_u0)                = -0.082 
    C(A_w1, A_w2)                =  0.080 
    C(A_u2, C_i0)                = -0.080 
    C(A_u2, B_u0)                = -0.079 
    C(A_u1, A_u2)                =  0.078 
    C(A_u2, B_u1)                =  0.075 
    C(A_i0, A_u1)                =  0.075 
    C(A_w0, B_i1)                = -0.070 
    C(A_i2, A_u0)                =  0.070 
    C(B_i1, C_w1)                =  0.068 
    C(A_w2, C_w0)                =  0.068 
    C(A_i0, A_u2)                =  0.065 
    C(A_u1, A_w2)                = -0.061 
    C(A_u2, C_w0)                = -0.060 
    C(A_u2, B_i1)                = -0.059 
    C(A_w1, C_w0)                =  0.059 
    C(A_i2, A_u2)                = -0.048 
    C(A_u0, C_w1)                =  0.047 
    C(A_i1, A_u2)                = -0.046 
    C(A_u1, C_u0)                = -0.045 
    C(A_u2, A_w0)                =  0.043 
    C(A_u1, B_i0)                = -0.040 
    C(B_i0, C_w0)                = -0.040 
    C(B_i1, C_i1)                = -0.038 
    C(A_u1, A_w0)                =  0.034 
    C(A_u0, A_w1)                =  0.034 
    C(A_u1, C_i0)                = -0.034 
    C(A_u0, A_w2)                =  0.034 
    C(A_i2, B_i0)                =  0.032 
    C(B_i0, B_w1)                =  0.030 
    C(A_u2, A_w2)                = -0.027 
    C(B_i0, C_i1)                = -0.026 
    C(A_u2, A_w1)                = -0.025 
    C(B_i0, C_u1)                = -0.025 
    C(A_u0, B_i0)                = -0.024 
    C(A_u0, B_i1)                = -0.024 
    C(B_i1, C_u1)                = -0.023 
    C(A_u1, B_i1)                = -0.023 
    C(B_i1, C_i0)                = -0.020 
    C(B_i1, B_w0)                =  0.020 
    C(B_i1, C_u0)                = -0.017 
    C(A_i1, A_w0)                = -0.017 
    C(A_i1, B_i0)                = -0.009 
    C(B_i0, C_i0)                = -0.007 
    C(A_i0, B_i1)                =  0.006 
    C(A_i0, A_w1)                =  0.005 
    C(B_i0, C_u0)                =  0.004 
    C(B_i0, B_i1)                =  0.002 
    C(B_i0, C_w1)                =  0.002 
    C(B_i1, C_w0)                =  0.002 
    C(A_u2, B_i0)                = -0.001 
    C(A_u1, C_w0)                = -0.001 
    C(A_w2, B_i0)                = -0.001 
#+end_example

*** [O I] forbidden lines
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-O_I_6300 --min-fraction 0.05 --ylo -6.5 -4  --yhi 4.5 7 --ncomp 3 --compA 1500.0 24.0 5.0 --compB 600.0 15.0 5.0 --compC 300.0 0.0 3.0 --linear-components ABC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     1120.656054 +/- 54.707555 (4.88%) initial =  1500.000000
  A_i1:     79.091427 +/- 64.846488 (81.99%) initial =  0.000000
  A_i2:    -153.570089 +/- 19.784197 (12.88%) initial =  0.000000
  A_u0:     22.910530 +/- 0.265100 (1.16%) initial =  24.000000
  A_u1:    -0.754146 +/- 0.324724 (43.06%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.890521 +/- 0.144011 (2.94%) initial =  5.000000
  A_w1:     0.518626 +/- 0.173659 (33.48%) initial =  0.000000
  A_w2:    fixed
  B_i0:     307.478106 +/- 55.336957 (18.00%) initial =  600.000000
  B_i1:     42.115782 +/- 65.659313 (155.90%) initial =  0.000000
  B_i2:    -43.622064 +/- 17.406661 (39.90%) initial =  0.000000
  B_u0:     14.105842 +/- 0.415726 (2.95%) initial =  15.000000
  B_u1:    -0.656462 +/- 0.500255 (76.20%) initial =  0.000000
  B_u2:    fixed
  B_w0:     3.679845 +/- 0.262750 (7.14%) initial =  5.000000
  B_w1:     0.421394 +/- 0.317946 (75.45%) initial =  0.000000
  B_w2:    fixed
  C_i0:     224.983045 +/- 7.911784 (3.52%) initial =  300.000000
  C_i1:     28.872669 +/- 9.336148 (32.34%) initial =  0.000000
  C_i2:     1.975306 +/- 15.250480 (772.06%) initial =  0.000000
  C_u0:    -0.191202 +/- 0.126530 (66.18%) initial =  0.000000
  C_u1:    -1.229840 +/- 0.160953 (13.09%) initial =  0.000000
  C_u2:    fixed
  C_w0:     3.618383 +/- 0.141456 (3.91%) initial =  3.000000
  C_w1:     0.255765 +/- 0.180201 (70.46%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(A_i1, B_i1)                = -0.986 
    C(A_i0, B_i0)                = -0.986 
    C(A_u0, B_i0)                =  0.984 
    C(A_u1, B_i1)                =  0.984 
    C(A_i1, A_u1)                = -0.979 
    C(A_i0, A_u0)                = -0.979 
    C(A_u0, B_u0)                =  0.961 
    C(A_i0, B_u0)                = -0.961 
    C(B_i0, B_u0)                =  0.956 
    C(A_u1, B_u1)                =  0.953 
    C(A_i0, A_w0)                =  0.953 
    C(A_i1, B_u1)                = -0.952 
    C(B_i1, B_u1)                =  0.946 
    C(A_i1, A_w1)                =  0.942 
    C(A_u0, A_w0)                = -0.935 
    C(A_w0, B_i0)                = -0.934 
    C(A_u1, A_w1)                = -0.923 
    C(A_w1, B_i1)                = -0.920 
    C(B_i0, B_w0)                =  0.901 
    C(A_w0, B_u0)                = -0.900 
    C(A_w1, B_u1)                = -0.880 
    C(B_i1, B_w1)                =  0.877 
    C(A_i0, B_w0)                = -0.869 
    C(B_u0, B_w0)                =  0.860 
    C(A_u0, B_w0)                =  0.859 
    C(A_i1, B_w1)                = -0.840 
    C(B_u1, B_w1)                =  0.835 
    C(A_u1, B_w1)                =  0.831 
    C(A_w0, B_w0)                = -0.759 
    C(A_w1, B_w1)                = -0.715 
    C(C_i1, C_w1)                =  0.686 
    C(A_u0, B_i1)                =  0.686 
    C(A_u0, A_u1)                =  0.684 
    C(A_i1, A_u0)                = -0.684 
    C(B_i0, B_i1)                =  0.674 
    C(A_i1, B_i0)                = -0.668 
    C(A_i0, A_i1)                =  0.665 
    C(A_i0, B_i1)                = -0.665 
    C(A_u1, B_i0)                =  0.662 
    C(A_i0, A_u1)                = -0.657 
    C(C_i0, C_w0)                =  0.638 
    C(B_i1, B_u0)                =  0.598 
    C(A_i1, B_u0)                = -0.596 
    C(A_u1, B_u0)                =  0.591 
    C(A_i1, A_w0)                =  0.587 
    C(A_u1, A_w0)                = -0.584 
    C(A_w0, B_i1)                = -0.583 
    C(A_u0, B_u1)                =  0.577 
    C(A_u0, A_w1)                = -0.569 
    C(B_i0, B_u1)                =  0.558 
    C(A_i0, B_u1)                = -0.552 
    C(A_i0, A_w1)                =  0.545 
    C(A_w1, B_i0)                = -0.543 
    C(B_i1, B_w0)                =  0.514 
    C(A_w0, A_w1)                =  0.509 
    C(B_u0, B_u1)                =  0.502 
    C(A_i1, B_w0)                = -0.500 
    C(A_u1, B_w0)                =  0.488 
    C(A_w0, B_u1)                = -0.461 
    C(A_w1, B_u0)                = -0.461 
    C(B_i0, B_w1)                =  0.457 
    C(A_u0, B_w1)                =  0.456 
    C(A_i0, B_w1)                = -0.441 
    C(B_w0, C_w0)                = -0.438 
    C(C_i0, C_i2)                = -0.435 
    C(B_w1, C_w1)                = -0.428 
    C(A_i2, B_i2)                = -0.415 
    C(B_w1, C_i1)                = -0.413 
    C(B_u1, B_w0)                =  0.407 
    C(B_w0, C_i0)                = -0.392 
    C(B_u0, B_w1)                =  0.390 
    C(B_w0, C_u0)                = -0.379 
    C(B_w0, B_w1)                =  0.378 
    C(B_w1, C_u1)                = -0.371 
    C(A_w1, B_w0)                = -0.350 
    C(A_w0, B_w1)                = -0.334 
    C(B_i0, C_w0)                = -0.320 
    C(B_i1, C_i1)                = -0.297 
    C(B_i0, C_i0)                = -0.295 
    C(B_i1, C_w1)                = -0.295 
    C(B_i0, C_u0)                = -0.286 
    C(C_i0, C_i1)                =  0.284 
    C(B_i0, B_i2)                = -0.281 
    C(A_i0, C_w0)                =  0.279 
    C(A_u0, C_w0)                = -0.271 
    C(B_i1, C_u1)                = -0.266 
    C(A_i0, C_i0)                =  0.261 
    C(A_i1, C_i1)                =  0.258 
    C(A_i0, C_u0)                =  0.256 
    C(A_u0, C_i0)                = -0.254 
    C(A_u1, C_i1)                = -0.250 
    C(A_u0, C_u0)                = -0.250 
    C(A_i1, C_w1)                =  0.250 
    C(A_i0, B_i2)                =  0.244 
    C(A_u1, C_w1)                = -0.242 
    C(B_i2, B_w0)                = -0.235 
    C(A_i1, C_u1)                =  0.233 
    C(A_i0, A_i2)                = -0.233 
    C(B_i2, B_u0)                = -0.232 
    C(A_w0, B_i2)                =  0.231 
    C(C_u0, C_w0)                =  0.230 
    C(A_u1, C_u1)                = -0.227 
    C(C_u1, C_w1)                =  0.223 
    C(A_w0, C_w0)                =  0.221 
    C(B_u0, C_w0)                = -0.220 
    C(B_u0, C_u0)                = -0.218 
    C(B_u0, C_i0)                = -0.215 
    C(C_i1, C_i2)                = -0.215 
    C(A_u0, B_i2)                = -0.213 
    C(C_i1, C_u1)                =  0.210 
    C(A_w0, C_i0)                =  0.208 
    C(A_w0, C_u0)                =  0.205 
    C(B_u1, C_i1)                = -0.204 
    C(C_i0, C_u0)                =  0.201 
    C(A_w1, C_i1)                =  0.193 
    C(B_u1, C_u1)                = -0.192 
    C(A_w1, C_w1)                =  0.188 
    C(B_u1, C_w1)                = -0.187 
    C(B_w0, C_i1)                = -0.182 
    C(A_i2, A_w0)                = -0.178 
    C(A_i2, B_i0)                =  0.178 
    C(A_w1, C_u1)                =  0.177 
    C(A_i2, B_u0)                =  0.175 
    C(B_i1, C_i0)                = -0.173 
    C(A_i2, B_w0)                =  0.172 
    C(B_i1, C_w0)                = -0.169 
    C(B_w1, C_i0)                = -0.168 
    C(B_i0, C_i1)                = -0.166 
    C(B_i1, C_u0)                = -0.163 
    C(C_i1, C_w0)                =  0.159 
    C(B_w1, C_w0)                = -0.158 
    C(A_i1, C_i0)                =  0.157 
    C(B_w1, C_u0)                = -0.153 
    C(A_i1, C_w0)                =  0.153 
    C(A_u0, C_i1)                = -0.151 
    C(A_u1, C_i0)                = -0.150 
    C(A_i0, C_i1)                =  0.150 
    C(A_i1, C_u0)                =  0.150 
    C(A_i2, A_u0)                =  0.150 
    C(A_i2, B_w1)                = -0.148 
    C(B_w0, C_w1)                = -0.145 
    C(A_u1, C_w0)                = -0.145 
    C(A_u1, C_u0)                = -0.143 
    C(B_w0, C_u1)                = -0.143 
    C(A_i2, B_u1)                = -0.139 
    C(C_i0, C_w1)                =  0.137 
    C(B_i0, C_w1)                = -0.137 
    C(B_i0, C_u1)                = -0.136 
    C(C_w0, C_w1)                =  0.127 
    C(A_u0, C_u1)                = -0.126 
    C(A_i2, A_w1)                =  0.125 
    C(A_i0, C_u1)                =  0.124 
    C(A_u0, C_w1)                = -0.124 
    C(A_i0, C_w1)                =  0.122 
    C(B_u0, C_i1)                = -0.120 
    C(B_i2, B_w1)                =  0.120 
    C(B_u1, C_i0)                = -0.116 
    C(B_u1, C_u0)                = -0.113 
    C(B_u1, C_w0)                = -0.107 
    C(A_i2, A_u1)                = -0.104 
    C(A_w0, C_i1)                =  0.102 
    C(B_u0, C_u1)                = -0.102 
    C(A_w1, C_i0)                =  0.099 
    C(B_i2, B_u1)                =  0.097 
    C(C_i1, C_u0)                =  0.096 
    C(A_w1, C_u0)                =  0.094 
    C(B_u0, C_w1)                = -0.093 
    C(A_i2, B_i1)                = -0.093 
    C(A_w1, C_w0)                =  0.092 
    C(C_i0, C_u1)                =  0.084 
    C(A_w1, B_i2)                = -0.084 
    C(A_w0, C_u1)                =  0.084 
    C(B_i2, C_w0)                =  0.082 
    C(B_i2, C_i0)                =  0.080 
    C(C_u1, C_w0)                =  0.080 
    C(C_u0, C_w1)                =  0.079 
    C(A_w0, C_w1)                =  0.079 
    C(C_u0, C_u1)                =  0.077 
    C(B_i2, C_u0)                =  0.071 
    C(A_i1, A_i2)                =  0.065 
    C(A_u1, B_i2)                =  0.058 
    C(A_i2, C_w0)                = -0.055 
    C(A_i2, C_w1)                =  0.052 
    C(B_i2, C_w1)                = -0.052 
    C(A_i2, C_i0)                = -0.049 
    C(A_i2, C_u0)                = -0.048 
    C(A_i1, B_i2)                = -0.044 
    C(A_i2, C_u1)                =  0.043 
    C(A_i2, C_i1)                =  0.041 
    C(B_i2, C_u1)                = -0.040 
    C(B_i2, C_i1)                = -0.033 
    C(B_i2, C_i2)                = -0.027 
    C(B_i1, B_i2)                =  0.025 
    C(C_i2, C_w1)                =  0.021 
    C(B_w1, C_i2)                = -0.018 
    C(A_i2, C_i2)                =  0.011 
    C(B_i1, C_i2)                = -0.011 
    C(A_u1, C_i2)                = -0.010 
    C(A_i1, C_i2)                =  0.010 
    C(B_u1, C_i2)                = -0.009 
    C(C_i2, C_u1)                =  0.008 
    C(A_w1, C_i2)                =  0.008 
    C(B_w0, C_i2)                =  0.002 
    C(C_i2, C_w0)                =  0.002 
    C(B_i0, C_i2)                =  0.001 
    C(A_w0, C_i2)                = -0.001 
    C(C_i2, C_u0)                = -0.001 
    C(A_i0, C_i2)                = -0.000 
    C(A_u0, C_i2)                = -0.000 
    C(B_u0, C_i2)                =  0.000 
#+end_example

#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-O_I_5577 --min-fraction 0.1 --ylo -6.5 -3 --yhi 3.5 7 --ncomp 2 --compA 500.0 0.5 2.0 --compB 500.0 -0.5 2.0
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     431.932261 +/- 43.517224 (10.08%) initial =  500.000000
  A_i1:     83.854805 +/- 63.420988 (75.63%) initial =  0.000000
  A_i2:     34.456668 +/- 78.148868 (226.80%) initial =  0.000000
  A_u0:     1.733938 +/- 0.137531 (7.93%) initial =  0.500000
  A_u1:    -1.080642 +/- 0.199969 (18.50%) initial =  0.000000
  A_u2:    -0.112665 +/- 0.244130 (216.69%) initial =  0.000000
  A_w0:     1.534047 +/- 0.060088 (3.92%) initial =  2.000000
  A_w1:     0.120070 +/- 0.084550 (70.42%) initial =  0.000000
  A_w2:     0.115568 +/- 0.115380 (99.84%) initial =  0.000000
  B_i0:     488.077015 +/- 43.752397 (8.96%) initial =  500.000000
  B_i1:    -105.457513 +/- 63.889216 (60.58%) initial =  0.000000
  B_i2:    -48.124615 +/- 78.496010 (163.11%) initial =  0.000000
  B_u0:    -1.418355 +/- 0.149963 (10.57%) initial = -0.500000
  B_u1:    -1.047011 +/- 0.219298 (20.95%) initial =  0.000000
  B_u2:    -0.080689 +/- 0.258808 (320.75%) initial =  0.000000
  B_w0:     1.631838 +/- 0.071531 (4.38%) initial =  2.000000
  B_w1:    -0.125308 +/- 0.105790 (84.42%) initial =  0.000000
  B_w2:    -0.028776 +/- 0.131659 (457.53%) initial =  0.000000
Correlations:
    C(A_i1, B_i1)                = -0.998 
    C(A_i0, B_i0)                = -0.997 
    C(A_i2, B_i2)                = -0.995 
    C(A_i1, B_u1)                = -0.994 
    C(A_u1, B_i1)                =  0.994 
    C(B_i1, B_u1)                =  0.994 
    C(A_i1, A_u1)                = -0.994 
    C(A_i0, B_u0)                = -0.994 
    C(B_i0, B_u0)                =  0.994 
    C(A_u0, B_i0)                =  0.994 
    C(A_i0, A_u0)                = -0.994 
    C(A_u1, B_u1)                =  0.991 
    C(A_u0, B_u0)                =  0.991 
    C(A_i2, B_u2)                = -0.990 
    C(A_u2, B_i2)                =  0.990 
    C(B_i2, B_u2)                =  0.989 
    C(A_i2, A_u2)                = -0.989 
    C(A_u2, B_u2)                =  0.983 
    C(B_i1, B_w1)                =  0.976 
    C(B_u1, B_w1)                =  0.975 
    C(B_i0, B_w0)                =  0.973 
    C(B_u0, B_w0)                =  0.972 
    C(A_i1, B_w1)                = -0.969 
    C(A_i0, B_w0)                = -0.966 
    C(A_u1, B_w1)                =  0.958 
    C(B_i2, B_w2)                =  0.955 
    C(A_u0, B_w0)                =  0.954 
    C(B_u2, B_w2)                =  0.953 
    C(A_i2, B_w2)                = -0.944 
    C(A_i0, A_w0)                =  0.939 
    C(A_u0, A_w0)                = -0.938 
    C(A_i1, A_w1)                =  0.936 
    C(A_u1, A_w1)                = -0.936 
    C(A_w0, B_i0)                = -0.928 
    C(A_w1, B_i1)                = -0.926 
    C(A_i2, A_w2)                =  0.926 
    C(A_u2, B_w2)                =  0.925 
    C(A_u2, A_w2)                = -0.922 
    C(A_w2, B_i2)                = -0.911 
    C(A_w0, B_u0)                = -0.910 
    C(A_w1, B_u1)                = -0.909 
    C(A_w2, B_u2)                = -0.887 
    C(A_w1, B_w1)                = -0.841 
    C(A_w0, B_w0)                = -0.839 
    C(A_w2, B_w2)                = -0.782 
    C(B_u0, B_u1)                =  0.686 
    C(A_u0, B_u1)                =  0.665 
    C(A_u1, B_u0)                =  0.664 
    C(B_i1, B_u0)                =  0.657 
    C(B_i0, B_u1)                =  0.657 
    C(A_i1, B_u0)                = -0.654 
    C(A_i0, B_u1)                = -0.654 
    C(B_u0, B_w1)                =  0.654 
    C(B_u1, B_w0)                =  0.648 
    C(A_u0, A_u1)                =  0.640 
    C(A_u0, B_w1)                =  0.640 
    C(A_u0, B_i1)                =  0.637 
    C(A_u1, B_i0)                =  0.635 
    C(A_i1, A_u0)                = -0.633 
    C(A_u1, B_w0)                =  0.633 
    C(A_i0, A_u1)                = -0.632 
    C(B_i0, B_i1)                =  0.628 
    C(B_i0, B_w1)                =  0.626 
    C(A_i0, B_i1)                = -0.626 
    C(A_i1, B_i0)                = -0.626 
    C(A_i0, B_w1)                = -0.625 
    C(A_i0, A_i1)                =  0.623 
    C(B_i1, B_w0)                =  0.620 
    C(A_i1, B_w0)                = -0.619 
    C(B_w0, B_w1)                =  0.610 
    C(A_w0, B_u1)                = -0.537 
    C(A_w1, B_u0)                = -0.535 
    C(A_w0, B_w1)                = -0.531 
    C(A_w1, B_w0)                = -0.525 
    C(A_w0, B_i1)                = -0.509 
    C(A_w1, B_i0)                = -0.505 
    C(A_u1, A_w0)                = -0.504 
    C(A_i1, A_w0)                =  0.503 
    C(A_u0, A_w1)                = -0.503 
    C(A_i0, A_w1)                =  0.500 
    C(A_w0, A_w1)                =  0.342 
    C(B_w0, B_w2)                =  0.105 
    C(B_u2, B_w0)                =  0.094 
    C(B_u0, B_w2)                =  0.086 
    C(A_u2, B_w0)                =  0.086 
    C(B_i0, B_w2)                =  0.077 
    C(B_i2, B_w0)                =  0.076 
    C(A_i2, B_w0)                = -0.076 
    C(A_u0, B_w2)                =  0.074 
    C(A_i0, B_w2)                = -0.073 
    C(B_u0, B_u2)                =  0.072 
    C(A_u2, B_u0)                =  0.065 
    C(B_i0, B_u2)                =  0.065 
    C(A_i0, B_u2)                = -0.060 
    C(A_u0, B_u2)                =  0.060 
    C(A_u2, B_i0)                =  0.059 
    C(B_i2, B_u0)                =  0.055 
    C(A_i0, A_u2)                = -0.055 
    C(A_i2, B_u0)                = -0.054 
    C(A_u0, A_u2)                =  0.054 
    C(B_i2, B_w1)                = -0.049 
    C(B_i0, B_i2)                =  0.048 
    C(A_i2, B_i0)                = -0.048 
    C(A_i2, B_w1)                =  0.048 
    C(A_u0, B_i2)                =  0.045 
    C(A_i0, B_i2)                = -0.045 
    C(A_i2, A_u0)                = -0.045 
    C(A_w2, B_w0)                = -0.045 
    C(A_i0, A_i2)                =  0.044 
    C(B_i1, B_i2)                = -0.036 
    C(A_w1, B_w2)                = -0.035 
    C(A_i2, B_i1)                =  0.035 
    C(A_u2, B_w1)                = -0.034 
    C(A_i1, A_i2)                = -0.033 
    C(A_i1, B_i2)                =  0.033 
    C(B_u2, B_w1)                = -0.032 
    C(A_w0, A_w2)                = -0.030 
    C(A_w2, B_w1)                =  0.029 
    C(A_w2, B_u0)                = -0.028 
    C(B_w1, B_w2)                = -0.028 
    C(A_i2, B_u1)                =  0.028 
    C(B_i2, B_u1)                = -0.028 
    C(A_w2, B_i0)                = -0.025 
    C(A_i1, A_w2)                = -0.025 
    C(A_w2, B_i1)                =  0.025 
    C(A_u0, A_w2)                = -0.024 
    C(A_w1, B_u2)                = -0.023 
    C(A_i0, A_w2)                =  0.022 
    C(A_u2, B_i1)                = -0.022 
    C(A_u1, B_i2)                = -0.021 
    C(A_i2, A_u1)                =  0.020 
    C(A_i2, A_w0)                = -0.020 
    C(A_w0, B_i2)                =  0.020 
    C(A_w2, B_u1)                =  0.020 
    C(A_i1, A_u2)                =  0.019 
    C(B_i1, B_u2)                = -0.019 
    C(A_u2, A_w1)                = -0.018 
    C(A_i1, B_u2)                =  0.017 
    C(A_u1, A_w2)                =  0.015 
    C(A_u2, B_u1)                = -0.015 
    C(A_w1, A_w2)                = -0.014 
    C(B_u1, B_u2)                = -0.012 
    C(B_i1, B_w2)                = -0.011 
    C(A_u2, A_w0)                =  0.010 
    C(A_w0, B_u2)                =  0.010 
    C(A_u1, A_u2)                = -0.010 
    C(A_w1, B_i2)                = -0.008 
    C(A_i1, B_w2)                =  0.008 
    C(A_u1, B_w2)                =  0.006 
    C(A_i2, A_w1)                =  0.005 
    C(A_u1, B_u2)                = -0.004 
    C(A_w0, B_w2)                = -0.004 
    C(B_u1, B_w2)                = -0.001 
#+end_example

*** [Fe II] lines
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-Fe_II_5262 --min-fraction 0.1 --ylo -7 -3.5 --yhi 5 7 --ncomp 2 --compA 100.0 25.0 5.0 --compB 20.0 16.0 4.0 --linear-components AB --linear-intensity-components AB
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     39.647427 +/- 5.739272 (14.48%) initial =  100.000000
  A_i1:    -5.599837 +/- 7.154968 (127.77%) initial =  0.000000
  A_i2:    fixed
  A_u0:     25.303135 +/- 0.528356 (2.09%) initial =  25.000000
  A_u1:    -0.141843 +/- 0.662509 (467.07%) initial =  0.000000
  A_u2:    fixed
  A_w0:     3.333995 +/- 0.520364 (15.61%) initial =  5.000000
  A_w1:    -0.382068 +/- 0.656800 (171.91%) initial =  0.000000
  A_w2:    fixed
  B_i0:     17.280652 +/- 5.870185 (33.97%) initial =  20.000000
  B_i1:    -0.626102 +/- 7.290039 (1164.35%) initial =  0.000000
  B_i2:    fixed
  B_u0:     14.498511 +/- 1.441462 (9.94%) initial =  16.000000
  B_u1:     1.645773 +/- 1.750238 (106.35%) initial =  0.000000
  B_u2:    fixed
  B_w0:     3.718789 +/- 1.452084 (39.05%) initial =  4.000000
  B_w1:    -0.999999 +/- 4.285285 (428.53%) initial =  0.000000
  B_w2:    fixed
Correlations:
    C(B_i0, B_w0)                =  0.820 
    C(A_i0, A_w0)                =  0.819 
    C(A_i1, A_w1)                =  0.817 
    C(B_i1, B_w1)                = -0.815 
    C(A_i0, B_i0)                = -0.732 
    C(A_i1, B_i1)                = -0.724 
    C(A_i0, B_u0)                = -0.694 
    C(A_i0, B_w0)                = -0.694 
    C(A_u0, B_i0)                =  0.692 
    C(A_u1, B_i1)                =  0.685 
    C(A_i1, B_u1)                = -0.684 
    C(A_i1, B_w1)                =  0.684 
    C(A_w0, B_i0)                = -0.672 
    C(A_w1, B_i1)                = -0.667 
    C(A_u0, B_w0)                =  0.659 
    C(A_u0, B_u0)                =  0.651 
    C(A_u1, B_w1)                = -0.650 
    C(A_u1, B_u1)                =  0.642 
    C(A_w0, B_u0)                = -0.639 
    C(A_w1, B_u1)                = -0.631 
    C(A_i0, A_u0)                = -0.620 
    C(B_i0, B_u0)                =  0.614 
    C(A_i1, A_u1)                = -0.609 
    C(B_i1, B_u1)                =  0.604 
    C(B_u0, B_w0)                =  0.599 
    C(B_u1, B_w1)                = -0.590 
    C(A_w0, B_w0)                = -0.569 
    C(A_u0, A_w0)                = -0.567 
    C(A_w1, B_w1)                =  0.561 
    C(A_u1, A_w1)                = -0.560 
    C(B_u0, B_u1)                = -0.413 
    C(B_w0, B_w1)                =  0.409 
    C(B_u1, B_w0)                = -0.273 
    C(B_u0, B_w1)                =  0.272 
    C(B_i0, B_w1)                =  0.211 
    C(B_i1, B_w0)                = -0.203 
    C(A_w0, A_w1)                =  0.199 
    C(A_i0, B_w1)                = -0.179 
    C(A_i0, B_u1)                =  0.178 
    C(B_i0, B_u1)                = -0.175 
    C(A_i1, B_w0)                =  0.171 
    C(A_i1, B_u0)                =  0.170 
    C(B_i1, B_u0)                = -0.168 
    C(A_u0, B_u1)                = -0.135 
    C(A_u0, B_w1)                =  0.130 
    C(A_u1, B_u0)                = -0.126 
    C(A_u1, B_w0)                = -0.121 
    C(A_u0, A_u1)                =  0.113 
    C(A_w0, B_u1)                =  0.087 
    C(A_i0, A_w1)                =  0.085 
    C(A_i1, A_w0)                =  0.085 
    C(A_w1, B_u0)                =  0.079 
    C(A_u0, A_w1)                = -0.077 
    C(A_u1, A_w0)                = -0.076 
    C(A_w0, B_w1)                = -0.074 
    C(A_w1, B_w0)                =  0.066 
    C(A_w1, B_i0)                = -0.052 
    C(B_i0, B_i1)                = -0.051 
    C(A_w0, B_i1)                = -0.051 
    C(A_i0, B_i1)                =  0.040 
    C(A_i1, B_i0)                =  0.039 
    C(A_i0, A_i1)                =  0.014 
    C(A_i0, A_u1)                = -0.005 
    C(A_i1, A_u0)                = -0.004 
    C(A_u1, B_i0)                =  0.002 
    C(A_u0, B_i1)                =  0.000 
#+end_example

The [Fe II] 5159 line is strong enough that we can start to see the curvature in the principal component of the nebular line. 
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-Fe_II_5159 --min-fraction 0.1 --ylo -6.5 -3.5 --yhi 5 7 --ncomp 2 --compA 100.0 22.0 5.0 --compB 20.0 15.0 4.0 --linear-components AB --linear-intensity-components AB
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     103.234827 +/- 22.371148 (21.67%) initial =  100.000000
  A_i1:    -18.607338 +/- 29.026651 (156.00%) initial =  0.000000
  A_i2:    fixed
  A_u0:     24.158517 +/- 0.678381 (2.81%) initial =  22.000000
  A_u1:    -0.559630 +/- 0.860738 (153.80%) initial =  0.000000
  A_u2:    fixed
  A_w0:     3.850094 +/- 0.467438 (12.14%) initial =  5.000000
  A_w1:    -0.172783 +/- 0.592819 (343.10%) initial =  0.000000
  A_w2:    fixed
  B_i0:     107.510480 +/- 22.740982 (21.15%) initial =  20.000000
  B_i1:     33.918498 +/- 29.469772 (86.88%) initial =  0.000000
  B_i2:    fixed
  B_u0:     14.232425 +/- 0.990549 (6.96%) initial =  15.000000
  B_u1:     0.020419 +/- 1.281590 (6276.44%) initial =  0.000000
  B_u2:    fixed
  B_w0:     4.389469 +/- 0.669339 (15.25%) initial =  4.000000
  B_w1:     0.999922 +/- 14.550006 (1455.11%) initial =  0.000000
  B_w2:    fixed
Correlations:
    C(A_i0, B_i0)                = -0.964 
    C(A_i1, B_i1)                = -0.964 
    C(A_i1, B_u1)                = -0.958 
    C(A_i0, B_u0)                = -0.958 
    C(B_i0, B_u0)                =  0.940 
    C(B_i1, B_u1)                =  0.940 
    C(B_i0, B_w0)                =  0.930 
    C(B_i1, B_w1)                = -0.926 
    C(A_u0, B_u0)                =  0.924 
    C(A_u0, B_i0)                =  0.923 
    C(A_u1, B_u1)                =  0.920 
    C(A_u1, B_i1)                =  0.919 
    C(A_i0, A_u0)                = -0.914 
    C(A_i1, A_u1)                = -0.911 
    C(A_i0, B_w0)                = -0.897 
    C(A_i1, B_w1)                =  0.893 
    C(B_u0, B_w0)                =  0.874 
    C(B_u1, B_w1)                = -0.870 
    C(A_i0, A_w0)                =  0.867 
    C(A_i1, A_w1)                =  0.856 
    C(A_u0, B_w0)                =  0.846 
    C(A_u1, B_w1)                = -0.834 
    C(A_w0, B_i0)                = -0.818 
    C(A_w0, B_u0)                = -0.817 
    C(A_u0, A_w0)                = -0.810 
    C(A_w1, B_i1)                = -0.805 
    C(A_w1, B_u1)                = -0.803 
    C(A_u1, A_w1)                = -0.797 
    C(B_i0, B_i1)                =  0.758 
    C(A_i1, B_i0)                = -0.743 
    C(A_i0, B_i1)                = -0.743 
    C(A_i0, A_i1)                =  0.742 
    C(A_i0, B_u1)                = -0.727 
    C(A_i1, B_u0)                = -0.726 
    C(B_i0, B_u1)                =  0.726 
    C(B_i1, B_u0)                =  0.725 
    C(B_u0, B_u1)                =  0.721 
    C(A_w0, B_w0)                = -0.704 
    C(A_w1, B_w1)                =  0.683 
    C(A_u0, B_i1)                =  0.651 
    C(B_i1, B_w0)                =  0.650 
    C(A_u1, B_i0)                =  0.649 
    C(A_i1, A_u0)                = -0.648 
    C(B_i0, B_w1)                = -0.647 
    C(A_i0, A_u1)                = -0.646 
    C(A_u0, B_u1)                =  0.638 
    C(A_u1, B_u0)                =  0.636 
    C(A_i1, B_w0)                = -0.636 
    C(A_i0, B_w1)                =  0.633 
    C(B_u1, B_w0)                =  0.622 
    C(B_u0, B_w1)                = -0.618 
    C(A_u0, A_u1)                =  0.599 
    C(B_w0, B_w1)                = -0.586 
    C(A_u1, B_w0)                =  0.518 
    C(A_u0, B_w1)                = -0.516 
    C(A_i1, A_w0)                =  0.513 
    C(A_w0, B_i1)                = -0.502 
    C(A_i0, A_w1)                =  0.502 
    C(A_w1, B_i0)                = -0.491 
    C(A_w0, B_u1)                = -0.485 
    C(A_w1, B_u0)                = -0.473 
    C(A_u1, A_w0)                = -0.432 
    C(A_u0, A_w1)                = -0.423 
    C(A_w0, A_w1)                =  0.390 
    C(A_w0, B_w1)                =  0.360 
    C(A_w1, B_w0)                = -0.353 
#+end_example

*** Si II lines
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-Si_II_6371 --min-fraction 0.05 --ylo -6.5 -3  --yhi 3 6.5 --ncomp 3 --compA 100.0 1.0 5.0 --compB 100.0 13.0 4.0 --compC 100.0 25.0 3.0 --linear-components ABC --linear-intensity-components ABC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     179.660687 +/- 39.500490 (21.99%) initial =  100.000000
  A_i1:    -19.236647 +/- 48.594822 (252.62%) initial =  0.000000
  A_i2:    fixed
  A_u0:     1.340439 +/- 1.061335 (79.18%) initial =  1.000000
  A_u1:    -1.294730 +/- 1.303348 (100.67%) initial =  0.000000
  A_u2:    fixed
  A_w0:     5.168164 +/- 0.535632 (10.36%) initial =  5.000000
  A_w1:    -0.324943 +/- 0.669472 (206.03%) initial =  0.000000
  A_w2:    fixed
  B_i0:     215.275788 +/- 48.443468 (22.50%) initial =  100.000000
  B_i1:     25.548352 +/- 59.915935 (234.52%) initial =  0.000000
  B_i2:    fixed
  B_u0:     12.540538 +/- 0.705422 (5.63%) initial =  13.000000
  B_u1:    -0.733284 +/- 0.887290 (121.00%) initial =  0.000000
  B_u2:    fixed
  B_w0:     5.073317 +/- 0.822686 (16.22%) initial =  4.000000
  B_w1:     0.723083 +/- 1.035834 (143.25%) initial =  0.000000
  B_w2:    fixed
  C_i0:     125.954899 +/- 12.454372 (9.89%) initial =  100.000000
  C_i1:    -7.002393 +/- 16.444022 (234.83%) initial =  0.000000
  C_i2:    fixed
  C_u0:     24.362211 +/- 0.278223 (1.14%) initial =  25.000000
  C_u1:     0.185598 +/- 0.371862 (200.36%) initial =  0.000000
  C_u2:    fixed
  C_w0:     3.450240 +/- 0.199566 (5.78%) initial =  3.000000
  C_w1:     0.078877 +/- 0.274297 (347.75%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(A_i0, A_u0)                =  0.985 
    C(A_i0, B_i0)                = -0.983 
    C(A_i1, A_u1)                =  0.979 
    C(A_i1, B_i1)                = -0.977 
    C(B_i0, B_w0)                =  0.976 
    C(A_u0, B_i0)                = -0.973 
    C(B_i1, B_w1)                =  0.967 
    C(A_u1, B_i1)                = -0.962 
    C(A_i0, A_w0)                =  0.949 
    C(A_i0, B_u0)                =  0.944 
    C(A_u0, A_w0)                =  0.942 
    C(A_u0, B_u0)                =  0.941 
    C(A_i0, B_w0)                = -0.938 
    C(A_i1, A_w1)                =  0.930 
    C(A_i1, B_u1)                =  0.924 
    C(A_u1, A_w1)                =  0.923 
    C(A_u0, B_w0)                = -0.917 
    C(A_i1, B_w1)                = -0.917 
    C(A_u1, B_u1)                =  0.916 
    C(A_w0, B_u0)                =  0.912 
    C(A_w0, B_i0)                = -0.905 
    C(B_w0, C_i0)                = -0.899 
    C(C_i0, C_u0)                = -0.898 
    C(B_i0, B_u0)                = -0.893 
    C(A_u1, B_w1)                = -0.884 
    C(C_i1, C_u1)                = -0.881 
    C(B_w1, C_i1)                = -0.880 
    C(C_i0, C_w0)                =  0.877 
    C(A_w1, B_u1)                =  0.874 
    C(A_w1, B_i1)                = -0.870 
    C(C_i1, C_w1)                =  0.866 
    C(B_i1, B_u1)                = -0.858 
    C(B_i0, C_i0)                = -0.851 
    C(B_w0, C_u0)                =  0.835 
    C(B_u0, B_w0)                = -0.832 
    C(B_i1, C_i1)                = -0.824 
    C(A_w0, B_w0)                = -0.812 
    C(B_w1, C_u1)                =  0.806 
    C(B_i0, C_u0)                =  0.790 
    C(B_u1, B_w1)                = -0.785 
    C(C_u0, C_w0)                = -0.784 
    C(A_i0, C_i0)                =  0.765 
    C(C_u1, C_w1)                = -0.762 
    C(B_i1, C_u1)                =  0.755 
    C(A_w1, B_w1)                = -0.745 
    C(A_u0, C_i0)                =  0.742 
    C(A_i1, C_i1)                =  0.716 
    C(A_i0, C_u0)                = -0.700 
    C(B_w0, C_w0)                = -0.693 
    C(A_u1, C_i1)                =  0.684 
    C(A_u0, C_u0)                = -0.679 
    C(B_w1, C_w1)                = -0.658 
    C(B_i0, C_w0)                = -0.652 
    C(A_i1, C_u1)                = -0.644 
    C(A_w0, C_i0)                =  0.627 
    C(A_u1, C_u1)                = -0.617 
    C(B_i1, C_w1)                = -0.614 
    C(A_w0, C_u0)                = -0.571 
    C(B_u0, C_i0)                =  0.566 
    C(A_i0, C_w0)                =  0.554 
    C(A_w1, C_i1)                =  0.540 
    C(A_u0, C_w0)                =  0.535 
    C(A_i1, C_w1)                =  0.496 
    C(B_u0, C_u0)                = -0.489 
    C(B_w0, B_w1)                =  0.486 
    C(A_w1, C_u1)                = -0.485 
    C(A_u1, C_w1)                =  0.472 
    C(B_u1, C_i1)                =  0.472 
    C(A_w0, C_w0)                =  0.442 
    C(B_u0, B_w1)                = -0.410 
    C(B_u0, B_u1)                =  0.402 
    C(B_u1, B_w0)                = -0.402 
    C(B_i0, B_w1)                =  0.389 
    C(B_u1, C_u1)                = -0.387 
    C(B_w1, C_i0)                = -0.378 
    C(A_i0, B_w1)                = -0.365 
    C(A_w1, C_w1)                =  0.362 
    C(B_i1, B_w0)                =  0.359 
    C(B_w0, C_i1)                = -0.349 
    C(B_u0, C_w0)                =  0.337 
    C(A_i1, B_w0)                = -0.329 
    C(B_i0, B_u1)                = -0.324 
    C(A_i0, B_u1)                =  0.316 
    C(A_u0, B_w1)                = -0.305 
    C(B_w1, C_u0)                =  0.305 
    C(B_i1, B_u0)                = -0.301 
    C(A_i1, B_u0)                =  0.287 
    C(B_u1, C_i0)                =  0.280 
    C(C_i0, C_i1)                =  0.277 
    C(A_u0, B_u1)                =  0.264 
    C(B_i1, C_i0)                = -0.262 
    C(B_w0, C_u1)                =  0.262 
    C(B_i0, C_i1)                = -0.261 
    C(B_u0, C_i1)                =  0.261 
    C(B_i0, B_i1)                =  0.253 
    C(B_w1, C_w0)                = -0.250 
    C(A_u1, B_w0)                = -0.246 
    C(B_u1, C_w1)                =  0.238 
    C(A_i0, C_i1)                =  0.237 
    C(A_i1, C_i0)                =  0.232 
    C(A_i0, B_i1)                = -0.231 
    C(A_w0, B_w1)                = -0.229 
    C(A_i1, B_i0)                = -0.225 
    C(B_u1, C_u0)                = -0.217 
    C(C_i1, C_u0)                = -0.217 
    C(A_u1, B_u0)                =  0.212 
    C(B_w0, C_w1)                = -0.210 
    C(A_i0, A_i1)                =  0.205 
    C(A_w0, B_u1)                =  0.204 
    C(C_i0, C_u1)                = -0.203 
    C(B_i1, C_u0)                =  0.196 
    C(C_i1, C_w0)                =  0.188 
    C(A_u0, C_i1)                =  0.186 
    C(B_u0, C_u1)                = -0.185 
    C(B_i0, C_u1)                =  0.181 
    C(C_i0, C_w1)                =  0.172 
    C(C_u0, C_u1)                =  0.169 
    C(A_u0, B_i1)                = -0.169 
    C(A_i1, C_u0)                = -0.168 
    C(B_u1, C_w0)                =  0.168 
    C(B_i1, C_w0)                = -0.160 
    C(A_u1, C_i0)                =  0.160 
    C(A_i0, C_u1)                = -0.159 
    C(A_w1, B_w0)                = -0.150 
    C(A_i1, A_u0)                =  0.144 
    C(B_i0, C_w1)                = -0.144 
    C(C_w0, C_w1)                =  0.142 
    C(A_u1, B_i0)                = -0.140 
    C(B_u0, C_w1)                =  0.139 
    C(A_i1, C_w0)                =  0.136 
    C(A_w1, B_u0)                =  0.133 
    C(C_u1, C_w0)                = -0.129 
    C(C_u0, C_w1)                = -0.126 
    C(A_i0, C_w1)                =  0.125 
    C(A_w0, C_i1)                =  0.125 
    C(A_i0, A_u1)                =  0.122 
    C(A_u0, C_u1)                = -0.112 
    C(A_u1, C_u0)                = -0.102 
    C(A_w0, B_i1)                = -0.098 
    C(A_u0, C_w1)                =  0.088 
    C(A_u1, C_w0)                =  0.082 
    C(A_w1, C_i0)                =  0.080 
    C(A_i1, A_w0)                =  0.076 
    C(A_w0, A_w1)                = -0.073 
    C(A_w0, C_u1)                = -0.062 
    C(A_u0, A_u1)                =  0.062 
    C(A_w1, B_i0)                = -0.051 
    C(A_w0, C_w1)                =  0.047 
    C(A_i0, A_w1)                =  0.034 
    C(A_w1, C_u0)                = -0.034 
    C(A_w1, C_w0)                =  0.026 
    C(A_u0, A_w1)                = -0.020 
    C(A_u1, A_w0)                = -0.001 
#+end_example

#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-Si_II_6347 --min-fraction 0.05 --ylo -6.5 -3  --yhi 3 6.5 --ncomp 3 --compA 100.0 1.0 5.0 --compB 100.0 13.0 4.0 --compC 100.0 25.0 3.0 --linear-components ABC --linear-intensity-components ABC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     17.049643 +/- 5.219414 (30.61%) initial =  100.000000
  A_i1:    -20.669997 +/- 6.943274 (33.59%) initial =  0.000000
  A_i2:    fixed
  A_u0:     0.118606 +/- 0.861367 (726.25%) initial =  1.000000
  A_u1:     0.197779 +/- 1.235660 (624.77%) initial =  0.000000
  A_u2:    fixed
  A_w0:     1.500001 +/- 0.752002 (50.13%) initial =  5.000000
  A_w1:    -0.713462 +/- 0.998412 (139.94%) initial =  0.000000
  A_w2:    fixed
  B_i0:     766.820260 +/- 14.175790 (1.85%) initial =  100.000000
  B_i1:     2.243776 +/- 19.951137 (889.18%) initial =  0.000000
  B_i2:    fixed
  B_u0:     12.876624 +/- 0.199207 (1.55%) initial =  13.000000
  B_u1:    -1.545150 +/- 0.280517 (18.15%) initial =  0.000000
  B_u2:    fixed
  B_w0:     9.732168 +/- 0.191038 (1.96%) initial =  4.000000
  B_w1:     0.859281 +/- 0.268402 (31.24%) initial =  0.000000
  B_w2:    fixed
  C_i0:     101.269028 +/- 7.519514 (7.43%) initial =  100.000000
  C_i1:     14.827599 +/- 10.785760 (72.74%) initial =  0.000000
  C_i2:    fixed
  C_u0:     24.896473 +/- 0.097972 (0.39%) initial =  25.000000
  C_u1:    -0.403347 +/- 0.140495 (34.83%) initial =  0.000000
  C_u2:    fixed
  C_w0:     2.161806 +/- 0.133546 (6.18%) initial =  3.000000
  C_w1:     0.106648 +/- 0.191608 (179.66%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(A_u0, A_u1)                =  0.895 
    C(B_i0, B_w0)                =  0.850 
    C(B_i1, B_w1)                =  0.844 
    C(C_i0, C_w0)                =  0.794 
    C(C_i1, C_w1)                =  0.794 
    C(A_w0, A_w1)                =  0.749 
    C(B_i1, C_i1)                = -0.714 
    C(B_i0, C_i0)                = -0.704 
    C(A_i0, A_i1)                = -0.701 
    C(B_u1, C_i1)                = -0.692 
    C(B_u0, C_i0)                = -0.676 
    C(B_w1, C_i1)                = -0.627 
    C(B_w0, C_i0)                = -0.619 
    C(B_i1, C_w1)                = -0.546 
    C(B_i0, C_w0)                = -0.538 
    C(B_u1, C_w1)                = -0.536 
    C(A_i0, B_w0)                = -0.527 
    C(B_u0, C_w0)                = -0.525 
    C(A_i0, B_i0)                = -0.514 
    C(A_i0, A_w0)                =  0.503 
    C(A_i1, B_w1)                = -0.500 
    C(A_i1, B_i1)                = -0.486 
    C(B_w1, C_w1)                = -0.456 
    C(B_w0, C_w0)                = -0.449 
    C(A_i0, B_u0)                =  0.397 
    C(A_i1, B_w0)                =  0.392 
    C(A_i0, B_w1)                =  0.376 
    C(A_i1, B_i0)                =  0.369 
    C(A_i1, B_u1)                =  0.355 
    C(A_i0, B_i1)                =  0.350 
    C(A_u0, A_w0)                =  0.310 
    C(A_u1, A_w1)                =  0.310 
    C(B_i1, B_u1)                =  0.307 
    C(A_u0, A_w1)                =  0.304 
    C(A_u1, A_w0)                =  0.283 
    C(A_i1, A_w1)                =  0.279 
    C(B_i0, B_u0)                =  0.260 
    C(A_w0, B_i0)                = -0.239 
    C(B_u1, B_w1)                =  0.236 
    C(A_w0, B_u0)                =  0.228 
    C(A_w0, B_w0)                = -0.228 
    C(A_i1, A_w0)                = -0.222 
    C(A_i1, B_u0)                = -0.198 
    C(B_u0, B_w0)                =  0.191 
    C(B_w0, C_u0)                = -0.183 
    C(B_w1, C_u1)                = -0.176 
    C(A_i0, B_u1)                = -0.160 
    C(B_u0, B_w1)                =  0.156 
    C(B_i0, B_i1)                = -0.152 
    C(A_i0, C_u0)                =  0.152 
    C(C_w0, C_w1)                = -0.148 
    C(A_w1, B_u1)                =  0.147 
    C(A_i1, C_u1)                =  0.143 
    C(A_w0, B_w1)                =  0.140 
    C(B_u1, B_w0)                =  0.139 
    C(C_u0, C_u1)                = -0.129 
    C(B_i0, B_w1)                = -0.125 
    C(B_i1, B_w0)                = -0.123 
    C(A_i1, C_u0)                = -0.120 
    C(B_i1, B_u0)                =  0.120 
    C(A_w0, B_i1)                =  0.119 
    C(A_i0, C_u1)                = -0.115 
    C(A_w1, B_i1)                = -0.112 
    C(A_i0, C_i1)                = -0.112 
    C(A_i1, C_i0)                = -0.106 
    C(B_i0, B_u1)                =  0.106 
    C(B_u0, C_u0)                =  0.104 
    C(B_u1, C_u1)                =  0.095 
    C(A_w1, B_w1)                = -0.094 
    C(A_i1, C_i1)                =  0.092 
    C(A_i0, C_i0)                =  0.089 
    C(A_u0, B_u0)                =  0.081 
    C(C_i0, C_w1)                = -0.079 
    C(C_i1, C_w0)                = -0.078 
    C(A_i0, C_w1)                = -0.077 
    C(B_u0, B_u1)                =  0.076 
    C(B_i0, C_w1)                =  0.076 
    C(A_u1, B_u1)                =  0.076 
    C(B_i0, C_u0)                = -0.073 
    C(B_i1, C_w0)                =  0.073 
    C(A_i1, C_w0)                = -0.072 
    C(A_w0, C_u0)                =  0.065 
    C(A_i0, A_u0)                =  0.065 
    C(B_i1, C_u1)                = -0.065 
    C(B_w0, B_w1)                = -0.065 
    C(B_u0, C_i1)                = -0.063 
    C(B_w0, C_u1)                =  0.061 
    C(B_w1, C_u0)                =  0.061 
    C(A_i1, C_w1)                =  0.061 
    C(B_i0, C_i1)                =  0.059 
    C(A_w0, C_i1)                = -0.059 
    C(A_i0, C_w0)                =  0.058 
    C(B_u1, C_i0)                = -0.057 
    C(B_i0, C_u1)                =  0.057 
    C(B_i1, C_u0)                =  0.056 
    C(B_i1, C_i0)                =  0.054 
    C(A_w1, B_u0)                =  0.054 
    C(A_u1, C_i1)                = -0.050 
    C(A_u0, B_w1)                =  0.050 
    C(A_u0, C_i0)                = -0.049 
    C(A_u1, B_w1)                =  0.045 
    C(A_u1, B_w0)                =  0.044 
    C(A_w0, C_u1)                = -0.043 
    C(A_w0, C_w1)                = -0.040 
    C(A_u0, B_w0)                =  0.039 
    C(A_i1, A_u1)                =  0.039 
    C(B_w0, C_w1)                =  0.037 
    C(A_u1, C_w1)                = -0.036 
    C(A_u0, C_w0)                = -0.035 
    C(B_u0, C_u1)                = -0.034 
    C(C_i0, C_i1)                = -0.033 
    C(B_w1, C_w0)                =  0.032 
    C(B_u1, C_u0)                = -0.029 
    C(A_u0, B_i1)                =  0.028 
    C(A_w1, C_i0)                = -0.028 
    C(A_w1, C_u1)                =  0.026 
    C(A_u0, C_i1)                = -0.025 
    C(A_u1, C_i0)                = -0.023 
    C(A_u1, B_u0)                =  0.022 
    C(A_u1, B_i0)                =  0.019 
    C(A_w1, C_w0)                = -0.019 
    C(A_u0, B_u1)                =  0.019 
    C(A_w1, B_w0)                =  0.018 
    C(A_w0, C_i0)                =  0.017 
    C(B_w0, C_i1)                =  0.015 
    C(A_u0, C_w1)                = -0.015 
    C(C_i1, C_u0)                = -0.015 
    C(A_i1, A_u0)                = -0.014 
    C(A_w1, C_i1)                = -0.014 
    C(A_u1, C_w0)                = -0.014 
    C(C_i0, C_u1)                = -0.013 
    C(A_i0, A_w1)                =  0.013 
    C(A_w0, B_u1)                = -0.013 
    C(A_i0, A_u1)                =  0.012 
    C(A_u1, B_i1)                =  0.012 
    C(A_w1, C_w1)                = -0.011 
    C(A_w0, C_w0)                =  0.010 
    C(A_u0, C_u1)                = -0.010 
    C(B_u0, C_w1)                = -0.009 
    C(A_u1, C_u0)                = -0.009 
    C(C_u1, C_w1)                = -0.009 
    C(C_u0, C_w0)                = -0.009 
    C(B_w1, C_i0)                =  0.009 
    C(C_u0, C_w1)                = -0.008 
    C(A_w1, C_u0)                = -0.008 
    C(C_u1, C_w0)                = -0.007 
    C(A_u1, C_u1)                = -0.005 
    C(A_u0, C_u0)                = -0.004 
    C(B_u1, C_w0)                = -0.004 
    C(A_u0, B_i0)                =  0.003 
    C(C_i0, C_u0)                =  0.002 
    C(A_w1, B_i0)                =  0.002 
    C(C_i1, C_u1)                =  0.002 
#+end_example

Note that you can just see the recombination component from the proplyd in this line.  Although it is very weak compared with the PDR fluorescent component, whereas in the nebula the recomb component is the stronger of the two.  This should allow an estimate to be made of the ratio of Si/H between the proplyd and the nebula. 
*** [S II] lines
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-S_II_6716 --vrange -20 50 --min-fraction 0.05 --ylo -6.0 -3.5 --yhi 4 7 --ncomp 3 --compA 5000.0 -2.0 5.0 --compB 15000 15.0 7.0 --compC 5000 30.0 10.0 --linear-components C
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     7440.386629 +/- 225.637011 (3.03%) initial =  5000.000000
  A_i1:     1101.115102 +/- 273.399760 (24.83%) initial =  0.000000
  A_i2:    -456.190133 +/- 153.349988 (33.62%) initial =  0.000000
  A_u0:    -1.123960 +/- 0.070132 (6.24%) initial = -2.000000
  A_u1:    -0.914875 +/- 0.087604 (9.58%) initial =  0.000000
  A_u2:    -0.216931 +/- 0.086771 (40.00%) initial =  0.000000
  A_w0:     3.903383 +/- 0.062982 (1.61%) initial =  5.000000
  A_w1:     0.200647 +/- 0.080031 (39.89%) initial =  0.000000
  A_w2:     0.095252 +/- 0.092631 (97.25%) initial =  0.000000
  B_i0:     12926.466824 +/- 611.569419 (4.73%) initial =  15000.000000
  B_i1:    -1667.659920 +/- 717.390887 (43.02%) initial =  0.000000
  B_i2:    -1657.051351 +/- 252.205333 (15.22%) initial =  0.000000
  B_u0:     15.017138 +/- 0.041539 (0.28%) initial =  15.000000
  B_u1:    -0.488205 +/- 0.052012 (10.65%) initial =  0.000000
  B_u2:    -0.988970 +/- 0.062303 (6.30%) initial =  0.000000
  B_w0:     4.133287 +/- 0.073767 (1.78%) initial =  7.000000
  B_w1:    -0.032324 +/- 0.088425 (273.56%) initial =  0.000000
  B_w2:    -0.211096 +/- 0.070288 (33.30%) initial =  0.000000
  C_i0:     9992.218722 +/- 830.303094 (8.31%) initial =  5000.000000
  C_i1:     1204.728766 +/- 972.083093 (80.69%) initial =  0.000000
  C_i2:    -409.108870 +/- 327.417453 (80.03%) initial =  0.000000
  C_u0:     21.743652 +/- 0.882708 (4.06%) initial =  30.000000
  C_u1:    -1.126714 +/- 1.053555 (93.51%) initial =  0.000000
  C_u2:    fixed
  C_w0:     10.134113 +/- 0.379080 (3.74%) initial =  10.000000
  C_w1:     1.000000 +/- 0.502642 (50.26%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(C_i0, C_u0)                = -0.990 
    C(B_i0, C_i0)                = -0.990 
    C(B_i0, C_u0)                =  0.986 
    C(C_i1, C_u1)                = -0.985 
    C(B_i1, C_i1)                = -0.983 
    C(B_i1, C_u1)                =  0.980 
    C(B_i0, B_w0)                =  0.963 
    C(B_w0, C_i0)                = -0.951 
    C(B_i1, B_w1)                =  0.944 
    C(A_i0, C_u0)                =  0.942 
    C(A_i0, C_i0)                = -0.941 
    C(B_w0, C_u0)                =  0.938 
    C(C_i0, C_w0)                =  0.936 
    C(C_u0, C_w0)                = -0.932 
    C(A_i0, C_w0)                = -0.932 
    C(B_w1, C_i1)                = -0.929 
    C(C_i1, C_w1)                = -0.925 
    C(C_u1, C_w1)                =  0.919 
    C(B_w1, C_u1)                =  0.911 
    C(A_i1, C_i1)                = -0.908 
    C(A_i0, A_w0)                =  0.907 
    C(A_i1, C_u1)                =  0.905 
    C(A_i0, B_i0)                =  0.904 
    C(B_i0, C_w0)                = -0.900 
    C(A_i1, C_w1)                =  0.896 
    C(A_u0, C_u0)                =  0.891 
    C(A_u0, C_i0)                = -0.887 
    C(B_i1, C_w1)                =  0.881 
    C(A_i0, A_u0)                =  0.880 
    C(A_u0, C_w0)                = -0.876 
    C(A_i1, A_w1)                =  0.873 
    C(A_i0, B_w0)                =  0.862 
    C(A_u0, B_i0)                =  0.860 
    C(B_u0, C_w0)                =  0.859 
    C(A_i1, B_i1)                =  0.848 
    C(A_u1, C_u1)                =  0.846 
    C(A_u1, C_i1)                = -0.841 
    C(B_w0, C_w0)                = -0.840 
    C(A_w0, C_u0)                =  0.837 
    C(A_w0, C_w0)                = -0.836 
    C(A_w0, C_i0)                = -0.832 
    C(A_u1, C_w1)                =  0.832 
    C(A_i1, A_u1)                =  0.827 
    C(A_u1, B_i1)                =  0.803 
    C(A_i1, B_w1)                =  0.801 
    C(A_u0, A_w0)                =  0.800 
    C(B_w1, C_w1)                =  0.796 
    C(A_u0, B_w0)                =  0.796 
    C(B_i2, C_i2)                = -0.794 
    C(A_w0, B_i0)                =  0.794 
    C(A_i0, B_u0)                = -0.792 
    C(B_u1, C_w1)                = -0.790 
    C(B_u0, C_u0)                = -0.776 
    C(A_w1, C_w1)                =  0.774 
    C(A_w1, C_u1)                =  0.771 
    C(A_w1, C_i1)                = -0.767 
    C(B_u0, C_i0)                =  0.759 
    C(A_u1, A_w1)                =  0.729 
    C(A_i1, B_u1)                = -0.728 
    C(A_w0, B_w0)                =  0.723 
    C(B_i2, B_w2)                =  0.722 
    C(B_i0, B_u0)                = -0.720 
    C(A_u1, B_w1)                =  0.717 
    C(A_u0, B_u0)                = -0.716 
    C(A_w1, B_i1)                =  0.711 
    C(B_u1, C_u1)                = -0.691 
    C(B_u0, B_w0)                = -0.681 
    C(B_u1, C_i1)                =  0.674 
    C(A_w0, B_u0)                = -0.670 
    C(A_i2, A_w2)                =  0.631 
    C(A_w1, B_w1)                =  0.622 
    C(A_u1, B_u1)                = -0.616 
    C(B_i1, B_u1)                = -0.616 
    C(B_u1, B_w1)                = -0.582 
    C(A_w1, B_u1)                = -0.565 
    C(B_w2, C_i2)                = -0.526 
    C(B_i0, B_i1)                = -0.326 
    C(A_i2, B_i1)                =  0.312 
    C(A_w2, B_w2)                = -0.307 
    C(A_i0, A_i1)                =  0.305 
    C(B_w0, C_i2)                =  0.304 
    C(B_i0, C_i2)                =  0.302 
    C(C_i0, C_i2)                = -0.301 
    C(A_i2, C_u1)                =  0.297 
    C(A_i2, C_i1)                = -0.290 
    C(A_i2, B_w1)                =  0.289 
    C(B_u0, B_u2)                = -0.287 
    C(A_i2, C_w1)                =  0.282 
    C(B_u2, C_u0)                =  0.281 
    C(B_i0, B_u2)                =  0.273 
    C(B_u2, C_w0)                = -0.272 
    C(C_i2, C_u0)                =  0.270 
    C(B_u2, C_i0)                = -0.267 
    C(B_i1, C_u0)                = -0.267 
    C(B_i1, C_i0)                =  0.257 
    C(B_i0, C_u1)                = -0.253 
    C(B_u2, C_i2)                = -0.253 
    C(B_i2, B_w0)                = -0.251 
    C(A_i0, C_i2)                =  0.250 
    C(B_i1, C_w0)                =  0.250 
    C(A_i0, B_u1)                = -0.243 
    C(B_u2, B_w0)                =  0.243 
    C(A_u0, B_u2)                =  0.243 
    C(A_i0, B_u2)                =  0.242 
    C(B_i2, B_w1)                = -0.242 
    C(A_u0, C_i2)                =  0.237 
    C(B_i0, C_w1)                = -0.233 
    C(C_i2, C_w0)                = -0.232 
    C(A_i2, B_i0)                = -0.226 
    C(B_i0, C_i1)                =  0.225 
    C(A_i1, B_u0)                = -0.223 
    C(A_i2, A_u1)                =  0.222 
    C(A_w0, B_u2)                =  0.220 
    C(B_i2, C_i0)                =  0.220 
    C(B_i0, B_i2)                = -0.219 
    C(A_w0, C_i2)                =  0.217 
    C(A_u2, B_w2)                = -0.216 
    C(A_i2, C_u0)                = -0.212 
    C(A_i2, C_i0)                =  0.211 
    C(A_i2, B_u1)                = -0.209 
    C(A_i0, B_i2)                = -0.206 
    C(B_i1, B_w0)                = -0.205 
    C(A_i2, B_w2)                = -0.205 
    C(A_i1, A_w0)                =  0.203 
    C(A_w2, B_i2)                = -0.200 
    C(A_i2, C_w0)                =  0.198 
    C(B_i2, C_u0)                = -0.192 
    C(B_i1, B_u2)                = -0.191 
    C(C_u0, C_u1)                = -0.188 
    C(B_i2, C_i1)                =  0.187 
    C(A_i2, A_w0)                = -0.187 
    C(B_u0, B_u1)                =  0.187 
    C(A_w2, B_u2)                =  0.185 
    C(A_i0, A_i2)                = -0.183 
    C(A_i2, B_w0)                = -0.181 
    C(A_u0, B_i1)                = -0.180 
    C(C_i0, C_u1)                =  0.180 
    C(B_i1, B_i2)                = -0.179 
    C(A_i2, A_u0)                = -0.176 
    C(A_i1, B_i2)                = -0.175 
    C(A_i0, A_w1)                =  0.173 
    C(B_i2, B_u2)                =  0.172 
    C(A_w1, A_w2)                = -0.172 
    C(C_u1, C_w0)                =  0.172 
    C(C_u0, C_w1)                = -0.172 
    C(A_u0, B_i2)                = -0.170 
    C(B_u2, C_i1)                =  0.169 
    C(A_w0, B_u1)                = -0.165 
    C(C_i0, C_w1)                =  0.165 
    C(B_i0, B_w1)                = -0.163 
    C(C_w0, C_w1)                =  0.163 
    C(C_i1, C_u0)                =  0.162 
    C(A_w0, B_i2)                = -0.161 
    C(B_u2, C_u1)                = -0.158 
    C(A_i1, A_u0)                =  0.155 
    C(B_i2, C_w0)                =  0.154 
    C(C_i0, C_i1)                = -0.152 
    C(A_u1, A_u2)                = -0.151 
    C(C_i1, C_w0)                = -0.150 
    C(A_i1, B_w0)                =  0.150 
    C(B_u0, C_i2)                = -0.146 
    C(B_u2, B_w1)                = -0.143 
    C(B_u2, C_w1)                = -0.142 
    C(A_i1, A_i2)                =  0.138 
    C(B_i2, C_u1)                = -0.137 
    C(A_u1, B_u2)                = -0.135 
    C(A_u2, A_w2)                =  0.134 
    C(B_w0, C_u1)                = -0.134 
    C(A_u2, B_u2)                =  0.132 
    C(B_u1, B_w0)                = -0.129 
    C(A_u1, B_i0)                = -0.128 
    C(B_i2, C_w1)                = -0.127 
    C(A_i2, A_u2)                =  0.126 
    C(B_w0, C_w1)                = -0.124 
    C(A_i1, C_i0)                = -0.124 
    C(A_u0, B_u1)                = -0.122 
    C(B_u1, B_u2)                = -0.119 
    C(A_w1, B_u0)                = -0.118 
    C(A_w1, B_u2)                = -0.118 
    C(A_u2, B_i2)                = -0.118 
    C(A_i2, B_u0)                =  0.118 
    C(A_w0, A_w2)                = -0.117 
    C(A_i1, C_w0)                = -0.116 
    C(A_i1, C_u0)                =  0.116 
    C(A_i2, B_i2)                = -0.114 
    C(A_u1, B_i2)                = -0.112 
    C(A_w2, B_w1)                =  0.112 
    C(B_i2, B_u0)                =  0.112 
    C(A_u0, C_u1)                = -0.111 
    C(A_u0, C_w1)                = -0.110 
    C(A_w0, B_i1)                = -0.109 
    C(B_w1, C_u0)                = -0.106 
    C(B_u1, C_i0)                =  0.106 
    C(B_w0, C_i1)                =  0.106 
    C(A_i2, B_u2)                =  0.105 
    C(B_u1, C_u0)                = -0.103 
    C(B_i2, B_u1)                =  0.101 
    C(A_w2, B_i1)                =  0.099 
    C(A_i2, C_i2)                = -0.099 
    C(B_w1, C_w0)                =  0.099 
    C(A_w1, B_w2)                =  0.099 
    C(A_i0, A_u1)                =  0.098 
    C(A_w1, B_i2)                = -0.097 
    C(B_w1, C_i0)                =  0.097 
    C(A_u0, A_u2)                = -0.091 
    C(A_u0, C_i1)                =  0.087 
    C(B_u1, C_w0)                =  0.087 
    C(A_w2, B_i0)                = -0.086 
    C(A_w2, C_u0)                = -0.085 
    C(A_i0, A_w2)                = -0.084 
    C(A_i0, B_w1)                =  0.083 
    C(A_w2, C_i0)                =  0.083 
    C(A_i1, B_u2)                = -0.083 
    C(A_w2, C_i1)                = -0.081 
    C(A_u2, B_w1)                =  0.081 
    C(A_w2, C_u1)                =  0.081 
    C(A_u1, B_w2)                =  0.079 
    C(B_w1, B_w2)                = -0.079 
    C(A_i2, A_w1)                =  0.079 
    C(B_u2, B_w2)                =  0.078 
    C(A_u1, C_w0)                =  0.077 
    C(A_w2, C_w0)                =  0.077 
    C(A_w2, B_u1)                = -0.076 
    C(B_i1, B_u0)                =  0.075 
    C(A_u1, C_u0)                = -0.074 
    C(B_w0, B_w2)                = -0.074 
    C(A_w2, C_w1)                =  0.073 
    C(A_u0, A_w2)                = -0.072 
    C(A_w2, B_w0)                = -0.068 
    C(A_u2, B_i1)                =  0.068 
    C(A_u1, C_i0)                =  0.067 
    C(A_w0, A_w1)                =  0.063 
    C(A_i1, B_w2)                =  0.062 
    C(A_i0, B_i1)                = -0.059 
    C(A_w1, B_w0)                =  0.057 
    C(A_u2, C_u1)                =  0.056 
    C(A_u0, A_u1)                = -0.055 
    C(A_u2, C_i1)                = -0.054 
    C(B_u1, B_w2)                = -0.054 
    C(A_u2, B_i0)                = -0.054 
    C(A_u0, A_w1)                =  0.052 
    C(B_i0, B_u1)                = -0.052 
    C(A_u2, C_u0)                = -0.052 
    C(A_u2, C_i0)                =  0.052 
    C(C_i2, C_w1)                = -0.051 
    C(C_i2, C_u1)                = -0.051 
    C(A_i1, B_i0)                =  0.050 
    C(A_u2, B_u1)                = -0.049 
    C(B_i0, B_w2)                = -0.048 
    C(B_w2, C_u1)                =  0.048 
    C(A_u1, B_u0)                = -0.048 
    C(A_i0, C_i1)                = -0.047 
    C(B_u1, C_i2)                =  0.046 
    C(A_w2, B_u0)                =  0.046 
    C(B_u0, B_w1)                = -0.046 
    C(A_u2, C_w1)                =  0.045 
    C(B_w2, C_w1)                =  0.045 
    C(B_w1, C_i2)                =  0.044 
    C(B_w0, B_w1)                = -0.044 
    C(A_u2, C_w0)                =  0.044 
    C(A_u2, B_w0)                = -0.043 
    C(A_w0, C_u1)                = -0.041 
    C(A_w0, C_w1)                = -0.040 
    C(B_w2, C_i0)                =  0.039 
    C(A_i0, A_u2)                = -0.039 
    C(A_u1, A_w2)                =  0.037 
    C(A_u2, A_w0)                = -0.037 
    C(A_u0, B_w1)                = -0.036 
    C(A_w1, B_i0)                = -0.032 
    C(A_i1, C_i2)                =  0.030 
    C(A_u1, A_w0)                =  0.027 
    C(A_u1, B_w0)                = -0.026 
    C(A_w1, C_i0)                = -0.026 
    C(A_i0, C_w1)                =  0.026 
    C(A_i1, A_u2)                =  0.025 
    C(B_i1, C_i2)                = -0.023 
    C(A_u2, B_u0)                =  0.023 
    C(A_u1, C_i2)                = -0.023 
    C(A_i0, C_u1)                =  0.022 
    C(A_w0, B_w1)                =  0.022 
    C(B_w2, C_u0)                = -0.021 
    C(A_w1, C_u0)                =  0.019 
    C(A_w0, C_i1)                =  0.019 
    C(B_u0, C_w1)                =  0.019 
    C(A_u2, C_i2)                = -0.018 
    C(B_w2, C_w0)                =  0.018 
    C(B_w2, C_i1)                = -0.017 
    C(A_w1, C_w0)                = -0.017 
    C(A_w2, C_i2)                =  0.013 
    C(B_u0, B_w2)                = -0.012 
    C(C_i1, C_i2)                = -0.011 
    C(A_u0, B_w2)                = -0.010 
    C(A_i1, A_w2)                = -0.010 
    C(B_u0, C_i1)                =  0.010 
    C(A_w1, C_i2)                = -0.007 
    C(B_u0, C_u1)                =  0.007 
    C(A_i0, B_w2)                = -0.006 
    C(A_u2, A_w1)                =  0.005 
    C(B_i1, B_w2)                =  0.004 
    C(A_w0, B_w2)                =  0.002 
#+end_example

This has a nebular component that looks like it curves red around the position of the proplyd.  This is only imperfectly fit, resulting in a bit of a spike of residual low-velocity emission, but much less than for slit p84.  It may be that a better fit to the nebular component might eliminate this entirely. 

#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-S_II_6731 --vrange -20 50 --min-fraction 0.05 --ylo -6.0 -3.5 --yhi 4 7 --ncomp 3 --compA 5000.0 -2.0 5.0 --compB 15000 15.0 7.0 --compC 5000 30.0 10.0 --linear-components C
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     6253.442045 +/- 257.987917 (4.13%) initial =  5000.000000
  A_i1:     785.869952 +/- 295.770736 (37.64%) initial =  0.000000
  A_i2:    -738.890944 +/- 238.504034 (32.28%) initial =  0.000000
  A_u0:    -0.940700 +/- 0.102036 (10.85%) initial = -2.000000
  A_u1:    -0.893233 +/- 0.121770 (13.63%) initial =  0.000000
  A_u2:    -0.314219 +/- 0.152020 (48.38%) initial =  0.000000
  A_w0:     3.809729 +/- 0.092035 (2.42%) initial =  5.000000
  A_w1:     0.182704 +/- 0.115141 (63.02%) initial =  0.000000
  A_w2:     0.012614 +/- 0.160860 (1275.27%) initial =  0.000000
  B_i0:     19287.989823 +/- 861.170101 (4.46%) initial =  15000.000000
  B_i1:    -2741.384724 +/- 907.946709 (33.12%) initial =  0.000000
  B_i2:    -2583.296182 +/- 367.629956 (14.23%) initial =  0.000000
  B_u0:     15.139690 +/- 0.033885 (0.22%) initial =  15.000000
  B_u1:    -0.458742 +/- 0.043687 (9.52%) initial =  0.000000
  B_u2:    -0.996305 +/- 0.063111 (6.33%) initial =  0.000000
  B_w0:     4.080372 +/- 0.067957 (1.67%) initial =  7.000000
  B_w1:    -0.152655 +/- 0.074619 (48.88%) initial =  0.000000
  B_w2:    -0.214548 +/- 0.068084 (31.73%) initial =  0.000000
  C_i0:     13235.955374 +/- 1104.419639 (8.34%) initial =  5000.000000
  C_i1:     3083.209396 +/- 1150.213546 (37.31%) initial =  0.000000
  C_i2:    -1248.484944 +/- 501.656114 (40.18%) initial =  0.000000
  C_u0:     22.412509 +/- 0.889502 (3.97%) initial =  30.000000
  C_u1:    -1.951896 +/- 0.975486 (49.98%) initial =  0.000000
  C_u2:    fixed
  C_w0:     9.726313 +/- 0.405515 (4.17%) initial =  10.000000
  C_w1:     1.000000 +/- 0.505104 (50.51%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(B_i0, C_i0)                = -0.989 
    C(B_i0, C_u0)                =  0.989 
    C(C_i0, C_u0)                = -0.986 
    C(B_i1, C_u1)                =  0.981 
    C(B_i1, C_i1)                = -0.976 
    C(C_i1, C_u1)                = -0.969 
    C(B_i0, B_w0)                =  0.958 
    C(B_w0, C_i0)                = -0.945 
    C(C_i0, C_w0)                =  0.938 
    C(C_u0, C_w0)                = -0.935 
    C(B_w0, C_u0)                =  0.929 
    C(B_i1, B_w1)                =  0.921 
    C(B_i0, C_w0)                = -0.914 
    C(C_u1, C_w1)                =  0.909 
    C(B_w1, C_i1)                = -0.906 
    C(C_i1, C_w1)                = -0.902 
    C(A_i0, C_i0)                = -0.901 
    C(A_i0, C_u0)                =  0.883 
    C(B_i1, C_w1)                =  0.878 
    C(A_i0, A_w0)                =  0.877 
    C(B_w1, C_u1)                =  0.869 
    C(A_i0, C_w0)                = -0.869 
    C(A_i0, B_i0)                =  0.856 
    C(A_i0, A_u0)                =  0.835 
    C(B_w0, C_w0)                = -0.833 
    C(A_u0, C_i0)                = -0.833 
    C(A_u0, C_u0)                =  0.824 
    C(A_i1, A_w1)                =  0.823 
    C(A_i0, B_w0)                =  0.816 
    C(A_u0, C_w0)                = -0.812 
    C(A_i1, C_i1)                = -0.801 
    C(A_u0, B_i0)                =  0.798 
    C(B_i2, C_i2)                = -0.792 
    C(A_w0, C_i0)                = -0.754 
    C(A_w0, C_u0)                =  0.743 
    C(A_w0, C_w0)                = -0.742 
    C(A_i1, A_u1)                =  0.739 
    C(A_u0, B_w0)                =  0.738 
    C(B_w1, C_w1)                =  0.736 
    C(A_i1, C_u1)                =  0.734 
    C(A_u0, A_w0)                =  0.724 
    C(A_u1, C_i1)                = -0.722 
    C(B_i2, B_w2)                =  0.711 
    C(B_u0, C_w0)                =  0.711 
    C(A_i1, C_w1)                =  0.707 
    C(A_w0, B_i0)                =  0.707 
    C(A_i1, B_i1)                =  0.702 
    C(A_u1, C_u1)                =  0.687 
    C(A_i0, B_u0)                = -0.679 
    C(A_i1, B_w1)                =  0.677 
    C(A_u1, C_w1)                =  0.668 
    C(A_u1, B_i1)                =  0.652 
    C(A_w0, B_w0)                =  0.640 
    C(A_i2, A_w2)                =  0.639 
    C(A_w1, C_i1)                = -0.616 
    C(B_u0, C_i0)                =  0.610 
    C(B_u0, C_u0)                = -0.608 
    C(A_u1, A_w1)                =  0.604 
    C(A_u0, B_u0)                = -0.588 
    C(A_i1, B_u1)                = -0.586 
    C(A_u1, B_w1)                =  0.580 
    C(A_w1, C_u1)                =  0.575 
    C(A_w1, C_w1)                =  0.569 
    C(B_i0, B_u0)                = -0.561 
    C(A_w0, B_u0)                = -0.534 
    C(B_u0, B_w0)                = -0.532 
    C(A_w1, B_i1)                =  0.528 
    C(B_w2, C_i2)                = -0.508 
    C(B_u1, C_w1)                = -0.502 
    C(A_i0, A_i1)                =  0.489 
    C(B_i0, C_i2)                =  0.472 
    C(C_i0, C_i2)                = -0.459 
    C(A_w1, B_w1)                =  0.454 
    C(C_w0, C_w1)                =  0.448 
    C(A_i0, B_u1)                = -0.444 
    C(A_u1, B_u1)                = -0.443 
    C(C_i2, C_u0)                =  0.443 
    C(B_w0, C_i2)                =  0.441 
    C(B_i0, C_w1)                = -0.437 
    C(A_i2, B_i1)                =  0.435 
    C(A_i2, C_u1)                =  0.433 
    C(B_u1, C_i1)                =  0.430 
    C(C_u0, C_w1)                = -0.423 
    C(A_i2, C_w1)                =  0.422 
    C(A_i1, B_u0)                = -0.410 
    C(B_i1, C_w0)                =  0.409 
    C(B_i0, C_u1)                = -0.408 
    C(C_u1, C_w0)                =  0.407 
    C(C_i2, C_w0)                = -0.406 
    C(A_i2, C_i1)                = -0.401 
    C(C_u0, C_u1)                = -0.399 
    C(B_i0, B_i1)                = -0.397 
    C(A_w1, B_u1)                = -0.394 
    C(B_i1, C_u0)                = -0.391 
    C(B_i2, B_w0)                = -0.390 
    C(B_u1, C_u1)                = -0.390 
    C(B_i0, B_i2)                = -0.382 
    C(A_i2, B_w1)                =  0.380 
    C(A_i1, A_w0)                =  0.378 
    C(B_i2, C_i0)                =  0.372 
    C(C_i0, C_w1)                =  0.370 
    C(A_w0, B_u1)                = -0.358 
    C(A_i1, A_u0)                =  0.357 
    C(B_u1, B_w1)                = -0.347 
    C(B_i2, C_u0)                = -0.346 
    C(A_u0, B_u1)                = -0.346 
    C(B_u0, B_u1)                =  0.342 
    C(B_u2, C_w0)                = -0.341 
    C(B_i1, B_u1)                = -0.339 
    C(B_u2, C_u0)                =  0.337 
    C(A_i0, C_i2)                =  0.334 
    C(C_i0, C_u1)                =  0.334 
    C(A_i0, A_w1)                =  0.331 
    C(A_u0, C_i2)                =  0.327 
    C(A_i2, C_w0)                =  0.327 
    C(A_i2, C_u0)                = -0.326 
    C(B_i1, C_i0)                =  0.326 
    C(A_i2, B_i0)                = -0.326 
    C(B_i0, B_u2)                =  0.324 
    C(C_i2, C_u1)                = -0.321 
    C(C_i2, C_w1)                = -0.317 
    C(B_u1, B_w0)                = -0.316 
    C(B_u1, C_i0)                =  0.312 
    C(B_u2, C_i0)                = -0.311 
    C(B_w0, C_w1)                = -0.310 
    C(B_i1, B_u2)                = -0.307 
    C(A_i0, B_i2)                = -0.304 
    C(A_i2, C_i0)                =  0.303 
    C(B_u2, C_u1)                = -0.297 
    C(B_i2, C_w0)                =  0.296 
    C(B_u2, C_w1)                = -0.296 
    C(A_w1, B_u0)                = -0.286 
    C(C_i1, C_w0)                = -0.284 
    C(B_u1, C_u0)                = -0.284 
    C(A_i1, B_w0)                =  0.283 
    C(A_i0, A_u1)                =  0.283 
    C(B_u2, C_i1)                =  0.280 
    C(A_w0, C_i2)                =  0.279 
    C(A_u0, B_i2)                = -0.278 
    C(B_u2, B_w0)                =  0.277 
    C(B_w0, C_u1)                = -0.277 
    C(B_i0, C_i1)                =  0.268 
    C(B_i1, C_i2)                = -0.268 
    C(A_w2, B_w2)                = -0.266 
    C(B_i1, B_w0)                = -0.266 
    C(A_i1, C_i0)                = -0.265 
    C(B_i0, B_u1)                = -0.264 
    C(B_u0, B_u2)                = -0.262 
    C(C_i1, C_u0)                =  0.259 
    C(A_i2, B_w0)                = -0.259 
    C(A_u1, B_u0)                = -0.247 
    C(A_u0, B_u2)                =  0.242 
    C(A_w0, B_i2)                = -0.241 
    C(A_i0, B_u2)                =  0.239 
    C(A_u0, A_w1)                =  0.233 
    C(B_u1, C_w0)                =  0.231 
    C(B_u2, B_w1)                = -0.230 
    C(A_i0, A_i2)                = -0.228 
    C(A_i2, A_u1)                =  0.227 
    C(A_i2, C_i2)                = -0.218 
    C(A_w0, A_w1)                =  0.212 
    C(A_w2, B_w1)                =  0.212 
    C(A_w2, B_i1)                =  0.211 
    C(A_u1, A_w0)                =  0.209 
    C(A_i2, A_w0)                = -0.207 
    C(C_i1, C_i2)                =  0.206 
    C(A_u2, B_i1)                =  0.206 
    C(A_i2, A_u0)                = -0.206 
    C(A_i1, C_u0)                =  0.206 
    C(B_w1, C_w0)                =  0.204 
    C(A_w0, B_u2)                =  0.203 
    C(A_u2, B_w1)                =  0.199 
    C(A_u2, C_u1)                =  0.199 
    C(A_w2, C_u1)                =  0.198 
    C(A_w1, B_w0)                =  0.192 
    C(C_i0, C_i1)                = -0.192 
    C(A_w2, C_i1)                = -0.190 
    C(A_i1, B_i0)                =  0.189 
    C(A_w2, C_w1)                =  0.188 
    C(B_i0, B_w1)                = -0.188 
    C(A_u2, C_i1)                = -0.187 
    C(A_u0, C_w1)                = -0.186 
    C(B_u1, B_u2)                = -0.186 
    C(A_u2, C_w1)                =  0.185 
    C(B_w1, C_u0)                = -0.182 
    C(A_i2, A_u2)                =  0.175 
    C(A_u2, B_w2)                = -0.174 
    C(A_i1, C_w0)                = -0.169 
    C(A_w1, C_i0)                = -0.168 
    C(A_w1, A_w2)                = -0.163 
    C(A_u1, B_u2)                = -0.155 
    C(B_u0, C_i2)                = -0.154 
    C(B_u0, B_w1)                = -0.151 
    C(A_w2, B_i2)                = -0.148 
    C(A_i2, B_w2)                = -0.148 
    C(B_i2, B_u0)                =  0.147 
    C(B_w1, C_i2)                = -0.146 
    C(A_u2, A_w2)                =  0.146 
    C(A_u0, A_u1)                =  0.143 
    C(A_i2, B_u1)                = -0.140 
    C(B_w0, C_i1)                =  0.139 
    C(A_u2, C_u0)                = -0.137 
    C(A_u2, B_i0)                = -0.136 
    C(A_u0, C_u1)                = -0.135 
    C(A_u2, C_w0)                =  0.135 
    C(A_w1, B_w2)                =  0.135 
    C(A_u0, A_u2)                = -0.132 
    C(A_i0, B_w1)                =  0.131 
    C(A_u0, B_i1)                = -0.130 
    C(A_w2, C_u0)                = -0.129 
    C(A_w2, C_w0)                =  0.128 
    C(A_w2, B_i0)                = -0.127 
    C(A_w1, B_u2)                = -0.126 
    C(B_u2, C_i2)                = -0.126 
    C(A_u2, C_i0)                =  0.126 
    C(B_u0, C_i1)                =  0.124 
    C(A_w1, C_u0)                =  0.123 
    C(A_u1, B_w2)                =  0.121 
    C(A_u1, B_w0)                =  0.120 
    C(A_i1, A_i2)                =  0.119 
    C(B_w1, C_i0)                =  0.118 
    C(A_w2, C_i0)                =  0.116 
    C(A_u1, A_u2)                = -0.115 
    C(A_w0, A_w2)                = -0.114 
    C(A_w1, B_i0)                =  0.113 
    C(B_w2, C_u1)                =  0.113 
    C(A_u1, C_i2)                = -0.111 
    C(A_w2, B_u2)                =  0.110 
    C(A_i1, B_u2)                = -0.110 
    C(B_w0, B_w2)                = -0.108 
    C(A_w0, C_w1)                = -0.107 
    C(A_i1, B_w2)                =  0.106 
    C(A_u2, B_w0)                = -0.105 
    C(B_i2, C_w1)                =  0.104 
    C(B_w2, C_w1)                =  0.103 
    C(B_i2, C_u1)                =  0.103 
    C(B_i2, B_u2)                =  0.099 
    C(A_w2, B_u1)                = -0.099 
    C(A_w0, B_w1)                =  0.099 
    C(A_i1, A_u2)                =  0.098 
    C(A_i0, C_w1)                = -0.096 
    C(A_i2, B_u0)                =  0.094 
    C(A_w2, B_w0)                = -0.093 
    C(A_u1, A_w2)                =  0.091 
    C(A_i0, C_i1)                = -0.091 
    C(A_w1, C_w0)                = -0.088 
    C(B_i0, B_w2)                = -0.088 
    C(A_i1, B_i2)                = -0.086 
    C(A_i0, A_w2)                = -0.085 
    C(A_u2, C_i2)                = -0.084 
    C(A_u1, C_i0)                = -0.084 
    C(B_i2, B_w1)                = -0.080 
    C(B_i2, B_u1)                =  0.077 
    C(A_u2, B_u1)                = -0.076 
    C(A_u0, A_w2)                = -0.075 
    C(B_w2, C_i1)                = -0.074 
    C(B_w2, C_i0)                =  0.073 
    C(A_i0, A_u2)                = -0.071 
    C(A_w1, C_i2)                = -0.068 
    C(A_u2, B_i2)                = -0.067 
    C(B_w0, B_w1)                = -0.067 
    C(B_u2, B_w2)                =  0.066 
    C(A_u2, A_w0)                = -0.064 
    C(B_i1, B_w2)                =  0.062 
    C(B_w2, C_u0)                = -0.062 
    C(B_u1, B_w2)                = -0.060 
    C(A_w0, C_u1)                = -0.060 
    C(A_u2, A_w1)                =  0.058 
    C(A_w0, B_i1)                = -0.057 
    C(B_w2, C_w0)                =  0.057 
    C(A_i1, C_i2)                = -0.054 
    C(A_w0, C_i1)                = -0.054 
    C(A_w2, C_i2)                = -0.049 
    C(A_u2, B_u2)                =  0.049 
    C(A_i2, A_w1)                =  0.048 
    C(B_w1, B_w2)                = -0.047 
    C(A_i0, B_i1)                = -0.047 
    C(A_i0, C_u1)                = -0.046 
    C(A_u0, B_w1)                =  0.045 
    C(B_u1, C_i2)                =  0.040 
    C(B_u0, C_u1)                = -0.038 
    C(A_i1, A_w2)                =  0.035 
    C(B_i1, B_i2)                =  0.034 
    C(A_u1, C_u0)                =  0.033 
    C(B_u0, C_w1)                =  0.032 
    C(A_u2, B_u0)                =  0.029 
    C(B_i1, B_u0)                = -0.024 
    C(A_u1, B_i0)                =  0.024 
    C(B_u0, B_w2)                = -0.021 
    C(A_w2, B_u0)                =  0.020 
    C(A_i2, B_u2)                = -0.020 
    C(A_u0, B_w2)                = -0.019 
    C(A_w1, B_i2)                = -0.017 
    C(A_u1, B_i2)                = -0.014 
    C(A_u0, C_i1)                =  0.012 
    C(A_i0, B_w2)                = -0.012 
    C(A_u1, C_w0)                =  0.006 
    C(A_i2, B_i2)                = -0.005 
    C(B_i2, C_i1)                = -0.001 
    C(A_w0, B_w2)                =  0.000 
#+end_example

*** [N II] lines
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-N_II_5755 --vrange -20 50 --min-fraction 0.05 --ylo -6.5 -4 --yhi 4 7 --ncomp 3 --compA 500.0 -2.0 5.0 --compB 1500 15.0 7.0 --compC 500 30.0 10.0 --linear-components ABC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     328.991046 +/- 22.556989 (6.86%) initial =  500.000000
  A_i1:     25.001299 +/- 29.829737 (119.31%) initial =  0.000000
  A_i2:    -88.733153 +/- 21.015146 (23.68%) initial =  0.000000
  A_u0:    -1.145092 +/- 0.215422 (18.81%) initial = -2.000000
  A_u1:    -0.502501 +/- 0.296921 (59.09%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.148663 +/- 0.200939 (4.84%) initial =  5.000000
  A_w1:     0.349233 +/- 0.272348 (77.98%) initial =  0.000000
  A_w2:    fixed
  B_i0:     1118.411463 +/- 113.974689 (10.19%) initial =  1500.000000
  B_i1:    -97.901885 +/- 78.186702 (79.86%) initial =  0.000000
  B_i2:    -229.970083 +/- 62.015782 (26.97%) initial =  0.000000
  B_u0:     13.332561 +/- 0.086352 (0.65%) initial =  15.000000
  B_u1:    -1.703567 +/- 0.124855 (7.33%) initial =  0.000000
  B_u2:    fixed
  B_w0:     4.848206 +/- 0.167786 (3.46%) initial =  7.000000
  B_w1:    -0.198688 +/- 0.153470 (77.24%) initial =  0.000000
  B_w2:    fixed
  C_i0:     719.235588 +/- 131.529312 (18.29%) initial =  500.000000
  C_i1:     396.110513 +/- 97.577218 (24.63%) initial =  0.000000
  C_i2:    -382.132784 +/- 70.542311 (18.46%) initial =  0.000000
  C_u0:     23.986588 +/- 1.811749 (7.55%) initial =  30.000000
  C_u1:    -4.423890 +/- 1.063313 (24.04%) initial =  0.000000
  C_u2:    fixed
  C_w0:     9.170335 +/- 0.994028 (10.84%) initial =  10.000000
  C_w1:     0.822946 +/- 0.642478 (78.07%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(B_i0, C_i0)                = -0.986 
    C(B_i0, C_u0)                =  0.978 
    C(C_i0, C_u0)                = -0.977 
    C(B_i1, C_i1)                = -0.956 
    C(C_i0, C_w0)                =  0.947 
    C(C_u0, C_w0)                = -0.938 
    C(B_i0, C_w0)                = -0.920 
    C(B_i0, B_w0)                =  0.907 
    C(B_i2, C_u0)                = -0.885 
    C(B_i2, C_i2)                = -0.885 
    C(B_i0, B_i2)                = -0.873 
    C(B_i2, C_i0)                =  0.860 
    C(B_i2, C_w0)                =  0.855 
    C(B_w0, C_i0)                = -0.852 
    C(B_w0, C_u0)                =  0.839 
    C(C_i0, C_i1)                =  0.827 
    C(C_i2, C_w0)                = -0.805 
    C(B_i0, C_i1)                = -0.804 
    C(B_i1, B_w1)                =  0.799 
    C(C_i2, C_u0)                =  0.796 
    C(C_i0, C_i2)                = -0.779 
    C(B_i0, C_i2)                =  0.769 
    C(B_i1, C_i0)                = -0.765 
    C(B_i0, B_i1)                =  0.757 
    C(B_i2, B_w0)                = -0.755 
    C(C_i1, C_u0)                = -0.753 
    C(B_i1, C_u1)                =  0.745 
    C(B_w0, C_w0)                = -0.737 
    C(A_i0, A_i1)                =  0.727 
    C(C_i1, C_u1)                = -0.717 
    C(C_i1, C_w0)                =  0.707 
    C(A_i1, C_i0)                = -0.706 
    C(A_i1, C_i1)                = -0.686 
    C(B_i1, C_u0)                =  0.682 
    C(A_i1, C_u0)                =  0.681 
    C(A_i1, A_w1)                =  0.678 
    C(B_w0, C_i1)                = -0.677 
    C(A_i0, C_w0)                = -0.675 
    C(B_i1, B_w0)                =  0.671 
    C(A_i1, C_w0)                = -0.671 
    C(A_i0, C_i1)                = -0.667 
    C(A_i0, C_i0)                = -0.666 
    C(B_w1, C_i1)                = -0.653 
    C(A_i1, B_i0)                =  0.651 
    C(B_w0, C_i2)                =  0.646 
    C(A_i0, A_w0)                =  0.645 
    C(A_i0, C_u0)                =  0.641 
    C(B_i1, C_w0)                = -0.632 
    C(A_i1, A_u1)                =  0.628 
    C(C_u1, C_w1)                = -0.623 
    C(A_i0, A_u0)                =  0.593 
    C(A_i0, B_i0)                =  0.578 
    C(A_u1, A_w1)                =  0.575 
    C(A_u0, A_w0)                =  0.568 
    C(B_i2, C_i1)                =  0.559 
    C(A_i0, B_i1)                =  0.550 
    C(A_i1, B_i2)                = -0.541 
    C(B_u1, C_u0)                = -0.535 
    C(B_i0, B_u1)                = -0.522 
    C(A_i1, B_i1)                =  0.516 
    C(B_u1, C_w0)                =  0.513 
    C(B_i2, B_u1)                =  0.512 
    C(B_i0, B_w1)                =  0.511 
    C(B_w0, B_w1)                =  0.504 
    C(B_u1, C_i0)                =  0.501 
    C(B_i1, B_i2)                = -0.501 
    C(B_w1, C_u1)                =  0.500 
    C(B_u1, B_w0)                = -0.499 
    C(A_i0, B_i2)                = -0.494 
    C(B_w1, C_i0)                = -0.491 
    C(A_i0, A_u1)                =  0.479 
    C(A_i1, C_i2)                =  0.463 
    C(B_u1, C_i2)                = -0.462 
    C(A_i1, B_w0)                =  0.462 
    C(C_i2, C_w1)                =  0.453 
    C(A_i0, C_i2)                =  0.449 
    C(A_i1, A_u0)                =  0.436 
    C(C_i1, C_i2)                = -0.435 
    C(B_w1, C_u0)                =  0.423 
    C(A_u0, A_u1)                =  0.422 
    C(A_i0, B_u0)                =  0.408 
    C(A_i0, C_u1)                =  0.403 
    C(A_i1, C_u1)                =  0.401 
    C(B_w1, C_w0)                = -0.399 
    C(A_w0, B_u0)                =  0.392 
    C(B_u0, C_u0)                =  0.390 
    C(A_u0, B_u0)                =  0.380 
    C(B_i1, C_i2)                =  0.368 
    C(B_i2, B_u0)                = -0.366 
    C(B_u0, C_i2)                =  0.364 
    C(A_i0, A_w1)                =  0.361 
    C(B_i2, C_w1)                = -0.353 
    C(B_u0, C_i0)                = -0.353 
    C(A_u0, A_w1)                =  0.343 
    C(A_u1, A_w0)                =  0.334 
    C(A_w1, B_w1)                = -0.331 
    C(B_i0, B_u0)                =  0.325 
    C(A_u1, B_w1)                = -0.315 
    C(B_i2, B_w1)                = -0.312 
    C(A_i1, A_w0)                =  0.309 
    C(C_i1, C_w1)                =  0.309 
    C(C_w0, C_w1)                = -0.305 
    C(A_i1, B_u0)                =  0.301 
    C(A_u1, C_i0)                = -0.293 
    C(B_i1, B_u1)                = -0.292 
    C(A_u1, C_w0)                = -0.290 
    C(B_u0, C_w0)                = -0.290 
    C(C_i0, C_u1)                = -0.290 
    C(A_u1, C_u0)                =  0.289 
    C(A_i0, B_w0)                =  0.288 
    C(A_w0, A_w1)                =  0.283 
    C(B_u0, C_w1)                =  0.282 
    C(A_w1, B_u1)                =  0.281 
    C(A_u1, C_i1)                = -0.276 
    C(A_u1, B_u0)                =  0.274 
    C(B_u1, C_i1)                =  0.272 
    C(B_u1, B_w1)                = -0.267 
    C(B_i1, C_w1)                = -0.265 
    C(B_i0, C_u1)                =  0.249 
    C(A_w0, B_w0)                = -0.247 
    C(A_u0, C_w0)                = -0.245 
    C(A_u0, C_i1)                = -0.243 
    C(A_w1, B_u0)                =  0.237 
    C(A_u1, B_i0)                =  0.235 
    C(B_w1, C_i2)                =  0.230 
    C(A_i0, B_w1)                =  0.226 
    C(B_u0, B_w0)                =  0.222 
    C(A_i0, A_i2)                = -0.218 
    C(A_u1, B_i2)                = -0.217 
    C(A_u0, C_u1)                =  0.216 
    C(C_u0, C_w1)                =  0.212 
    C(A_i2, C_w1)                = -0.198 
    C(A_u1, B_u1)                =  0.197 
    C(A_u0, C_i0)                = -0.196 
    C(B_u0, C_u1)                = -0.193 
    C(A_u1, C_i2)                =  0.192 
    C(A_w1, C_i0)                = -0.192 
    C(A_i1, C_w1)                = -0.191 
    C(A_w1, C_u0)                =  0.190 
    C(A_w1, C_w0)                = -0.188 
    C(A_u0, C_u0)                =  0.187 
    C(A_u0, B_w0)                = -0.183 
    C(A_u1, C_u1)                =  0.181 
    C(A_i0, B_u1)                = -0.181 
    C(B_w0, C_u1)                =  0.176 
    C(B_i0, C_w1)                =  0.175 
    C(A_w1, C_i1)                = -0.175 
    C(A_u1, C_w1)                = -0.171 
    C(B_w0, C_w1)                =  0.167 
    C(C_u1, C_w0)                = -0.165 
    C(A_i2, C_u1)                =  0.159 
    C(A_w0, B_u1)                =  0.158 
    C(A_w0, C_u1)                =  0.152 
    C(C_u0, C_u1)                =  0.152 
    C(A_w1, B_i0)                =  0.145 
    C(C_i0, C_w1)                = -0.144 
    C(A_w1, B_i2)                = -0.143 
    C(A_i2, C_i2)                = -0.141 
    C(A_w1, C_w1)                = -0.136 
    C(A_w0, C_i1)                = -0.134 
    C(A_u0, B_i1)                =  0.133 
    C(A_u0, C_w1)                = -0.132 
    C(C_i2, C_u1)                = -0.132 
    C(A_i2, B_u0)                = -0.131 
    C(B_u0, C_i1)                = -0.127 
    C(A_w1, C_i2)                =  0.127 
    C(A_w0, C_w0)                = -0.127 
    C(A_i0, C_w1)                = -0.122 
    C(A_i2, A_w0)                = -0.120 
    C(A_u0, B_u1)                =  0.117 
    C(A_u0, C_i2)                =  0.117 
    C(A_w1, C_u1)                =  0.116 
    C(A_i2, C_w0)                =  0.110 
    C(A_w0, C_w1)                = -0.108 
    C(A_u0, B_i2)                = -0.106 
    C(B_u1, C_u1)                =  0.103 
    C(B_u1, C_w1)                = -0.102 
    C(A_i1, B_u1)                = -0.098 
    C(A_u0, B_i0)                =  0.095 
    C(A_u1, B_i1)                =  0.090 
    C(A_w0, B_w1)                = -0.085 
    C(A_u1, B_w0)                =  0.084 
    C(A_u0, B_w1)                = -0.082 
    C(A_w0, C_i0)                = -0.081 
    C(A_i2, C_u0)                = -0.080 
    C(A_i2, B_i2)                =  0.079 
    C(A_i2, A_u0)                = -0.077 
    C(A_i2, B_i1)                =  0.076 
    C(A_w0, C_u0)                =  0.075 
    C(A_i1, A_i2)                = -0.066 
    C(B_i1, B_u0)                =  0.062 
    C(A_i2, C_i1)                = -0.059 
    C(A_i2, C_i0)                =  0.057 
    C(A_i2, B_w1)                =  0.055 
    C(A_i1, B_w1)                =  0.053 
    C(A_i2, B_u1)                =  0.048 
    C(A_w0, B_i1)                =  0.047 
    C(A_w1, B_w0)                =  0.044 
    C(A_i2, B_i0)                = -0.043 
    C(B_u0, B_w1)                = -0.043 
    C(A_w0, C_i2)                =  0.037 
    C(B_i2, C_u1)                =  0.035 
    C(B_w1, C_w1)                = -0.033 
    C(A_i2, A_u1)                = -0.028 
    C(A_i2, A_w1)                = -0.027 
    C(B_u0, B_u1)                = -0.022 
    C(A_w0, B_i0)                = -0.016 
    C(A_w0, B_i2)                = -0.012 
    C(A_i2, B_w0)                =  0.007 
    C(A_w1, B_i1)                = -0.002 
#+end_example

#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-N_II_6548 --vrange -20 50 --min-fraction 0.05 --ylo -6.5 -4 --yhi 4 7 --ncomp 3 --compA 7500.0 -1.0 3.5 --compB 25000.0 14.0 4.5 --compC 25000.0 20.0 10.0 --linear-components ABC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     12297.338982 +/- 452.911408 (3.68%) initial =  7500.000000
  A_i1:     504.658430 +/- 508.453550 (100.75%) initial =  0.000000
  A_i2:    -2203.224556 +/- 363.728987 (16.51%) initial =  0.000000
  A_u0:    -0.229093 +/- 0.100811 (44.00%) initial = -1.000000
  A_u1:    -0.736744 +/- 0.132813 (18.03%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.372118 +/- 0.096158 (2.20%) initial =  3.500000
  A_w1:     0.200659 +/- 0.127957 (63.77%) initial =  0.000000
  A_w2:    fixed
  B_i0:     33826.670558 +/- 1650.847389 (4.88%) initial =  25000.000000
  B_i1:    -2556.641448 +/- 1120.941875 (43.84%) initial =  0.000000
  B_i2:    -3359.172701 +/- 775.976513 (23.10%) initial =  0.000000
  B_u0:     13.997466 +/- 0.039980 (0.29%) initial =  14.000000
  B_u1:    -1.484120 +/- 0.055407 (3.73%) initial =  0.000000
  B_u2:    fixed
  B_w0:     4.676665 +/- 0.081981 (1.75%) initial =  4.500000
  B_w1:     0.119334 +/- 0.076565 (64.16%) initial =  0.000000
  B_w2:    fixed
  C_i0:     18889.973409 +/- 2061.829771 (10.91%) initial =  25000.000000
  C_i1:     7041.080899 +/- 1457.258892 (20.70%) initial =  0.000000
  C_i2:    -8620.841174 +/- 1032.651112 (11.98%) initial =  0.000000
  C_u0:     24.767789 +/- 1.242754 (5.02%) initial =  20.000000
  C_u1:    -2.963780 +/- 0.846111 (28.55%) initial =  0.000000
  C_u2:    fixed
  C_w0:     10.277547 +/- 0.700535 (6.82%) initial =  10.000000
  C_w1:     1.000000 +/- 0.030316 (3.03%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(B_i0, C_i0)                = -0.982 
    C(C_i0, C_u0)                = -0.981 
    C(B_i0, C_u0)                =  0.979 
    C(C_i0, C_w0)                =  0.957 
    C(C_u0, C_w0)                = -0.947 
    C(B_i1, C_i1)                = -0.935 
    C(B_i0, C_w0)                = -0.924 
    C(B_i0, B_w0)                =  0.909 
    C(B_i1, C_u1)                =  0.884 
    C(C_i1, C_u1)                = -0.862 
    C(B_i2, C_i2)                = -0.852 
    C(B_w0, C_i0)                = -0.844 
    C(B_i0, B_i2)                = -0.839 
    C(B_i2, C_u0)                = -0.838 
    C(B_w0, C_u0)                =  0.835 
    C(B_i2, C_i0)                =  0.829 
    C(B_i1, B_w1)                =  0.826 
    C(B_i2, C_w0)                =  0.810 
    C(A_i0, C_w0)                = -0.795 
    C(A_i0, C_i0)                = -0.782 
    C(C_i2, C_w0)                = -0.775 
    C(C_i0, C_i2)                = -0.774 
    C(C_u1, C_w1)                =  0.773 
    C(C_i2, C_u0)                =  0.769 
    C(A_i0, C_u0)                =  0.767 
    C(B_i0, C_i2)                =  0.756 
    C(B_w0, C_w0)                = -0.742 
    C(A_i0, A_i1)                =  0.726 
    C(B_i2, B_w0)                = -0.707 
    C(A_i1, A_w1)                =  0.693 
    C(A_i0, B_i0)                =  0.691 
    C(C_i1, C_w1)                = -0.675 
    C(A_i1, C_i1)                = -0.664 
    C(A_i1, C_i0)                = -0.656 
    C(B_w1, C_i1)                = -0.654 
    C(A_i0, A_w0)                =  0.646 
    C(A_i1, C_u0)                =  0.629 
    C(C_i0, C_i1)                =  0.628 
    C(B_w0, C_i2)                =  0.621 
    C(A_i0, C_i1)                = -0.618 
    C(A_i1, C_w0)                = -0.616 
    C(B_i1, C_w1)                =  0.616 
    C(A_u0, A_w0)                =  0.610 
    C(A_i0, B_i2)                = -0.599 
    C(A_u1, A_w1)                =  0.596 
    C(B_i0, C_i1)                = -0.593 
    C(B_w1, C_u1)                =  0.593 
    C(A_i1, B_i0)                =  0.592 
    C(A_i0, A_u0)                =  0.565 
    C(A_i0, C_i2)                =  0.564 
    C(C_i1, C_u0)                = -0.559 
    C(A_i1, A_u1)                =  0.542 
    C(C_i1, C_w0)                =  0.513 
    C(B_w0, C_i1)                = -0.513 
    C(A_w0, B_u0)                =  0.510 
    C(B_i1, C_i0)                = -0.507 
    C(A_u0, B_u0)                =  0.501 
    C(B_i0, B_i1)                =  0.493 
    C(A_i1, C_u1)                =  0.492 
    C(B_i1, B_w0)                =  0.471 
    C(A_i1, B_i2)                = -0.468 
    C(A_u1, B_u1)                =  0.460 
    C(A_i0, B_i1)                =  0.456 
    C(A_w1, B_u1)                =  0.441 
    C(A_i1, B_i1)                =  0.434 
    C(A_u1, B_w1)                = -0.432 
    C(B_i1, C_u0)                =  0.432 
    C(B_w0, B_w1)                =  0.430 
    C(A_i1, C_w1)                =  0.427 
    C(A_i0, B_w0)                =  0.420 
    C(A_i1, B_w0)                =  0.418 
    C(A_i0, A_i2)                = -0.408 
    C(A_i1, A_u0)                =  0.401 
    C(A_i1, C_i2)                =  0.400 
    C(A_i2, C_w0)                =  0.395 
    C(B_i1, C_w0)                = -0.382 
    C(A_i2, C_u0)                = -0.377 
    C(B_i0, B_w1)                =  0.375 
    C(B_u1, B_w0)                = -0.375 
    C(A_i0, C_u1)                =  0.365 
    C(A_i2, C_i0)                =  0.364 
    C(B_i2, C_i1)                =  0.363 
    C(A_i2, C_i2)                = -0.361 
    C(B_w1, C_i0)                = -0.355 
    C(A_w1, B_w1)                = -0.349 
    C(A_i2, B_i0)                = -0.349 
    C(A_i1, A_w0)                =  0.349 
    C(B_i0, B_u1)                = -0.346 
    C(A_u0, A_u1)                =  0.334 
    C(B_u1, C_u0)                = -0.323 
    C(A_i0, A_w1)                =  0.321 
    C(A_i0, B_u0)                =  0.316 
    C(A_i2, B_i2)                =  0.313 
    C(B_u1, C_i0)                =  0.310 
    C(A_i0, A_u1)                =  0.306 
    C(B_u1, C_w0)                =  0.305 
    C(A_u0, A_w1)                =  0.298 
    C(B_w1, C_u0)                =  0.297 
    C(B_w1, C_w1)                =  0.292 
    C(A_u0, C_w0)                = -0.291 
    C(B_u0, B_u1)                =  0.288 
    C(B_i2, B_u1)                =  0.287 
    C(A_u1, A_w0)                =  0.287 
    C(B_u1, B_w1)                = -0.280 
    C(A_u1, B_u0)                =  0.274 
    C(A_i2, B_w0)                = -0.264 
    C(C_i1, C_i2)                = -0.263 
    C(B_i1, B_i2)                = -0.259 
    C(B_w1, C_w0)                = -0.259 
    C(C_i0, C_u1)                = -0.259 
    C(C_i2, C_w1)                = -0.256 
    C(B_u1, C_i2)                = -0.255 
    C(A_w0, C_w0)                = -0.246 
    C(A_w0, A_w1)                =  0.234 
    C(A_w1, B_u0)                =  0.233 
    C(A_u0, C_u0)                =  0.232 
    C(A_u0, C_i0)                = -0.230 
    C(B_u0, B_w1)                = -0.228 
    C(A_u1, C_w1)                =  0.226 
    C(A_i1, A_i2)                = -0.225 
    C(B_i0, C_u1)                =  0.216 
    C(A_i0, B_w1)                =  0.210 
    C(A_w0, C_i0)                = -0.200 
    C(A_w0, C_i1)                = -0.199 
    C(A_u0, B_u1)                =  0.198 
    C(A_w0, C_u0)                =  0.196 
    C(A_w1, C_i0)                = -0.196 
    C(A_w1, C_u0)                =  0.193 
    C(A_w1, C_w0)                = -0.192 
    C(A_i0, C_w1)                =  0.191 
    C(A_u0, C_i2)                =  0.184 
    C(A_w1, C_w1)                =  0.184 
    C(A_u0, C_i1)                = -0.184 
    C(B_w0, C_u1)                =  0.183 
    C(B_i2, B_w1)                = -0.180 
    C(A_i2, C_w1)                =  0.179 
    C(A_w1, C_i1)                = -0.175 
    C(A_u0, B_w0)                = -0.171 
    C(A_i1, B_u0)                =  0.169 
    C(B_i1, B_u0)                = -0.169 
    C(A_w0, B_u1)                =  0.168 
    C(B_i1, B_u1)                = -0.166 
    C(C_u0, C_u1)                =  0.165 
    C(A_u0, B_i2)                = -0.165 
    C(B_i2, C_w1)                =  0.164 
    C(A_w0, B_w0)                = -0.158 
    C(B_u0, C_u1)                = -0.155 
    C(B_i1, C_i2)                =  0.151 
    C(A_w0, C_u1)                =  0.151 
    C(C_u1, C_w0)                = -0.151 
    C(A_i2, A_w0)                = -0.148 
    C(A_w1, B_i0)                =  0.148 
    C(A_w1, B_i2)                = -0.147 
    C(A_w0, C_i2)                =  0.145 
    C(A_i2, A_u0)                = -0.145 
    C(A_i1, B_u1)                =  0.141 
    C(B_u0, C_w1)                = -0.140 
    C(A_u1, C_i1)                = -0.140 
    C(A_u1, C_u1)                =  0.137 
    C(A_w1, C_u1)                =  0.131 
    C(A_w1, C_i2)                =  0.128 
    C(A_w0, B_i2)                = -0.128 
    C(A_u0, C_u1)                =  0.122 
    C(A_u0, B_w1)                = -0.121 
    C(A_i2, B_u1)                =  0.118 
    C(B_u0, C_u0)                =  0.117 
    C(A_u1, C_w0)                = -0.114 
    C(A_u1, C_i0)                = -0.113 
    C(A_u0, B_i0)                =  0.112 
    C(A_u1, C_u0)                =  0.111 
    C(B_w1, C_i2)                =  0.110 
    C(A_w0, C_w1)                =  0.108 
    C(B_u0, C_i2)                =  0.105 
    C(C_w0, C_w1)                =  0.105 
    C(A_i2, B_u0)                = -0.099 
    C(B_u1, C_i1)                =  0.096 
    C(B_i2, B_u0)                = -0.096 
    C(B_u0, C_i0)                = -0.094 
    C(A_w0, B_i1)                =  0.092 
    C(B_u0, B_w0)                = -0.087 
    C(A_i2, C_u1)                =  0.087 
    C(A_u1, B_i1)                = -0.086 
    C(A_i0, B_u1)                = -0.085 
    C(A_w0, B_i0)                =  0.085 
    C(C_i2, C_u1)                = -0.082 
    C(B_u0, C_i1)                =  0.082 
    C(A_i2, C_i1)                =  0.081 
    C(A_u0, C_w1)                =  0.078 
    C(A_u1, B_w0)                = -0.071 
    C(A_u1, B_i2)                = -0.071 
    C(A_i2, A_w1)                = -0.065 
    C(A_u1, C_i2)                =  0.059 
    C(A_u1, B_i0)                =  0.053 
    C(B_u1, C_u1)                =  0.052 
    C(A_w1, B_i1)                = -0.052 
    C(A_u0, B_i1)                =  0.052 
    C(A_w1, B_w0)                =  0.048 
    C(A_w0, B_w1)                = -0.045 
    C(C_u0, C_w1)                = -0.044 
    C(B_u0, C_w0)                = -0.040 
    C(B_i0, B_u0)                =  0.040 
    C(A_i2, A_u1)                = -0.032 
    C(A_i1, B_w1)                =  0.030 
    C(B_w0, C_w1)                = -0.029 
    C(B_u1, C_w1)                = -0.027 
    C(A_i2, B_i1)                = -0.025 
    C(B_i0, C_w1)                = -0.024 
    C(A_i2, B_w1)                = -0.021 
    C(C_i0, C_w1)                = -0.016 
    C(B_i2, C_u1)                = -0.004 
#+end_example

#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-N_II_6583 --vrange -20 50 --min-fraction 0.05 --ylo -6.5 -4 --yhi 4 7 --ncomp 3 --compA 30000.0 -1.0 3.5 --compB 100000.0 14.0 4.5 --compC 100000.0 20.0 10.0 --linear-components ABC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     52498.169046 +/- 1628.088078 (3.10%) initial =  30000.000000
  A_i1:     2371.461558 +/- 1836.726335 (77.45%) initial =  0.000000
  A_i2:    -9595.964504 +/- 1445.985108 (15.07%) initial =  0.000000
  A_u0:    -1.666659 +/- 0.082336 (4.94%) initial = -1.000000
  A_u1:    -0.714577 +/- 0.108811 (15.23%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.160235 +/- 0.081457 (1.96%) initial =  3.500000
  A_w1:     0.132013 +/- 0.108534 (82.21%) initial =  0.000000
  A_w2:    fixed
  B_i0:     150607.832830 +/- 6529.327456 (4.34%) initial =  100000.000000
  B_i1:    -8968.043680 +/- 4628.366124 (51.61%) initial =  0.000000
  B_i2:    -11940.310051 +/- 3054.597481 (25.58%) initial =  0.000000
  B_u0:     12.632915 +/- 0.034703 (0.27%) initial =  14.000000
  B_u1:    -1.412940 +/- 0.047975 (3.40%) initial =  0.000000
  B_u2:    fixed
  B_w0:     4.668414 +/- 0.073094 (1.57%) initial =  4.500000
  B_w1:     0.158109 +/- 0.069116 (43.71%) initial =  0.000000
  B_w2:    fixed
  C_i0:     79676.532017 +/- 8016.694891 (10.06%) initial =  100000.000000
  C_i1:     29158.644987 +/- 5870.548197 (20.13%) initial =  0.000000
  C_i2:    -36467.357481 +/- 4063.284118 (11.14%) initial =  0.000000
  C_u0:     23.581642 +/- 1.144361 (4.85%) initial =  20.000000
  C_u1:    -2.821500 +/- 0.818083 (28.99%) initial =  0.000000
  C_u2:    fixed
  C_w0:     10.220567 +/- 0.648351 (6.34%) initial =  10.000000
  C_w1:     0.999999 +/- 1.301340 (130.13%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(B_i0, C_i0)                = -0.984 
    C(B_i0, C_u0)                =  0.980 
    C(C_i0, C_u0)                = -0.980 
    C(C_i0, C_w0)                =  0.955 
    C(B_i1, C_i1)                = -0.946 
    C(C_u0, C_w0)                = -0.944 
    C(B_i0, C_w0)                = -0.925 
    C(B_i0, B_w0)                =  0.910 
    C(B_i1, C_u1)                =  0.895 
    C(C_i1, C_u1)                = -0.871 
    C(B_w0, C_i0)                = -0.851 
    C(B_w0, C_u0)                =  0.841 
    C(B_i2, C_i2)                = -0.836 
    C(B_i1, B_w1)                =  0.829 
    C(B_i0, B_i2)                = -0.821 
    C(B_i2, C_u0)                = -0.820 
    C(B_i2, C_i0)                =  0.810 
    C(B_i2, C_w0)                =  0.795 
    C(A_i0, C_w0)                = -0.781 
    C(C_u1, C_w1)                =  0.781 
    C(A_i0, C_i0)                = -0.770 
    C(C_i2, C_w0)                = -0.755 
    C(A_i0, C_u0)                =  0.754 
    C(C_i0, C_i2)                = -0.752 
    C(B_w0, C_w0)                = -0.748 
    C(C_i2, C_u0)                =  0.746 
    C(B_i0, C_i2)                =  0.733 
    C(C_i1, C_w1)                = -0.697 
    C(B_i2, B_w0)                = -0.690 
    C(A_i0, B_i0)                =  0.689 
    C(A_i0, A_i1)                =  0.689 
    C(A_i1, A_w1)                =  0.685 
    C(B_w1, C_i1)                = -0.681 
    C(A_i1, C_i1)                = -0.651 
    C(B_i1, C_w1)                =  0.644 
    C(A_i0, A_w0)                =  0.643 
    C(A_i1, C_i0)                = -0.639 
    C(B_w1, C_u1)                =  0.626 
    C(C_i0, C_i1)                =  0.616 
    C(A_i1, C_u0)                =  0.611 
    C(B_w0, C_i2)                =  0.604 
    C(A_i0, C_i1)                = -0.601 
    C(A_i1, C_w0)                = -0.597 
    C(A_i1, B_i0)                =  0.586 
    C(B_i0, C_i1)                = -0.586 
    C(A_i0, B_i2)                = -0.578 
    C(C_i1, C_u0)                = -0.544 
    C(A_u0, A_w0)                =  0.543 
    C(A_i0, C_i2)                =  0.537 
    C(A_u1, A_w1)                =  0.528 
    C(A_i0, A_u0)                =  0.515 
    C(B_i1, C_i0)                = -0.515 
    C(B_w0, C_i1)                = -0.512 
    C(B_i0, B_i1)                =  0.500 
    C(C_i1, C_w0)                =  0.495 
    C(A_i1, C_u1)                =  0.493 
    C(A_i1, A_u1)                =  0.488 
    C(B_i1, B_w0)                =  0.474 
    C(A_i0, B_i1)                =  0.469 
    C(A_i1, B_i1)                =  0.458 
    C(A_i1, B_i2)                = -0.441 
    C(A_w0, B_u0)                =  0.441 
    C(A_i1, C_w1)                =  0.438 
    C(B_i1, C_u0)                =  0.437 
    C(A_i0, B_w0)                =  0.427 
    C(B_w0, B_w1)                =  0.425 
    C(A_i1, B_w0)                =  0.423 
    C(A_u0, B_u0)                =  0.423 
    C(A_i0, A_i2)                = -0.395 
    C(A_u1, B_w1)                = -0.391 
    C(B_i1, C_w0)                = -0.384 
    C(A_u1, B_u1)                =  0.383 
    C(B_i0, B_w1)                =  0.377 
    C(A_i1, C_i2)                =  0.370 
    C(A_w1, B_u1)                =  0.370 
    C(A_i0, C_u1)                =  0.365 
    C(A_i2, C_w0)                =  0.365 
    C(B_w1, C_i0)                = -0.362 
    C(B_u1, B_w0)                = -0.360 
    C(B_i0, B_u1)                = -0.350 
    C(A_i2, C_u0)                = -0.348 
    C(A_i1, A_u0)                =  0.345 
    C(B_u1, C_u0)                = -0.342 
    C(B_w1, C_w1)                =  0.338 
    C(A_i2, C_i0)                =  0.337 
    C(B_i2, C_i1)                =  0.330 
    C(B_u1, C_w0)                =  0.329 
    C(A_i2, C_i2)                = -0.327 
    C(B_u1, C_i0)                =  0.326 
    C(A_i2, B_i0)                = -0.324 
    C(A_i1, A_w0)                =  0.312 
    C(A_w1, B_w1)                = -0.310 
    C(B_w1, C_u0)                =  0.301 
    C(B_i2, B_u1)                =  0.299 
    C(A_i0, A_w1)                =  0.288 
    C(A_i0, B_u0)                =  0.287 
    C(A_i2, B_i2)                =  0.286 
    C(A_u0, C_w0)                = -0.273 
    C(B_u1, C_i2)                = -0.269 
    C(C_i0, C_u1)                = -0.267 
    C(B_w1, C_w0)                = -0.259 
    C(A_i0, A_u1)                =  0.257 
    C(C_i2, C_w1)                = -0.250 
    C(A_i2, B_w0)                = -0.250 
    C(A_w0, C_w0)                = -0.247 
    C(B_i1, B_i2)                = -0.245 
    C(A_u0, A_u1)                =  0.238 
    C(A_u0, A_w1)                =  0.237 
    C(C_i1, C_i2)                = -0.233 
    C(A_i0, B_w1)                =  0.232 
    C(B_i0, C_u1)                =  0.231 
    C(A_u1, A_w0)                =  0.224 
    C(B_u0, B_u1)                =  0.219 
    C(A_u0, C_u0)                =  0.215 
    C(A_u0, C_i0)                = -0.213 
    C(A_u1, C_w1)                =  0.211 
    C(B_u1, B_w1)                = -0.209 
    C(A_i1, A_i2)                = -0.209 
    C(A_w0, C_i0)                = -0.203 
    C(A_i0, C_w1)                =  0.201 
    C(A_u1, B_u0)                =  0.201 
    C(A_w0, C_u0)                =  0.199 
    C(B_w0, C_u1)                =  0.198 
    C(A_w0, C_i1)                = -0.197 
    C(A_w1, C_i0)                = -0.197 
    C(A_w1, C_u0)                =  0.193 
    C(B_u0, B_w1)                = -0.192 
    C(A_w1, C_w0)                = -0.190 
    C(A_w1, C_w1)                =  0.181 
    C(A_w1, B_u0)                =  0.176 
    C(B_u0, C_u1)                = -0.176 
    C(B_u0, C_w1)                = -0.175 
    C(A_w1, C_i1)                = -0.172 
    C(C_u0, C_u1)                =  0.171 
    C(A_u0, C_i2)                =  0.170 
    C(A_w0, A_w1)                =  0.166 
    C(B_i2, B_w1)                = -0.164 
    C(A_u0, C_i1)                = -0.161 
    C(B_i2, C_w1)                =  0.161 
    C(A_w1, B_i0)                =  0.160 
    C(A_i2, C_w1)                =  0.157 
    C(A_u0, B_i2)                = -0.156 
    C(A_u0, B_w0)                = -0.153 
    C(C_u1, C_w0)                = -0.153 
    C(B_i1, B_u0)                = -0.151 
    C(A_w0, C_u1)                =  0.149 
    C(B_u0, C_u0)                =  0.147 
    C(A_w1, B_i2)                = -0.146 
    C(A_w0, C_i2)                =  0.143 
    C(B_i1, C_i2)                =  0.139 
    C(A_i2, A_w0)                = -0.137 
    C(A_w0, B_i2)                = -0.133 
    C(A_w0, B_w0)                = -0.130 
    C(A_i1, B_u0)                =  0.130 
    C(A_u0, B_u1)                =  0.130 
    C(A_w1, C_u1)                =  0.130 
    C(A_i0, B_u1)                = -0.129 
    C(B_u0, C_i2)                =  0.127 
    C(B_i2, B_u0)                = -0.126 
    C(B_i1, B_u1)                = -0.125 
    C(A_i2, B_u1)                =  0.125 
    C(A_w1, C_i2)                =  0.123 
    C(A_i2, A_u0)                = -0.122 
    C(B_u0, C_i0)                = -0.122 
    C(A_u1, C_u1)                =  0.122 
    C(A_u1, C_i1)                = -0.121 
    C(A_w0, B_i1)                =  0.116 
    C(A_u0, B_i0)                =  0.113 
    C(A_w0, C_w1)                =  0.106 
    C(A_u0, C_u1)                =  0.106 
    C(A_w0, B_u1)                =  0.106 
    C(A_w0, B_i0)                =  0.103 
    C(A_u1, C_i0)                = -0.095 
    C(A_u1, C_w0)                = -0.095 
    C(A_i2, B_u0)                = -0.094 
    C(B_w1, C_i2)                =  0.094 
    C(A_u1, C_u0)                =  0.094 
    C(A_i1, B_u1)                =  0.094 
    C(C_w0, C_w1)                =  0.093 
    C(A_u0, B_w1)                = -0.090 
    C(B_u0, C_i1)                =  0.090 
    C(C_i2, C_u1)                = -0.087 
    C(B_i0, B_u0)                =  0.086 
    C(B_u1, C_i1)                =  0.085 
    C(A_i2, C_u1)                =  0.074 
    C(A_i2, C_i1)                =  0.072 
    C(A_w1, B_w0)                =  0.071 
    C(A_u0, C_w1)                =  0.065 
    C(A_u1, B_i1)                = -0.063 
    C(A_u0, B_i1)                =  0.063 
    C(A_i1, B_w1)                =  0.062 
    C(B_u1, C_u1)                =  0.062 
    C(A_u1, B_i2)                = -0.059 
    C(B_u0, C_w0)                = -0.057 
    C(A_u1, B_w0)                = -0.057 
    C(A_i2, A_w1)                = -0.053 
    C(A_u1, B_i0)                =  0.050 
    C(A_u1, C_i2)                =  0.044 
    C(B_u1, C_w1)                = -0.035 
    C(C_i0, C_w1)                = -0.033 
    C(A_i2, B_i1)                = -0.030 
    C(C_u0, C_w1)                = -0.030 
    C(A_i2, B_w1)                = -0.023 
    C(A_i2, A_u1)                = -0.018 
    C(B_u0, B_w0)                = -0.017 
    C(A_w1, B_i1)                = -0.017 
    C(A_w0, B_w1)                = -0.010 
    C(B_w0, C_w1)                = -0.008 
    C(B_i2, C_u1)                =  0.004 
    C(B_i0, C_w1)                = -0.003 
#+end_example


*** [Fe III] lines
#+BEGIN_SRC sh 
python hires-extract/fit-nebula.py p85-Fe_III_5270 --min-fraction 0.05 --ylo -6.5 -4  --yhi 4 6.5 --ncomp 3 --compA 300.0 21.0 5.0 --compB 40.0 30.0 4.0 --compC 90.0 6.0 4.0 --linear-components ABC --linear-intensity-components BC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     200.981245 +/- 83.735023 (41.66%) initial =  300.000000
  A_i1:     59.742597 +/- 41.645620 (69.71%) initial =  0.000000
  A_i2:    -7.425784 +/- 10.699698 (144.09%) initial =  0.000000
  A_u0:     19.663945 +/- 0.274117 (1.39%) initial =  21.000000
  A_u1:    -1.070631 +/- 0.422271 (39.44%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.623554 +/- 0.540025 (11.68%) initial =  5.000000
  A_w1:     1.000000 +/- 0.188529 (18.85%) initial =  0.000000
  A_w2:    fixed
  B_i0:     66.952600 +/- 110.264369 (164.69%) initial =  40.000000
  B_i1:    -13.187172 +/- 62.395598 (473.15%) initial =  0.000000
  B_i2:    fixed
  B_u0:     28.927793 +/- 15.866872 (54.85%) initial =  30.000000
  B_u1:    -3.399381 +/- 12.640022 (371.83%) initial =  0.000000
  B_u2:    fixed
  B_w0:     9.414237 +/- 9.947182 (105.66%) initial =  4.000000
  B_w1:     1.000000 +/- 0.085545 (8.55%) initial =  0.000000
  B_w2:    fixed
  C_i0:     72.265063 +/- 19.613456 (27.14%) initial =  90.000000
  C_i1:    -28.708988 +/- 19.235729 (67.00%) initial =  0.000000
  C_i2:    fixed
  C_u0:     6.787828 +/- 0.529145 (7.80%) initial =  6.000000
  C_u1:    -1.443368 +/- 0.640421 (44.37%) initial =  0.000000
  C_u2:    fixed
  C_w0:     4.191467 +/- 0.553038 (13.19%) initial =  4.000000
  C_w1:    -1.000000 +/- 0.016603 (1.66%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(A_i0, B_i0)                = -0.989 
    C(B_i0, B_u0)                = -0.984 
    C(A_i0, B_u0)                =  0.982 
    C(B_i0, B_w0)                =  0.961 
    C(A_i1, B_u1)                =  0.960 
    C(A_i1, B_i1)                = -0.949 
    C(B_u0, B_w0)                = -0.941 
    C(B_i1, C_i1)                = -0.930 
    C(A_i0, A_w0)                =  0.927 
    C(B_w0, C_i0)                = -0.922 
    C(A_i0, B_w0)                = -0.919 
    C(B_u0, B_u1)                =  0.884 
    C(B_u0, C_i0)                =  0.878 
    C(A_w0, B_i0)                = -0.877 
    C(B_i0, C_i0)                = -0.877 
    C(B_i1, B_u1)                = -0.874 
    C(A_i1, C_i1)                =  0.873 
    C(C_i1, C_w1)                =  0.871 
    C(A_w0, B_u0)                =  0.856 
    C(B_i1, B_w1)                =  0.855 
    C(B_u1, C_i1)                =  0.846 
    C(B_u1, B_w0)                = -0.822 
    C(B_i0, B_u1)                = -0.822 
    C(A_i0, C_i0)                =  0.813 
    C(C_i0, C_w0)                =  0.812 
    C(B_u1, C_i0)                =  0.810 
    C(A_i0, B_u1)                =  0.808 
    C(B_w1, C_i1)                = -0.802 
    C(A_i1, B_u0)                =  0.773 
    C(A_u1, B_w0)                =  0.764 
    C(A_w0, B_w0)                = -0.755 
    C(B_i1, C_w1)                = -0.744 
    C(A_u1, C_i0)                = -0.741 
    C(B_u1, C_w1)                =  0.725 
    C(A_i1, C_w1)                =  0.708 
    C(C_u0, C_w0)                =  0.702 
    C(A_i1, C_i0)                =  0.695 
    C(A_i1, B_w1)                = -0.695 
    C(A_i1, B_i0)                = -0.688 
    C(A_i0, A_i1)                =  0.685 
    C(A_i1, B_w0)                = -0.677 
    C(A_u1, B_u0)                = -0.665 
    C(A_u1, B_i0)                =  0.660 
    C(A_u0, B_w1)                =  0.643 
    C(C_i0, C_u0)                =  0.636 
    C(A_w0, B_u1)                =  0.620 
    C(A_u0, C_i1)                = -0.613 
    C(B_i1, B_u0)                = -0.609 
    C(A_i0, A_u1)                = -0.604 
    C(B_u1, B_w1)                = -0.601 
    C(B_w0, C_w0)                = -0.599 
    C(B_u0, C_i1)                =  0.598 
    C(A_u1, B_u1)                = -0.586 
    C(A_w0, C_i0)                =  0.576 
    C(B_w1, C_w1)                = -0.568 
    C(B_u0, C_w1)                =  0.564 
    C(A_u0, B_i1)                =  0.564 
    C(A_u1, C_w0)                = -0.558 
    C(B_i1, C_i0)                = -0.556 
    C(B_u1, C_w0)                =  0.553 
    C(B_w0, C_i1)                = -0.545 
    C(C_i1, C_u1)                =  0.538 
    C(B_u0, C_w0)                =  0.535 
    C(A_u0, B_u1)                = -0.535 
    C(B_i1, B_w0)                =  0.533 
    C(B_i0, C_w0)                = -0.523 
    C(C_i0, C_i1)                =  0.523 
    C(B_w1, C_u1)                = -0.514 
    C(A_i1, A_w0)                =  0.509 
    C(A_i0, C_w1)                =  0.509 
    C(B_i0, C_i1)                = -0.508 
    C(B_i0, B_i1)                =  0.505 
    C(B_w0, C_w1)                = -0.504 
    C(B_i1, C_u1)                = -0.504 
    C(B_i0, C_w1)                = -0.502 
    C(A_i0, C_i1)                =  0.502 
    C(A_i0, B_i1)                = -0.500 
    C(A_i1, C_w0)                =  0.497 
    C(A_i1, A_u0)                = -0.494 
    C(A_u0, C_w1)                = -0.494 
    C(A_i1, A_u1)                = -0.487 
    C(C_u1, C_w1)                =  0.479 
    C(A_u0, B_w0)                =  0.468 
    C(C_i0, C_w1)                =  0.452 
    C(B_w0, C_u0)                = -0.449 
    C(A_u0, A_u1)                =  0.443 
    C(A_u1, A_w0)                = -0.443 
    C(A_i0, C_w0)                =  0.435 
    C(A_u1, C_u0)                = -0.430 
    C(A_u1, B_w1)                =  0.425 
    C(B_i1, C_w0)                = -0.421 
    C(A_u1, B_i1)                =  0.415 
    C(A_w0, C_w1)                =  0.392 
    C(B_i0, C_u0)                = -0.376 
    C(C_i1, C_w0)                =  0.363 
    C(A_u0, B_u0)                = -0.362 
    C(B_u0, C_u0)                =  0.357 
    C(B_w1, C_w0)                = -0.350 
    C(B_w1, C_i0)                = -0.347 
    C(A_u1, C_i1)                = -0.344 
    C(A_i1, C_u1)                =  0.342 
    C(A_w0, C_i1)                =  0.335 
    C(A_u0, B_i0)                =  0.327 
    C(A_w0, B_i1)                = -0.325 
    C(A_u1, C_u1)                =  0.311 
    C(A_i0, A_u0)                = -0.307 
    C(A_i2, B_u1)                = -0.306 
    C(B_w0, B_w1)                =  0.304 
    C(B_u1, C_u0)                =  0.301 
    C(A_u0, C_i0)                = -0.293 
    C(C_w0, C_w1)                =  0.280 
    C(A_i2, A_u1)                =  0.280 
    C(A_i0, C_u0)                =  0.279 
    C(A_u0, C_u1)                = -0.279 
    C(A_i2, B_w0)                =  0.277 
    C(A_i1, A_i2)                = -0.277 
    C(A_i2, B_i1)                =  0.275 
    C(A_i2, C_i1)                = -0.271 
    C(A_i2, B_u0)                = -0.269 
    C(A_i2, C_i0)                = -0.264 
    C(B_u0, B_w1)                = -0.264 
    C(A_i2, B_w1)                =  0.256 
    C(C_u0, C_u1)                = -0.250 
    C(A_i0, A_i2)                = -0.248 
    C(A_i2, B_i0)                =  0.248 
    C(A_i2, A_u0)                =  0.238 
    C(B_u1, C_u1)                =  0.236 
    C(A_i1, C_u0)                =  0.220 
    C(A_u0, A_w0)                = -0.212 
    C(A_i2, C_w1)                = -0.204 
    C(A_u1, C_w1)                = -0.196 
    C(A_i2, C_w0)                = -0.187 
    C(A_w0, C_w0)                =  0.178 
    C(A_i2, A_w0)                = -0.174 
    C(A_w0, C_u1)                = -0.172 
    C(B_i0, C_u1)                =  0.169 
    C(B_w0, C_u1)                =  0.167 
    C(B_i0, B_w1)                =  0.163 
    C(C_i0, C_u1)                = -0.153 
    C(A_u0, C_u0)                =  0.149 
    C(A_i0, C_u1)                = -0.142 
    C(A_i1, A_w1)                = -0.138 
    C(A_i0, B_w1)                = -0.124 
    C(B_i1, C_u0)                = -0.123 
    C(C_u1, C_w0)                = -0.113 
    C(A_i2, A_w1)                = -0.110 
    C(A_w1, B_i1)                =  0.110 
    C(A_w1, C_u0)                = -0.104 
    C(A_w1, B_w1)                =  0.099 
    C(A_i2, C_u0)                = -0.095 
    C(B_w1, C_u0)                = -0.087 
    C(A_w0, A_w1)                =  0.085 
    C(C_i1, C_u0)                =  0.085 
    C(A_w1, C_w0)                = -0.084 
    C(B_u0, C_u1)                = -0.080 
    C(A_w0, B_w1)                =  0.066 
    C(A_w1, B_u1)                = -0.062 
    C(A_u0, C_w0)                = -0.062 
    C(A_w1, C_i0)                = -0.060 
    C(A_u0, A_w1)                = -0.053 
    C(A_i2, C_u1)                = -0.051 
    C(A_w1, C_i1)                = -0.038 
    C(C_u0, C_w1)                =  0.034 
    C(A_w0, C_u0)                =  0.028 
    C(A_u1, A_w1)                = -0.026 
    C(A_i0, A_w1)                =  0.021 
    C(A_w1, C_w1)                =  0.017 
    C(A_w1, B_i0)                = -0.007 
    C(A_w1, C_u1)                =  0.007 
    C(A_w1, B_w0)                =  0.004 
    C(A_w1, B_u0)                = -0.000 
#+end_example

#+BEGIN_SRC sh 
python hires-extract/fit-nebula.py p85-Fe_III_4881 --min-fraction 0.05 --ylo -6.5 -4  --yhi 4 6.5 --ncomp 3 --compA 300.0 21.0 5.0 --compB 40.0 30.0 4.0 --compC 90.0 6.0 4.0 --linear-components ABC --linear-intensity-components BC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     212.094380 +/- 95.722126 (45.13%) initial =  300.000000
  A_i1:     16.510831 +/- 71.741739 (434.51%) initial =  0.000000
  A_i2:    -9.680918 +/- 14.469199 (149.46%) initial =  0.000000
  A_u0:     17.866501 +/- 0.411652 (2.30%) initial =  21.000000
  A_u1:    -1.325233 +/- 0.546950 (41.27%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.164593 +/- 0.621685 (14.93%) initial =  5.000000
  A_w1:    -0.351872 +/- 0.537257 (152.69%) initial =  0.000000
  A_w2:    fixed
  B_i0:     153.560747 +/- 150.746467 (98.17%) initial =  40.000000
  B_i1:    -22.004626 +/- 115.576154 (525.24%) initial =  0.000000
  B_i2:    fixed
  B_u0:     23.404360 +/- 9.708892 (41.48%) initial =  30.000000
  B_u1:     0.849690 +/- 7.701843 (906.43%) initial =  0.000000
  B_u2:    fixed
  B_w0:     9.734978 +/- 4.510333 (46.33%) initial =  4.000000
  B_w1:    -0.999995 +/- 3.166616 (316.66%) initial =  0.000000
  B_w2:    fixed
  C_i0:     77.530875 +/- 58.782198 (75.82%) initial =  90.000000
  C_i1:     19.431061 +/- 54.633200 (281.16%) initial =  0.000000
  C_i2:    fixed
  C_u0:     5.334858 +/- 1.465024 (27.46%) initial =  6.000000
  C_u1:     2.168324 +/- 1.807268 (83.35%) initial =  0.000000
  C_u2:    fixed
  C_w0:     4.414509 +/- 1.090370 (24.70%) initial =  4.000000
  C_w1:     1.000000 +/- 0.432948 (43.29%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(B_i0, B_u0)                = -0.993 
    C(B_i1, B_u1)                = -0.972 
    C(A_i0, B_i0)                = -0.966 
    C(A_i0, A_w0)                =  0.958 
    C(A_i0, B_u0)                =  0.954 
    C(B_u0, C_i0)                =  0.931 
    C(B_w0, C_i0)                = -0.929 
    C(B_u0, B_w0)                = -0.923 
    C(B_i0, C_i0)                = -0.922 
    C(B_i0, B_w0)                =  0.911 
    C(A_i1, B_i1)                = -0.902 
    C(A_w0, B_i0)                = -0.885 
    C(B_u1, C_i1)                =  0.865 
    C(A_i1, B_u1)                =  0.860 
    C(C_u0, C_w0)                =  0.859 
    C(A_i1, A_w1)                =  0.859 
    C(A_w0, B_u0)                =  0.858 
    C(B_i1, C_i1)                = -0.855 
    C(C_i0, C_w0)                =  0.834 
    C(B_u1, B_w1)                =  0.833 
    C(A_i0, B_w0)                = -0.807 
    C(C_i1, C_u1)                =  0.800 
    C(A_i0, C_i0)                =  0.799 
    C(C_i0, C_u0)                =  0.799 
    C(C_u1, C_w1)                = -0.797 
    C(B_w1, C_i1)                =  0.796 
    C(A_u1, C_w0)                =  0.778 
    C(B_i1, B_w1)                = -0.770 
    C(A_u0, C_w1)                = -0.763 
    C(A_u1, C_i0)                =  0.759 
    C(A_u1, C_u0)                =  0.729 
    C(C_i1, C_w1)                = -0.722 
    C(C_u0, C_u1)                =  0.703 
    C(A_w1, B_i1)                = -0.681 
    C(A_w0, B_w0)                = -0.673 
    C(A_w0, C_i0)                =  0.670 
    C(B_w0, C_w0)                = -0.660 
    C(A_u1, B_w0)                = -0.653 
    C(B_u0, C_w0)                =  0.639 
    C(A_u0, C_u1)                =  0.634 
    C(B_i0, C_w0)                = -0.632 
    C(A_u1, B_u0)                =  0.632 
    C(A_u1, B_i0)                = -0.624 
    C(B_u0, B_w1)                =  0.624 
    C(B_w0, C_u0)                = -0.610 
    C(B_i0, B_w1)                = -0.601 
    C(B_w1, C_i0)                =  0.599 
    C(B_w0, B_w1)                = -0.588 
    C(C_i1, C_u0)                =  0.586 
    C(A_u0, A_w0)                = -0.581 
    C(B_u0, C_u0)                =  0.576 
    C(A_w1, B_u1)                =  0.572 
    C(A_i1, C_i1)                =  0.569 
    C(A_i0, B_w1)                =  0.562 
    C(B_i0, C_u0)                = -0.561 
    C(A_i0, A_u0)                = -0.558 
    C(A_i1, B_w1)                =  0.536 
    C(A_u0, C_i1)                =  0.519 
    C(B_u1, B_w0)                = -0.511 
    C(A_u0, B_i0)                =  0.493 
    C(B_i1, C_u1)                = -0.491 
    C(A_i0, A_u1)                =  0.485 
    C(B_u1, C_u1)                =  0.481 
    C(A_u0, B_u0)                = -0.480 
    C(C_u1, C_w0)                =  0.480 
    C(B_i1, C_w1)                =  0.471 
    C(A_u0, B_w0)                =  0.470 
    C(A_w0, C_w1)                =  0.469 
    C(A_i0, C_w0)                =  0.462 
    C(C_i0, C_i1)                =  0.460 
    C(B_w1, C_u0)                =  0.438 
    C(A_w0, B_w1)                =  0.436 
    C(B_u1, C_i0)                =  0.435 
    C(A_i0, C_w1)                =  0.430 
    C(B_u0, B_u1)                =  0.422 
    C(A_u1, A_w0)                =  0.414 
    C(B_u1, C_w1)                = -0.414 
    C(B_w1, C_u1)                =  0.406 
    C(B_i1, B_w0)                =  0.401 
    C(B_w0, C_i1)                = -0.395 
    C(B_i0, B_u1)                = -0.375 
    C(A_u1, A_w1)                = -0.373 
    C(A_i0, C_u0)                =  0.367 
    C(C_i1, C_w0)                =  0.367 
    C(A_w0, C_w0)                =  0.364 
    C(A_w0, A_w1)                = -0.361 
    C(C_u0, C_w1)                = -0.353 
    C(C_i0, C_u1)                =  0.336 
    C(A_u0, A_u1)                = -0.336 
    C(A_u0, B_i1)                = -0.333 
    C(B_u1, C_u0)                =  0.328 
    C(A_w1, C_i1)                =  0.322 
    C(A_i1, B_w0)                = -0.315 
    C(A_w1, C_w0)                = -0.311 
    C(B_i1, C_i0)                = -0.308 
    C(A_u1, C_u1)                =  0.308 
    C(B_u0, C_i1)                =  0.306 
    C(B_i0, C_w1)                = -0.302 
    C(A_i0, B_u1)                =  0.301 
    C(A_u0, C_i0)                = -0.297 
    C(B_w1, C_w0)                =  0.294 
    C(B_w1, C_w1)                = -0.280 
    C(B_i1, B_u0)                = -0.279 
    C(A_w1, C_u0)                = -0.275 
    C(B_u0, C_w1)                =  0.274 
    C(A_w0, C_u1)                = -0.272 
    C(A_u0, B_u1)                =  0.268 
    C(A_i0, A_w1)                = -0.267 
    C(B_i0, C_i1)                = -0.264 
    C(A_i2, C_u1)                = -0.261 
    C(A_w1, B_i0)                =  0.260 
    C(B_i1, C_u0)                = -0.252 
    C(A_i2, C_u0)                = -0.246 
    C(A_w1, C_i0)                = -0.239 
    C(A_w0, C_u0)                =  0.236 
    C(A_u0, A_w1)                =  0.236 
    C(A_w1, C_w1)                = -0.227 
    C(B_i0, B_i1)                =  0.226 
    C(A_i2, A_u1)                = -0.211 
    C(A_i2, C_w0)                = -0.208 
    C(A_i1, C_w1)                = -0.207 
    C(A_w1, B_u0)                = -0.206 
    C(A_i1, A_u1)                = -0.201 
    C(A_i2, C_w1)                =  0.190 
    C(B_w0, C_w1)                = -0.185 
    C(A_w1, B_w1)                =  0.177 
    C(B_u1, C_w0)                =  0.172 
    C(A_i1, B_u0)                =  0.171 
    C(B_w0, C_u1)                = -0.166 
    C(A_i0, C_u1)                = -0.166 
    C(A_i1, C_u1)                =  0.157 
    C(A_w0, B_u1)                =  0.154 
    C(A_u0, C_u0)                =  0.150 
    C(A_i1, C_w0)                = -0.149 
    C(C_w0, C_w1)                = -0.149 
    C(A_i0, B_i1)                = -0.148 
    C(A_u0, B_w1)                =  0.143 
    C(A_u1, C_i1)                =  0.140 
    C(A_i2, C_i1)                = -0.138 
    C(A_i1, A_u0)                =  0.128 
    C(A_i2, C_i0)                = -0.126 
    C(A_i0, C_i1)                =  0.123 
    C(A_i1, B_i0)                = -0.117 
    C(A_i2, A_u0)                = -0.117 
    C(A_i1, C_i0)                =  0.110 
    C(A_i2, A_w1)                =  0.103 
    C(A_i0, A_i1)                =  0.095 
    C(B_i1, C_w0)                = -0.085 
    C(A_i1, A_i2)                =  0.085 
    C(A_u0, C_w0)                = -0.081 
    C(A_u1, B_i1)                =  0.068 
    C(A_u1, B_w1)                =  0.067 
    C(A_i1, C_u0)                = -0.066 
    C(A_u1, C_w1)                =  0.061 
    C(B_u0, C_u1)                =  0.058 
    C(A_i2, A_w0)                =  0.055 
    C(A_i2, B_w0)                =  0.054 
    C(A_w1, C_u1)                =  0.049 
    C(A_w1, B_w0)                =  0.049 
    C(C_i0, C_w1)                =  0.045 
    C(A_i2, B_u0)                = -0.028 
    C(A_i1, A_w0)                = -0.027 
    C(B_i0, C_u1)                = -0.027 
    C(A_i0, A_i2)                =  0.026 
    C(A_i2, B_i0)                =  0.024 
    C(A_w0, C_i1)                = -0.023 
    C(A_i2, B_u1)                = -0.009 
    C(A_u1, B_u1)                =  0.008 
    C(A_i2, B_w1)                =  0.007 
    C(A_i2, B_i1)                =  0.007 
    C(A_w0, B_i1)                =  0.002 
#+end_example




*** [Cl III] lines
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-Cl_III_5518 --min-fraction 0.05 --ylo -7 -4  --yhi 4 6.5 --ncomp 3 --compA 150.0 17.0 5.0 --compB 60.0 24.0 5.0 --compC 30.0 3.0 3.0 --linear-components ABC --linear-intensity-components ABC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     206.403612 +/- 72.083828 (34.92%) initial =  150.000000
  A_i1:     6.456096 +/- 38.491914 (596.21%) initial =  0.000000
  A_i2:    fixed
  A_u0:     10.535632 +/- 0.390422 (3.71%) initial =  17.000000
  A_u1:    -0.568116 +/- 0.522968 (92.05%) initial =  0.000000
  A_u2:    fixed
  A_w0:     5.818051 +/- 0.732132 (12.58%) initial =  5.000000
  A_w1:     0.058623 +/- 0.593525 (1012.45%) initial =  0.000000
  A_w2:    fixed
  B_i0:     93.353080 +/- 128.937009 (138.12%) initial =  60.000000
  B_i1:     33.688279 +/- 66.214553 (196.55%) initial =  0.000000
  B_i2:    fixed
  B_u0:     26.275322 +/- 14.720111 (56.02%) initial =  24.000000
  B_u1:    -6.556729 +/- 11.083156 (169.03%) initial =  0.000000
  B_u2:    fixed
  B_w0:     15.000000 +/- 17.177931 (114.52%) initial =  5.000000
  B_w1:     0.999997 +/- 7.865993 (786.60%) initial =  0.000000
  B_w2:    fixed
  C_i0:     92.778460 +/- 26.367010 (28.42%) initial =  30.000000
  C_i1:     2.262756 +/- 31.426554 (1388.86%) initial =  0.000000
  C_i2:    fixed
  C_u0:    -1.978562 +/- 0.477580 (24.14%) initial =  3.000000
  C_u1:    -1.301013 +/- 0.499362 (38.38%) initial =  0.000000
  C_u2:    fixed
  C_w0:     3.779863 +/- 0.449684 (11.90%) initial =  3.000000
  C_w1:    -0.009300 +/- 0.566072 (6087.04%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(B_i0, B_w0)                =  0.981 
    C(A_i0, B_i0)                = -0.969 
    C(A_i0, B_u0)                =  0.968 
    C(B_i0, B_u0)                = -0.951 
    C(A_i0, B_w0)                = -0.931 
    C(A_i0, A_w0)                =  0.922 
    C(B_u0, B_w0)                = -0.901 
    C(C_i0, C_w0)                =  0.886 
    C(C_i1, C_w1)                =  0.881 
    C(B_i0, C_i0)                = -0.866 
    C(A_w0, C_u0)                = -0.858 
    C(B_w0, C_i0)                = -0.853 
    C(A_w0, B_u0)                =  0.851 
    C(B_u0, C_i1)                =  0.834 
    C(B_i0, C_i1)                = -0.818 
    C(A_w0, B_i0)                = -0.816 
    C(B_u0, C_i0)                =  0.812 
    C(A_i1, B_i1)                = -0.811 
    C(A_i0, C_i1)                =  0.796 
    C(A_u0, C_u0)                =  0.789 
    C(B_u1, C_i0)                =  0.786 
    C(B_i0, B_u1)                = -0.776 
    C(B_w0, C_i1)                = -0.774 
    C(B_i1, B_u1)                = -0.768 
    C(A_w0, B_w0)                = -0.762 
    C(A_i1, B_u1)                =  0.759 
    C(A_w1, C_u1)                = -0.758 
    C(A_i0, C_u0)                = -0.755 
    C(C_i0, C_i1)                =  0.751 
    C(A_i1, A_w1)                =  0.748 
    C(A_i0, C_i0)                =  0.746 
    C(A_u1, C_u1)                =  0.734 
    C(A_i0, B_u1)                =  0.714 
    C(B_u1, B_w0)                = -0.703 
    C(B_u0, B_u1)                =  0.700 
    C(B_u1, C_i1)                =  0.689 
    C(B_i1, C_i1)                = -0.669 
    C(B_u0, C_u0)                = -0.664 
    C(A_w0, C_i1)                =  0.662 
    C(B_w0, C_w0)                = -0.644 
    C(B_i0, C_w0)                = -0.643 
    C(B_i0, C_u0)                =  0.636 
    C(B_i1, B_u0)                = -0.625 
    C(A_u0, A_w0)                = -0.623 
    C(B_i1, C_i0)                = -0.620 
    C(A_i1, C_u1)                = -0.619 
    C(B_u0, C_w1)                =  0.609 
    C(B_w0, B_w1)                =  0.608 
    C(B_i0, C_w1)                = -0.594 
    C(B_u1, C_w0)                =  0.593 
    C(B_u0, C_w0)                =  0.592 
    C(B_w0, C_u0)                =  0.591 
    C(C_i1, C_w0)                =  0.578 
    C(C_i1, C_u0)                = -0.576 
    C(A_i0, C_w1)                =  0.571 
    C(B_w0, C_w1)                = -0.569 
    C(C_i0, C_w1)                =  0.564 
    C(B_i0, B_i1)                =  0.553 
    C(A_i0, B_i1)                = -0.536 
    C(A_w0, B_u1)                =  0.532 
    C(A_i0, B_w1)                = -0.518 
    C(A_i1, A_u1)                = -0.512 
    C(B_i0, B_w1)                =  0.511 
    C(A_i0, C_w0)                =  0.501 
    C(A_i0, A_u0)                = -0.498 
    C(A_u1, A_w1)                = -0.493 
    C(A_w0, B_w1)                = -0.486 
    C(B_u1, C_w1)                =  0.482 
    C(B_i1, C_w1)                = -0.479 
    C(A_u1, C_i0)                = -0.473 
    C(C_w0, C_w1)                =  0.472 
    C(A_w0, C_i0)                =  0.465 
    C(A_w0, C_w1)                =  0.461 
    C(B_i1, C_w0)                = -0.460 
    C(A_i1, C_i0)                =  0.459 
    C(A_u0, C_i1)                = -0.447 
    C(A_w1, C_w1)                = -0.445 
    C(A_u1, B_i0)                =  0.433 
    C(C_u0, C_w1)                = -0.426 
    C(A_u1, B_w0)                =  0.424 
    C(B_u1, C_u0)                = -0.423 
    C(B_i1, B_w0)                =  0.420 
    C(A_w0, B_i1)                = -0.418 
    C(A_u1, B_u0)                = -0.405 
    C(A_i1, B_u0)                =  0.402 
    C(A_u0, B_u0)                = -0.401 
    C(A_u0, B_i0)                =  0.398 
    C(C_u1, C_w1)                =  0.395 
    C(B_u0, B_w1)                = -0.394 
    C(B_i1, B_w1)                = -0.394 
    C(A_u1, B_u1)                = -0.393 
    C(A_i1, B_i0)                = -0.380 
    C(A_i0, A_u1)                = -0.379 
    C(A_u0, B_w0)                =  0.370 
    C(A_i0, A_i1)                =  0.367 
    C(A_w1, C_i1)                = -0.363 
    C(B_i1, C_u0)                =  0.360 
    C(A_u1, C_w0)                = -0.354 
    C(A_u0, B_u1)                = -0.333 
    C(B_w1, C_u0)                =  0.329 
    C(A_u0, B_i1)                =  0.326 
    C(A_i1, C_w0)                =  0.325 
    C(A_u0, C_w1)                = -0.324 
    C(A_u1, B_i1)                =  0.320 
    C(A_w1, B_u1)                =  0.297 
    C(A_w1, B_i1)                = -0.297 
    C(A_i1, B_w1)                =  0.293 
    C(B_u1, C_u1)                = -0.287 
    C(B_w1, C_i0)                = -0.283 
    C(A_i1, A_w0)                =  0.272 
    C(C_i0, C_u0)                = -0.265 
    C(A_u1, A_w0)                = -0.260 
    C(A_i1, C_i1)                =  0.258 
    C(B_i1, C_u1)                =  0.253 
    C(C_i1, C_u1)                =  0.250 
    C(A_i1, B_w0)                = -0.245 
    C(A_w1, B_w1)                =  0.234 
    C(A_w0, C_w0)                =  0.231 
    C(A_u1, C_w1)                =  0.216 
    C(A_u0, C_w0)                =  0.205 
    C(B_w1, C_w0)                = -0.199 
    C(A_i1, C_u0)                = -0.193 
    C(C_i0, C_u1)                = -0.188 
    C(A_w1, B_w0)                =  0.164 
    C(C_u1, C_w0)                = -0.151 
    C(A_i1, A_u0)                = -0.147 
    C(A_u1, B_w1)                =  0.146 
    C(B_w1, C_i1)                = -0.142 
    C(A_u1, C_u0)                =  0.131 
    C(A_w1, C_u0)                =  0.130 
    C(A_u0, A_w1)                =  0.122 
    C(A_u0, C_u1)                = -0.113 
    C(B_u1, B_w1)                = -0.110 
    C(A_w0, A_w1)                = -0.102 
    C(A_w1, B_u0)                = -0.101 
    C(B_i0, C_u1)                =  0.097 
    C(B_w1, C_w1)                = -0.090 
    C(A_i0, A_w1)                = -0.089 
    C(A_w1, B_i0)                =  0.084 
    C(A_u0, B_w1)                =  0.071 
    C(B_u0, C_u1)                = -0.070 
    C(B_w1, C_u1)                = -0.067 
    C(A_i0, C_u1)                = -0.063 
    C(C_u0, C_u1)                = -0.062 
    C(B_w0, C_u1)                =  0.056 
    C(A_i1, C_w1)                =  0.055 
    C(A_u0, C_i0)                = -0.044 
    C(A_u0, A_u1)                =  0.034 
    C(A_u1, C_i1)                = -0.027 
    C(C_u0, C_w0)                = -0.026 
    C(A_w1, C_w0)                = -0.026 
    C(A_w1, C_i0)                =  0.006 
    C(A_w0, C_u1)                = -0.004 
#+end_example

Restricting the fit to linear intensity variation works must better.  We should maybe try this with p84 too. 

#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-Cl_III_5538 --min-fraction 0.05 --ylo -7 -4  --yhi 5 7 --ncomp 3 --compA 400.0 12.0 5.0 --compB 120.0 29.0 15.0 --compC 300.0 -1.0 5.0 --linear-components ABC --linear-intensity-components ABC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     251.403668 +/- 46.544175 (18.51%) initial =  400.000000
  A_i1:     66.476832 +/- 52.940807 (79.64%) initial =  0.000000
  A_i2:    fixed
  A_u0:     9.973654 +/- 0.207572 (2.08%) initial =  12.000000
  A_u1:    -1.066652 +/- 0.257826 (24.17%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.635814 +/- 0.302666 (6.53%) initial =  5.000000
  A_w1:     0.540919 +/- 0.360104 (66.57%) initial =  0.000000
  A_w2:    fixed
  B_i0:     128.038595 +/- 88.059842 (68.78%) initial =  120.000000
  B_i1:    -36.926301 +/- 94.363454 (255.55%) initial =  0.000000
  B_i2:    fixed
  B_u0:     17.071747 +/- 6.957809 (40.76%) initial =  29.000000
  B_u1:     5.339585 +/- 7.312678 (136.95%) initial =  0.000000
  B_u2:    fixed
  B_w0:     11.014096 +/- 3.248020 (29.49%) initial =  15.000000
  B_w1:    -0.892932 +/- 3.711245 (415.62%) initial =  0.000000
  B_w2:    fixed
  C_i0:     121.366486 +/- 37.159406 (30.62%) initial =  300.000000
  C_i1:     8.757803 +/- 38.700679 (441.90%) initial =  0.000000
  C_i2:    fixed
  C_u0:    -2.093539 +/- 0.317677 (15.17%) initial = -1.000000
  C_u1:    -1.200462 +/- 0.394385 (32.85%) initial =  0.000000
  C_u2:    fixed
  C_w0:     4.048748 +/- 0.568149 (14.03%) initial =  5.000000
  C_w1:     0.250355 +/- 0.622099 (248.49%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(B_i0, B_u0)                = -0.988 
    C(B_i1, B_u1)                = -0.984 
    C(B_u0, C_i0)                =  0.955 
    C(C_i0, C_w0)                =  0.942 
    C(A_i0, B_i0)                = -0.939 
    C(B_i0, C_i0)                = -0.935 
    C(B_u1, C_i1)                =  0.933 
    C(A_i1, B_i1)                = -0.925 
    C(C_i1, C_w1)                =  0.925 
    C(B_w0, C_i0)                = -0.922 
    C(A_i0, B_u0)                =  0.908 
    C(B_i1, C_i1)                = -0.904 
    C(B_u0, B_w0)                = -0.899 
    C(B_w1, C_i1)                = -0.895 
    C(B_i0, B_w0)                =  0.889 
    C(A_i1, B_u1)                =  0.885 
    C(B_u1, B_w1)                = -0.879 
    C(B_i1, B_w1)                =  0.871 
    C(B_w0, C_w0)                = -0.846 
    C(B_u0, C_w0)                =  0.841 
    C(B_i0, C_w0)                = -0.815 
    C(A_i0, A_w0)                =  0.813 
    C(A_i1, A_w1)                =  0.798 
    C(B_w1, C_w1)                = -0.794 
    C(B_u1, C_w1)                =  0.786 
    C(A_i0, A_i1)                =  0.777 
    C(A_i0, C_i0)                =  0.769 
    C(B_i1, C_w1)                = -0.751 
    C(A_i1, B_i0)                = -0.724 
    C(A_i0, B_w0)                = -0.721 
    C(A_i0, B_i1)                = -0.708 
    C(A_w1, C_u1)                = -0.699 
    C(A_i1, B_u0)                =  0.698 
    C(A_w0, C_u0)                = -0.698 
    C(A_i1, C_i1)                =  0.691 
    C(A_u0, C_u0)                =  0.690 
    C(A_u1, C_u1)                =  0.683 
    C(A_i1, B_w1)                = -0.680 
    C(A_i0, B_u1)                =  0.671 
    C(A_i1, B_w0)                = -0.670 
    C(A_i0, B_w1)                = -0.657 
    C(B_i0, B_i1)                =  0.640 
    C(A_w0, B_i0)                = -0.612 
    C(A_i0, C_w0)                =  0.611 
    C(B_i1, B_u0)                = -0.600 
    C(B_i0, B_w1)                =  0.600 
    C(B_i1, B_w0)                =  0.598 
    C(B_i0, B_u1)                = -0.587 
    C(A_i1, C_i0)                =  0.573 
    C(A_w1, B_i1)                = -0.572 
    C(A_u0, A_w0)                = -0.565 
    C(A_w0, B_u0)                =  0.554 
    C(B_u0, B_w1)                = -0.554 
    C(A_u1, A_w1)                = -0.554 
    C(A_i1, A_w0)                =  0.545 
    C(B_u0, B_u1)                =  0.543 
    C(B_u1, B_w0)                = -0.537 
    C(A_i0, A_u0)                = -0.533 
    C(B_w0, B_w1)                =  0.529 
    C(A_i1, A_u1)                = -0.528 
    C(A_i0, A_w1)                =  0.517 
    C(A_w1, B_u1)                =  0.503 
    C(A_i1, C_w1)                =  0.503 
    C(A_i0, C_i1)                =  0.498 
    C(A_i1, C_w0)                =  0.486 
    C(B_i1, C_i0)                = -0.485 
    C(A_w0, B_i1)                = -0.473 
    C(B_w1, C_i0)                = -0.468 
    C(A_u0, B_w0)                =  0.457 
    C(A_w1, B_i0)                = -0.456 
    C(A_w0, B_u1)                =  0.455 
    C(A_u0, B_i0)                =  0.453 
    C(A_i0, A_u1)                = -0.452 
    C(A_i1, A_u0)                = -0.450 
    C(A_u0, B_u0)                = -0.446 
    C(A_w1, B_u0)                =  0.446 
    C(A_u1, B_w1)                =  0.444 
    C(A_u1, B_i0)                =  0.442 
    C(A_i0, C_u0)                = -0.441 
    C(A_u1, B_w0)                =  0.439 
    C(A_w0, A_w1)                =  0.439 
    C(A_i1, C_u1)                = -0.438 
    C(A_u1, B_i1)                =  0.435 
    C(A_u0, B_i1)                =  0.431 
    C(A_u1, B_u0)                = -0.430 
    C(A_u0, A_u1)                =  0.429 
    C(A_u0, B_w1)                =  0.429 
    C(A_w0, B_w1)                = -0.429 
    C(B_i0, C_i1)                = -0.425 
    C(B_u1, C_i0)                =  0.425 
    C(A_u1, B_u1)                = -0.422 
    C(B_i1, C_w0)                = -0.417 
    C(C_u0, C_u1)                =  0.415 
    C(A_w1, B_w0)                = -0.413 
    C(A_u0, B_u1)                = -0.412 
    C(B_w0, C_i1)                = -0.410 
    C(A_i0, C_w1)                =  0.400 
    C(B_w1, C_w0)                = -0.397 
    C(B_u0, C_i1)                =  0.380 
    C(B_u1, C_w0)                =  0.362 
    C(A_u1, C_i0)                = -0.362 
    C(B_i0, C_w1)                = -0.349 
    C(A_w1, C_u0)                = -0.333 
    C(A_w0, C_i0)                =  0.333 
    C(B_w0, C_w1)                = -0.330 
    C(A_w1, C_i0)                =  0.328 
    C(A_w0, C_u1)                = -0.327 
    C(A_u1, A_w0)                = -0.327 
    C(A_u0, C_i1)                = -0.316 
    C(A_u0, A_w1)                = -0.312 
    C(A_w0, B_w0)                = -0.310 
    C(B_u0, C_w1)                =  0.308 
    C(A_i1, C_u0)                = -0.303 
    C(C_i0, C_i1)                =  0.298 
    C(A_w0, C_i1)                =  0.296 
    C(A_i0, C_u1)                = -0.284 
    C(C_w0, C_w1)                =  0.278 
    C(A_u1, C_u0)                =  0.275 
    C(A_u0, C_i0)                = -0.275 
    C(A_u1, C_w0)                = -0.275 
    C(C_i1, C_w0)                =  0.272 
    C(A_u0, C_u1)                =  0.268 
    C(B_i0, C_u0)                =  0.260 
    C(C_i0, C_w1)                =  0.260 
    C(A_w1, C_w0)                =  0.259 
    C(A_w1, B_w1)                = -0.245 
    C(B_i1, C_u1)                =  0.240 
    C(C_u1, C_w1)                =  0.236 
    C(B_u0, C_u0)                = -0.225 
    C(A_w1, C_i1)                =  0.221 
    C(A_w0, C_w1)                =  0.218 
    C(A_u0, C_w1)                = -0.217 
    C(B_i1, C_u0)                =  0.215 
    C(A_u1, C_i1)                = -0.205 
    C(B_i0, C_u1)                =  0.204 
    C(B_u1, C_u1)                = -0.200 
    C(B_u1, C_u0)                = -0.200 
    C(B_u0, C_u1)                = -0.193 
    C(C_u0, C_w0)                =  0.154 
    C(A_w0, C_w0)                =  0.151 
    C(B_w1, C_u0)                =  0.147 
    C(B_w0, C_u1)                =  0.139 
    C(B_w0, C_u0)                =  0.129 
    C(B_w1, C_u1)                =  0.103 
    C(C_i0, C_u1)                = -0.092 
    C(A_u0, C_w0)                = -0.082 
    C(C_i1, C_u0)                = -0.071 
    C(C_i1, C_u1)                =  0.046 
    C(C_i0, C_u0)                = -0.023 
    C(A_w1, C_w1)                =  0.022 
    C(C_u1, C_w0)                = -0.022 
    C(A_u1, C_w1)                =  0.010 
    C(C_u0, C_w1)                =  0.006 
#+end_example

*** [S III] line
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-S_III_6312 --min-fraction 0.05 --ylo -6.5 -4  --yhi 5 7 --ncomp 3 --compA 1500.0 17.0 5.0 --compB 600.0 24.0 5.0 --compC 300.0 3.0 3.0 --linear-components ABC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     1004.516208 +/- 56.801109 (5.65%) initial =  1500.000000
  A_i1:     36.860593 +/- 66.240245 (179.70%) initial =  0.000000
  A_i2:    -24.462744 +/- 37.924020 (155.03%) initial =  0.000000
  A_u0:     12.769768 +/- 0.095006 (0.74%) initial =  17.000000
  A_u1:    -1.424997 +/- 0.120323 (8.44%) initial =  0.000000
  A_u2:    fixed
  A_w0:     5.083596 +/- 0.136858 (2.69%) initial =  5.000000
  A_w1:     0.372794 +/- 0.172056 (46.15%) initial =  0.000000
  A_w2:    fixed
  B_i0:     1010.099519 +/- 95.030694 (9.41%) initial =  600.000000
  B_i1:     383.684175 +/- 99.930086 (26.04%) initial =  0.000000
  B_i2:    -110.170335 +/- 68.386115 (62.07%) initial =  0.000000
  B_u0:     19.025520 +/- 1.508911 (7.93%) initial =  24.000000
  B_u1:    -2.644712 +/- 1.746529 (66.04%) initial =  0.000000
  B_u2:    fixed
  B_w0:     13.914229 +/- 0.932862 (6.70%) initial =  5.000000
  B_w1:    -0.295819 +/- 1.089978 (368.46%) initial =  0.000000
  B_w2:    fixed
  C_i0:     336.266487 +/- 41.796745 (12.43%) initial =  300.000000
  C_i1:    -105.309012 +/- 43.655448 (41.45%) initial =  0.000000
  C_i2:    -16.073940 +/- 23.303607 (144.98%) initial =  0.000000
  C_u0:    -0.187991 +/- 0.160112 (85.17%) initial =  3.000000
  C_u1:    -1.817968 +/- 0.198156 (10.90%) initial =  0.000000
  C_u2:    fixed
  C_w0:     3.541206 +/- 0.226824 (6.41%) initial =  3.000000
  C_w1:    -0.793609 +/- 0.268818 (33.87%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(B_i0, B_u0)                = -0.917 
    C(C_i1, C_w1)                =  0.895 
    C(C_i0, C_w0)                =  0.890 
    C(B_i1, B_u1)                = -0.862 
    C(B_u0, C_i0)                =  0.859 
    C(A_i1, A_w1)                =  0.850 
    C(B_i0, C_i0)                = -0.838 
    C(B_u1, C_i1)                =  0.823 
    C(A_i1, B_i1)                = -0.821 
    C(A_i0, B_i0)                = -0.818 
    C(A_i0, A_w0)                =  0.812 
    C(B_w0, C_i0)                = -0.808 
    C(B_i1, C_i1)                = -0.773 
    C(A_i2, B_i2)                = -0.773 
    C(B_w1, C_i1)                = -0.770 
    C(A_i0, B_u0)                =  0.742 
    C(B_w0, C_w0)                = -0.698 
    C(B_w0, B_w1)                = -0.690 
    C(B_i0, C_w0)                = -0.675 
    C(B_u0, C_w0)                =  0.672 
    C(A_i1, B_u1)                =  0.653 
    C(B_w1, C_w1)                = -0.651 
    C(B_u1, C_w1)                =  0.637 
    C(B_u0, B_u1)                = -0.630 
    C(A_w0, C_u0)                = -0.627 
    C(B_i1, C_w1)                = -0.623 
    C(B_i0, B_w0)                =  0.620 
    C(A_w1, C_u1)                = -0.611 
    C(B_u0, B_w0)                = -0.607 
    C(A_u0, C_u0)                =  0.592 
    C(A_u1, C_u1)                =  0.576 
    C(B_w1, C_i0)                =  0.570 
    C(B_u1, B_w1)                = -0.569 
    C(B_w0, C_i1)                =  0.520 
    C(A_w1, B_i1)                = -0.517 
    C(B_u1, C_i0)                = -0.515 
    C(B_i1, B_w1)                =  0.506 
    C(B_i2, B_u1)                = -0.491 
    C(C_i0, C_i1)                = -0.482 
    C(B_u0, B_w1)                =  0.478 
    C(B_i0, B_w1)                = -0.471 
    C(C_i0, C_i2)                = -0.470 
    C(B_u1, B_w0)                =  0.470 
    C(A_i1, C_u1)                = -0.455 
    C(A_i2, B_u1)                =  0.452 
    C(B_i2, C_i2)                = -0.447 
    C(B_u0, C_i1)                = -0.447 
    C(A_i0, C_i0)                =  0.444 
    C(A_w0, B_i0)                = -0.444 
    C(A_i0, C_u0)                = -0.435 
    C(B_i0, B_i2)                = -0.435 
    C(B_w1, C_w0)                =  0.418 
    C(B_i0, B_u1)                =  0.417 
    C(B_i2, C_i1)                = -0.407 
    C(B_u1, C_i2)                =  0.400 
    C(B_i2, C_i0)                =  0.387 
    C(B_i2, B_u0)                =  0.382 
    C(B_u0, C_i2)                = -0.378 
    C(A_u1, C_w0)                = -0.375 
    C(B_w0, C_w1)                =  0.373 
    C(A_u0, C_w1)                = -0.364 
    C(B_i2, B_w1)                =  0.360 
    C(B_i0, C_i2)                =  0.358 
    C(B_i1, B_w0)                = -0.355 
    C(A_w1, B_u1)                =  0.352 
    C(A_w0, B_u0)                =  0.350 
    C(A_i1, C_i1)                =  0.345 
    C(B_i2, B_w0)                = -0.344 
    C(C_i0, C_w1)                = -0.340 
    C(C_i1, C_w0)                = -0.340 
    C(B_i2, C_w1)                = -0.332 
    C(A_i2, C_i1)                =  0.332 
    C(B_w0, C_i2)                =  0.330 
    C(A_u0, C_i1)                = -0.330 
    C(A_i2, B_u0)                = -0.318 
    C(A_i2, B_i0)                =  0.316 
    C(B_i1, B_i2)                =  0.315 
    C(B_w1, C_i2)                = -0.313 
    C(A_u1, C_i0)                = -0.312 
    C(A_i2, B_i1)                = -0.306 
    C(B_u1, C_w0)                = -0.306 
    C(B_i0, C_i1)                =  0.305 
    C(C_u0, C_u1)                = -0.302 
    C(C_u1, C_w0)                = -0.302 
    C(C_u0, C_w1)                = -0.300 
    C(C_u0, C_w0)                =  0.288 
    C(A_i2, C_i2)                =  0.283 
    C(C_u1, C_w1)                =  0.280 
    C(A_i0, C_w0)                =  0.276 
    C(B_i1, C_i2)                = -0.274 
    C(A_i0, A_i2)                = -0.270 
    C(B_u0, C_w1)                = -0.268 
    C(B_i1, B_u0)                =  0.267 
    C(A_i0, A_i1)                =  0.266 
    C(A_i2, C_i0)                = -0.265 
    C(A_i2, C_w1)                =  0.263 
    C(C_i2, C_w0)                = -0.263 
    C(A_u0, A_w0)                = -0.261 
    C(C_i1, C_u0)                = -0.258 
    C(A_i0, B_i2)                =  0.247 
    C(B_i2, C_w0)                =  0.246 
    C(A_i1, A_w0)                =  0.240 
    C(A_u1, A_w1)                = -0.240 
    C(C_i1, C_i2)                =  0.238 
    C(A_i1, A_i2)                =  0.237 
    C(A_w0, B_i1)                = -0.236 
    C(B_i1, C_i0)                =  0.233 
    C(A_u0, C_u1)                = -0.231 
    C(C_i0, C_u1)                = -0.229 
    C(A_u1, C_u0)                = -0.229 
    C(A_i0, B_u1)                = -0.227 
    C(A_w1, B_w1)                =  0.225 
    C(C_i2, C_w1)                =  0.223 
    C(C_w0, C_w1)                = -0.219 
    C(B_i1, C_u1)                =  0.219 
    C(A_i1, B_i2)                = -0.211 
    C(A_i1, C_w1)                =  0.206 
    C(A_w0, B_w0)                =  0.205 
    C(A_i0, C_i2)                = -0.201 
    C(A_i2, B_w0)                =  0.197 
    C(A_u1, B_w0)                =  0.196 
    C(A_i0, A_w1)                =  0.191 
    C(A_i0, B_w1)                =  0.189 
    C(A_i2, A_w1)                =  0.189 
    C(A_i2, B_w1)                = -0.186 
    C(A_w1, B_i0)                = -0.184 
    C(A_i1, C_i2)                =  0.183 
    C(A_u1, B_i0)                =  0.183 
    C(C_i1, C_u1)                =  0.181 
    C(A_i1, A_u1)                = -0.181 
    C(B_i0, C_u0)                =  0.179 
    C(A_u0, B_i1)                =  0.176 
    C(A_i0, A_u0)                = -0.176 
    C(A_u1, B_u0)                = -0.175 
    C(A_w0, A_w1)                =  0.174 
    C(A_u0, B_w0)                =  0.174 
    C(A_w0, C_w1)                =  0.171 
    C(A_i1, B_i0)                = -0.169 
    C(A_w1, C_w0)                =  0.168 
    C(A_u1, B_w1)                =  0.164 
    C(B_i0, C_w1)                =  0.162 
    C(A_u0, B_w1)                =  0.162 
    C(C_i0, C_u0)                =  0.160 
    C(A_i0, B_i1)                = -0.158 
    C(A_u1, B_i1)                =  0.156 
    C(A_i2, C_w0)                = -0.155 
    C(A_w0, C_w0)                = -0.153 
    C(A_u1, A_w0)                =  0.153 
    C(A_w0, C_i1)                =  0.153 
    C(A_w1, C_w1)                = -0.151 
    C(A_u0, A_w1)                =  0.151 
    C(A_u0, B_u1)                = -0.147 
    C(A_u0, C_w0)                =  0.143 
    C(A_w0, C_u1)                =  0.140 
    C(A_u1, C_w1)                =  0.135 
    C(A_u0, B_i0)                =  0.135 
    C(A_w1, C_u0)                =  0.133 
    C(B_w0, C_u1)                =  0.132 
    C(B_u1, C_u1)                = -0.131 
    C(B_u0, C_u0)                = -0.130 
    C(A_i0, B_w0)                = -0.124 
    C(A_i1, C_w0)                =  0.123 
    C(A_w1, C_i0)                =  0.122 
    C(A_w1, B_i2)                = -0.122 
    C(B_w1, C_u0)                =  0.121 
    C(B_i1, C_u0)                =  0.116 
    C(A_u0, B_u0)                = -0.114 
    C(B_i0, C_u1)                =  0.108 
    C(A_u1, B_u1)                = -0.103 
    C(A_w1, C_i2)                =  0.101 
    C(A_i1, B_w0)                =  0.099 
    C(B_w1, C_u1)                = -0.087 
    C(B_w0, C_u0)                = -0.085 
    C(B_i1, C_w0)                =  0.081 
    C(A_i1, B_u0)                = -0.073 
    C(A_u0, A_u1)                =  0.064 
    C(A_u1, C_i1)                =  0.053 
    C(B_u0, C_u1)                = -0.049 
    C(A_i0, C_w1)                =  0.048 
    C(A_w1, B_w0)                = -0.048 
    C(A_i2, C_u1)                = -0.045 
    C(C_i2, C_u1)                = -0.044 
    C(A_i0, C_i1)                = -0.044 
    C(A_u0, B_i2)                =  0.043 
    C(A_w1, C_i1)                = -0.042 
    C(A_u0, C_i0)                =  0.041 
    C(A_i2, A_u0)                = -0.040 
    C(A_w0, B_w1)                = -0.038 
    C(B_u1, C_u0)                = -0.034 
    C(B_i0, B_i1)                = -0.033 
    C(A_i0, C_u1)                =  0.033 
    C(A_i1, C_u0)                =  0.029 
    C(A_w0, C_i2)                = -0.028 
    C(B_i2, C_u1)                =  0.028 
    C(A_i2, A_w0)                = -0.027 
    C(B_i2, C_u0)                =  0.022 
    C(A_w0, C_i0)                = -0.022 
    C(A_u1, C_i2)                = -0.022 
    C(A_i1, C_i0)                =  0.021 
    C(A_i1, A_u0)                =  0.021 
    C(A_i2, A_u1)                =  0.016 
    C(A_u1, B_i2)                =  0.012 
    C(A_w1, B_u0)                =  0.010 
    C(A_w0, B_u1)                = -0.010 
    C(C_i2, C_u0)                =  0.005 
    C(A_i1, B_w1)                = -0.004 
    C(A_u0, C_i2)                = -0.002 
    C(A_w0, B_i2)                =  0.002 
    C(A_i0, A_u1)                = -0.002 
    C(A_i2, C_u0)                =  0.001 
#+end_example

*** He I lines
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-He_I_S_6678 --vrange -30 60 --min-fraction 0.05 --ylo -6.5 -3.5 --yhi 4.5 6.5 --ncomp 3 --compA 2000.0 5.0 5.0 --compB 3000 15.0 7.0 --compC 1000 30.0 10.0 --linear-components ABC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     2532.902451 +/- 390.717170 (15.43%) initial =  2000.000000
  A_i1:     663.273454 +/- 208.716191 (31.47%) initial =  0.000000
  A_i2:    -79.339596 +/- 31.623242 (39.86%) initial =  0.000000
  A_u0:     1.807888 +/- 0.530456 (29.34%) initial =  5.000000
  A_u1:    -0.453822 +/- 0.413855 (91.19%) initial =  0.000000
  A_u2:    fixed
  A_w0:     6.588666 +/- 0.161183 (2.45%) initial =  5.000000
  A_w1:     0.236060 +/- 0.124190 (52.61%) initial =  0.000000
  A_w2:    fixed
  B_i0:     2627.708972 +/- 475.589154 (18.10%) initial =  3000.000000
  B_i1:     38.381150 +/- 205.311234 (534.93%) initial =  0.000000
  B_i2:    -43.796891 +/- 52.528496 (119.94%) initial =  0.000000
  B_u0:     13.347151 +/- 0.941076 (7.05%) initial =  15.000000
  B_u1:     1.464590 +/- 0.575618 (39.30%) initial =  0.000000
  B_u2:    fixed
  B_w0:     8.031193 +/- 0.632990 (7.88%) initial =  7.000000
  B_w1:     1.000000 +/- 0.171807 (17.18%) initial =  0.000000
  B_w2:    fixed
  C_i0:     793.814782 +/- 112.938369 (14.23%) initial =  1000.000000
  C_i1:     75.399020 +/- 60.011836 (79.59%) initial =  0.000000
  C_i2:    -266.266330 +/- 41.605125 (15.63%) initial =  0.000000
  C_u0:     33.203092 +/- 1.520606 (4.58%) initial =  30.000000
  C_u1:     3.037086 +/- 0.946586 (31.17%) initial =  0.000000
  C_u2:    fixed
  C_w0:     10.098221 +/- 0.772622 (7.65%) initial =  10.000000
  C_w1:    -1.000000 +/- 0.534104 (53.41%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(A_i0, A_u0)                =  0.989 
    C(B_i0, B_w0)                =  0.987 
    C(A_i0, B_i0)                = -0.986 
    C(C_i0, C_u0)                = -0.985 
    C(A_i0, B_u0)                =  0.977 
    C(A_u0, B_u0)                =  0.975 
    C(A_i1, A_u1)                =  0.966 
    C(A_u0, B_i0)                = -0.964 
    C(A_i1, B_i1)                = -0.961 
    C(A_i0, B_w0)                = -0.959 
    C(A_u0, A_w0)                =  0.959 
    C(C_i0, C_w0)                =  0.952 
    C(C_u0, C_w0)                = -0.942 
    C(A_u1, B_i1)                = -0.940 
    C(A_w0, B_u0)                =  0.937 
    C(A_i0, A_w0)                =  0.936 
    C(B_i0, B_u0)                = -0.932 
    C(A_u0, B_w0)                = -0.919 
    C(A_i1, B_u1)                =  0.909 
    C(B_u0, B_w0)                = -0.893 
    C(A_w0, B_i0)                = -0.891 
    C(A_i1, A_w1)                =  0.872 
    C(C_u1, C_w1)                =  0.856 
    C(B_w0, C_i0)                = -0.854 
    C(C_i1, C_w1)                = -0.854 
    C(C_i1, C_u1)                = -0.853 
    C(A_u1, A_w1)                =  0.849 
    C(A_u0, A_u1)                = -0.845 
    C(B_w0, C_u0)                =  0.840 
    C(A_u1, B_u1)                =  0.823 
    C(A_w0, B_w0)                = -0.822 
    C(A_u1, B_i0)                =  0.819 
    C(A_i0, A_u1)                = -0.814 
    C(B_i0, C_i0)                = -0.813 
    C(A_w1, B_i1)                = -0.813 
    C(B_i0, C_u0)                =  0.800 
    C(A_w1, B_u1)                =  0.793 
    C(B_i1, B_u1)                = -0.789 
    C(A_u1, A_w0)                = -0.777 
    C(A_u1, B_w0)                =  0.777 
    C(A_u0, B_i1)                =  0.756 
    C(A_u1, B_u0)                = -0.738 
    C(B_i2, C_i0)                =  0.735 
    C(B_i2, C_u0)                = -0.735 
    C(B_i0, B_i1)                = -0.734 
    C(A_i0, B_i1)                =  0.725 
    C(A_i1, A_u0)                = -0.722 
    C(B_w0, C_w0)                = -0.715 
    C(A_i0, C_i0)                =  0.709 
    C(A_i1, B_i0)                =  0.706 
    C(B_i2, B_w0)                = -0.703 
    C(B_i0, B_i2)                = -0.699 
    C(A_i0, C_u0)                = -0.694 
    C(B_i2, C_w0)                =  0.693 
    C(A_i0, A_i1)                = -0.688 
    C(B_i1, B_w0)                = -0.688 
    C(B_i0, C_w0)                = -0.684 
    C(A_w0, B_i1)                =  0.678 
    C(A_i1, B_w0)                =  0.669 
    C(C_i0, C_i2)                = -0.667 
    C(B_i2, C_i2)                = -0.663 
    C(B_i1, B_u0)                =  0.655 
    C(A_u0, C_i0)                =  0.649 
    C(A_u1, C_i0)                = -0.642 
    C(A_i0, B_i2)                =  0.642 
    C(A_i1, A_w0)                = -0.640 
    C(C_i2, C_u0)                =  0.636 
    C(A_u0, C_u0)                = -0.632 
    C(C_i2, C_w0)                = -0.630 
    C(A_u1, C_u0)                =  0.622 
    C(A_u0, B_i2)                =  0.600 
    C(A_i1, C_i0)                = -0.598 
    C(A_i1, B_u0)                = -0.595 
    C(A_i2, B_i2)                = -0.595 
    C(B_i1, C_i0)                =  0.592 
    C(B_i1, C_u0)                = -0.588 
    C(A_i1, C_u0)                =  0.580 
    C(A_i0, C_w0)                =  0.566 
    C(B_i2, B_u0)                =  0.560 
    C(B_u0, C_i0)                =  0.557 
    C(A_u0, A_w1)                = -0.553 
    C(B_w0, C_i2)                =  0.553 
    C(B_u1, C_i0)                = -0.548 
    C(B_u0, C_u0)                = -0.542 
    C(B_i0, C_i2)                =  0.540 
    C(A_w0, B_i2)                =  0.537 
    C(A_w0, C_i0)                =  0.533 
    C(A_w0, A_w1)                = -0.531 
    C(A_u1, C_w0)                = -0.530 
    C(B_u1, C_u0)                =  0.524 
    C(A_w0, C_u0)                = -0.518 
    C(A_u0, C_w0)                =  0.510 
    C(B_i1, C_w0)                =  0.508 
    C(A_u1, B_i2)                = -0.504 
    C(A_i1, C_w0)                = -0.504 
    C(A_w1, B_i0)                =  0.501 
    C(A_i0, A_w1)                = -0.496 
    C(B_u1, C_w0)                = -0.490 
    C(B_i0, B_u1)                =  0.478 
    C(A_i0, C_i2)                = -0.476 
    C(B_i1, B_i2)                =  0.472 
    C(B_i2, C_u1)                =  0.471 
    C(B_u1, B_w0)                =  0.470 
    C(A_w1, B_w0)                =  0.451 
    C(A_u0, B_u1)                = -0.451 
    C(B_u1, C_i1)                = -0.445 
    C(A_u0, C_i2)                = -0.442 
    C(A_u1, C_i2)                =  0.436 
    C(A_i0, B_u1)                = -0.425 
    C(B_i2, C_w1)                =  0.423 
    C(A_i1, B_i2)                = -0.420 
    C(A_w1, B_u0)                = -0.417 
    C(B_i1, B_w1)                =  0.413 
    C(A_w0, C_w0)                =  0.410 
    C(B_i1, C_i2)                = -0.406 
    C(B_u0, C_w0)                =  0.405 
    C(A_w1, C_i0)                = -0.399 
    C(B_u0, C_u1)                =  0.398 
    C(A_i1, C_i2)                =  0.395 
    C(C_u0, C_u1)                = -0.394 
    C(B_i0, C_u1)                = -0.393 
    C(B_u0, C_i2)                = -0.382 
    C(A_w1, C_u0)                =  0.381 
    C(A_i0, C_u1)                =  0.380 
    C(A_w0, C_i2)                = -0.377 
    C(B_w0, C_u1)                = -0.377 
    C(C_u1, C_w0)                =  0.364 
    C(A_w0, B_u1)                = -0.356 
    C(C_i0, C_u1)                =  0.348 
    C(A_u0, C_u1)                =  0.347 
    C(A_i2, C_u1)                = -0.345 
    C(B_u1, C_i2)                =  0.339 
    C(A_w1, C_w0)                = -0.335 
    C(A_i1, B_w1)                = -0.331 
    C(B_i1, C_u1)                =  0.329 
    C(A_w0, C_u1)                =  0.322 
    C(B_u0, C_w1)                =  0.320 
    C(A_i2, C_w1)                = -0.319 
    C(C_w0, C_w1)                =  0.317 
    C(C_u0, C_w1)                = -0.312 
    C(B_u1, B_w1)                = -0.310 
    C(B_i0, C_w1)                = -0.308 
    C(A_w1, B_i2)                = -0.303 
    C(A_i0, C_w1)                =  0.298 
    C(A_w1, C_i2)                =  0.293 
    C(A_i2, C_i2)                =  0.293 
    C(B_w0, C_w1)                = -0.291 
    C(B_w1, C_i1)                = -0.287 
    C(B_u0, B_u1)                = -0.285 
    C(C_i2, C_u1)                = -0.285 
    C(A_i2, B_i0)                =  0.279 
    C(B_i2, B_u1)                = -0.279 
    C(B_i1, C_w1)                =  0.276 
    C(A_i2, B_w0)                =  0.275 
    C(A_i0, A_i2)                = -0.275 
    C(A_u0, C_w1)                =  0.274 
    C(C_i0, C_w1)                =  0.274 
    C(C_i2, C_w1)                = -0.273 
    C(A_i2, B_u0)                = -0.267 
    C(A_w0, C_w1)                =  0.260 
    C(B_w0, B_w1)                =  0.260 
    C(A_i2, C_u0)                =  0.255 
    C(A_i2, C_i0)                = -0.249 
    C(A_i2, C_i1)                =  0.246 
    C(A_i2, A_u0)                = -0.242 
    C(A_i2, A_w0)                = -0.242 
    C(A_i2, C_w0)                = -0.234 
    C(A_w1, B_w1)                = -0.228 
    C(B_w1, C_i0)                = -0.223 
    C(B_u1, C_w1)                =  0.220 
    C(B_u1, C_u1)                =  0.215 
    C(B_w1, C_u0)                =  0.202 
    C(B_i2, B_w1)                = -0.197 
    C(B_i0, B_w1)                =  0.197 
    C(A_w1, C_i1)                = -0.192 
    C(B_u0, C_i1)                = -0.183 
    C(A_i2, B_w1)                =  0.183 
    C(A_i0, B_w1)                = -0.178 
    C(B_w1, C_w0)                = -0.175 
    C(B_i2, C_i1)                = -0.174 
    C(B_u0, B_w1)                = -0.173 
    C(B_w1, C_u1)                =  0.151 
    C(A_u1, B_w1)                = -0.151 
    C(A_i1, C_i1)                = -0.150 
    C(B_w1, C_i2)                =  0.142 
    C(A_u1, C_u1)                = -0.140 
    C(A_w0, B_w1)                = -0.130 
    C(A_i2, B_u1)                = -0.122 
    C(A_u0, B_w1)                = -0.121 
    C(A_u1, C_i1)                = -0.117 
    C(B_i1, C_i1)                = -0.115 
    C(A_w0, C_i1)                = -0.111 
    C(A_u1, C_w1)                = -0.106 
    C(A_i0, C_i1)                = -0.102 
    C(A_u0, C_i1)                = -0.092 
    C(A_i1, C_u1)                = -0.085 
    C(A_i2, A_u1)                =  0.080 
    C(B_w1, C_w1)                =  0.079 
    C(B_i0, C_i1)                =  0.073 
    C(A_i2, B_i1)                = -0.070 
    C(C_i0, C_i1)                =  0.049 
    C(A_i1, C_w1)                = -0.047 
    C(B_w0, C_i1)                =  0.039 
    C(A_w1, C_u1)                =  0.023 
    C(A_i2, A_w1)                = -0.013 
    C(C_i1, C_i2)                = -0.008 
    C(A_i1, A_i2)                = -0.006 
    C(C_i1, C_w0)                =  0.005 
    C(A_w1, C_w1)                =  0.004 
    C(C_i1, C_u0)                =  0.004 
#+end_example

#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-He_I_T_5876 --vrange -30 60 --min-fraction 0.05 --ylo -6.5 -3.5 --yhi 4.5 6.5 --ncomp 3 --compA 2000.0 5.0 5.0 --compB 3000 15.0 7.0 --compC 1000 30.0 10.0 --linear-components ABC
#+END_SRC

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     4606.989722 +/- 773.383193 (16.79%) initial =  2000.000000
  A_i1:     128.214486 +/- 357.507747 (278.84%) initial =  0.000000
  A_i2:    -482.270587 +/- 99.275187 (20.58%) initial =  0.000000
  A_u0:     2.451464 +/- 0.770494 (31.43%) initial =  5.000000
  A_u1:    -1.884622 +/- 0.545445 (28.94%) initial =  0.000000
  A_u2:    fixed
  A_w0:     6.855064 +/- 0.230552 (3.36%) initial =  5.000000
  A_w1:    -0.328448 +/- 0.175207 (53.34%) initial =  0.000000
  A_w2:    fixed
  B_i0:     3697.554003 +/- 1179.025066 (31.89%) initial =  3000.000000
  B_i1:     1643.076995 +/- 284.438872 (17.31%) initial =  0.000000
  B_i2:    -83.624755 +/- 220.119301 (263.22%) initial =  0.000000
  B_u0:     14.088896 +/- 1.233901 (8.76%) initial =  15.000000
  B_u1:    -0.248871 +/- 0.936899 (376.46%) initial =  0.000000
  B_u2:    fixed
  B_w0:     7.630742 +/- 0.858579 (11.25%) initial =  7.000000
  B_w1:     1.000000 +/- 0.064742 (6.47%) initial =  0.000000
  B_w2:    fixed
  C_i0:     2520.025163 +/- 538.226405 (21.36%) initial =  1000.000000
  C_i1:    -18.933493 +/- 262.874584 (1388.41%) initial =  0.000000
  C_i2:    -764.161985 +/- 159.067240 (20.82%) initial =  0.000000
  C_u0:     28.959271 +/- 2.529573 (8.73%) initial =  30.000000
  C_u1:     4.325468 +/- 1.395696 (32.27%) initial =  0.000000
  C_u2:    fixed
  C_w0:     11.788245 +/- 1.031903 (8.75%) initial =  10.000000
  C_w1:    -1.000000 +/- 0.682050 (68.21%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(C_i0, C_u0)                = -0.996 
    C(A_i0, A_u0)                =  0.994 
    C(B_i0, B_w0)                =  0.989 
    C(A_i0, B_u0)                =  0.987 
    C(A_u0, B_u0)                =  0.982 
    C(C_i1, C_u1)                = -0.973 
    C(C_u0, C_w0)                = -0.968 
    C(C_i0, C_w0)                =  0.964 
    C(A_u0, A_w0)                =  0.962 
    C(A_u1, B_u1)                =  0.959 
    C(A_i0, A_w0)                =  0.955 
    C(A_w0, B_u0)                =  0.952 
    C(A_u0, B_i0)                = -0.937 
    C(A_i0, B_i0)                = -0.935 
    C(A_i0, B_w0)                = -0.926 
    C(A_i1, A_w1)                =  0.918 
    C(A_u0, B_w0)                = -0.915 
    C(C_i1, C_w1)                = -0.914 
    C(B_i2, C_i0)                =  0.899 
    C(B_i0, B_i2)                = -0.895 
    C(C_u1, C_w1)                =  0.889 
    C(B_i2, C_u0)                = -0.888 
    C(B_i0, B_u0)                = -0.885 
    C(B_u0, B_w0)                = -0.877 
    C(B_i2, C_i2)                = -0.873 
    C(B_i2, B_w0)                = -0.872 
    C(C_i0, C_i2)                = -0.862 
    C(B_i0, C_i0)                = -0.857 
    C(A_u1, A_w1)                =  0.854 
    C(C_i2, C_u0)                =  0.852 
    C(A_i1, A_u1)                =  0.848 
    C(A_i1, B_u1)                =  0.846 
    C(B_w0, C_i0)                = -0.844 
    C(A_w0, B_i0)                = -0.843 
    C(B_i0, C_u0)                =  0.837 
    C(C_i2, C_w0)                = -0.835 
    C(B_i2, C_w0)                =  0.834 
    C(A_u0, A_u1)                = -0.832 
    C(B_w0, C_u0)                =  0.821 
    C(A_w1, B_u1)                =  0.805 
    C(A_w0, B_w0)                = -0.805 
    C(A_i0, A_u1)                = -0.802 
    C(A_u1, A_w0)                = -0.800 
    C(A_u1, B_u0)                = -0.775 
    C(A_i2, A_u0)                = -0.769 
    C(A_i2, B_i2)                = -0.768 
    C(A_i0, A_i2)                = -0.765 
    C(A_u0, B_i2)                =  0.761 
    C(A_u1, B_i0)                =  0.758 
    C(B_i0, C_w0)                = -0.754 
    C(A_i2, B_u0)                = -0.753 
    C(A_u0, B_u1)                = -0.752 
    C(A_i2, B_i0)                =  0.750 
    C(A_i0, B_i2)                =  0.747 
    C(B_i0, C_i2)                =  0.734 
    C(A_i2, B_w0)                =  0.733 
    C(B_i0, B_u1)                =  0.730 
    C(A_i0, B_u1)                = -0.726 
    C(A_i2, A_w0)                = -0.721 
    C(B_w0, C_w0)                = -0.720 
    C(B_w0, C_i2)                =  0.712 
    C(A_u1, B_w0)                =  0.711 
    C(A_i1, B_i1)                = -0.700 
    C(A_w0, B_u1)                = -0.692 
    C(B_u1, B_w0)                =  0.689 
    C(B_i2, B_u0)                =  0.687 
    C(A_w1, B_i1)                = -0.681 
    C(B_u0, B_u1)                = -0.678 
    C(B_i1, B_w1)                = -0.653 
    C(A_i2, A_u1)                =  0.653 
    C(A_u1, B_i1)                = -0.652 
    C(A_w0, B_i2)                =  0.648 
    C(A_u0, C_i0)                =  0.632 
    C(A_u1, B_i2)                = -0.632 
    C(A_i0, C_i0)                =  0.621 
    C(B_i2, B_u1)                = -0.621 
    C(A_u0, C_u0)                = -0.605 
    C(A_i1, C_i1)                = -0.598 
    C(A_i0, C_u0)                = -0.592 
    C(A_i2, B_u1)                =  0.583 
    C(A_i1, C_u1)                =  0.576 
    C(B_u1, C_i1)                = -0.568 
    C(B_u1, C_i0)                = -0.566 
    C(A_i2, C_i0)                = -0.556 
    C(B_u1, C_u0)                =  0.553 
    C(A_w0, A_w1)                = -0.546 
    C(A_u0, C_i2)                = -0.544 
    C(B_i1, B_u1)                = -0.541 
    C(A_i2, C_u0)                =  0.537 
    C(A_i0, C_i2)                = -0.531 
    C(A_i2, C_i2)                =  0.527 
    C(B_u0, C_i0)                =  0.527 
    C(A_u0, A_w1)                = -0.524 
    C(B_u1, C_w0)                = -0.521 
    C(A_u1, C_i0)                = -0.517 
    C(A_u0, C_w0)                =  0.513 
    C(A_u1, C_u0)                =  0.500 
    C(A_i1, A_w0)                = -0.499 
    C(A_w1, C_i1)                = -0.497 
    C(B_u0, C_u0)                = -0.497 
    C(B_u1, C_u1)                =  0.494 
    C(A_i0, C_w0)                =  0.489 
    C(B_u1, C_i2)                =  0.486 
    C(A_w0, C_i0)                =  0.486 
    C(B_u1, C_w1)                =  0.484 
    C(A_i1, C_w1)                =  0.484 
    C(A_i0, A_w1)                = -0.483 
    C(A_i1, A_u0)                = -0.479 
    C(A_w1, B_u0)                = -0.464 
    C(A_w0, C_u0)                = -0.460 
    C(A_i2, C_w0)                = -0.458 
    C(A_w1, C_u1)                =  0.456 
    C(B_u0, C_i2)                = -0.454 
    C(A_u1, C_i1)                = -0.449 
    C(A_u1, C_i2)                =  0.448 
    C(A_u1, C_w0)                = -0.448 
    C(A_i0, A_i1)                = -0.443 
    C(A_i1, B_u0)                = -0.436 
    C(A_w0, C_i2)                = -0.425 
    C(A_w1, B_i0)                =  0.401 
    C(A_i2, B_i1)                = -0.400 
    C(B_u0, C_w0)                =  0.397 
    C(A_i2, A_w1)                =  0.396 
    C(A_w0, B_i1)                =  0.380 
    C(A_u1, C_u1)                =  0.379 
    C(A_w1, C_w1)                =  0.378 
    C(A_w0, C_w0)                =  0.375 
    C(A_u0, B_i1)                =  0.371 
    C(A_u1, C_w1)                =  0.369 
    C(A_i1, B_w1)                =  0.363 
    C(B_i1, B_u0)                =  0.353 
    C(A_i1, A_i2)                =  0.341 
    C(A_w1, B_w0)                =  0.340 
    C(A_i1, B_i0)                =  0.327 
    C(A_i0, B_i1)                =  0.312 
    C(A_w1, B_i2)                = -0.303 
    C(B_i1, B_i2)                =  0.276 
    C(A_i1, B_w0)                =  0.276 
    C(A_w0, C_i1)                =  0.271 
    C(A_i0, C_i1)                =  0.270 
    C(A_i0, C_w1)                = -0.255 
    C(A_u0, C_i1)                =  0.252 
    C(B_i0, B_i1)                = -0.249 
    C(A_w0, C_w1)                = -0.235 
    C(A_u0, C_w1)                = -0.230 
    C(B_u0, C_i1)                =  0.214 
    C(A_w0, C_u1)                = -0.209 
    C(B_i0, C_w1)                =  0.208 
    C(B_w1, C_i1)                =  0.207 
    C(B_w0, C_w1)                =  0.206 
    C(A_i1, B_i2)                = -0.205 
    C(B_u1, B_w1)                =  0.204 
    C(B_i1, C_w1)                =  0.203 
    C(A_i0, C_u1)                = -0.199 
    C(B_i1, B_w0)                = -0.194 
    C(A_w1, C_i0)                = -0.188 
    C(A_u1, B_w1)                =  0.187 
    C(B_w1, C_u1)                = -0.181 
    C(B_i0, C_i1)                = -0.180 
    C(B_u0, C_w1)                = -0.180 
    C(A_w1, C_u0)                =  0.178 
    C(A_u0, C_u1)                = -0.176 
    C(A_w1, C_i2)                =  0.172 
    C(B_w0, C_i1)                = -0.171 
    C(A_w1, B_w1)                =  0.170 
    C(B_i1, C_u1)                =  0.164 
    C(A_w1, C_w0)                = -0.160 
    C(B_u0, C_u1)                = -0.151 
    C(B_i1, C_i1)                = -0.144 
    C(B_i2, C_u1)                =  0.128 
    C(C_u1, C_w0)                =  0.121 
    C(C_u0, C_u1)                = -0.118 
    C(B_w1, C_w1)                = -0.108 
    C(C_i2, C_u1)                = -0.103 
    C(C_i0, C_u1)                =  0.102 
    C(B_i1, C_i0)                =  0.101 
    C(B_i1, C_u0)                = -0.100 
    C(B_i1, C_i2)                = -0.093 
    C(A_i2, B_w1)                =  0.091 
    C(C_i0, C_w1)                = -0.091 
    C(B_i0, C_u1)                =  0.084 
    C(A_i1, C_i0)                = -0.083 
    C(B_w0, C_u1)                =  0.081 
    C(B_i1, C_w0)                =  0.077 
    C(A_i0, B_w1)                =  0.077 
    C(B_w0, B_w1)                = -0.076 
    C(A_i1, C_i2)                =  0.074 
    C(C_u0, C_w1)                =  0.074 
    C(A_i1, C_u0)                =  0.071 
    C(A_w0, B_w1)                =  0.071 
    C(B_i0, B_w1)                = -0.065 
    C(C_w0, C_w1)                = -0.060 
    C(A_i1, C_w0)                = -0.053 
    C(B_u0, B_w1)                =  0.052 
    C(C_i2, C_w1)                =  0.048 
    C(A_u0, B_w1)                =  0.043 
    C(B_i2, B_w1)                = -0.038 
    C(A_i2, C_i1)                = -0.037 
    C(B_w1, C_i0)                =  0.031 
    C(A_i2, C_u1)                = -0.031 
    C(B_w1, C_u0)                = -0.028 
    C(B_w1, C_w0)                =  0.024 
    C(B_w1, C_i2)                = -0.023 
    C(A_i2, C_w1)                =  0.021 
    C(B_i2, C_i1)                = -0.019 
    C(B_i2, C_w1)                = -0.014 
    C(C_i1, C_i2)                = -0.013 
    C(C_i1, C_u0)                =  0.009 
    C(C_i0, C_i1)                =  0.009 
    C(C_i1, C_w0)                = -0.008 
#+end_example

*** C II line
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-C_II_6578 --vrange -20 50 --min-fraction 0.05 --ylo -6 -3.5 --yhi 5.0 6.3 --ncomp 2 --compA 500.0 4.0 6.0 --compB 200.0 17.0 5.0 --linear-components ABC
#+END_SRC

#+RESULTS:
#+begin_example
%s. Could not estimate error-bars
  A_i0:     393.009797 +/- 0.000000 (0.00%) initial =  500.000000
  A_i1:     180.215588 +/- 0.000000 (0.00%) initial =  0.000000
  A_i2:    -76.006938 +/- 0.000000 (0.00%) initial =  0.000000
  A_u0:     4.937325 +/- 0.000000 (0.00%) initial =  4.000000
  A_u1:     0.508672 +/- 0.000000 (0.00%) initial =  0.000000
  A_u2:    -1.088267 +/- 0.000000 (0.00%) initial =  0.000000
  A_w0:     6.266890 +/- 0.000000 (0.00%) initial =  6.000000
  A_w1:     1.000000 +/- 0.000000 (0.00%) initial =  0.000000
  A_w2:    -0.234266 +/- 0.000000 (0.00%) initial =  0.000000
  B_i0:     297.897465 +/- 0.000000 (0.00%) initial =  200.000000
  B_i1:    -149.040023 +/- 0.000000 (0.00%) initial =  0.000000
  B_i2:     0.340871 +/- 0.000000 (0.00%) initial =  0.000000
  B_u0:     17.778607 +/- 0.000000 (0.00%) initial =  17.000000
  B_u1:     7.591727 +/- 0.000000 (0.00%) initial =  0.000000
  B_u2:    -0.317393 +/- 0.000000 (0.00%) initial =  0.000000
  B_w0:     9.187208 +/- 0.000000 (0.00%) initial =  5.000000
  B_w1:     1.000000 +/- 0.000000 (0.00%) initial =  0.000000
  B_w2:    -1.000000 +/- 0.000000 (0.00%) initial =  0.000000
Correlations:
#+end_example

*** [O III] lines
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p85-O_III_5007 --vrange -20 50 --min-fraction 0.02 --ylo -6.5 -3.5 --yhi 5.2 6.0 --ncomp 3 --compA 60000.0 5.0 5.0 --compB 90000 15.0 7.0 --compC 20000 30.0 10.0 --linear-components ABC --linear-intensity-components AB
#+END_SRC

This has a problem with the bright blob seen at the top of the slit, which we can't currently model, but that hardly effects the results.  It means we can't include much nebula above the proplyd though, which results in some deterioration of the fit quality compared with p84.  As a result, there are some negative parts in the middle. 

#+RESULTS:
#+begin_example
Tolerance seems to be too small.
  A_i0:     78864.114355 +/- 2447.803905 (3.10%) initial =  60000.000000
  A_i1:    -16170.751526 +/- 2633.497959 (16.29%) initial =  0.000000
  A_i2:    fixed
  A_u0:     4.167094 +/- 0.135966 (3.26%) initial =  5.000000
  A_u1:    -2.506186 +/- 0.143903 (5.74%) initial =  0.000000
  A_u2:    fixed
  A_w0:     5.750772 +/- 0.060057 (1.04%) initial =  5.000000
  A_w1:    -0.243142 +/- 0.068972 (28.37%) initial =  0.000000
  A_w2:    fixed
  B_i0:     80025.312237 +/- 4712.947059 (5.89%) initial =  90000.000000
  B_i1:     35542.951133 +/- 4544.414926 (12.79%) initial =  0.000000
  B_i2:    fixed
  B_u0:     16.244506 +/- 0.140159 (0.86%) initial =  15.000000
  B_u1:    -1.677038 +/- 0.168444 (10.04%) initial =  0.000000
  B_u2:    fixed
  B_w0:     6.392253 +/- 0.169643 (2.65%) initial =  7.000000
  B_w1:     1.000000 +/- 0.300006 (30.00%) initial =  0.000000
  B_w2:    fixed
  C_i0:     23363.320479 +/- 2896.757030 (12.40%) initial =  20000.000000
  C_i1:     4082.674551 +/- 2844.541807 (69.67%) initial =  0.000000
  C_i2:    -2733.368639 +/- 492.195876 (18.01%) initial =  0.000000
  C_u0:     32.538066 +/- 1.309205 (4.02%) initial =  30.000000
  C_u1:     1.385552 +/- 1.225447 (88.44%) initial =  0.000000
  C_u2:    fixed
  C_w0:     10.504560 +/- 0.863150 (8.22%) initial =  10.000000
  C_w1:     0.465714 +/- 0.869710 (186.75%) initial =  0.000000
  C_w2:    fixed
Correlations:
    C(C_i0, C_u0)                = -0.987 
    C(A_i0, A_u0)                =  0.987 
    C(B_i0, B_w0)                =  0.985 
    C(C_i0, C_w0)                =  0.979 
    C(A_i1, A_u1)                =  0.974 
    C(C_i1, C_u1)                = -0.970 
    C(B_i1, B_w1)                = -0.968 
    C(C_u0, C_w0)                = -0.960 
    C(C_i1, C_w1)                =  0.959 
    C(A_u0, A_w0)                =  0.937 
    C(A_i0, A_w0)                =  0.937 
    C(A_i0, B_w0)                = -0.934 
    C(C_u1, C_w1)                = -0.923 
    C(B_i0, C_u0)                =  0.922 
    C(B_i0, C_i0)                = -0.922 
    C(A_u1, A_w1)                =  0.914 
    C(A_i0, B_i0)                = -0.911 
    C(A_i1, B_w1)                =  0.908 
    C(A_i1, A_w1)                =  0.908 
    C(A_u0, B_w0)                = -0.906 
    C(A_u0, B_u0)                =  0.889 
    C(A_u0, B_i0)                = -0.884 
    C(A_w0, B_u0)                =  0.877 
    C(B_w0, C_u0)                =  0.876 
    C(B_w0, C_i0)                = -0.870 
    C(A_i1, B_i1)                = -0.867 
    C(A_i0, B_u0)                =  0.867 
    C(A_u1, B_u1)                =  0.862 
    C(B_i0, C_w0)                = -0.860 
    C(B_i1, C_i1)                = -0.859 
    C(A_u1, B_w1)                =  0.854 
    C(B_i1, C_u1)                =  0.848 
    C(A_w1, B_u1)                =  0.837 
    C(A_i1, B_u1)                =  0.811 
    C(A_u1, B_i1)                = -0.809 
    C(A_w0, B_w0)                = -0.797 
    C(B_w0, C_w0)                = -0.788 
    C(A_w0, B_i0)                = -0.788 
    C(C_i0, C_i1)                =  0.760 
    C(B_w1, C_u1)                = -0.757 
    C(B_w1, C_i1)                =  0.756 
    C(B_i1, C_w1)                = -0.745 
    C(B_i0, B_i1)                =  0.740 
    C(C_i1, C_w0)                =  0.731 
    C(A_w1, B_w1)                =  0.717 
    C(C_i1, C_u0)                = -0.713 
    C(B_i0, C_i1)                = -0.705 
    C(B_i1, B_w0)                =  0.703 
    C(B_i1, C_i0)                = -0.703 
    C(A_w1, B_i1)                = -0.695 
    C(A_i0, C_u0)                = -0.689 
    C(A_i0, C_i0)                =  0.686 
    C(C_i0, C_w1)                =  0.684 
    C(C_w0, C_w1)                =  0.683 
    C(B_i1, C_u0)                =  0.677 
    C(B_u0, B_w0)                = -0.667 
    C(C_i0, C_u1)                = -0.665 
    C(B_i0, B_w1)                = -0.660 
    C(A_i0, B_i1)                = -0.654 
    C(A_u0, C_u0)                = -0.651 
    C(B_i1, C_w0)                = -0.647 
    C(A_u0, C_i0)                =  0.647 
    C(B_w0, C_i1)                = -0.645 
    C(B_w0, B_w1)                = -0.639 
    C(C_u0, C_u1)                =  0.633 
    C(B_i0, C_u1)                =  0.632 
    C(C_u0, C_w1)                = -0.630 
    C(C_u1, C_w0)                = -0.629 
    C(A_i0, B_w1)                =  0.612 
    C(B_w1, C_w1)                =  0.606 
    C(B_i0, C_w1)                = -0.606 
    C(B_i0, B_u0)                = -0.604 
    C(B_w1, C_i0)                =  0.600 
    C(A_u0, B_i1)                = -0.599 
    C(A_i0, A_i1)                =  0.597 
    C(A_i0, C_w0)                =  0.593 
    C(B_w1, C_u0)                = -0.581 
    C(B_w0, C_u1)                =  0.578 
    C(A_i1, B_i0)                = -0.578 
    C(A_i1, B_w0)                = -0.571 
    C(A_u0, C_w0)                =  0.559 
    C(B_u1, B_w1)                =  0.558 
    C(A_u0, B_w1)                =  0.553 
    C(A_i1, A_u0)                =  0.553 
    C(A_w0, C_u0)                = -0.537 
    C(B_w0, C_w1)                = -0.537 
    C(A_i0, C_i1)                =  0.535 
    C(A_w0, B_i1)                = -0.534 
    C(A_w0, C_i0)                =  0.534 
    C(B_w1, C_w0)                =  0.533 
    C(A_i1, A_w0)                =  0.529 
    C(A_i0, A_u1)                =  0.503 
    C(A_i1, C_i1)                =  0.501 
    C(A_w0, B_w1)                =  0.492 
    C(A_i1, C_u1)                = -0.490 
    C(A_i0, C_u1)                = -0.489 
    C(A_u0, C_i1)                =  0.480 
    C(A_u0, A_u1)                =  0.480 
    C(A_w0, A_w1)                =  0.476 
    C(A_i1, C_i0)                =  0.470 
    C(A_u1, B_i0)                = -0.467 
    C(A_i1, C_u0)                = -0.464 
    C(A_u1, B_w0)                = -0.458 
    C(A_w0, C_w0)                =  0.456 
    C(A_u1, A_w0)                =  0.456 
    C(B_i1, B_u1)                = -0.445 
    C(A_i0, A_w1)                =  0.438 
    C(A_u0, C_u1)                = -0.434 
    C(A_i0, C_w1)                =  0.430 
    C(A_u1, C_i1)                =  0.419 
    C(A_u1, C_u1)                = -0.416 
    C(A_u0, A_w1)                =  0.407 
    C(A_i1, C_w0)                =  0.405 
    C(A_w0, C_i1)                =  0.399 
    C(A_u0, C_w1)                =  0.384 
    C(A_i1, B_u0)                =  0.383 
    C(A_w1, B_i0)                = -0.373 
    C(A_w1, B_w0)                = -0.363 
    C(A_w0, C_u1)                = -0.361 
    C(A_u1, C_i0)                =  0.358 
    C(A_u1, C_u0)                = -0.351 
    C(A_i1, C_w1)                =  0.350 
    C(A_u1, B_u0)                =  0.331 
    C(B_i1, B_u0)                = -0.319 
    C(B_u0, B_w1)                =  0.319 
    C(A_w0, C_w1)                =  0.314 
    C(A_w1, B_u0)                =  0.307 
    C(A_w1, C_i1)                =  0.305 
    C(A_w1, C_u1)                = -0.302 
    C(A_u1, C_w0)                =  0.300 
    C(A_u1, C_w1)                =  0.280 
    C(B_u0, C_u0)                = -0.273 
    C(B_u0, C_i0)                =  0.266 
    C(A_w1, C_i0)                =  0.261 
    C(A_w1, C_u0)                = -0.255 
    C(A_w0, B_u1)                =  0.217 
    C(A_w1, C_w0)                =  0.213 
    C(A_i0, B_u1)                =  0.208 
    C(B_u0, B_u1)                =  0.202 
    C(A_w1, C_w1)                =  0.192 
    C(A_u0, B_u1)                =  0.191 
    C(C_i0, C_i2)                = -0.190 
    C(A_i1, C_i2)                = -0.185 
    C(B_u0, C_w0)                =  0.176 
    C(C_i2, C_u0)                =  0.172 
    C(A_u1, C_i2)                = -0.171 
    C(B_w1, C_i2)                = -0.168 
    C(C_i2, C_w0)                = -0.164 
    C(B_u0, C_i1)                =  0.163 
    C(B_i1, C_i2)                =  0.162 
    C(B_u1, C_w1)                = -0.161 
    C(B_i0, C_i2)                =  0.160 
    C(B_w0, C_i2)                =  0.151 
    C(B_u0, C_u1)                = -0.147 
    C(A_w1, C_i2)                = -0.146 
    C(B_u1, C_i2)                = -0.138 
    C(A_i0, C_i2)                = -0.122 
    C(B_u1, B_w0)                = -0.112 
    C(A_u0, C_i2)                = -0.112 
    C(C_i1, C_i2)                = -0.108 
    C(A_w0, C_i2)                = -0.094 
    C(B_i0, B_u1)                = -0.092 
    C(B_u0, C_w1)                =  0.089 
    C(C_i2, C_u1)                =  0.081 
    C(B_u1, C_w0)                = -0.074 
    C(C_i2, C_w1)                = -0.051 
    C(B_u1, C_i1)                = -0.044 
    C(B_u0, C_i2)                = -0.044 
    C(B_u1, C_u1)                =  0.040 
    C(B_u1, C_i0)                = -0.030 
    C(B_u1, C_u0)                =  0.022 
#+end_example


** Heliocentric correction


* COMMENT Test of my new org-bullets configuration. 
** Second
*** Third
**** Fourth
***** Fifth
****** Sixth
******* Seventh
******** Eighth
********* Ninth
********** Tenth
*********** Eleventh
************ Twelfth
************* Thirteenth
Only 13 normal levels it seems
*************** Fourteenth
After that they become inline tasks I think
**************** Fifteenth
***************** Sixteenth




 
* Other temperature indicators
  CLOCK: [2013-02-12 Tue 15:16]--[2013-02-12 Tue 18:17] =>  3:01

** C II versus [S III], [Cl III] 

+ The 2+ ions of these elements all have similar ionization potentials
+ But obviously there is a different temperature dependence for the C II recombination line
+ Need to be careful with collisional deexcitation of [Cl III]
+ There is at least one of the 14" slit spectra where this does not seem to be an issue
+ One would expect that the C line would be broader 


** [N II] versus [S II]
+ This will only work in places where the emission in the two ions is coextensive.  
+ Also where the lines are at their narrowest
+ And where there is no collisional de-excitation
+ Best place seems to be the diffuse blue layer
+ /Note that the 6716 line is blended with a He line on the blue wing/

|      Wav | Spec | TT | Configuration | Term   |     A_ki |     f_ik | -LEVEL-ENERGY--CM^-1- | Refs     |
|----------+------+----+---------------+--------+----------+----------+-----------------------+----------|
| 6717.460 | He I | E1 | 1s.3s-1s.24p  | 3S-3Po | 6.35E+03 | 4.30E-05 | 183236.89 - 198119.36 | 005, 084 |


** Doppler widths in 10^4 K gas

+ W_therm: assume 20 km/s for H (FWHM)
+ W_tot: assume additional broadening of 10 km/s

| Element |  A |   IP I |  IP II | IP III | Wt(1e4 K) | W(1e4 K, 10 kms) | Wt(3e3) K | W(3e3, 4 km/s) |
|---------+----+--------+--------+--------+-----------+------------------+-----------+----------------|
| H       |  1 | 13.598 |        |        |      20.0 |             22.4 |      11.0 |           11.7 |
| D       |  2 | 13.598 |        |        |      14.1 |             17.3 |       7.7 |            8.7 |
| He      |  4 | 24.587 | 54.416 |        |      10.0 |             14.1 |       5.5 |            6.8 |
| C       | 12 | 11.260 | 24.383 | 47.887 |       5.8 |             11.6 |       3.2 |            5.1 |
| N       | 14 | 14.534 | 29.601 | 47.448 |       5.3 |             11.3 |       2.9 |            4.9 |
| O       | 16 | 13.618 | 35.116 | 54.934 |       5.0 |             11.2 |       2.7 |            4.8 |
| S       | 32 | 10.360 |  23.33 |  34.83 |       3.5 |             10.6 |       1.9 |            4.4 |
| Cl      | 35 | 12.967 |  23.81 |  39.61 |       3.4 |             10.6 |       1.9 |            4.4 |
| Fe      | 56 |  7.870 |  16.18 | 30.651 |       2.7 |             10.4 |       1.5 |            4.3 |
#+TBLFM: $6=20.0/sqrt($2);f1::$7=sqrt(10**2 + $-1**2);f1::$8=20.0 sqrt(0.3 / $2);f1::$9=sqrt(4**2 + $-1**2);f1

So there should be a roughly 10% difference (or 1 km/s) in width between [N II] and [S II].  So the precision of the width measurements needs to be better than that.  

*** Test of sensitivity to T

+ Consider two different ions: k = 1,2
+ Assume thermal width of component k is Wt_k**2 = 400 T4/A_k
+ Non-thermal width is same for both ions Wnt
+ Total width: W_k**2 = Wnt**2 + 400 T4/A_k
+ Difference: W_1**2 - W_2**2 = 400 T4 (A_2 - A_1)/(A_1 A_2)
+ T4 = (W_1**2 - W_2**2) A_1 A_2 / 400 (A_2 - A_1)
  + With A_1 = 14, A_2 = 32 we get T4 = 0.062222 (W_1**2 - W_2**2)
+ The last column, T_up, is an upper bound on the temperature, assuming there is no non-thermal broadening at all. 

| A_1 | W_1          | A_2 | W_2           | W_1^2 - W_2^2   | T_4               | T_up              |
|-----+--------------+-----+---------------+-----------------+-------------------+-------------------|
|  14 | 11.3 +/- 0.1 |  32 | 10.6 +/- 0.1  | 15.33 +/- 3.10  | 0.9539 +/- 0.1929 | 4.4692 +/- 0.0791 |
|   2 | 8.7  +/- 0.9 |  14 | 4.9  +/- 0.05 | 51.68 +/- 15.67 | 0.3015 +/- 0.0914 | 0.3785 +/- 0.0783 |
#+TBLFM: $5=$2**2 - $4**2; f2::$6=$1 $3 $-1 / 400 ($3 - $1); f4::$7=$2**2 $1 / 400 ;f4

+ So, this does not look promising for the ionized lines 
  + We need a precision of 1% in the widths in order to get a precision of 20% in the temperature
+ The neutral lines look much better:
  + A precision of 10% in the widths gives precision of 30% in the temperature 




* Imaging of 244-440
:LOGBOOK:
CLOCK: [2013-04-18 Thu 10:49]--[2013-04-18 Thu 10:51] =>  0:02
  CLOCK: [2013-04-11 Thu 09:07]--[2013-04-11 Thu 10:07] =>  1:00
  :END:
+ I am downloading all the relevant images of 244-440 from archive.stsci.edu
+ ACS:
  + Lots of enormous continuum images plus some H alpha
+ WFPC2:
  + Many images in all sorts of filters, but only WFC (not PC)
  + Most interesting are the [S II] images, which show stuff not seen at other wavelengths
    + This seems to confirm the reality of the strange [S II] low velocity spike that we see on the p84 spectrum, although it is a little odd that the HST image has it well inside the ionization front.
    + We need to investigate its spaatial distribution on the spectrum in more detail.
    + Also will be important to compare with the perpendicular slit. 
+ For the moment, I am just dumping them all on the QNAP NAS disk
  + =/fs/nas11/other0/will/Nahiely/244-440-MAST=
  + They add up to many GB, and most of the files won't be needed
  + Probably just want the =_drz.fits= files
+ Composite images:
  + [[file:HST/244-440__NII-Ha-OIII.jpg][file:~/Dropbox/KeckProplyd/HST/244-440__NII-Ha-OIII.jpg]]
  + [[file:HST/244-440__OI-SII-Cont.jpg][file:~/Dropbox/KeckProplyd/HST/244-440__OI-SII-Cont.jpg]]



* Measuring the PDR temperature by comparing Deuterium and metal fluorescent lines!!!
  :LOGBOOK:
  CLOCK: [2013-02-03 Sun 18:12]--[2013-02-12 Tue 19:16] => 217:04
  CLOCK: [2012-09-20 Thu 21:44]--[2012-09-21 Fri 00:11] =>  2:27
  CLOCK: [2012-09-20 Thu 16:56]--[2012-09-20 Thu 17:10] =>  0:14
  :END:

** Summary

The deuterium Balmer lines and several low-ionization metal line lines (such as [N I] and O I) are excited by fluorescence of the FUV continuum.  These lines are expected to be formed in the neutral photodissociation region, just behind the ionization front.  Assuming that the fluorescent deuterium and metal lines form in the same region, then the non-thermal broadening of the two types of lines, which may come from velocity gradients and turbulence, should be the same.  Therefore any difference in the observed linewidths should be due to the greater thermal broadening of the deuterium lines on account of a lower atomic weight.  The kinetic temperature of the fluorescing layer can therefore be empirically determined from comparison of the line profiles.  This is an important probe of the physical conditions in the neutral gas, which otherwise posesses very few clear-cut diagnostic indicators.  



** Literature

+ Grandi papers 1975, 1976
+ Muench and Taylor 1975
  + Gets the mechanism wrong (they propose Ly \beta excitation) but first to show that the spatial distribution of O I lines is special
+ Bautista 1976

** Remaining reduction steps to do
+ [X] de-biasing
  + CANCELLED and flat-fielding
+ [X] remove cosmic rays
+ [X] extract individual orders
  + [X] rectify to nearest pixel
  + [X] rectify with interpolation
+ [X] correct for order overlap

** Deuterium Balmer lines
+ The main complication with these lines is subtracting off the wing of the H line
+ This is particularly difficult when there is high velocity emission
  + So objects with strong jets, such as 170334 are probably best avoided
+ [ ] One way of doing the isolation of the D component would be simply to subtract H\alpha from H\beta (after multiplying by the Case B recombination Balmer decrement).
  + This should leave the D component visible, since the Balmer decrement is different for the fluorescence (D\beta is relatively stronger).
  + Of course, it will also give residuals of any component that has a different temperature from the standard one, but hopefully this won't be significant.
  + We may also need to take account of the fins structure broadening, and how this is different between H\alpha and H\beta.


*** STARTED How does fine-structure broadening affect the D lines?
    :LOGBOOK:
    - Note taken on [2013-02-25 Mon 08:45] \\
      Got the paper now
    - State "STARTED"    from "WAITING"    [2013-02-25 Mon 08:44]
    - State "WAITING"    from ""           [2013-02-24 Sun 22:33] \\
      Need to try and get the paper through work
    :END:
+ This paper looks like it might be useful:
  + http://adsabs.harvard.edu/abs/2010ADNDT..96..586K
+ Actually, the data is in NIST
  + http://physics.nist.gov/PhysRefData/ASD/levels_form.html
  + Reference is to above paper
+ For Case B conditions, the strongest transitions are 


**** STARTED Do we need to do j-resolved calculations?
     :LOGBOOK:
     - State "STARTED"    from ""           [2013-02-27 Wed 09:19]
     :END:
+ It seems not, at least according to Clegg et al. 
#+BEGIN_QUOTE
We further assume that bnlj = bnl, with the values of bnl being calculated as described above. This is equivalent to the assumption that the j-levels associated with a particular nl are populated according to their statistical weights (2j + 1).
#+END_QUOTE

+ Actually, we may do....

**** Papers on fine-structure transitions 2s-2p at radio wavelengths

+ [[http://adsabs.harvard.edu/abs/2005ApJ...633..309D][Dennison et al 2005]] discuss radio lines at 1.1 and 9.8 GHz
  + They seem to do the excitation quite carefully, considering the fully j-resolved problem
  + They include radiative transitions 2s->2p that are induced by the free-free microwave emission

+ [[http://adsabs.harvard.edu/abs/2008MNRAS.390.1430D][Dijkstra et al 2008]] criticizing earlier paper of [[http://adsabs.harvard.edu/abs/2007ApJ...664....1S][Seth et al 2007]]
  + These are about the detectability of the 1.1 GHz line from cosmological halos 

**** H and D fine-structure line wavelengths
#+CONSTANTS: Nair=1.000293

***** H alpha
| Transition                |               E_i |           E_k |         dE |    lambda |     dV | index |    dV* | Case B |
|---------------------------+-------------------+---------------+------------+-----------+--------+-------+--------+--------|
| H\alpha 2p(1/2) - 3d(3/2) |    0.749598426019 | 0.88841538381 | 0.13881696 | 6562.5996 | -2.828 |     5 | -7.858 |  0.182 |
| H\alpha 2s(1/2) - 3p(3/2) | 0.749598747568292 | 0.88841538543 | 0.13881664 | 6562.6147 | -2.138 |     4 | -7.168 |  0.220 |
| H\alpha 2p(1/2) - 3s(1/2) |    0.749598426019 | 0.88841449321 | 0.13881607 | 6562.6417 | -0.904 |     1 | -5.934 |  0.045 |
| H\alpha 2s(1/2) - 3p(1/2) | 0.749598747568292 | 0.88841439752 | 0.13881565 | 6562.6615 |  0.000 |     3 |  -5.03 |  0.110 |
| H\alpha 2p(3/2) - 3d(5/2) |    0.749601760236 | 0.88841571308 | 0.13881395 | 6562.7419 |  3.673 |     7 | -1.357 |  0.322 |
| H\alpha 2p(3/2) - 3d(3/2) |    0.749601760236 | 0.88841538381 | 0.13881362 | 6562.7575 |  4.385 |     6 | -0.645 |  0.036 |
| H\alpha 2p(3/2) - 3s(1/2) |    0.749601760236 | 0.88841449321 | 0.13881273 | 6562.7996 |  6.309 |     2 |  1.279 |  0.089 |
#+TBLFM: $4=$3 - $2::$5=1 / $-1 $ryd $ang $Nair::$6=$c ($-1 - @I$-1)/@I$-1 $km ;f3::$8=$6 - 5.03

#+name: h-alpha-fs-vshifts
#+BEGIN_EXAMPLE
0.6 -		       +
    |		       +
0.4 -	  + +	       +
    |	  + +	       +
0.2 -	  + +	+      +    +
    |	  5 4 1 3      7 6  2
0.0 - + . . . . + . . . . + . . 
     -10       -05	 +00 
#+END_EXAMPLE

+ The table is ordered by increasing wavelength
+ =index= is from Table 2a of Clegg et al 1999
+ =dV*= is adding -5.03 km/s to put the shifts on the same scale s Clegg
  + This assumes a reference wavelength of 6562.8812
  + The shifts then agree with Clegg's table to +/- 0.01 km/s
+ =Case B= are the relative intensities from Clegg's Table 3, assuming n_e = 1e6 and T_e = 1e4
  + The strongest components are 4, 5, and 7
  + There is little variation with (n_e, T_e):
    + With n_e = (1e2, 1e9) the individual components vary less than 10% in strength
    + At low T_e, the main change is that the 3d states get more populated:
      + #5 becomes stronger at the expense of #4,
	+ but the sum of the two does not change much and they are very close together in wavelength.
      + #6 and #7 gets stronger at the expense of #1, #2, #3
+ The most important splitting is between j=1/2 and j=3/2 of the n=2 level
  + This divides the lines into the blue group (5, 4, 1, 3) and the red group (7, 6, 2)

***** D alpha
| Transition                |              E_i |           E_k |         dE |    lambda |     dV | index |
|---------------------------+------------------+---------------+------------+-----------+--------+-------|
| D\alpha 2p(1/2) - 3d(3/2) |   0.749802385026 |  0.8886571141 | 0.13885473 | 6560.8145 | -2.828 |     5 |
| D\alpha 2s(1/2) - 3p(3/2) | 0.74980270701155 | 0.88865711646 | 0.13885441 | 6560.8296 | -2.138 |     4 |
| D\alpha 2p(1/2) - 3s(1/2) |   0.749802385026 | 0.88865622417 | 0.13885384 | 6560.8566 | -0.905 |     1 |
| D\alpha 2s(1/2) - 3p(1/2) | 0.74980270701155 | 0.88865612831 | 0.13885342 | 6560.8764 |  0.000 |     3 |
| D\alpha 2p(3/2) - 3d(5/2) |    0.74980572010 |  0.8886574435 | 0.13885172 | 6560.9567 |  3.669 |     7 |
| D\alpha 2p(3/2) - 3d(3/2) |    0.74980572010 |  0.8886571141 | 0.13885139 | 6560.9723 |  4.382 |     6 |
| D\alpha 2p(3/2) - 3s(1/2) |    0.74980572010 | 0.88865622417 | 0.13885050 | 6561.0144 |  6.306 |     2 |
#+TBLFM: $4=$3 - $2::$5=1 / $-1 $ryd $ang $Nair::$6=$c ($-1 - @I$-1)/@I$-1 $km ;f3

+ [ ] How are the relative intensities different for Case C (fluorescent pumping)?
  + If the only excitation were by Ly\beta then things would be simple:
    + Selection rules (\(\Delta L = 1\) for E1) mean that we can only excite the 3p level from 1s
    + So only components 3 and 4 will occur
    + The separation of these is only 2.14 km/s
  + But presumably the higher order Lyman lines will also contribute....
    + [ ] We need to run a Cloudy model to find out

***** H beta
| Transition               |               E_i |             E_k |         dE |    lambda |     dV | index |
|--------------------------+-------------------+-----------------+------------+-----------+--------+-------|
| H\beta 2p(1/2) - 4d(3/2) |    0.749598426019 |  0.937000268393 | 0.18740184 | 4861.2123 | -1.184 |     5 |
| H\beta 2s(1/2) - 4p(3/2) | 0.749598747568292 | 0.9370002690086 | 0.18740152 | 4861.2206 | -0.672 |     4 |
| H\beta 2p(1/2) - 4s(1/2) |    0.749598426019 | 0.9369998926881 | 0.18740147 | 4861.2219 | -0.592 |     1 |
| H\beta 2s(1/2) - 4p(1/2) | 0.749598747568292 | 0.9369998522406 | 0.18740110 | 4861.2315 |  0.000 |     3 |
| H\beta 2p(3/2) - 4d(5/2) |    0.749601760236 | 0.9370004072442 | 0.18739865 | 4861.2950 |  3.916 |     7 |
| H\beta 2p(3/2) - 4d(3/2) |    0.749601760236 |  0.937000268393 | 0.18739851 | 4861.2987 |  4.144 |     6 |
| H\beta 2p(3/2) - 4s(1/2) |    0.749601760236 | 0.9369998926881 | 0.18739813 | 4861.3085 |  4.749 |     2 |
#+TBLFM: $4=$3 - $2::$5=1 / $-1 $ryd $ang $Nair::$6=$c ($-1 - @I$-1)/@I$-1 $km ;f3


**** STARTED Populations of the energy levels
     :LOGBOOK:
     - State "STARTED"    from ""           [2013-02-27 Wed 23:07]
     :END:
+ From the observed Balmer decrement and from the known A values
  + We can calculate the populations of the excited levels
  + How does this help?  See handwritten notes.
+ Comparing Ly\beta and Ly\gamma contributions to H\alpha component emission
  + Every 100 Ly\beta pumps produce:
    + 8 H\alpha 3p_{3/2} - 2s_{1/2} photons
    + 4 H\alpha 3p_{1/2} - 2s_{1/2} photons
  + Every 100 Ly\gamma pumps produce:
    + 8 H\beta 4p_{3/2} - 2s_{1/2} photons
    + 4 H\beta 4p_{1/2} - 2s_{1/2} photons
    + 2 H\alpha 3s_{1/2} - 2p_{3/2} photons
    + 1 H\alpha 3s_{1/2} - 2p_{1/2} photon
    + < 0.5 H\alpha 3d - 2p photons
  + We also know that there are about 2.2 H\alpha photons per H\beta photon
    + Therefore the ratio of 3p-2s/3s-2p photons is 8.8 (assuming no contribution from higher lines).
  + The 2p level has the largest splitting of the j-states
    + 3.5 times larger than the splitting of 3p, and 4p is half that again
  + Higher pumping lines (Ly\delta, Ly\epsilon, etc) have a similar effect
    + The majority of Balmer photons they produce will be the highest possible (H\gamma for Ly\delta, and so on).
      + All of these will be np->2s transitions
    + Then they will produce a smaller number of lower Balmer photons: (n-1)->2, (n-2)->2, etc 
      + Most of these will be (n-k)s->2p because
	1. The initial decay np->(n-k)s is 10 times more likely than np->(n-k)d
	   + [ ] Need to check how this varies with n
	2. All the p-levels are effectively drained by dominant Lyman transitions to 2s
	   + (This is assuming that the Lyman lines escape)
	   + So that migration back to the high-l levels is strongly suppressed, since we would have to go through a p-level


**** Hydrogen energy levels
| Configuration | Term | J   |        Level (Ry) | Level Splittings (Ry) | Splitting (cm^-1) | My splitting |
|---------------+------+-----+-------------------+-----------------------+-------------------+--------------|
| 1s            | 2S   | 1/2 | 0.000000000000000 |                       |                0. |           0. |
|               |      |     |                   |                       |                0. |           0. |
|---------------+------+-----+-------------------+-----------------------+-------------------+--------------|
| 2p            | 2P°  | 1/2 |    0.749598426019 |        0.749598426019 |         82258.919 |           0. |
|               |      | 3/2 |    0.749601760236 |        0.000003334217 |        0.36588802 |   0.36588802 |
|               |      |     |                   |                       |                0. |   -82258.919 |
| 2s            | 2S   | 1/2 | 0.749598747568292 |       -0.000003012668 |       -0.33060210 |  0.035285924 |
|               |      |     |                   |                       |                0. |   -82258.919 |
| 2             |      |     |        0.74960060 |            0.00000185 |        0.20301403 |   0.23856684 |
|               |      |     |                   |                       |                0. |   -82258.919 |
|---------------+------+-----+-------------------+-----------------------+-------------------+--------------|
| 3p            | 2P°  | 1/2 |     0.88841439752 |            0.13881380 |         15233.054 |           0. |
|               |      | 3/2 |     0.88841538543 |         0.00000098791 |        0.10841059 |   0.10841059 |
|               |      |     |                   |                       |                0. |   -97492.211 |
| 3s            | 2S   | 1/2 |     0.88841449321 |        -0.00000089222 |      -0.097909828 |  0.010500764 |
|               |      |     |                   |                       |                0. |   -97492.211 |
| 3             |      |     |        0.88841524 |            0.00000075 |       0.082302987 |  0.092451494 |
|               |      |     |                   |                       |                0. |   -97492.211 |
| 3d            | 2D   | 3/2 |     0.88841538381 |            0.00000014 |       0.015363224 |   0.10823282 |
|               |      | 5/2 |     0.88841571308 |         0.00000032927 |       0.036133206 |   0.14436602 |
|               |      |     |                   |                       |                0. |   -97492.211 |
|---------------+------+-----+-------------------+-----------------------+-------------------+--------------|
| 4p            | 2P°  | 1/2 |   0.9369998522406 |         0.04858413916 |         5331.4930 |           0. |
|               |      | 3/2 |   0.9370002690086 |       0.0000004167680 |       0.045735002 |  0.045735002 |
|               |      |     |                   |                       |                0. |   -102823.85 |
| 4s            | 2S   | 1/2 |   0.9369998926881 |      -0.0000003763205 |      -0.041296402 | 4.4385452e-3 |
|               |      |     |                   |                       |                0. |   -102823.85 |
| 4d            | 2D   | 3/2 |    0.937000268393 |        0.000000375705 |       0.041228858 |  0.045667403 |
|               |      | 5/2 |   0.9370004072442 |        0.000000138851 |       0.015237136 |  0.060904539 |
|               |      |     |                   |                       |                0. |   -102823.85 |
| 4             |      |     |       0.937000357 |          -0.000000050 |     -5.4868658e-3 |  0.055390898 |
|               |      |     |                   |                       |                0. |   -102823.85 |
| 4f            | 2F°  | 5/2 |     0.93700040727 |           0.000000050 |      5.4868658e-3 |  0.060907393 |
|               |      | 7/2 |    0.937000476536 |         0.00000006927 |      7.6015039e-3 |  0.068508457 |
|---------------+------+-----+-------------------+-----------------------+-------------------+--------------|
#+TBLFM: $6=$-1 $Ryd::$7=($4 - @-I$4) $Ryd

**** Deuterium energy levels
| Configuration | Term | J   |         Level (Ry) | Level Splittings (Ry) | Splitting (cm^-1) |           |
|---------------+------+-----+--------------------+-----------------------+-------------------+-----------|
| 1s            | 2S   | 1/2 |   0.00000000000000 |                       |                0. |      0.00 |
|---------------+------+-----+--------------------+-----------------------+-------------------+-----------|
| 2p            | 2P°  | 1/2 |     0.749802385026 |        0.749802385026 |         82281.301 | 899140.40 |
|               |      | 3/2 |      0.74980572010 |         0.00000333507 |        0.36598163 |      4.00 |
|               |      |     |                    |                       |                0. |      0.00 |
| 2s            | 2S   | 1/2 |   0.74980270701155 |        -0.00000301309 |       -0.33064841 |     -3.61 |
|               |      |     |                    |                       |                0. |      0.00 |
| 2             |      |     |       [0.74980413] |            0.00000142 |        0.15582699 |      1.70 |
|               |      |     |                    |                       |                0. |      0.00 |
|---------------+------+-----+--------------------+-----------------------+-------------------+-----------|
| 3p            | 2P°  | 1/2 |      0.88865612831 |            0.13885200 |         15237.246 | 166507.13 |
|               |      | 3/2 |      0.88865711646 |         0.00000098815 |        0.10843693 |      1.18 |
|               |      |     |                    |                       |                0. |      0.00 |
| 3s            | 2S   | 1/2 |      0.88865622417 |        -0.00000089229 |      -0.097917509 |     -1.07 |
|               |      |     |                    |                       |                0. |      0.00 |
| 3             |      |     |       [0.88865702] |            0.00000080 |       0.087789853 |      0.96 |
|               |      |     |                    |                       |                0. |      0.00 |
| 3d            | 2D   | 3/2 |       0.8886571141 |            0.00000009 |      9.8763584e-3 |      0.11 |
|               |      | 5/2 |       0.8886574435 |          0.0000003294 |       0.036147472 |      0.40 |
|---------------+------+-----+--------------------+-----------------------+-------------------+-----------|
| 4p            | 2P°  | 1/2 |     0.937254802713 |          0.0485973592 |         5332.9437 |  58276.49 |
|               |      | 3/2 |     0.937255219682 |        0.000000416969 |       0.045757059 |      0.50 |
|               |      |     |                    |                       |                0. |      0.00 |
| 4s            | 2S   | 1/2 |    0.9372548433157 |       -0.000000376366 |      -0.041301395 |     -0.45 |
|               |      |     |                    |                       |                0. |      0.00 |
| 4d            | 2D   | 3/2 |   [0.937255219007] |        0.000000375691 |       0.041227322 |      0.45 |
|               |      | 5/2 |    0.9372553579738 |        0.000000138967 |       0.015249866 |      0.17 |
|               |      |     |                    |                       |                0. |      0.00 |
| 4             |      |     |      [0.937255275] |          -0.000000083 |     -9.1081972e-3 |     -0.10 |
|               |      |     |                    |                       |                0. |      0.00 |
| 4f            | 2F°  | 5/2 | (0.93725535772590) |           0.000000083 |      9.1081972e-3 |      0.10 |
|               |      | 7/2 | (0.93725542720592) |      0.00000006948002 |      7.6245509e-3 |      0.08 |
|---------------+------+-----+--------------------+-----------------------+-------------------+-----------|
#+TBLFM: $6=$-1 $Ryd::$7=$c $-2/0.25 $km ;f2



**** H radiative rates

***** Matrix of radiative rates

|   n_l -> |        1 |        2 |        3 |        4 |        5 |        6 |        7 |        8 |        9 |       10 |       11 |   Case C |     Case D |
|----------+----------+----------+----------+----------+----------+----------+----------+----------+----------+----------+----------+----------+------------|
|   n_u \/ |    Lyman |   Balmer |  Paschen | Brackett |    Pfund |       Hu |          |          |          |          |          | Sum(i<k) | Sum(1<i<k) |
|----------+----------+----------+----------+----------+----------+----------+----------+----------+----------+----------+----------+----------+------------|
|        2 | 4.69E+08 |      (2) |          |          |          |          |          |          |          |          |          |    4.7e8 |          2 |
|        3 | 5.57E+07 | 4.41E+07 |      (3) |          |          |          |          |          |          |          |          |   1.00e8 |      4.4e7 |
|        4 | 1.28E+07 | 8.41E+06 | 8.98E+06 |      (4) |          |          |          |          |          |          |          |    3.0e7 |      1.7e7 |
|        5 | 4.12E+06 | 2.53E+06 | 2.20E+06 | 2.70E+06 |      (5) |          |          |          |          |          |          |    1.2e7 |      7.4e6 |
|        6 | 1.64E+06 | 9.72E+05 | 7.77E+05 | 7.70E+05 | 1.02E+06 |      (6) |          |          |          |          |          |    5.2e6 |      3.5e6 |
|        7 | 7.56E+05 | 4.38E+05 | 3.35E+05 | 3.04E+05 | 3.25E+05 | 4.56E+05 |      (7) |          |          |          |          |    2.6e6 |      1.9e6 |
|        8 | 3.87E+05 | 2.21E+05 | 1.65E+05 | 1.42E+05 | 1.39E+05 | 1.56E+05 | 2.27E+05 |      (8) |          |          |          |    1.4e6 |      1.1e6 |
|        9 | 2.14E+05 | 1.21E+05 | 8.90E+04 | 7.45E+04 | 6.90E+04 | 7.06E+04 | 8.23E+04 | 1.23E+05 |      (9) |          |          |    8.4e5 |      6.3e5 |
|       10 | 1.26E+05 | 7.11E+04 | 5.15E+04 | 4.23E+04 | 3.80E+04 | 3.68E+04 | 3.90E+04 | 4.67E+04 | 7.14E+04 |     (10) |          |    5.2e5 |      4.0e5 |
|       11 | 7.83E+04 | 4.39E+04 | 3.15E+04 | 2.55E+04 | 2.24E+04 | 2.11E+04 | 2.12E+04 | 2.30E+04 | 2.81E+04 | 4.37E+04 |     (11) |    3.4e5 |      2.6e5 |
|       12 | 5.06E+04 | 2.83E+04 | 2.02E+04 | 1.62E+04 | 1.40E+04 | 1.29E+04 | 1.25E+04 | 1.29E+04 | 1.43E+04 | 1.77E+04 | 2.80E+04 |    2.3e5 |      1.8e5 |
|----------+----------+----------+----------+----------+----------+----------+----------+----------+----------+----------+----------+----------+------------|
| Sum(i>k) |    5.4e8 |    5.7e7 |    1.3e7 |    4.1e6 |    1.6e6 |    7.5e5 |    3.8e5 |    2.1e5 |    1.1e5 |    6.1e4 |    2.8e4 |          |            |
#+TBLFM: @3$13..@13$13=vsum($2..$12); s2::@3$14..@13$14=vsum($3..$12); s2::@14$2..@14$12=vsum(@II..@III); s2

+ This shows the Einstein A values for the transition n_u -> n_l
So the sum of 


***** Resolved fine structure transitions from NIST

+ Transition probabilities from [[http://adsabs.harvard.edu/abs/2009JPCRD..38..565W][Wiese & Fuhr (2009)]]

****** Downward transitions from the 4p levels

+ This level is excited by Ly\gamma (1s->4p) and can decay via:
  + Ly\gamma (4p->1s) 
  + H\beta (4p->2s) + ...
    + (collisions 2s->2p) + Ly\alpha (2p->1s)
    + 2-photon (2s->1s)
  + Pa\alpha (4p->3s,3d) + ...
    + H\alpha (3s,3d->2p) + Ly\alpha (2p->1s)
    + (collisions 3s,3d->3p) + Ly\beta (3p->1s)

| Transition       | Line     |        A_{ki} |    p_{ki} |
|------------------+----------+------------+--------|
| 4p 3/2 -> 1s 1/2 | Ly gamma | 6.8186e+07 | 0.8390 |
| 4p 3/2 -> 2s 1/2 | H beta   | 9.6680e+06 | 0.1190 |
| 4p 3/2 -> 3s 1/2 | P alpha  | 3.0650e+06 | 0.0377 |
| 4p 3/2 -> 3d 3/2 | P alpha  | 3.4754e+04 | 0.0004 |
| 4p 3/2 -> 3d 5/2 | P alpha  | 3.1280e+05 | 0.0038 |
|------------------+----------+------------+--------|
|                  |          |  8.12666e7 |        |
|------------------+----------+------------+--------|
| 4p 1/2 -> 1s 1/2 | Ly gamma | 6.8186e+07 | 0.8390 |
| 4p 1/2 -> 2s 1/2 | H beta   | 9.6683e+06 | 0.1190 |
| 4p 1/2 -> 3s 1/2 | P alpha  | 3.0652e+06 | 0.0377 |
| 4p 1/2 -> 3d 3/2 | P alpha  | 3.4759e+05 | 0.0043 |
|------------------+----------+------------+--------|
|                  |          |  8.12671e7 |        |
|                  |          |            |        |
#+TBLFM: @2$4..@6$4=$3/@II$3;f4::@8$4..@11$4=$3/@IIII$3;f4::@7$3=vsum(@I..@II);s6::@12$3=vsum(@III..@IIII);s6

****** NIST table of just the 4p transitions

|---------------+---------------+------+------------+------+--------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|
|      Observed |          Ritz | Rel. |        Aki | Acc. | Ei           Ek                      | Lower level           | Upper level           | gi   gk | Type | TP    | Line  |
|    Wavelength |    Wavelength | Int. |       s^-1 |      | (cm-1)       (cm-1)                  | --------------------- | --------------------- |         |      | Ref.  | Ref.  |
|      Air  (Å) |      Air  (Å) | (?)  |            |      |                                      | Conf.   Term  J       | Conf.   Term  J       |         |      |       |       |
|---------------+---------------+------+------------+------+--------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|
|       972.541 | 972.536594376 |      | 6.8186e+07 | AAA  | 0.0000000000   -  102823.8943175     | 1s      2S    1/2     | 4p      2P*   3/2     | 2 - 4   |      | T8637 | L8445 |
|       972.541 | 972.537026950 |      | 6.8186e+07 | AAA  | 0.0000000000   -  102823.8485825     | 1s      2S    1/2     | 4p      2P*   1/2     | 2 - 2   |      | T8637 | L8445 |
|---------------+---------------+------+------------+------+--------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|
| 4861.28694917 | 4861.28694918 |      | 9.6680e+06 | AAA  | 82258.9543992821   -  102823.8943175 | 2s      2S    1/2     | 4p      2P*   3/2     | 2 - 4   |      | T8637 | L9477 |
| 4861.29776054 | 4861.29776053 |      | 9.6683e+06 | AAA  | 82258.9543992821   -  102823.8485825 | 2s      2S    1/2     | 4p      2P*   1/2     | 2 - 2   |      | T8637 | L9477 |
|---------------+---------------+------+------------+------+--------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|
|               |   18750.72050 |      | 3.0650e+06 | AAA  | 97492.221701       -  102823.8943175 | 3s      2S    1/2     | 4p      2P*   3/2     | 2 - 4   |      | T8637 |       |
|               |   18750.88135 |      | 3.0652e+06 | AAA  | 97492.221701       -  102823.8485825 | 3s      2S    1/2     | 4p      2P*   1/2     | 2 - 2   |      | T8637 |       |
|               |   18751.06422 |      | 3.4754e+04 | AAA  | 97492.319433       -  102823.8943175 | 3d      2D    3/2     | 4p      2P*   3/2     | 4 - 4   |      | T8637 |       |
|               |   18751.19130 |      | 3.1280e+05 | AAA  | 97492.355566       -  102823.8943175 | 3d      2D    5/2     | 4p      2P*   3/2     | 6 - 4   |      | T8637 |       |
|               |   18751.22507 |      | 3.4759e+05 | AAA  | 97492.319433       -  102823.8485825 | 3d      2D    3/2     | 4p      2P*   1/2     | 4 - 2   |      | T8637 |       |
|---------------+---------------+------+------------+------+--------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|



***** Downward transitions from the 3p levels

+ This level is excited by Ly\beta (1s->3p) and can decay via:
  + Ly\beta (3p->1s) 
  + H\alpha (3p->2s) + ...
    + (collisions 2s->2p) + Ly\alpha (2p->1s)
    + 2-photon (2s->1s)

| Transition       | Line    |        A_{ki} |    p_{ki} |
|------------------+---------+------------+--------|
| 3p 3/2 -> 1s 1/2 | Ly beta | 1.6725e+08 | 0.8817 |
| 3p 3/2 -> 2s 1/2 | H alpha | 2.2448e+07 | 0.1183 |
|------------------+---------+------------+--------|
|                  |         |  1.89698e8 |        |
|------------------+---------+------------+--------|
| 3p 1/2 -> 1s 1/2 | Ly beta | 1.6725e+08 | 0.8817 |
| 3p 1/2 -> 2s 1/2 | H alpha | 2.2449e+07 | 0.1183 |
|------------------+---------+------------+--------|
|                  |         |  1.89699e8 |        |
#+TBLFM: @2$4..@3$4=$3/@II$3;f4::@4$3=vsum(@I..@II);s6::@5$4..@6$4=$3/@IIII$3;f4::@7$3=vsum(@III..@IIII);s6


****** NIST table of just the 3p transitions

|-------------+---------------+------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+----------|
|    Observed |          Ritz | Rel. |        Aki | Acc. | Ei           Ek                     | Lower level           | Upper level           | gi   gk | Type | TP    | Line     |
|  Wavelength |    Wavelength | Int. |       s^-1 |      | (cm-1)       (cm-1)                 | --------------------- | --------------------- |         |      | Ref.  | Ref.     |
|    Air  (Å) |      Air  (Å) | (?)  |            |      |                                     | Conf.   Term  J       | Conf.   Term  J       |         |      |       |          |
|-------------+---------------+------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+----------|
|    1025.728 | 1025.72182505 |      | 1.6725e+08 | AAA  | 0.0000000000   -   97492.319611     | 1s      2S    1/2     | 3p      2P*   3/2     | 2 - 4   |      | T8637 | L3545    |
|    1025.728 | 1025.72296565 |      | 1.6725e+08 | AAA  | 0.0000000000   -   97492.211200     | 1s      2S    1/2     | 3p      2P*   1/2     | 2 - 2   |      | T8637 | L3545    |
|-------------+---------------+------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+----------|
| 6562.724827 |   6562.724827 |      | 2.2448e+07 | AAA  | 82258.9543992821   -   97492.319611 | 2s      2S    1/2     | 3p      2P*   3/2     | 2 - 4   |      | T8637 | L6891c38 |
| 6562.771534 |   6562.771533 |      | 2.2449e+07 | AAA  | 82258.9543992821   -   97492.211200 | 2s      2S    1/2     | 3p      2P*   1/2     | 2 - 2   |      | T8637 | L6891c38 |
|-------------+---------------+------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+----------|


***** Downward transitions from the 3s,3d levels

+ These levels are excited via decays from higher levels like 4p->3s, 4p->3d (or from np->3d, np->3s, nf->3d)
+ They can decay via
  + H\alpha (3s->2p, 3d->2p) + Ly\alpha (2p->1s)
  + (Very weak Ly\beta)
  + And that's it!

| Transition       | Line    |        A_{ki} |           p_{ki} |
|------------------+---------+------------+---------------|
| 3d 5/2 -> 1s 1/2 | Ly beta |  5.937e+02 |  9.1830106e-6 |
| 3d 5/2 -> 2p 3/2 | H alpha | 6.4651e+07 |    0.99998453 |
|------------------+---------+------------+---------------|
|                  |         |   6.4652e7 |               |
|------------------+---------+------------+---------------|
| 3d 3/2 -> 1s 1/2 | Ly beta |  5.938e+02 |  9.1844153e-6 |
| 3d 3/2 -> 2p 1/2 | H alpha | 5.3877e+07 |    0.83332560 |
| 3d 3/2 -> 2p 3/2 | H alpha | 1.0775e+07 |    0.16665893 |
|------------------+---------+------------+---------------|
|                  |         |   6.4653e7 |               |
|------------------+---------+------------+---------------|
| 3s 1/2 -> 1s 1/2 | Ly beta |  1.109e-06 | 1.7563309e-13 |
| 3s 1/2 -> 2p 1/2 | H alpha | 2.1046e+06 |    0.33330694 |
| 3s 1/2 -> 2s 1/2 | H alpha |        0.0 |            0. |
| 3s 1/2 -> 2p 3/2 | H alpha | 4.2097e+06 |    0.66669306 |
|------------------+---------+------------+---------------|
|                  |         |   6.3143e6 |               |
|------------------+---------+------------+---------------|
#+TBLFM: @2$4..@3$4=$-1/@+I$-1::@4$3=vsum(@-II..@-I);s5::@5$4..@7$4=$-1/@+I$-1::@8$3=vsum(@-II..@-I);s5::@9$4..@12$4=$-1/@+I$-1::@13$3=vsum(@-II..@-I);s5


****** NIST table of just the 3s,3d transitions

|-------------+---------------+------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|
| Observed    |          Ritz | Rel. |        Aki | Acc. | Ei           Ek                     | Lower level           | Upper level           | gi   gk | Type | TP    | Line  |
| Wavelength  |    Wavelength | Int. |       s^-1 |      | (cm-1)       (cm-1)                 | --------------------- | --------------------- |         |      | Ref.  | Ref.  |
| Air  (Å)    |      Air  (Å) | (?)  |            |      |                                     | Conf.   Term  J       | Conf.   Term  J       |         |      |       |       |
|-------------+---------------+------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|
|             | 1025.72144677 |      |  5.937e+02 | AAA  | 0.0000000000   -   97492.355566     | 1s      2S    1/2     | 3d      2D    5/2     | 2 - 6   | E2   | T7651 |       |
|             | 1025.72182693 |      |  5.938e+02 | AAA  | 0.0000000000   -   97492.319433     | 1s      2S    1/2     | 3d      2D    3/2     | 2 - 4   | E2   | T7651 |       |
|             | 1025.72285517 |      |  1.109e-06 | AAA  | 0.0000000000   -   97492.221701     | 1s      2S    1/2     | 3s      2S    1/2     | 2 - 2   | M1   | T7651 |       |
|-------------+---------------+------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|
| 6562.709699 |   6562.709702 |      | 5.3877e+07 | AAA  | 82258.9191133      -   97492.319433 | 2p      2P*   1/2     | 3d      2D    3/2     | 2 - 4   |      | T8637 | L2752 |
|             |   6562.751807 |      | 2.1046e+06 | AAA  | 82258.9191133      -   97492.221701 | 2p      2P*   1/2     | 3s      2S    1/2     | 2 - 2   |      | T8637 |       |
|             |   6562.767009 |      |            |      | 82258.9543992821   -   97492.221701 | 2s      2S    1/2     | 3s      2S    1/2     | 2 - 2   | M1   |       |       |
| 6562.85175  |   6562.851769 |      | 6.4651e+07 | AAA  | 82259.2850014      -   97492.355566 | 2p      2P*   3/2     | 3d      2D    5/2     | 4 - 6   |      | T8637 | L2752 |
|             |   6562.867336 |      | 1.0775e+07 | AAA  | 82259.2850014      -   97492.319433 | 2p      2P*   3/2     | 3d      2D    3/2     | 4 - 4   |      | T8637 |       |
|             |   6562.909442 |      | 4.2097e+06 | AAA  | 82259.2850014      -   97492.221701 | 2p      2P*   3/2     | 3s      2S    1/2     | 4 - 2   |      | T8637 |       |
|-------------+---------------+------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|


***** Original NIST tables organised by line

****** Lyman lines

|-------------------+-------------------+--------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+-----------|
|          Observed |              Ritz |   Rel. |        Aki | Acc. | Ei           Ek                     | Lower level           | Upper level           | gi   gk | Type | TP    | Line      |
|        Wavelength |        Wavelength |   Int. |       s^-1 |      | (cm-1)       (cm-1)                 | --------------------- | --------------------- |         |      | Ref.  | Ref.      |
|          Vac  (Å) |          Vac  (Å) |    (?) |            |      |                                     | Conf.   Term  J       | Conf.   Term  J       |         |      |       |           |
|-------------------+-------------------+--------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+-----------|
|                   |                   |        |            |      |                                     |                       |                       |         |      |       |           |
|           937.801 |     937.803361139 |        | 1.9728e+07 | AAA  | 0.0000000000   - [106632.1620756]   | 1s      2S    1/2     | 6p      2P*   3/2     | 2 - 4   |      | T8637 | L8445     |
|           937.801 |     937.803480320 |        | 1.9728e+07 | AAA  | 0.0000000000   - [106632.1485242]   | 1s      2S    1/2     | 6p      2P*   1/2     | 2 - 2   |      | T8637 | L8445     |
|                   |     937.803468734 |        |            |      | 0.0000000000   -  106632.1498416    | 1s      2S    1/2     | 6s      2S    1/2     | 2 - 2   | M1   |       |           |
|           937.814 |         937.80340 |  19000 | 1.6440e+06 | AAA  | 0.0000000000   -  106632.1681       | 1s      2S    1/2     | 6                     | 2 -     |      | T8637 | L8834     |
|-------------------+-------------------+--------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+-----------|
|           949.742 |       949.7429095 |        | 3.4375e+07 | AAA  | 0.0000000000   -  105291.65209      | 1s      2S    1/2     | 5p      2P*   3/2     | 2 - 4   |      | T8637 | L3545     |
|                   |                   |        |            |      |                                     |                       |                       |         |      |       |           |
|           949.742 |         949.74298 |  33000 | 4.1250e+06 | AAA  | 0.0000000000   -  105291.657        | 1s      2S    1/2     | 5                     | 2 -     |      | T8637 | L3545     |
|           949.742 |       949.7431207 |        | 3.4375e+07 | AAA  | 0.0000000000   -  105291.62867      | 1s      2S    1/2     | 5p      2P*   1/2     | 2 - 2   |      | T8637 | L3545     |
|      949.74284001 |      949.74283998 |        |            |      | 0.0000000000   - [105291.659796]    | 1s      2S    1/2     | 5d      2D    5/2     | 2 - 6   | E2   |       | L15291c37 |
|       949.7431001 |       949.7431002 |        |            |      | 0.0000000000   - [105291.63094]     | 1s      2S    1/2     | 5s      2S    1/2     | 2 - 2   | M1   |       | L15291c36 |
|-------------------+-------------------+--------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+-----------|
|           972.517 |         972.53674 |  83000 | 1.2785e+07 | AAA  | 0.0000000000   -  102823.904        | 1s      2S    1/2     | 4                     | 2 -     |      | T8637 | L8834     |
|                   |                   |        |            |      |                                     |                       |                       |         |      |       |           |
|                   |     972.536984969 |        |            |      | 0.0000000000   -  102823.8530211    | 1s      2S    1/2     | 4s      2S    1/2     | 2 - 2   | M1   |       |           |
|           972.541 |     972.536594376 |        | 6.8186e+07 | AAA  | 0.0000000000   -  102823.8943175    | 1s      2S    1/2     | 4p      2P*   3/2     | 2 - 4   |      | T8637 | L8445     |
|           972.541 |     972.537026950 |        | 6.8186e+07 | AAA  | 0.0000000000   -  102823.8485825    | 1s      2S    1/2     | 4p      2P*   1/2     | 2 - 2   |      | T8637 | L8445     |
|-------------------+-------------------+--------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+-----------|
|                   |     1025.72144677 |        |  5.937e+02 | AAA  | 0.0000000000   -   97492.355566     | 1s      2S    1/2     | 3d      2D    5/2     | 2 - 6   | E2   | T7651 |           |
|                   |     1025.72182693 |        |  5.938e+02 | AAA  | 0.0000000000   -   97492.319433     | 1s      2S    1/2     | 3d      2D    3/2     | 2 - 4   | E2   | T7651 |           |
|                   |                   |        |            |      |                                     |                       |                       |         |      |       |           |
|                   |     1025.72285517 |        |  1.109e-06 | AAA  | 0.0000000000   -   97492.221701     | 1s      2S    1/2     | 3s      2S    1/2     | 2 - 2   | M1   | T7651 |           |
|          1025.728 |     1025.72182505 |        | 1.6725e+08 | AAA  | 0.0000000000   -   97492.319611     | 1s      2S    1/2     | 3p      2P*   3/2     | 2 - 4   |      | T8637 | L3545     |
|          1025.728 |         1025.7222 | 250000 | 5.5751e+07 | AAA  | 0.0000000000   -   97492.304        | 1s      2S    1/2     | 3                     | 2 -     |      | T8637 | L3545     |
|          1025.728 |     1025.72296565 |        | 1.6725e+08 | AAA  | 0.0000000000   -   97492.211200     | 1s      2S    1/2     | 3p      2P*   1/2     | 2 - 2   |      | T8637 | L3545     |
|-------------------+-------------------+--------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+-----------|
|         1215.6699 |    1215.668237310 |        | 6.2648e+08 | AAA  | 0.0000000000   -   82259.2850014    | 1s      2S    1/2     | 2p      2P*   3/2     | 2 - 4   |      | T8637 | L12020    |
|                   |                   |        |            |      |                                     |                       |                       |         |      |       |           |
|         1215.6699 |    1215.673644609 |        | 6.2649e+08 | AAA  | 0.0000000000   -   82258.9191133    | 1s      2S    1/2     | 2p      2P*   1/2     | 2 - 2   |      | T8637 | L12020    |
|         1215.6701 |         1215.6700 | 840000 | 4.6986e+08 | AAA  | 0.0000000000   -   82259.158        | 1s      2S    1/2     | 2                     | 2 -     |      | T8637 | L12020    |
| 1215.673123130200 | 1215.673123130200 |        |  2.495e-06 | AAA  | 0.0000000000   -   82258.9543992821 | 1s      2S    1/2     | 2s      2S    1/2     | 2 - 2   | M1   | T7651 | L12363    |
|-------------------+-------------------+--------+------------+------+-------------------------------------+-----------------------+-----------------------+---------+------+-------+-----------|

****** Balmer lines
|---------------+---------------+--------+------------+------+---------------------------------------+-----------------------+-----------------------+---------+------+-------+----------|
|      Observed |          Ritz |   Rel. |        Aki | Acc. | Ei           Ek                       | Lower level           | Upper level           | gi   gk | Type | TP    | Line     |
|    Wavelength |    Wavelength |   Int. |       s^-1 |      | (cm-1)       (cm-1)                   | --------------------- | --------------------- |         |      | Ref.  | Ref.     |
|      Air  (Å) |      Air  (Å) |    (?) |            |      |                                       | Conf.   Term  J       | Conf.   Term  J       |         |      |       |          |
|---------------+---------------+--------+------------+------+---------------------------------------+-----------------------+-----------------------+---------+------+-------+----------|
|               |               |        |            |      |                                       |                       |                       |         |      |       |          |
|               | 4101.70228371 |        | 4.2877e+06 | AAA  | 82258.9191133      - [106632.1620536] | 2p      2P*   1/2     | 6d      2D    3/2     | 2 - 4   |      | T8637 |          |
|               | 4101.70433887 |        | 2.4501e+05 | AAA  | 82258.9191133      -  106632.1498416  | 2p      2P*   1/2     | 6s      2S    1/2     | 2 - 2   |      | T8637 |          |
| 4101.70746200 | 4101.70746200 |        |            |      | 82258.9543992821   -  106632.1665697  | 2s      2S    1/2     | 6d      2D    5/2     | 2 - 6   | E2   |       | L11759   |
|               | 4101.70821833 |        | 2.8583e+06 | AAA  | 82258.9543992821   - [106632.1620756] | 2s      2S    1/2     | 6p      2P*   3/2     | 2 - 4   |      | T8637 |          |
| 4101.71027719 | 4101.71027719 |        |            |      | 82258.9543992821   -  106632.1498416  | 2s      2S    1/2     | 6s      2S    1/2     | 2 - 2   | M1   |       | L11759   |
|               |               |        |            |      |                                       |                       |                       |         |      |       |          |
|               | 4101.71049891 |        | 2.8584e+06 | AAA  | 82258.9543992821   - [106632.1485242] | 2s      2S    1/2     | 6p      2P*   1/2     | 2 - 2   |      | T8637 |          |
|      4101.734 |     4101.7415 |  70000 | 9.7320e+05 | AAA  | 82259.158          -  106632.1681     | 2                     | 6                     |         |      | T8637 | L7436c29 |
|               | 4101.76310010 |        | 5.1450e+06 | AAA  | 82259.2850014      -  106632.1665697  | 2p      2P*   3/2     | 6d      2D    5/2     | 4 - 6   |      | T8637 |          |
|               | 4101.76386014 |        | 8.5748e+05 | AAA  | 82259.2850014      - [106632.1620536] | 2p      2P*   3/2     | 6d      2D    3/2     | 4 - 4   |      | T8637 |          |
|               | 4101.76591536 |        | 4.9006e+05 | AAA  | 82259.2850014      -  106632.1498416  | 2p      2P*   3/2     | 6s      2S    1/2     | 4 - 2   |      | T8637 |          |
|---------------+---------------+--------+------------+------+---------------------------------------+-----------------------+-----------------------+---------+------+-------+----------|
|               |               |        |            |      |                                       |                       |                       |         |      |       |          |
|               |   4340.426937 |        | 7.8548e+06 | AAA  | 82258.9191133      -  105291.651993   | 2p      2P*   1/2     | 5d      2D    3/2     | 2 - 4   |      | T8637 |          |
|               |   4340.430904 |        | 4.2955e+05 | AAA  | 82258.9191133      - [105291.63094]   | 2p      2P*   1/2     | 5s      2S    1/2     | 2 - 2   |      | T8637 |          |
|               |   4340.433569 |        | 4.9483e+06 | AAA  | 82258.9543992821   -  105291.65209    | 2s      2S    1/2     | 5p      2P*   3/2     | 2 - 4   |      | T8637 |          |
|               |   4340.437553 |        |            |      | 82258.9543992821   - [105291.63094]   | 2s      2S    1/2     | 5s      2S    1/2     | 2 - 2   | M1   |       |          |
|               |   4340.437982 |        | 4.9484e+06 | AAA  | 82258.9543992821   -  105291.62867    | 2s      2S    1/2     | 5p      2P*   1/2     | 2 - 2   |      | T8637 |          |
|               |               |        |            |      |                                       |                       |                       |         |      |       |          |
|      4340.472 |      4340.471 |  90000 | 2.5304e+06 | AAA  | 82259.158          -  105291.657      | 2                     | 5                     |         |      | T8637 | L7436c29 |
|               |   4340.494419 |        | 9.4254e+06 | AAA  | 82259.2850014      - [105291.659796]  | 2p      2P*   3/2     | 5d      2D    5/2     | 4 - 6   |      | T8637 |          |
|               |   4340.495889 |        | 1.5709e+06 | AAA  | 82259.2850014      -  105291.651993   | 2p      2P*   3/2     | 5d      2D    3/2     | 4 - 4   |      | T8637 |          |
|               |   4340.499856 |        | 8.5920e+05 | AAA  | 82259.2850014      - [105291.63094]   | 2p      2P*   3/2     | 5s      2S    1/2     | 4 - 2   |      | T8637 |          |
|---------------+---------------+--------+------------+------+---------------------------------------+-----------------------+-----------------------+---------+------+-------+----------|
|               |  4861.2786238 |        | 1.7188e+07 | AAA  | 82258.9191133      -  102823.894250   | 2p      2P*   1/2     | 4d      2D    3/2     | 2 - 4   |      | T8637 |          |
|               |               |        |            |      |                                       |                       |                       |         |      |       |          |
| 4861.28336326 | 4861.28336324 |        |            |      | 82258.9543992821   -  102823.9094871  | 2s      2S    1/2     | 4d      2D    5/2     | 2 - 6   | E2   |       | L9496    |
| 4861.28694917 | 4861.28694918 |        | 9.6680e+06 | AAA  | 82258.9543992821   -  102823.8943175  | 2s      2S    1/2     | 4p      2P*   3/2     | 2 - 4   |      | T8637 | L9477    |
|               | 4861.28836998 |        | 8.5941e+05 | AAA  | 82258.9191133      -  102823.8530211  | 2p      2P*   1/2     | 4s      2S    1/2     | 2 - 2   |      | T8637 |          |
| 4861.29671127 | 4861.29671127 |        |            |      | 82258.9543992821   -  102823.8530211  | 2s      2S    1/2     | 4s      2S    1/2     | 2 - 2   | M1   |       | L9496    |
| 4861.29776054 | 4861.29776053 |        | 9.6683e+06 | AAA  | 82258.9543992821   -  102823.8485825  | 2s      2S    1/2     | 4p      2P*   1/2     | 2 - 2   |      | T8637 | L9477    |
|               |               |        |            |      |                                       |                       |                       |         |      |       |          |
|       4861.35 |      4861.333 | 180000 | 8.4193e+06 | AAA  | 82259.158          -  102823.904      | 2                     | 4                     |         |      | T8637 | L7439c30 |
|               | 4861.36151557 |        | 2.0625e+07 | AAA  | 82259.2850014      -  102823.9094871  | 2p      2P*   3/2     | 4d      2D    5/2     | 4 - 6   |      | T8637 |          |
|               |  4861.3651175 |        | 3.4375e+06 | AAA  | 82259.2850014      -  102823.894250   | 2p      2P*   3/2     | 4d      2D    3/2     | 4 - 4   |      | T8637 |          |
|               | 4861.37486402 |        | 1.7190e+06 | AAA  | 82259.2850014      -  102823.8530211  | 2p      2P*   3/2     | 4s      2S    1/2     | 4 - 2   |      | T8637 |          |
|---------------+---------------+--------+------------+------+---------------------------------------+-----------------------+-----------------------+---------+------+-------+----------|
|   6562.709699 |   6562.709702 |        | 5.3877e+07 | AAA  | 82258.9191133      -   97492.319433   | 2p      2P*   1/2     | 3d      2D    3/2     | 2 - 4   |      | T8637 | L2752    |
|               |               |        |            |      |                                       |                       |                       |         |      |       |          |
|   6562.724827 |   6562.724827 |        | 2.2448e+07 | AAA  | 82258.9543992821   -   97492.319611   | 2s      2S    1/2     | 3p      2P*   3/2     | 2 - 4   |      | T8637 | L6891c38 |
|               |   6562.751807 |        | 2.1046e+06 | AAA  | 82258.9191133      -   97492.221701   | 2p      2P*   1/2     | 3s      2S    1/2     | 2 - 2   |      | T8637 |          |
|               |   6562.767009 |        |            |      | 82258.9543992821   -   97492.221701   | 2s      2S    1/2     | 3s      2S    1/2     | 2 - 2   | M1   |       |          |
|   6562.771534 |   6562.771533 |        | 2.2449e+07 | AAA  | 82258.9543992821   -   97492.211200   | 2s      2S    1/2     | 3p      2P*   1/2     | 2 - 2   |      | T8637 | L6891c38 |
|       6562.79 |      6562.819 | 500000 | 4.4101e+07 | AAA  | 82259.158          -   97492.304      | 2                     | 3                     |         |      | T8637 | L7400c29 |
|               |               |        |            |      |                                       |                       |                       |         |      |       |          |
|    6562.85175 |   6562.851769 |        | 6.4651e+07 | AAA  | 82259.2850014      -   97492.355566   | 2p      2P*   3/2     | 3d      2D    5/2     | 4 - 6   |      | T8637 | L2752    |
|               |   6562.867336 |        | 1.0775e+07 | AAA  | 82259.2850014      -   97492.319433   | 2p      2P*   3/2     | 3d      2D    3/2     | 4 - 4   |      | T8637 |          |
|               |   6562.909442 |        | 4.2097e+06 | AAA  | 82259.2850014      -   97492.221701   | 2p      2P*   3/2     | 3s      2S    1/2     | 4 - 2   |      | T8637 |          |
|---------------+---------------+--------+------------+------+---------------------------------------+-----------------------+-----------------------+---------+------+-------+----------|

****** Paschen lines
|------------+--------------+---------+------------+------+----------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|
|   Observed |         Ritz | Rel.    |        Aki | Acc. | Ei           Ek                        | Lower level           | Upper level           | gi   gk | Type | TP    | Line  |
| Wavelength |   Wavelength | Int.    |       s^-1 |      | (cm-1)       (cm-1)                    | --------------------- | --------------------- |         |      | Ref.  | Ref.  |
|   Air  (Å) |     Air  (Å) | (?)     |            |      |                                        | Conf.   Term  J       | Conf.   Term  J       |         |      |       |       |
|------------+--------------+---------+------------+------+----------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|
|            | 10937.981995 |         | 1.5649e+06 | AAA  | 97492.211200       - [106632.1620536]  | 3p      2P*   1/2     | 6d      2D    3/2     | 2 - 4   |      | T8637 |       |
|            | 10937.994535 |         | 9.5508e+05 | AAA  | 97492.221701       - [106632.1620756]  | 3s      2S    1/2     | 6p      2P*   3/2     | 2 - 4   |      | T8637 |       |
|            |              |         |            |      |                                        |                       |                       |         |      |       |       |
|            | 10937.996609 |         | 1.6906e+05 | AAA  | 97492.211200       -  106632.1498416   | 3p      2P*   1/2     | 6s      2S    1/2     | 2 - 2   |      | T8637 |       |
|            | 10938.010753 |         | 9.5511e+05 | AAA  | 97492.221701       - [106632.1485242]  | 3s      2S    1/2     | 6p      2P*   1/2     | 2 - 2   |      | T8637 |       |
|            | 10938.106119 |         | 2.0030e+06 | AAA  | 97492.319433       - (106632.16656761) | 3d      2D    3/2     | 6f      2F*   5/2     | 4 - 6   |      | T8637 |       |
|            | 10938.106330 |         | 1.8778e+06 | AAA  | 97492.319611       -  106632.1665697   | 3p      2P*   3/2     | 6d      2D    5/2     | 4 - 6   |      | T8637 |       |
|            | 10938.111495 |         | 7.8242e+03 | AAA  | 97492.319433       - [106632.1620756]  | 3d      2D    3/2     | 6p      2P*   3/2     | 4 - 4   |      | T8637 |       |
|            |              |         |            |      |                                        |                       |                       |         |      |       |       |
|            | 10938.111735 |         | 3.1296e+05 | AAA  | 97492.319611       - [106632.1620536]  | 3p      2P*   3/2     | 6d      2D    3/2     | 4 - 4   |      | T8637 |       |
|            | 10938.126349 |         | 3.3815e+05 | AAA  | 97492.319611       -  106632.1498416   | 3p      2P*   3/2     | 6s      2S    1/2     | 4 - 2   |      | T8637 |       |
|            | 10938.127713 |         | 7.8253e+04 | AAA  | 97492.319433       - [106632.1485242]  | 3d      2D    3/2     | 6p      2P*   1/2     | 4 - 2   |      | T8637 |       |
|            | 10938.146659 |         | 2.1460e+06 | AAA  | 97492.355566       - (106632.16882614) | 3d      2D    5/2     | 6f      2F*   7/2     | 6 - 8   |      | T8637 |       |
|            | 10938.149362 |         | 1.4307e+05 | AAA  | 97492.355566       - (106632.16656761) | 3d      2D    5/2     | 6f      2F*   5/2     | 6 - 6   |      | T8637 |       |
|            |              |         |            |      |                                        |                       |                       |         |      |       |       |
|            | 10938.154738 |         | 7.0421e+04 | AAA  | 97492.355566       - [106632.1620756]  | 3d      2D    5/2     | 6p      2P*   3/2     | 6 - 4   |      | T8637 |       |
|   10938.17 |    10938.086 | 14000   | 7.7829e+05 | AAA  | 97492.304          -  106632.1681      | 3                     | 6                     |         |      | T8637 | L7421 |
|------------+--------------+---------+------------+------+----------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|
|            |  12817.92576 |         | 2.8263e+06 | AAA  | 97492.211200       -  105291.651993    | 3p      2P*   1/2     | 5d      2D    3/2     | 2 - 4   |      | T8637 |       |
|            |  12817.94286 |         | 1.6377e+06 | AAA  | 97492.221701       -  105291.65209     | 3s      2S    1/2     | 5p      2P*   3/2     | 2 - 4   |      | T8637 |       |
|            |  12817.96036 |         | 3.0157e+05 | AAA  | 97492.211200       - [105291.63094]    | 3p      2P*   1/2     | 5s      2S    1/2     | 2 - 2   |      | T8637 |       |
|            |              |         |            |      |                                        |                       |                       |         |      |       |       |
|            |  12817.98135 |         | 1.6378e+06 | AAA  | 97492.221701       -  105291.62867     | 3s      2S    1/2     | 5p      2P*   1/2     | 2 - 2   |      | T8637 |       |
|  12818.072 |    12818.070 | 32000   | 2.2008e+06 | AAA  | 97492.304          -  105291.657       | 3                     | 5                     |         |      | T8637 | L7421 |
|            |  12818.09075 |         | 4.2394e+06 | AAA  | 97492.319433       - (105291.65983494) | 3d      2D    3/2     | 5f      2F*   5/2     | 4 - 6   |      | T8637 |       |
|            |  12818.09111 |         | 3.3915e+06 | AAA  | 97492.319611       - [105291.659796]   | 3p      2P*   3/2     | 5d      2D    5/2     | 4 - 6   |      | T8637 |       |
|            |  12818.10348 |         | 1.4954e+04 | AAA  | 97492.319433       -  105291.65209     | 3d      2D    3/2     | 5p      2P*   3/2     | 4 - 4   |      | T8637 |       |
|            |              |         |            |      |                                        |                       |                       |         |      |       |       |
|            |  12818.10393 |         | 5.6525e+05 | AAA  | 97492.319611       -  105291.651993    | 3p      2P*   3/2     | 5d      2D    3/2     | 4 - 4   |      | T8637 |       |
|            |  12818.13853 |         | 6.0320e+05 | AAA  | 97492.319611       - [105291.63094]    | 3p      2P*   3/2     | 5s      2S    1/2     | 4 - 2   |      | T8637 |       |
|            |  12818.14197 |         | 1.4956e+05 | AAA  | 97492.319433       -  105291.62867     | 3d      2D    3/2     | 5p      2P*   1/2     | 4 - 2   |      | T8637 |       |
|            |  12818.14378 |         | 4.5421e+06 | AAA  | 97492.355566       -  105291.66370     | 3d      2D    5/2     | 5f      2F*   7/2     | 6 - 8   |      | T8637 |       |
|            | 12818.150135 |         | 3.0281e+05 | AAA  | 97492.355566       - (105291.65983494) | 3d      2D    5/2     | 5f      2F*   5/2     | 6 - 6   |      | T8637 |       |
|            |  12818.16286 |         | 1.3459e+05 | AAA  | 97492.355566       -  105291.65209     | 3d      2D    5/2     | 5p      2P*   3/2     | 6 - 4   |      | T8637 |       |
|------------+--------------+---------+------------+------+----------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|
|            |              |         |            |      |                                        |                       |                       |         |      |       |       |
|            |  18750.68381 |         | 5.8647e+06 | AAA  | 97492.211200       -  102823.894250    | 3p      2P*   1/2     | 4d      2D    3/2     | 2 - 4   |      | T8637 |       |
|            |  18750.72050 |         | 3.0650e+06 | AAA  | 97492.221701       -  102823.8943175   | 3s      2S    1/2     | 4p      2P*   3/2     | 2 - 4   |      | T8637 |       |
|            |  18750.82881 |         | 6.1182e+05 | AAA  | 97492.211200       -  102823.8530211   | 3p      2P*   1/2     | 4s      2S    1/2     | 2 - 2   |      | T8637 |       |
|            |  18750.88135 |         | 3.0652e+06 | AAA  | 97492.221701       -  102823.8485825   | 3s      2S    1/2     | 4p      2P*   1/2     | 2 - 2   |      | T8637 |       |
|            |              |         |            |      |                                        |                       |                       |         |      |       |       |
|            |  18751.01086 |         | 1.2869e+07 | AAA  | 97492.319433       -  102823.90949     | 3d      2D    3/2     | 4f      2F*   5/2     | 4 - 6   |      | T8637 |       |
|            |  18751.01149 |         | 7.0376e+06 | AAA  | 97492.319611       -  102823.9094871   | 3p      2P*   3/2     | 4d      2D    5/2     | 4 - 6   |      | T8637 |       |
|            |  18751.06422 |         | 3.4754e+04 | AAA  | 97492.319433       -  102823.8943175   | 3d      2D    3/2     | 4p      2P*   3/2     | 4 - 4   |      | T8637 |       |
|            |  18751.06508 |         | 1.1729e+06 | AAA  | 97492.319611       -  102823.894250    | 3p      2P*   3/2     | 4d      2D    3/2     | 4 - 4   |      | T8637 |       |
|            |  18751.11120 |         | 1.3788e+07 | AAA  | 97492.355566       -  102823.917091    | 3d      2D    5/2     | 4f      2F*   7/2     | 6 - 8   |      | T8637 |       |
|            |              |         |            |      |                                        |                       |                       |         |      |       |       |
|            |  18751.13794 |         | 9.1919e+05 | AAA  | 97492.355566       -  102823.90949     | 3d      2D    5/2     | 4f      2F*   5/2     | 6 - 6   |      | T8637 |       |
|            |  18751.19130 |         | 3.1280e+05 | AAA  | 97492.355566       -  102823.8943175   | 3d      2D    5/2     | 4p      2P*   3/2     | 6 - 4   |      | T8637 |       |
|            |  18751.21008 |         | 1.2238e+06 | AAA  | 97492.319611       -  102823.8530211   | 3p      2P*   3/2     | 4s      2S    1/2     | 4 - 2   |      | T8637 |       |
|            |  18751.22507 |         | 3.4759e+05 | AAA  | 97492.319433       -  102823.8485825   | 3d      2D    3/2     | 4p      2P*   1/2     | 4 - 2   |      | T8637 |       |
|    18751.3 |    18750.976 | (51000) | 8.9860e+06 | AAA  | 97492.304          -  102823.904       | 3                     | 4                     |         |      | T8637 | L4812 |
|------------+--------------+---------+------------+------+----------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|


****** Br beta
|------------+--------------+--------+------------+------+-----------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|
| Observed   |         Ritz | Rel.   |        Aki | Acc. | Ei           Ek                         | Lower level           | Upper level           | gi   gk | Type | TP    | Line  |
| Wavelength |   Wavelength | Int.   |       s^-1 |      | (cm-1)       (cm-1)                     | --------------------- | --------------------- |         |      | Ref.  | Ref.  |
| Air  (Å)   |     Air  (Å) | (?)    |            |      |                                         | Conf.   Term  J       | Conf.   Term  J       |         |      |       |       |
|------------+--------------+--------+------------+------+-----------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|
|            |              |        |            |      |                                         |                       |                       |         |      |       |       |
|            | 26251.180525 |        | 7.1849e+05 | AAA  | 102823.8485825      - [106632.1620536]  | 4p      2P*   1/2     | 6d      2D    3/2     | 2 - 4   |      | T8637 |       |
|            | 26251.210969 |        | 4.4561e+05 | AAA  | 102823.8530211      - [106632.1620756]  | 4s      2S    1/2     | 6p      2P*   3/2     | 2 - 4   |      | T8637 |       |
|            | 26251.264704 |        | 1.1942e+05 | AAA  | 102823.8485825      -  106632.1498416   | 4p      2P*   1/2     | 6s      2S    1/2     | 2 - 2   |      | T8637 |       |
|            | 26251.304381 |        | 4.4563e+05 | AAA  | 102823.8530211      - [106632.1485242]  | 4s      2S    1/2     | 6p      2P*   1/2     | 2 - 2   |      | T8637 |       |
|            |  26251.46421 |        | 1.2012e+06 | AAA  | 102823.894250       - (106632.16656761) | 4d      2D    3/2     | 6f      2F*   5/2     | 4 - 6   |      | T8637 |       |
|            |              |        |            |      |                                         |                       |                       |         |      |       |       |
|            | 26251.464654 |        | 8.6219e+05 | AAA  | 102823.8943175      -  106632.1665697   | 4p      2P*   3/2     | 6d      2D    5/2     | 4 - 6   |      | T8637 |       |
|            |  26251.49517 |        | 9.4169e+03 | AAA  | 102823.894250       - [106632.1620756]  | 4d      2D    3/2     | 6p      2P*   3/2     | 4 - 4   |      | T8637 |       |
|            | 26251.495786 |        | 1.4370e+05 | AAA  | 102823.8943175      - [106632.1620536]  | 4p      2P*   3/2     | 6d      2D    3/2     | 4 - 4   |      | T8637 |       |
| 26251.55   |     26251.52 | (9000) | 7.7110e+05 | AAA  | 102823.904          -  106632.1681      | 4                     | 6                     |         |      | T8637 | L7452 |
|            | 26251.553669 |        | 1.2870e+06 | AAA  | 102823.9094871      - (106632.16882614) | 4d      2D    5/2     | 6f      2F*   7/2     | 6 - 8   |      | T8637 |       |
|            |              |        |            |      |                                         |                       |                       |         |      |       |       |
|            |   26251.5537 |        | 1.3238e+06 | AAA  | 102823.90949        - (106632.16882188) | 4f      2F*   5/2     | 6g      2G    7/2     | 6 - 8   |      | T8637 |       |
|            | 26251.569238 |        | 8.5799e+04 | AAA  | 102823.9094871      - (106632.16656761) | 4d      2D    5/2     | 6f      2F*   5/2     | 6 - 6   |      | T8637 |       |
|            |   26251.5693 |        | 1.0214e+03 | AAA  | 102823.90949        -  106632.1665697   | 4f      2F*   5/2     | 6d      2D    5/2     | 6 - 6   |      | T8637 |       |
|            | 26251.579967 |        | 2.3885e+05 | AAA  | 102823.8943175      -  106632.1498416   | 4p      2P*   3/2     | 6s      2S    1/2     | 4 - 2   |      | T8637 |       |
|            |  26251.58858 |        | 9.4181e+04 | AAA  | 102823.894250       - [106632.1485242]  | 4d      2D    3/2     | 6p      2P*   1/2     | 4 - 2   |      | T8637 |       |
|            |              |        |            |      |                                         |                       |                       |         |      |       |       |
|            |  26251.59677 |        | 1.3728e+06 | AAA  | 102823.917091       - (106632.17017701) | 4f      2F*   7/2     | 6g      2G    9/2     | 8 - 10  |      | T8637 |       |
|            | 26251.600203 |        | 8.4755e+04 | AAA  | 102823.9094871      - [106632.1620756]  | 4d      2D    5/2     | 6p      2P*   3/2     | 6 - 4   |      | T8637 |       |
|            |   26251.6004 |        | 2.1451e+04 | AAA  | 102823.90949        - [106632.1620536]  | 4f      2F*   5/2     | 6d      2D    3/2     | 6 - 4   |      | T8637 |       |
|            |  26251.60611 |        | 4.9028e+04 | AAA  | 102823.917091       - (106632.16882188) | 4f      2F*   7/2     | 6g      2G    7/2     | 8 - 8   |      | T8637 |       |
|            |  26251.62164 |        | 2.0429e+04 | AAA  | 102823.917091       -  106632.1665697   | 4f      2F*   7/2     | 6d      2D    5/2     | 8 - 6   |      | T8637 |       |
|------------+--------------+--------+------------+------+-----------------------------------------+-----------------------+-----------------------+---------+------+-------+-------|


***** All H lines up to n=12 from van Hoof (summed over all l,j-states)

+ Note that Lyman lines are vacuum wavelengths, whereas all others are air wavelengths

| LAB WAVL ANG VAC |    DLAM | SPC | TT | CONF    |  TERM | J_i J_k             |     A_ki | TPF | LVL EN  CM 1          | REF |
|------------------+---------+-----+----+---------+-------+---------------------+----------+-----+-----------------------+-----|
|       918.129309 | 6.7E-06 | H I | E1 | 1*-12*  |  1-12 | 1/2 - 1/2-23/2      | 5.06E+04 |   1 | 0.00 - 108917.12      | 007 |
|       919.351348 | 8.8E-06 | H I | E1 | 1*-11*  |  1-11 | 1/2 - 1/2-21/2      | 7.83E+04 |   1 | 0.00 - 108772.34      | 007 |
|       920.963023 | 1.2E-05 | H I | E1 | 1*-10*  |  1-10 | 1/2 - 1/2-19/2      | 1.26E+05 |   1 | 0.00 - 108582.00      | 007 |
|       923.150296 | 1.6E-05 | H I | E1 | 1*-9*   |   1-9 | 1/2 - 1/2-17/2      | 2.14E+05 |   1 | 0.00 - 108324.73      | 007 |
|       926.225637 | 2.3E-05 | H I | E1 | 1*-8*   |   1-8 | 1/2 - 1/2-15/2      | 3.87E+05 |   1 | 0.00 - 107965.06      | 007 |
|        930.74820 | 3.5E-05 | H I | E1 | 1*-7*   |   1-7 | 1/2 - 1/2-13/2      | 7.56E+05 |   1 | 0.00 - 107440.45      | 007 |
|        937.80340 | 5.6E-05 | H I | E1 | 1*-6*   |   1-6 | 1/2 - 1/2-11/2      | 1.64E+06 |   1 | 0.00 - 106632.17      | 007 |
|        949.74298 | 1.0E-04 | H I | E1 | 1*-5*   |   1-5 | 1/2 - 1/2-9/2       | 4.12E+06 |   1 | 0.00 - 105291.66      | 007 |
|        972.53674 | 2.0E-04 | H I | E1 | 1*-4*   |   1-4 | 1/2 - 1/2-7/2       | 1.28E+07 |   1 | 0.00 - 102823.90      | 007 |
|        1025.7222 | 5.4E-04 | H I | E1 | 1*-3*   |   1-3 | 1/2 - 1/2-5/2       | 5.57E+07 |   1 | 0.00 -  97492.31      | 007 |
|        1215.6700 | 2.5E-03 | H I | E1 | 1*-2*   |   1-2 | 1/2 - 1/2-3/2       | 4.69E+08 |   1 | 0.00 -  82259.11      | 007 |
|------------------+---------+-----+----+---------+-------+---------------------+----------+-----+-----------------------+-----|
| LAB WAVL ANG AIR |    DLAM | SPC | TT | CONF    |  TERM | J_i J_k             |     A_ki | TPF | LEVEL ENERGY  CM^ 1   | REF |
|------------------+---------+-----+----+---------+-------+---------------------+----------+-----+-----------------------+-----|
|         3750.152 | 1.4E-02 | H I | E1 | 2*-12*  |  2-12 | 1/2-3/2 - 1/2-23/2  | 2.83E+04 |   1 | 82259.11 - 108917.12  | 007 |
|         3770.630 | 1.4E-02 | H I | E1 | 2*-11*  |  2-11 | 1/2-3/2 - 1/2-21/2  | 4.39E+04 |   1 | 82259.11 - 108772.34  | 007 |
|         3797.897 | 1.4E-02 | H I | E1 | 2*-10*  |  2-10 | 1/2-3/2 - 1/2-19/2  | 7.11E+04 |   1 | 82259.11 - 108582.00  | 007 |
|         3835.384 | 1.5E-02 | H I | E1 | 2*-9*   |   2-9 | 1/2-3/2 - 1/2-17/2  | 1.21E+05 |   1 | 82259.11 - 108324.73  | 007 |
|         3889.049 | 1.5E-02 | H I | E1 | 2*-8*   |   2-8 | 1/2-3/2 - 1/2-15/2  | 2.21E+05 |   1 | 82259.11 - 107965.06  | 007 |
|         3970.072 | 1.6E-02 | H I | E1 | 2*-7*   |   2-7 | 1/2-3/2 - 1/2-13/2  | 4.38E+05 |   1 | 82259.11 - 107440.45  | 007 |
|         4101.735 | 1.7E-02 | H I | E1 | 2*-6*   |   2-6 | 1/2-3/2 - 1/2-11/2  | 9.72E+05 |   1 | 82259.11 - 106632.17  | 007 |
|         4340.463 | 1.9E-02 | H I | E1 | 2*-5*   |   2-5 | 1/2-3/2 - 1/2-9/2   | 2.53E+06 |   1 | 82259.11 - 105291.66  | 007 |
|         4861.325 | 2.3E-02 | H I | E1 | 2*-4*   |   2-4 | 1/2-3/2 - 1/2-7/2   | 8.41E+06 |   1 | 82259.11 - 102823.90  | 007 |
|          6562.80 | 3.9E-02 | H I | E1 | 2*-3*   |   2-3 | 1/2-3/2 - 1/2-5/2   | 4.41E+07 |   1 | 82259.11 -  97492.31  | 007 |
|         8750.472 | 1.8E-02 | H I | E1 | 3*-12*  |  3-12 | 1/2-5/2 - 1/2-23/2  | 2.02E+04 |   1 | 97492.31 - 108917.12  | 007 |
|         8862.783 | 1.9E-02 | H I | E1 | 3*-11*  |  3-11 | 1/2-5/2 - 1/2-21/2  | 3.15E+04 |   1 | 97492.31 - 108772.34  | 007 |
|         9014.910 | 1.9E-02 | H I | E1 | 3*-10*  |  3-10 | 1/2-5/2 - 1/2-19/2  | 5.15E+04 |   1 | 97492.31 - 108582.00  | 007 |
|         9229.015 | 2.0E-02 | H I | E1 | 3*-9*   |   3-9 | 1/2-5/2 - 1/2-17/2  | 8.90E+04 |   1 | 97492.31 - 108324.73  | 007 |
|         9545.971 | 2.1E-02 | H I | E1 | 3*-8*   |   3-8 | 1/2-5/2 - 1/2-15/2  | 1.65E+05 |   1 | 97492.31 - 107965.06  | 007 |
|        10049.373 | 2.3E-02 | H I | E1 | 3*-7*   |   3-7 | 1/2-5/2 - 1/2-13/2  | 3.35E+05 |   1 | 97492.31 - 107440.45  | 007 |
|        10938.095 | 2.6E-02 | H I | E1 | 3*-6*   |   3-6 | 1/2-5/2 - 1/2-11/2  | 7.77E+05 |   1 | 97492.31 - 106632.17  | 007 |
|         12818.08 | 3.3E-02 | H I | E1 | 3*-5*   |   3-5 | 1/2-5/2 - 1/2-9/2   | 2.20E+06 |   1 | 97492.31 - 105291.66  | 007 |
|         18751.01 | 5.9E-02 | H I | E1 | 3*-4*   |   3-4 | 1/2-5/2 - 1/2-7/2   | 8.98E+06 |   1 | 97492.31 - 102823.90  | 007 |
|        16407.192 | 2.1E-02 | H I | E1 | 4*-12*  |  4-12 | 1/2-7/2 - 1/2-23/2  | 1.62E+04 |   1 | 102823.90 - 108917.12 | 007 |
|        16806.521 | 2.2E-02 | H I | E1 | 4*-11*  |  4-11 | 1/2-7/2 - 1/2-21/2  | 2.55E+04 |   1 | 102823.90 - 108772.34 | 007 |
|        17362.108 | 2.3E-02 | H I | E1 | 4*-10*  |  4-10 | 1/2-7/2 - 1/2-19/2  | 4.23E+04 |   1 | 102823.90 - 108582.00 | 007 |
|        18174.121 | 2.5E-02 | H I | E1 | 4*-9*   |   4-9 | 1/2-7/2 - 1/2-17/2  | 7.45E+04 |   1 | 102823.90 - 108324.73 | 007 |
|        19445.562 | 2.8E-02 | H I | E1 | 4*-8*   |   4-8 | 1/2-7/2 - 1/2-15/2  | 1.42E+05 |   1 | 102823.90 - 107965.06 | 007 |
|         21655.29 | 3.2E-02 | H I | E1 | 4*-7*   |   4-7 | 1/2-7/2 - 1/2-13/2  | 3.04E+05 |   1 | 102823.90 - 107440.45 | 007 |
|         26251.51 | 4.3E-02 | H I | E1 | 4*-6*   |   4-6 | 1/2-7/2 - 1/2-11/2  | 7.70E+05 |   1 | 102823.90 - 106632.17 | 007 |
|         40511.58 | 8.0E-02 | H I | E1 | 4*-5*   |   4-5 | 1/2-7/2 - 1/2-9/2   | 2.70E+06 |   1 | 102823.90 - 105291.66 | 007 |
|        27575.154 | 2.5E-02 | H I | E1 | 5*-12*  |  5-12 | 1/2-9/2 - 1/2-23/2  | 1.40E+04 |   1 | 105291.66 - 108917.12 | 007 |
|        28722.124 | 2.6E-02 | H I | E1 | 5*-11*  |  5-11 | 1/2-9/2 - 1/2-21/2  | 2.24E+04 |   1 | 105291.66 - 108772.34 | 007 |
|        30383.735 | 2.8E-02 | H I | E1 | 5*-10*  |  5-10 | 1/2-9/2 - 1/2-19/2  | 3.80E+04 |   1 | 105291.66 - 108582.00 | 007 |
|         32960.93 | 3.2E-02 | H I | E1 | 5*-9*   |   5-9 | 1/2-9/2 - 1/2-17/2  | 6.90E+04 |   1 | 105291.66 - 108324.73 | 007 |
|         37395.37 | 3.8E-02 | H I | E1 | 5*-8*   |   5-8 | 1/2-9/2 - 1/2-15/2  | 1.39E+05 |   1 | 105291.66 - 107965.06 | 007 |
|         46525.09 | 5.2E-02 | H I | E1 | 5*-7*   |   5-7 | 1/2-9/2 - 1/2-13/2  | 3.25E+05 |   1 | 105291.66 - 107440.45 | 007 |
|         74578.24 | 1.0E-01 | H I | E1 | 5*-6*   |   5-6 | 1/2-9/2 - 1/2-11/2  | 1.02E+06 |   1 | 105291.66 - 106632.17 | 007 |
|        43752.613 | 2.9E-02 | H I | E1 | 6*-12*  |  6-12 | 1/2-11/2 - 1/2-23/2 | 1.29E+04 |   1 | 106632.17 - 108917.12 | 007 |
|         46712.35 | 3.2E-02 | H I | E1 | 6*-11*  |  6-11 | 1/2-11/2 - 1/2-21/2 | 2.11E+04 |   1 | 106632.17 - 108772.34 | 007 |
|         51272.59 | 3.6E-02 | H I | E1 | 6*-10*  |  6-10 | 1/2-11/2 - 1/2-19/2 | 3.68E+04 |   1 | 106632.17 - 108582.00 | 007 |
|         59066.03 | 4.4E-02 | H I | E1 | 6*-9*   |   6-9 | 1/2-11/2 - 1/2-17/2 | 7.06E+04 |   1 | 106632.17 - 108324.73 | 007 |
|         75004.48 | 6.1E-02 | H I | E1 | 6*-8*   |   6-8 | 1/2-11/2 - 1/2-15/2 | 1.56E+05 |   1 | 106632.17 - 107965.06 | 007 |
|        123685.26 | 1.2E-01 | H I | E1 | 6*-7*   |   6-7 | 1/2-11/2 - 1/2-13/2 | 4.56E+05 |   1 | 106632.17 - 107440.45 | 007 |
|         67701.45 | 3.5E-02 | H I | E1 | 7*-12*  |  7-12 | 1/2-13/2 - 1/2-23/2 | 1.25E+04 |   1 | 107440.45 - 108917.12 | 007 |
|         75060.58 | 4.0E-02 | H I | E1 | 7*-11*  |  7-11 | 1/2-13/2 - 1/2-21/2 | 2.12E+04 |   1 | 107440.45 - 108772.34 | 007 |
|         87576.77 | 4.9E-02 | H I | E1 | 7*-10*  |  7-10 | 1/2-13/2 - 1/2-19/2 | 3.90E+04 |   1 | 107440.45 - 108582.00 | 007 |
|        113056.13 | 7.0E-02 | H I | E1 | 7*-9*   |   7-9 | 1/2-13/2 - 1/2-17/2 | 8.23E+04 |   1 | 107440.45 - 108324.73 | 007 |
|        190567.03 | 1.5E-01 | H I | E1 | 7*-8*   |   7-8 | 1/2-13/2 - 1/2-15/2 | 2.27E+05 |   1 | 107440.45 - 107965.06 | 007 |
|        105006.36 | 4.4E-02 | H I | E1 | 8*-12*  |  8-12 | 1/2-15/2 - 1/2-23/2 | 1.29E+04 |   1 | 107965.06 - 108917.12 | 007 |
|        123837.92 | 5.5E-02 | H I | E1 | 8*-11*  |  8-11 | 1/2-15/2 - 1/2-21/2 | 2.30E+04 |   1 | 107965.06 - 108772.34 | 007 |
|        162046.86 | 7.9E-02 | H I | E1 | 8*-10*  |  8-10 | 1/2-15/2 - 1/2-19/2 | 4.67E+04 |   1 | 107965.06 - 108582.00 | 007 |
|        277958.02 | 1.7E-01 | H I | E1 | 8*-9*   |   8-9 | 1/2-15/2 - 1/2-17/2 | 1.23E+05 |   1 | 107965.06 - 108324.73 | 007 |
|        168760.27 | 6.0E-02 | H I | E1 | 9*-12*  |  9-12 | 1/2-17/2 - 1/2-23/2 | 1.43E+04 |   1 | 108324.73 - 108917.12 | 007 |
|        223343.68 | 8.8E-02 | H I | E1 | 9*-11*  |  9-11 | 1/2-17/2 - 1/2-21/2 | 2.81E+04 |   1 | 108324.73 - 108772.34 | 007 |
|        388592.73 | 1.9E-01 | H I | E1 | 9*-10*  |  9-10 | 1/2-17/2 - 1/2-19/2 | 7.14E+04 |   1 | 108324.73 - 108582.00 | 007 |
|        298313.68 | 9.7E-02 | H I | E1 | 10*-12* | 10-12 | 1/2-19/2 - 1/2-23/2 | 1.77E+04 |   1 | 108582.00 - 108917.12 | 007 |
|        525205.69 | 2.2E-01 | H I | E1 | 10*-11* | 10-11 | 1/2-19/2 - 1/2-21/2 | 4.37E+04 |   1 | 108582.00 - 108772.34 | 007 |
|        690531.41 | 2.4E-01 | H I | E1 | 11*-12* | 11-12 | 1/2-21/2 - 1/2-23/2 | 2.80E+04 |   1 | 108772.34 - 108917.12 | 007 |
 
*** Models of fluorescent excitation

+ We want to check that the metal lines and the D lines really do come from the same zone
+ Also look into high resolution synthetic spectra from stellar atmospheres
  + Luridiana et al (2009) suggest that O VI absorption in the wind can quench the stellar Ly beta flux.
  + But this is only if V_inf > 1700 km/s
  + For th1C the wind is probably slower than this

** Metal fluorescent lines 

+ Notes:
  + Line strengths are given on scale of Hb=100
  + And for 244-440 unless otherwise noted
    + Measured from p64-ff.fits, where Hb has peak of about 2.0
+ [N I]
  + 5198, 5200
  + strongest fluorescence lines: 0.3 (Trapezium) to 1.0 (244-440)
  + both are single
  + potentially contributions from collisions, chemistry
    + but at least 10 times weaker
+ O I
  + moderate strength to weak
    + 7002: 0.5
    + 6047: 0.5
    + 5959: 0.15
    + 5555: 0.2
    + 5513: 0.15
    + 5299: 0.2
    + 5275: 0.05
    + 4980: 0.05
  + all triplets (but 2 comps blended so look like doublets)
    + More details [[id:D7560FBA-D617-49BE-A846-7B45C997D741][down here]]
    + should be easy to deblend by my shift-subtract method
+ Ni I
+ Si II
  + has both a recombination and fluorescent component
+ Fe II
  + Lots of lines (but most are so weak they will be impossible to measure):
    + 6829
    + 5527
    + 5433
    + 5377
    + 5334
    + 5273
    + 5262
    + 5169*
    + 5159
    + 5112
    + 5035
    + 4905
    + 4890
    + 4814
+ Co I 5147

** Further plans

*** Look at the Br-gamma line in the Keck NIR spectra

Do these have sufficient s/n to spot the Deuterium component?

*** Use Adal's UVES data from HH 202

+ [N I] lines are seen from the shock and the nebula
  + But ten times weaker in the shock relative to H beta
  + Probably the shock component is not fluoresced
+ They observe all the Balmer series
  + Useful for probing linewidth along the series
  + But may be difficult since the shock gets in the way

*** Observation with SPM?

+ Can we use the 35 micron slit with Mezcal?
+ Is there a CCD with small enough pixels to take advantage?

*** Other regions

+ Regions ionized by B stars
  + Will have a larger fluorescent/recombination ratio
  + But will be fainter in absolute terms



* Keck proplyd spectra revisited
  :LOGBOOK:
  CLOCK: [2012-05-10 Thu 08:48]--[2012-05-10 Thu 09:40] =>  0:52
  CLOCK: [2012-05-09 Wed 22:55]--[2012-05-09 Wed 23:50] =>  0:55
  :END:

** Other Orion observations in the Keck data archive
   CLOCK: [2012-05-27 Sun 20:53]--[2012-05-27 Sun 21:53] =>  1:00
   CLOCK: [2012-05-26 Sat 21:51]--[2012-05-27 Sun 00:20] =>  2:29
   CLOCK: [2012-05-26 Sat 19:53]--[2012-05-26 Sat 20:13] =>  0:20

+ It turns out that there are loads of data in the data archive. 
+ A 10 arcmin radius search around M42 gives 3553 science files.
+ Here are some that might be useful

*** Herbig - HIRES spectra of th1E

+ Program: H-alpha spectroscopy of anomalous pre-main-sequence stars
+ Wav range: 4350 to 6750 A
  + This goes bluer than the proplyd spectra
  + so includes the permitted O II lines
+ Exposure time: 1200, 1200, 180, 1200 sec
  + Strong lines such as [O III] are saturated on the longer exposures
+ Aperture: C1
  + This is 7 arcsec long
  + shorter than the proplyd spectra, but has same width: 0.861 arcsec

*** James Graham - NIRSPEC spectra of region around HH 201
+ Program: U36NS - Super Star Clusters
+ Wav range: 1.84 to 2.63 microns
  + See mainly sky lines, but a handful of nebular lines
  + Many show high velocity components
+ Aperture: 0.432 x 24

*** Graeme Smith - NIRSPEC spectra of regions near Trapezium
+ Program: U095NS - Winds from metal-poor Pop II stars
+ Wav range: 0.95 to 1.12 microns
  + Best position is JW538, which seems to go near LV1
    + or possible even near 170-334
  + several lines with high-velocity components
+ Aperture: 0.432 x 12

*** Morris - NIRSPEC AO spectra of big proplyds (e.g., 182-413)

+ Wav range 1.84 to 2.63 microns (NIRSPEC-7 filter)
  + HST 10 : 

*** Morris - NIRSPEC AO spectra of small Trapezium proplyds (LV knots)
+ Program: U32bANS - Dwarf spheroidal central black holes
+ Wav range: 1.84 to 2.63 microns
+ Aperture: 0.027 x 2.26
+ Sample data
  + [[file:KOA/NS.20041218.46108.fits][NS.20041218.46108.fits]]
+ Targets: bizarrely, the targets seem to be proplyds!
  + The LV3 spectrum seems to be the best!
    + [[file:KOA/NS.20041218.40353.fits][NS.20041218.40353.fits]]
  + And LV1 is amazing!!
    + [[file:KOA/NS.20041218.35707.fits][NS.20041218.35707.fits]]
    + You see a velocity gradient in the interproplyd shock!
  + LV2
    + [[file:KOA/NS.20041218.38524.fits][NS.20041218.38524.fits]]


*** Stanke - NIRSPEC H_2 spectra of BN/KL
+ Program: H33bNS - Molecular gas formation in the large Bok globule CB34
+ Wav range 2.11 to 2.13 microns (H2 filter)
  + [[file:KOA/NS.20050131.29125.fits][NS.20050131.29125.fits]]
  + Just shows the 2.12 micron 1-0 S(1) line
+ Wav range 1.84 to 2.63 microns (NIRSPEC-7 filter)
  + [[file:KOA/NS.20050131.30306.fits][NS.20050131.30306.fits]]
+ 






** Structure of dataset

*** Instrument characteristics

+ Most spectra are with the C2 slit (14 arcsec x 0.574 arcsec)
+ Some are with the C3 slit (28 arcsec x 0.574 arcsec)
+ Instrument has plate scale of 0.725 mm/arcsec = 1.379 arcsec / mm =
  1.379e-3 arcsec/micron
+ Pixels 24 microns = 24 1.379e-3 = 3.3096e-2 arcsec (WRONG!!!)
+ Apparently, it should really be 0.191 arcsec/pixel
  + C2 slit length corresponds to 14/0.191 = 73 pixels
  + Our data seem to be double-binned in the sppatial direction
  + Pixel sixe: 0.382 arcsec
    + Yiannis observations are 6.6 x 4.2 arcsec
      + with pixels of 0.3 arcsec


**** List of available slits with resolutions

From http://www2.keck.hawaii.edu/inst/hires/

| Deckname | Length (") | Width (") | Resolution (calculated) | Resolution (measured*) | Resolution (measured+) |
|----------+------------+-----------+-------------------------+------------------------+------------------------|
| B1       |        3.5 |     0.574 | 72,000                  | 67,000                 | 66,400                 |
| B2       |        7.0 |     0.574 | 72,000                  | 67,000                 | 66,400                 |
| B3       |       14.0 |     0.574 | 72,000                  | 67,000                 | 66,400                 |
| B4       |       28.0 |     0.574 | 72,000                  | 67,000                 | 66,400                 |
| B5       |        3.5 |     0.861 | 48,000                  | 49,000                 | 50,000                 |
| C1       |        7.0 |     0.861 | 48,000                  | 49,000                 | 50,000                 |
| C2       |       14.0 |     0.861 | 48,000                  | 49,000                 | 50,000                 |
| C3       |       28.0 |     0.861 | 48,000                  | 49,000                 | 50,000                 |
| C4       |        3.5 |     1.148 | 36,000                  | 37,000                 | 37,500                 |
| C5       |        7.0 |     1.148 | 36,000                  | 37,000                 | 37,500                 |
| D1       |       14.0 |     1.148 | 36,000                  | 37,000                 | 37,500                 |
| D2       |       28.0 |     1.148 | 36,000                  | 37,000                 | 37,500                 |
| D3       |        7.0 |     1.722 | 24,000                  | 24,000                 | 24,700                 |
| D4       |       14.0 |     1.722 | 24,000                  | 24,000                 | 24,700                 |
| D5       |      0.119 |     0.179 | pinhole                 |                        |                        |
| E1       |        1.0 |     0.400 | 103,000                 | 84,000                 | 86,600                 |
| E2       |        3.0 |     0.400 | 103,000                 | 84,000                 | 86,600                 |
| E3       |        5.0 |     0.400 | 103,000                 | 84,000                 | 86,600                 |
| E4       |        7.0 |     0.400 | 103,000                 | 84,000                 | 86,600                 |
| E5       |        1.0 |     0.800 | 51,000                  | 52,000                 | 52,000                 |

*** Proplyd spectra

*** Jet spectra

*** Lamp spectra

**** ThAr lamp - t55.fits

**** Quartz lamp - q10.fits


** STARTED Reduction Strategy
   :LOGBOOK:
   - State "STARTED"    from ""           [2013-03-15 Fri 11:26]
   :END:

*** Just remove bias from all files

#+name: remove-bias
#+BEGIN_SRC python :results output verbatim :var targets="p"
  import astropy.io.fits as pyfits
  import glob
  import os
  
  filenames = glob.glob("Keck[12]/{}[0-9][0-9].fits".format(targets))
  
  for filename in filenames:
      obj, = pyfits.open(filename)
      bias = obj.data[:,2080:].mean()
      obj.data -= bias
      newfilename = "b".join(os.path.splitext(filename))
      obj.writeto(newfilename, output_verify='fix', clobber=True)
  
  
#+END_SRC

#+RESULTS:
: result silenced

#+RESULTS: remove-bias
#+begin_example
WARNING: Output verification result: [astropy.io.fits.verify]
WARNING: VerifyWarning: HDU 0: [astropy.io.fits.verify]
WARNING: VerifyWarning:     Card 14: [astropy.io.fits.verify]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:35:16 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Note: PyFITS uses zero-based indexing.
 [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p71b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:35:42 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p72b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:35:57 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p73b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:36:15 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p74b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:36:28 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p75b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:36:43 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p76b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:36:56 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p77b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:37:10 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p78b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:37:22 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p79b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:37:38 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p80b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:38:02 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p81b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:38:21 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p82b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:38:34 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p83b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:38:45 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p84b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:38:58 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p85b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:39:11 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p86b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:39:25 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck1/p87b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:     Card 5: [astropy.io.fits.verify]
WARNING: VerifyWarning:         Card 'OBJECT' is not FITS standard (invalid value string: 'Ori 170337,, PA=151 / IRAF .imh title).  Fixed 'OBJECT' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:28:31 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck2/p56b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:28:52 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck2/p57b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:29:06 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck2/p58b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:29:19 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck2/p59b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:29:34 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck2/p60b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:29:47 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck2/p61b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:30:03 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck2/p62b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:30:16 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck2/p63b.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:30:33 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Overwriting existing file 'Keck2/p64b.fits'. [astropy.io.fits.hdu.hdulist]
#+end_example

Do the same for the arc lamps
#+call: remove-bias(targets="t")

#+RESULTS: remove-bias(targets="t")
#+begin_example
WARNING: Output verification result: [astropy.io.fits.verify]
WARNING: VerifyWarning: HDU 0: [astropy.io.fits.verify]
WARNING: VerifyWarning:     Card 14: [astropy.io.fits.verify]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:40:25 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: Note: PyFITS uses zero-based indexing.
 [astropy.io.fits.verify]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:40:46 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:41:03 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:41:18 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:28:00 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
#+end_example

And do the same for the quartz lamps
#+call: remove-bias(targets="q")

#+RESULTS: remove-bias(targets="q")
: WARNING: Output verification result: [astropy.io.fits.verify]
: WARNING: VerifyWarning: HDU 0: [astropy.io.fits.verify]
: WARNING: VerifyWarning:     Card 14: [astropy.io.fits.verify]
: WARNING: VerifyWarning:         Card 'DATE-MOD' is not FITS standard (invalid value string: '1998-01-23T08:42:15 / Date of latest file modification).  Fixed 'DATE-MOD' card to meet the FITS standard. [astropy.io.fits.verify]
: WARNING: Note: PyFITS uses zero-based indexing.
:  [astropy.io.fits.verify]

*** Correcting for the blaze efficiency, etc

+ The variation in efficiency with wavelength along an order can be fit with a low-order polynomial. I call this function =blaze=, and the observed spectrum should be divided by it.
+ There is also a strange feature on the left, which I think is scattered light, which can be well represented by a function of the form \( x e^{-x }\).  I call this function =bump= and it should be subtracted before dividing by =blaze=.




**** Initial version - didn't work too well

+ In principle, thes functions might be different for the different orders.  However, there seems to be very little variation, so I have just found a global solution as a function of x-pixel on the chip. 



#+BEGIN_SRC python
import astropy.io.fits as pyfits
import numpy as np
hdu = pyfits.open("Keck1/p84b.fits")
im = hdu[0].data
ny, nx = im.shape
x = np.arange(nx)

med = np.median(im, axis=0)
im_med = np.vstack([med]*ny)
m = (im < 10.0) | (im > 50.0)
im2 = im.copy()
im2[m]  = im_med[m]
med2 = np.mean(im2, axis=0)
# determine polynomial by fitting to trimmed average profile
z = np.polyfit(x[250:2050], med2[250:2050], 3)
# z = [ -2.30584428e-09   2.87562023e-06   8.29433276e-03   1.46622494e+01]

p = np.poly1d(z)
blaze = p(x)/np.mean(p(x))
bump = 16.0*(x/30.0)*np.exp(-(x/30.0))

im -= bump[np.newaxis, :]
im /= blaze[np.newaxis, :]
hdu.writeto("Keck1/p84c.fits", clobber=True)

return z
#+END_SRC

#+RESULTS:
| -2.30584428e-09 | 2.87562023e-06 | 0.00829433276 | 14.6622494 |

+ [ ] This works kind of OK, but there is still a small linear term at the 20% level, which does vary with order.

**** Fixing blaze efficiency for all the files

#+BEGIN_SRC python :results output verbatim
  import astropy.io.fits as pyfits
  import glob
  import os
  import numpy as np
  
  z = [ -2.30584428e-09, 2.87562023e-06, 8.29433276e-03, 1.46622494e+01]
  p = np.poly1d(z)

  filenames = glob.glob("Keck[12]/[jp]*[0-9][0-9].fits")
  
  for filename in filenames:
      oldfilename = "b".join(os.path.splitext(filename))
      obj, = pyfits.open(oldfilename)
      im = obj.data
      ny, nx = im.shape
      x = np.arange(nx)
   
      blaze = p(x)/np.mean(p(x))
      bump = 16.0*(x/30.0)*np.exp(-(x/30.0))
       
      im -= bump[np.newaxis, :]
      im /= blaze[np.newaxis, :]

      newfilename = "c".join(os.path.splitext(filename))
      print ",**** Writing to ", newfilename
      obj.writeto(newfilename, output_verify='fix', clobber=True)
  
#+END_SRC

#+RESULTS:
#+begin_example
,**** Writing to  Keck1/p71c.fits
,**** Writing to  Keck1/p72c.fits
,**** Writing to  Keck1/p73c.fits
,**** Writing to  Keck1/p74c.fits
,**** Writing to  Keck1/p75c.fits
,**** Writing to  Keck1/p76c.fits
,**** Writing to  Keck1/p77c.fits
,**** Writing to  Keck1/p78c.fits
,**** Writing to  Keck1/p79c.fits
,**** Writing to  Keck1/p80c.fits
,**** Writing to  Keck1/p81c.fits
,**** Writing to  Keck1/p82c.fits
,**** Writing to  Keck1/p83c.fits
,**** Writing to  Keck1/p84c.fits
,WARNING: Overwriting existing file 'Keck1/p84c.fits'. [astropy.io.fits.hdu.hdulist]
,**** Writing to  Keck1/p85c.fits
,**** Writing to  Keck1/p86c.fits
,**** Writing to  Keck1/p87c.fits
,**** Writing to  Keck2/j65c.fits
,WARNING: Overwriting existing file 'Keck2/j65c.fits'. [astropy.io.fits.hdu.hdulist]
,**** Writing to  Keck2/j66c.fits
,WARNING: Overwriting existing file 'Keck2/j66c.fits'. [astropy.io.fits.hdu.hdulist]
,**** Writing to  Keck2/j67c.fits
,WARNING: Overwriting existing file 'Keck2/j67c.fits'. [astropy.io.fits.hdu.hdulist]
,**** Writing to  Keck2/j68c.fits
,WARNING: Overwriting existing file 'Keck2/j68c.fits'. [astropy.io.fits.hdu.hdulist]
,**** Writing to  Keck2/j69c.fits
,WARNING: Overwriting existing file 'Keck2/j69c.fits'. [astropy.io.fits.hdu.hdulist]
,**** Writing to  Keck2/j70c.fits
,WARNING: Overwriting existing file 'Keck2/j70c.fits'. [astropy.io.fits.hdu.hdulist]
,**** Writing to  Keck2/j71c.fits
,WARNING: Overwriting existing file 'Keck2/j71c.fits'. [astropy.io.fits.hdu.hdulist]
,**** Writing to  Keck2/je75c.fits
,WARNING: Overwriting existing file 'Keck2/je75c.fits'. [astropy.io.fits.hdu.hdulist]
,**** Writing to  Keck2/je76c.fits
,WARNING: Overwriting existing file 'Keck2/je76c.fits'. [astropy.io.fits.hdu.hdulist]
,**** Writing to  Keck2/jw72c.fits
,WARNING: Overwriting existing file 'Keck2/jw72c.fits'. [astropy.io.fits.hdu.hdulist]
,**** Writing to  Keck2/jw73c.fits
,WARNING: Overwriting existing file 'Keck2/jw73c.fits'. [astropy.io.fits.hdu.hdulist]
,**** Writing to  Keck2/jw74c.fits
,WARNING: Overwriting existing file 'Keck2/jw74c.fits'. [astropy.io.fits.hdu.hdulist]
,**** Writing to  Keck2/p56c.fits
,**** Writing to  Keck2/p57c.fits
,**** Writing to  Keck2/p58c.fits
,**** Writing to  Keck2/p59c.fits
,**** Writing to  Keck2/p60c.fits
,**** Writing to  Keck2/p61c.fits
,**** Writing to  Keck2/p62c.fits
,**** Writing to  Keck2/p63c.fits
,**** Writing to  Keck2/p64c.fits
#+end_example


*** Extracting each line

Programs are described in [[file:hires-extract/README.org][hires-extract/README.org]]



**** DONE Extracting and pixel-rectifying each order
     CLOSED: [2013-03-15 Fri 11:25]
:PROPERTIES:
:ID:       715877DD-07F2-42BC-A656-3038DD845675
:END:
+ [2013-02-21 Thu]
  + We try and make each order straight (horizontal), but without doing any interpolation.  This means that we shift columns by whole pixels only.  As a result, there are some saw-tooth artefacts along sharp edges.
+ [2013-03-12 Tue]
  + Now we do linear interpolation, which is much smoother

#+name: example-order-extraction
#+BEGIN_SRC sh :results verbatim
python hires-extract/extract-orders.py \
    Keck1/p84c Calibration/wav0070  Keck1/t70-orders
#+END_SRC

#+name: example-order-extraction-170337
#+BEGIN_SRC sh :results output
python hires-extract/extract-orders.py \
    Keck1/p73b Calibration/wav0070  Keck1/t70-orders
#+END_SRC

#+RESULTS: example-order-extraction-170337
#+begin_example
WARNING: Overwriting existing file 'orders-labels.fits'. [astropy.io.fits.hdu.hdulist]
astropy: WARNING: Overwriting existing file 'orders-labels.fits'.
Number of order boxes found:  26
Number of objects found:  24
Order 51 : 6909.79-7011.71
Label 24: 6909.78-7011.72

Number of good wavelength pixels found in order box:  77452 16386
WARNING: RuntimeWarning: invalid value encountered in divide [__main__]
astropy: WARNING: RuntimeWarning: invalid value encountered in divide
Order 52 : 6776.92-6876.91
Label 23: 6776.91-6876.92

Number of good wavelength pixels found in order box:  77445 16387
Order 53 : 6649.06-6747.20
Label 22: 6649.05-6747.21

Number of good wavelength pixels found in order box:  77439 16387
Order 54 : 6525.95-6622.29
Label 21: 6525.94-6622.30

Number of good wavelength pixels found in order box:  77448 16387
Order 55 : 6407.31-6501.92
Label 20: 6407.30-6501.93

Number of good wavelength pixels found in order box:  77463 16387
Order 56 : 6292.92-6385.85
Label 19: 6292.90-6385.86

Number of good wavelength pixels found in order box:  77496 16386
Order 57 : 6182.53-6273.85
Label 18: 6182.52-6273.86

Number of good wavelength pixels found in order box:  77520 16386
Order 58 : 6075.96-6165.71
Label 17: 6075.95-6165.72

Number of good wavelength pixels found in order box:  77560 16386
Order 59 : 5973.00-6061.23
Label 16: 5972.99-6061.24

Number of good wavelength pixels found in order box:  77605 16386
Order 60 : 5873.47-5960.23
Label 15: 5873.46-5960.24

Number of good wavelength pixels found in order box:  77664 16386
Order 61 : 5777.21-5862.55
Label 14: 5593.85-5862.56

Number of good wavelength pixels found in order box:  83154 16386
Order 62 : 5684.05-5768.01
Label 14: 5593.85-5862.56

Number of good wavelength pixels found in order box:  87634 16387
Order 63 : 5593.86-5676.47
Label 14: 5593.85-5862.56

Number of good wavelength pixels found in order box:  79033 16386
Order 64 : 5506.48-5587.79
Label 13: 5506.47-5587.80

Number of good wavelength pixels found in order box:  68313 16385
Order 65 : 5421.79-5501.84
Label 12: 5421.78-5501.85

Number of good wavelength pixels found in order box:  63342 16386
Order 66 : 5339.66-5418.49
Label 11: 5339.66-5418.50

Number of good wavelength pixels found in order box:  58401 16386
Order 67 : 5259.99-5337.62
Label 10: 5259.99-5337.63

Number of good wavelength pixels found in order box:  53483 16384
Order 68 : 5182.66-5259.13
Label 9: 5182.66-5259.14

Number of good wavelength pixels found in order box:  48495 16385
Order 69 : 5107.58-5182.92
Label 8: 5107.58-5182.93

Number of good wavelength pixels found in order box:  43471 16386
Order 70 : 5034.63-5108.88
Label 7: 5034.63-5108.89

Number of good wavelength pixels found in order box:  38332 15020
Order 71 : 4963.75-5036.92
Label 6: 4963.75-5036.93

Number of good wavelength pixels found in order box:  33049 7337
Order 72 : 4895.73-4965.46
Label 5: 4894.83-4966.97

Number of good wavelength pixels found in order box:  27583 45
Order 73 : No valid wavelengths found
Label 4: 4827.80-4898.92

Number of good wavelength pixels found in order box:  21908 21908
Order 74 : 4715.85-4768.27
Label 3: 4762.58-4832.71

Number of good wavelength pixels found in order box:  15977 15977
Order 75 : 4637.28-4705.52
Label 2: 4699.09-4768.27

Number of good wavelength pixels found in order box:  9768 9768
Order 76 : No valid wavelengths found
Label 1: 4637.28-4705.52

Number of good wavelength pixels found in order box:  3211 3211
#+end_example

#+name: display-extracted-orders
#+BEGIN_SRC sh :results none :var spec="p84b"
for i in $(seq -w 51 76); do
    xpaset -p ds9 frame new
    xpaset -p ds9 file Extract/${spec}-order${i}.fits[1]
done
#+END_SRC

+ [2013-02-23 Sat] Cosmic ray removal is done separately to each extracted and rectified order
  + Discussed [[id:E214FDA3-BAC7-4516-B9A5-11E5F6F15B60][down here]]

#+call: display-extracted-orders(spec="p73b")

#+RESULTS: display-extracted-orders(spec="p73b")
: result silenced


#+name: display-extracted-orders-cr
#+BEGIN_SRC sh :results output :var spec="p84c" :var limits="0 70"
for i in $(seq -w 51 76); do
    xpaset -p ds9 frame new
    xpaset -p ds9 file Extract/${spec}-order${i}.fits[1]
    xpaset -p ds9 zoom to 0.4 8
    xpaset -p ds9 scale limits ${limits}
    # xpaset -p ds9 frame new
    # xpaset -p ds9 file Extract/${spec}-order${i}-cr.fits[1]
done
xpaset -p ds9 frame match image
#+END_SRC


#+call: display-extracted-orders-cr(spec="t70b")

#+call: display-extracted-orders-cr(spec="q69b", limits="0 7000")
     
#+RESULTS: display-extracted-orders-cr(spec="q69b", limits="0 7000")

#+call: display-extracted-orders-cr(spec="q69o", limits="0 7000")

#+RESULTS: display-extracted-orders-cr(spec="q69o", limits="0 7000")

#+call: display-extracted-orders-cr(spec="p73b")

#+RESULTS: display-extracted-orders-cr(spec="p73b")

#+call: display-extracted-orders-cr(spec="p84b")

#+RESULTS: display-extracted-orders-cr(spec="p84b")

#+call: display-extracted-orders-cr(spec="p84s")

#+RESULTS: display-extracted-orders-cr(spec="p84s")

#+call: display-extracted-orders-cr(spec="p84o", limits="0 130")

#+RESULTS: display-extracted-orders-cr(spec="p84o")

#+call: display-extracted-orders-cr(spec="p84b-cr")


+ A single very long plot of the entire spectrum

#+name: plot-all-orders-strip
#+BEGIN_SRC python :var obj="p84b" :var j1=16 :var j2=30
from matplotlib import pyplot as plt
from matplotlib.ticker import Locator
import astropy.io.fits as pyfits
orders = range(51, 77)
for i in orders:
    f = pyfits.open("Extract/{}-order{}-cr.fits".format(obj, i))
    spec = f["SCI"].data[j1:j2,:].mean(axis=0) 
    wav = f["WAV"].data[0,:]
    plt.semilogy(wav, spec, "-")
F = plt.gcf()
A = plt.gca()
F.set_size_inches( (1500, 6) )
Locator.MAXTICKS = 4000
A.xaxis.set_major_locator(plt.MaxNLocator(3000, integer=True))
plt.grid()
plt.axis("tight")
plt.xlabel("Wavelength, Angstrom")
plt.ylabel("{} mean brightness".format(obj))
plt.savefig("{}-strip-spec.pdf".format(obj), bbox_inches='tight')
#+END_SRC

#+RESULTS: plot-all-orders-strip
: None

#+call: plot-all-orders-strip(obj="p73b", j1=19, j2=29)

#+RESULTS: plot-all-orders-strip(obj="p73b", j1=19, j2=29)
: None



***** DONE Final adjustments to the order box positions/angles
      CLOSED: [2013-03-15 Fri 11:25]
      :LOGBOOK:
      CLOCK: [2013-03-14 Thu 18:42]--[2013-03-15 Fri 11:25] => 16:43
      CLOCK: [2013-03-13 Wed 09:18]--[2013-03-13 Wed 16:55] =>  7:37
      :END:
:PROPERTIES:
:ID:       AD19406C-8713-4AB4-9CCF-77F0A42FDC67
:END:
+ Originally I had only measured the angles to an accuracy of 0.1 degrees, but it turns that we need about 10 times better accuracy than that
+ The plan is to measure bottom and top of the order at left and right, and then calculate an average slope, and therefore a correction to the angles

| ! | Order |   iL | j1L |  j2L |   iR | j1R |  j2R |     dydx | dtheta |    jc | thold |      jold | thnew |   jnew |
|---+-------+------+-----+------+------+-----+------+----------+--------+-------+-------+-----------+-------+--------|
| # |    51 |  150 | 3.5 | 40.5 | 2000 | 5.3 | 40.5 |  4.86e-4 |  0.028 | 22.45 |   1.0 | 983.31636 | 1.028 | 982.77 |
| # |    52 |  200 | 3.5 | 40.7 | 1700 | 4.7 | 40.0 |  1.67e-4 |  0.010 | 22.23 |   1.0 | 928.82176 |  1.01 | 928.05 |
| # |    53 |  235 | 4.3 | 42.4 | 1960 | 5.0 | 41.0 | -2.03e-4 | -0.012 | 23.18 |   1.0 | 874.80941 | 0.988 | 874.99 |
| # |    54 |  200 | 3.6 | 42.7 | 2000 | 2.9 | 40.1 | -9.17e-4 | -0.053 | 22.33 |   1.0 | 824.17284 | 0.947 | 823.50 |
| # |    55 |  130 | 4.7 | 43.2 | 1920 | 4.0 | 40.9 | -8.38e-4 | -0.048 | 23.20 |   1.0 | 774.84182 | 0.952 | 775.04 |
| # |    56 |  116 | 3.0 | 40.9 | 1996 | 4.7 | 41.3 |  5.59e-4 |  0.032 | 22.48 |   0.9 | 727.23997 | 0.932 | 726.72 |
| # |    57 |  142 | 4.7 | 42.6 | 2000 | 5.7 | 42.1 |  1.35e-4 |  0.008 | 23.78 |   0.9 | 680.94367 | 0.908 | 681.72 |
| # |    58 |   80 | 5.6 | 41.5 | 2000 | 6.4 | 40.7 |      0e0 |  0.000 | 23.55 |   0.9 | 636.57639 |   0.9 | 637.13 |
| # |    59 |  200 | 5.2 | 42.8 | 1970 | 5.1 | 41.6 | -3.67e-4 | -0.021 | 23.68 |   0.9 | 593.17361 | 0.879 | 593.85 |
| # |    60 |  440 | 4.6 | 42.2 | 1960 | 4.2 | 41.1 | -4.93e-4 | -0.028 | 23.03 |   0.9 |  552.1821 | 0.872 | 552.21 |
| # |    61 |  200 | 8.0 | 42.6 | 1984 | 6.3 | 40.4 | -1.09e-3 | -0.062 | 24.33 |   0.9 | 512.15509 | 0.838 | 513.49 |
| # |    62 |  500 | 5.7 | 41.3 | 1910 | 6.8 | 42.0 |  6.38e-4 |  0.037 | 23.95 |   0.8 | 473.09259 | 0.837 | 474.04 |
| # |    63 |  400 | 3.5 | 41.2 | 1530 | 3.8 | 40.8 | -4.42e-5 | -0.003 | 22.33 |   0.8 |  435.9591 | 0.797 | 435.29 |
| # |    64 |  400 | 4.0 | 42.8 | 1894 | 3.4 | 42.7 | -2.34e-4 | -0.013 | 23.23 |   0.8 | 398.82562 | 0.787 | 399.06 |
| # |    65 |  160 | 3.9 | 42.9 | 1960 | 3.1 | 43.2 | -1.39e-4 | -0.008 | 23.28 |   0.8 | 363.62114 | 0.792 | 363.90 |
| # |    66 |  164 | 4.2 | 42.7 | 1970 | 2.9 | 42.7 | -3.60e-4 | -0.021 | 23.13 |   0.8 | 329.38117 | 0.779 | 329.51 |
| # |    67 |  187 | 4.7 | 43.6 | 1984 | 3.1 | 43.2 | -5.56e-4 | -0.032 | 23.65 |   0.8 | 295.62345 | 0.768 | 296.27 |
| # |    68 |  150 | 3.4 | 41.3 | 1970 | 3.3 | 43.8 |  6.59e-4 |  0.038 | 22.95 |   0.7 | 263.79475 | 0.738 | 263.74 |
| # |    69 |   70 | 3.5 | 41.9 | 2000 | 3.4 | 43.9 |  4.92e-4 |  0.028 | 23.18 |   0.7 | 231.96605 | 0.728 | 232.15 |
| # |    70 |   80 | 3.3 | 41.7 | 1980 | 3.1 | 42.9 |  2.63e-4 |  0.015 | 22.75 |   0.7 | 201.58411 | 0.715 | 201.33 |
| # |    71 |  110 | 4.3 | 42.8 | 1990 | 3.3 | 44.1 |  7.98e-5 |  0.005 | 23.63 |   0.7 | 171.20217 | 0.705 | 171.83 |
| # |    72 |  120 | 5.1 | 42.7 | 1990 | 3.3 | 43.9 | -1.60e-4 | -0.009 | 23.75 |   0.7 | 142.26698 | 0.691 | 143.02 |
| # |    73 | 1050 | 4.4 | 43.1 | 2000 | 3.3 | 43.4 | -4.21e-4 | -0.024 | 23.55 |   0.7 | 113.81405 | 0.676 | 114.36 |
| # |    74 | 1050 | 4.1 | 42.1 | 1990 | 2.9 | 44.3 |  5.32e-4 |  0.030 | 23.35 |   0.6 | 86.807877 |  0.63 |  87.16 |
| # |    75 | 1030 | 4.5 | 41.5 | 2040 | 5.5 | 42.5 |  9.90e-4 |  0.057 | 23.50 |   0.6 | 59.801704 | 0.657 |  60.30 |
| # |    76 | 1600 | 5.5 | 43.5 | 1930 | 5.5 | 43.5 |      0e0 |  0.000 | 24.50 |   0.6 | 33.277784 |   0.6 |  34.78 |
#+TBLFM: $9=0.5 ($j1R + $j2R - $j1L - $j2L)/($iR - $iL); s3::$10=arctan($dydx);f3::$11=0.25 ($j1L + $j2L + $j1R + $j2R) ;f2::$14=$thold + $dtheta::$15=$jold + $jc - 23.0; f2

+ So that worked pretty well for the angles, but not so well for the positions
+ In fact, it would be better to use the quartz lamp images

#+BEGIN_SRC python :results output
  import astropy.io.fits as pyfits
  import matplotlib.pyplot as plt
  import numpy as np
  from scipy.special import erf
  
  
  def window(x, x1, x2, sigma):
      """Window function with Gaussian broadening"""
      return (0.5 * (erf((x - x1)/sigma) + 1.0) *
              0.5 * (erf((x2 - x)/sigma) + 1.0))
  
  
  for iorder in range(51,77):
      im = pyfits.open("Extract/q69b-order{}.fits".format(iorder))["SCI"].data
      ny, nx = im.shape
      y = 1.0 + np.arange(ny)
      yprofile = im.sum(axis=1)
      yprofile /= np.mean(yprofile[16:24])
      yprofile[~np.isfinite(yprofile)] = 0.0
      y1 = yprofile[:26].max() - 0.1
      y2 = yprofile[26:44].max() - 0.1
      print iorder, y1, y2
      plt.plot(y, yprofile)
      plt.plot(y, 0.95*window(y, 4.0, 40.8, 1.0) + 0.05)
      plt.plot(y, 
               0.05 + 
               0.95*window(y, 4.5, 41.8, 1.0) + 
               0.83*window(y, -10.0, 11.55, 1.0) + 
               1.07*window(y, 35.05, 60.0, 1.0)
      )
      plt.plot([0.0, 10.0], [y1, y1])
      plt.plot([35.0, 50.0], [y2, y2])
      plt.xlim(0.0, 53.0)
      plt.ylim(0.0, 2.8)
      plt.grid()
      plt.xlabel("J pixel (1-based)")
      plt.ylabel("Lamp intensity")
      plt.title("Order {}".format(iorder))
      plt.savefig("Extract/q96b-yprofile-order{}.pdf".format(iorder))
      plt.clf()
#+END_SRC

#+RESULTS:

+ Plan is now to fit an analytic model to the quartz lamp image:
  + Erf window function in the y-direction, two edges with pos and width
    + Each edge is a quadratic function y_{1}(x), y_{2}(x)
    + So number of parameters: 2 (3 + 2) = 10 per order
  + Low order polynomial in the x-direction: another 3 or 4 parameters
  + So with 25 orders: 25 14 = 350 parameters
+ That is a bit excessive
  + So instead of fitting the 2D original image,
  + we will just fit the 1D y-profile of the extracted strips
+ Done this now
  + Using [[file:hires-extract/quartz-model.py][hires-extract/quartz-model.py]]
  + Created database: [[file:quartz-database.json][quartz-database.json]]
+ Now, convert database to a table for ease of viewing
  + There are up to three windows for each order strip
    1. The order itself
       + This is always present
       + It is the central set of columns in the table
    2. The previous order
       + Left set of columns in the table
    3. The next order
       + The right set of columns in the table

#+BEGIN_SRC python
import yaml
orders = yaml.load(open("quartz-database.json"))
tab = []
tab.append(["order"] + ["height", "y1", "y2", "w", "sig"]*3)
for order in sorted(orders.keys()):
    row = [order]
    for win in 2, 1, 3:
        height = orders[order].get("height_0" + str(win), 0.0)
        y1 = orders[order].get("y1_0" + str(win), 0.0)
        w = orders[order].get("w_0" + str(win), 0.0)
        y2 = y1 + w
        sigma = orders[order].get("sigma_0" + str(win), 0.0)
        row.extend(["{:.2f}".format(x) for x in [height, y1, y2, w, sigma]])
    tab.append(row)
return tab
#+END_SRC

#+RESULTS:
| order |  height |    y1 |     y2 |     w |  sig |  height |    y1 |    y2 |     w |  sig |  height |     y1 |    y2 |     w |  sig |
|-------+---------+-------+--------+-------+------+---------+-------+-------+-------+------+---------+--------+-------+-------+------|
|    51 |    0.00 |  0.00 |   0.00 |  0.00 | 0.00 | 4986.14 | 12.99 | 49.61 | 36.62 | 1.06 |    0.00 |   0.00 |  0.00 |  0.00 | 0.00 |
|    52 |    0.00 |  0.00 |   0.00 |  0.00 | 0.00 | 5573.45 | 13.00 | 49.62 | 36.62 | 1.05 |    0.00 |   0.00 |  0.00 |  0.00 | 0.00 |
|    53 | 5573.45 | 69.75 | 105.75 | 36.00 | 0.56 | 5789.41 | 13.00 | 49.62 | 36.62 | 1.03 |    0.00 |   0.00 |  0.00 |  0.00 | 0.00 |
|    54 | 5789.41 | 64.16 | 100.16 | 36.00 | 1.16 | 5778.92 | 12.97 | 49.59 | 36.62 | 1.04 | 8999.89 | -36.22 | -0.22 | 36.00 | 1.33 |
|    55 | 5778.92 | 62.35 |  98.35 | 36.00 | 1.08 | 5593.79 | 13.00 | 49.64 | 36.64 | 1.01 | 5650.34 | -34.02 |  1.98 | 36.00 | 1.15 |
|    56 | 5593.79 | 60.60 |  96.60 | 36.00 | 1.06 | 5333.19 | 12.99 | 49.65 | 36.65 | 1.01 | 4963.47 | -32.30 |  3.70 | 36.00 | 1.03 |
|    57 | 5333.19 | 58.94 |  94.94 | 36.00 | 1.08 | 4942.29 | 12.99 | 49.66 | 36.67 | 1.01 | 4565.49 | -30.72 |  5.28 | 36.00 | 1.03 |
|    58 | 4942.29 | 57.39 |  93.39 | 36.00 | 1.06 | 4542.39 | 13.00 | 49.68 | 36.69 | 1.01 | 4176.35 | -29.22 |  6.78 | 36.00 | 1.03 |
|    59 | 4542.39 | 55.92 |  91.92 | 36.00 | 1.10 | 4148.98 | 13.00 | 49.74 | 36.74 | 1.04 | 3821.00 | -27.77 |  8.23 | 36.00 | 1.08 |
|    60 | 4148.98 | 54.53 |  90.53 | 36.00 | 1.08 | 3812.26 | 13.00 | 49.77 | 36.78 | 1.07 | 3501.23 | -26.39 |  9.61 | 36.00 | 1.12 |
|    61 | 3812.26 | 53.20 |  89.20 | 36.00 | 1.14 | 3489.17 | 13.00 | 49.83 | 36.82 | 1.08 | 3201.37 | -25.09 | 10.91 | 36.00 | 0.99 |
|    62 | 3489.17 | 51.92 |  87.92 | 36.00 | 1.07 | 3206.58 | 12.98 | 49.82 | 36.84 | 0.99 | 2935.70 | -23.91 | 12.09 | 36.00 | 0.99 |
|    63 | 3206.58 | 50.70 |  86.70 | 36.00 | 1.30 | 2916.96 | 13.00 | 49.80 | 36.80 | 0.91 | 2623.50 | -22.76 | 13.24 | 36.00 | 0.96 |
|    64 | 2916.96 | 49.57 |  85.57 | 36.00 | 1.04 | 2613.77 | 13.00 | 49.84 | 36.84 | 0.95 | 2349.60 | -21.65 | 14.35 | 36.00 | 1.04 |
|    65 | 2613.77 | 48.44 |  84.44 | 36.00 | 0.98 | 2344.19 | 13.00 | 49.79 | 36.80 | 1.01 | 2101.25 | -20.60 | 15.40 | 36.00 | 1.05 |
|    66 | 2344.19 | 47.42 |  83.42 | 36.00 | 1.02 | 2095.65 | 13.00 | 49.83 | 36.83 | 1.03 | 1872.12 | -19.57 | 16.43 | 36.00 | 1.05 |
|    67 | 2095.65 | 46.44 |  82.44 | 36.00 | 1.04 | 1855.95 | 13.00 | 49.89 | 36.89 | 1.01 | 1664.49 | -18.55 | 17.45 | 36.00 | 1.02 |
|    68 | 1855.95 | 45.50 |  81.50 | 36.00 | 1.05 | 1667.65 | 13.00 | 49.96 | 36.95 | 0.99 | 1492.51 | -17.57 | 18.43 | 36.00 | 0.97 |
|    69 | 1667.65 | 44.58 |  80.58 | 36.00 | 1.01 | 1504.07 | 13.00 | 50.00 | 37.00 | 0.97 | 1324.85 | -16.66 | 19.34 | 36.00 | 0.97 |
|    70 | 1504.07 | 43.70 |  79.70 | 36.00 | 1.00 | 1330.62 | 13.00 | 50.04 | 37.05 | 0.97 | 1172.78 | -15.78 | 20.22 | 36.00 | 0.98 |
|    71 | 1330.62 | 42.88 |  78.88 | 36.00 | 0.98 | 1172.78 | 13.00 | 50.10 | 37.09 | 0.97 | 1028.34 | -14.94 | 21.06 | 36.00 | 0.97 |
|    72 | 1172.78 | 42.07 |  78.07 | 36.00 | 0.99 | 1029.35 | 13.00 | 50.13 | 37.13 | 0.97 |  889.10 | -14.14 | 21.86 | 36.00 | 0.97 |
|    73 | 1029.35 | 41.31 |  77.31 | 36.00 | 1.00 |  891.93 | 13.00 | 50.17 | 37.17 | 0.98 |  700.25 | -13.37 | 22.63 | 36.00 | 0.97 |
|    74 |  891.93 | 40.55 |  76.55 | 36.00 | 1.23 |  701.36 | 13.00 | 50.20 | 37.21 | 1.14 |  359.58 | -12.56 | 23.44 | 36.00 | 1.05 |
|    75 |  701.36 | 39.86 |  75.86 | 36.00 | 1.02 |  364.07 | 13.00 | 50.25 | 37.25 | 0.99 |   46.58 | -11.92 | 24.08 | 36.00 | 1.10 |
|    76 |  364.07 | 31.07 |  67.07 | 36.00 | 1.18 |   42.53 |  5.02 | 42.26 | 37.25 | 0.95 |  700.00 |  58.00 | 94.00 | 36.00 | 1.00 |

+ [X] Fix up the vertical positions once and for all
  + It would be nice to have a bit more visible at the bottom of each strip
    + This will allow us to get a good chunk of the next higher order to make it easier to remove
    + We will therefore try and get all the values of y1 to be 10, instead of the 3-5 that they are now
    + Note that this will not necessarily make the y2's align, since the order width w increases slighty with order number
    + We really need to take a trace of a bright point continuum source to set the zero y-point of each order.
    + From looking at the position of high-velocity knots in Ha and Hb in the spectrum p74c, it looks like the objects have a constant offset from the bottom edge of the order, so we are justified in trying to align that.
  + So we first work out new values to put in the region file:
    + The column jbox is what we currently have in [[file:Keck1/t70-orders-final.reg][t70-orders-final.reg]]
      + which was calculated in the previous table
    + The column jbox_fix is now pasted into the region file, and that should make the strips all come out at the same height
    + I have also changed the strip height to 56
      + Hopefully this will have the effect of increasing the margins
  + So, the next thing to do is to re-run extract-orders.py

| order |   jbox |   y1 | jbox_fix |    y1 | jbox_fix2 | dj | jbox_fix3 | dj2 | jbox_fix4 |
|-------+--------+------+----------+-------+-----------+----+-----------+-----+-----------|
|    51 | 982.77 | 4.34 |   982.90 | 12.44 |    982.34 |  1 |    983.34 |   0 |    983.34 |
|    52 | 928.05 | 4.51 |   928.35 | 12.16 |    927.51 |  0 |    927.51 |   0 |    927.51 |
|    53 | 874.99 | 3.84 |   874.62 | 13.23 |    874.85 | -1 |    873.85 |   0 |    873.85 |
|    54 | 823.50 | 4.53 |   823.82 | 12.72 |    823.54 |  0 |    823.54 |   0 |    823.54 |
|    55 | 775.04 | 4.15 |   774.98 | 12.17 |    774.15 |  0 |    774.15 |   0 |    774.15 |
|    56 | 726.72 | 5.01 |   727.52 | 12.50 |    727.02 |  0 |    727.02 |   0 |    727.02 |
|    57 | 681.72 | 3.60 |   681.11 | 13.50 |    681.61 | -1 |    680.61 |   0 |    680.61 |
|    58 | 637.13 | 4.43 |   637.35 | 12.09 |    636.44 |  0 |    636.44 |   0 |    636.44 |
|    59 | 593.85 | 4.00 |   593.64 | 13.38 |    594.02 |  0 |    594.02 |   0 |    594.02 |
|    60 | 552.21 | 4.70 |   552.70 | 12.00 |    551.70 |  0 |    551.70 |   0 |    551.70 |
|    61 | 513.49 | 3.21 |   512.49 | 12.71 |    512.20 |  0 |    512.20 |   0 |    512.20 |
|    62 | 474.04 | 3.34 |   473.17 | 13.12 |    473.29 |  0 |    473.29 |   0 |    473.29 |
|    63 | 435.29 | 5.21 |   436.29 | 12.97 |    436.26 |  0 |    436.26 |   0 |    436.26 |
|    64 | 399.06 | 5.06 |   399.91 | 12.15 |    399.06 |  1 |    400.06 |   0 |    400.06 |
|    65 | 363.90 | 4.53 |   364.22 | 13.31 |    364.53 |  0 |    364.53 |  -1 |    363.53 |
|    66 | 329.51 | 4.37 |   329.67 | 12.70 |    329.37 |  1 |    330.37 |  -1 |    329.37 |
|    67 | 296.27 | 4.14 |   296.20 | 12.95 |    296.15 |  1 |    297.15 |  -1 |    296.15 |
|    68 | 263.74 | 4.27 |   263.80 | 12.47 |    263.27 |  1 |    264.27 |  -1 |    263.27 |
|    69 | 232.15 | 3.91 |   231.85 | 13.06 |    231.91 |  1 |    232.91 |  -1 |    231.91 |
|    70 | 201.33 | 4.48 |   201.60 | 12.88 |    201.48 |  1 |    202.48 |  -1 |    201.48 |
|    71 | 171.83 | 3.81 |   171.43 | 13.38 |    171.81 |  0 |    171.81 |  -1 |    170.81 |
|    72 | 143.02 | 4.04 |   142.85 | 12.19 |    142.04 |  2 |    144.04 |  -1 |    143.04 |
|    73 | 114.36 | 4.05 |   114.20 | 12.85 |    114.05 |  2 |    116.05 |  -1 |    115.05 |
|    74 |  87.16 | 4.49 |    87.44 | 12.05 |     86.49 |  1 |     87.49 |  -1 |     86.49 |
|    75 |  60.30 | 4.04 |    60.13 | 12.90 |     60.03 |  1 |     61.03 |  -1 |     60.03 |
|    76 |  34.78 | 3.33 |    33.90 |  4.46 |     25.36 | -7 |     18.36 |  -1 |     17.36 |
|-------+--------+------+----------+-------+-----------+----+-----------+-----+-----------|
|       |        | 4.21 |     0.00 |       |    -13.00 |    |    -13.00 |     |    -13.00 |
#+TBLFM: $4=$2 + $3 - @II$3; f2::$6=$4 + $5 - 13.0; f2::$8=$6 + $7; f2::$10=$8 + $9; f2::@28$3=vmean(@I..@II); f2

+ Yes, that finally did it!
  + See the table of the quartz database above
    + All the y1's are now 13.00
  + We had to do some integer shifts at the end too (see above table)
  + But we now have everything aligned except order 76
    + This is problematic, since we run out of CCD below it
    + It would be fixable, but it is too much effort for one measly [Fe III] line
+ [X] The only remaining problem is order 54, which still has a slight tilt
  + This is worth fixing since it has Ha and [N II] in it
  + It amounts to about 0.3 pixels over the entire range
    + That is arctan(0.3/2000) = 0.0086 degrees, which should be added to theta
    + At the same time, we should subtract 0.3/2 = 0.15 from the y-center to compensate
    + So this is what the new region looks like:
#+BEGIN_EXAMPLE
box(1050.0, 823.39, 2060, 56, 0.956) # text={Order 54}
#+END_EXAMPLE

+ Hurray, that worked too
  + There is a deviation of 0.03 in the y1 position for slit 54, but that is imperceptible



**** DONE Correct for order overlap
     CLOSED: [2013-03-20 Wed 22:33]
     :LOGBOOK:
     - State "TODO"       from ""           [2013-03-15 Fri 13:44]
     :END:

+ [X] First we need to correct for the stray light that is seen in between the orders
  + This can be deduced from the bit between 51 and 52


**** DONE Extracting the postage stamps
     CLOSED: [2013-03-20 Wed 22:33]
     :LOGBOOK:
     - State "STARTED"    from "WAITING"    [2013-03-19 Tue 20:49]
     - State "WAITING"    from ""           [2013-03-15 Fri 11:27] \\
       Need to come back to this once I have dealt with the order overlap
     :END:
#+BEGIN_SRC sh :results none
for f in $(ls -1 Stamps/p84-*-stamp.fits); do xpaset -p ds9 frame new; xpaset -p ds9 file $f; done
#+END_SRC


#+BEGIN_SRC sh :results none
for f in $(ls -1 Stamps/p84-*-stamp-nc.fits); do xpaset -p ds9 frame new; xpaset -p ds9 file $f; done
#+END_SRC


*** Wavelength calibration
    CLOCK: [2013-01-03 Thu 10:37]--[2013-01-03 Thu 14:02] =>  3:25
    :PROPERTIES:
    :dir:      Calibration
    :END:

#+BEGIN_SRC sh
pwd
#+END_SRC

#+RESULTS:
: /Users/will/Dropbox/KeckProplyd/Calibration

**** Wavelength range of each order

| Order |  wavmin |  wavmax |
|-------+---------+---------|
|    51 | 6909.79 | 7011.71 |
|    52 | 6776.92 | 6876.91 |
|    53 | 6649.06 | 6747.20 |
|    54 | 6525.95 | 6622.29 |
|    55 | 6407.31 | 6501.92 |
|    56 | 6292.92 | 6385.85 |
|    57 | 6182.53 | 6273.85 |
|    58 | 6075.96 | 6165.71 |
|    59 | 5973.00 | 6061.23 |
|    60 | 5873.47 | 5960.23 |
|    61 | 5777.21 | 5862.55 |
|    62 | 5684.05 | 5768.01 |
|    63 | 5593.86 | 5676.47 |
|    64 | 5506.48 | 5587.79 |
|    65 | 5421.79 | 5501.84 |
|    66 | 5339.66 | 5418.49 |
|    67 | 5259.99 | 5337.62 |
|    68 | 5182.66 | 5259.13 |
|    69 | 5107.58 | 5182.92 |
|    70 | 5034.63 | 5108.88 |
|    71 | 4963.75 | 5036.92 |
|    72 | 4895.73 | 4965.46 |
|    73 | 4827.80 | 4898.92 |
|    74 | 4762.58 | 4832.71 |
|    75 | 4699.09 | 4768.27 |
|    76 | 4637.28 | 4705.52 |


**** Line data
     :LOGBOOK:
     CLOCK: [2013-02-22 Fri 13:30]--[2013-02-22 Fri 14:35] =>  1:05
     CLOCK: [2013-02-22 Fri 11:09]--[2013-02-22 Fri 11:50] =>  0:41
     CLOCK: [2013-02-22 Fri 09:10]--[2013-02-22 Fri 10:58] =>  1:48
     CLOCK: [2013-02-21 Thu 22:06]--[2013-02-21 Thu 22:35] =>  0:29
     :END:

+ Organized by order
+ Some lines are only in either one or the other of NIST and van Hoof databases
+ We are tring to list all the lines that are visible or might be contributing to a weak blend


***** STARTED Best data for the most interesting lines
      :LOGBOOK:
      - State "STARTED"    from "TODO"       [2013-02-24 Sun 19:00]
      :END:
      :PROPERTIES:
      :dir:      Stamps
      :END:

+ These show the barycenters of the lines for the case of multiplets
+ For Da I am using the 2s(1/2) - 3p(1/2) transition for now

#+name: line-data-best
|       Wav | Ion      | Order | jcent |
|-----------+----------+-------+-------|
|   4701.53 | [Fe III] |    76 |     0 |
|   4733.91 | [Fe III] |    75 |     0 |
|   4754.69 | [Fe III] |    75 |     0 |
|   4769.43 | [Fe III] |    74 |     0 |
| 4814.5342 | [Fe II]  |    74 |     0 |
| 4859.9092 | D b      |    73 |     0 |
|   4881.00 | [Fe III] |    73 |     0 |
|  4921.931 | He I S   |    72 |     0 |
|   4930.54 | [Fe III] |    72 |     0 |
|  4931.227 | [O III]  |    72 |     0 |
|  4958.911 | [O III]  |    72 |     0 |
|  5006.843 | [O III]  |    71 |     0 |
|   5011.26 | [Fe III] |    71 |     0 |
| 5015.6780 | He I S   |    71 |     0 |
|  5041.024 | Si II    |    70 |     0 |
| 5047.7385 | He I S   |    70 |     0 |
|  5055.984 | Si II    |    70 |     0 |
|   5084.77 | [Fe III] |    70 |     0 |
|  5146.749 | Co I     |    69 |     0 |
| 5158.7771 | [Fe II]  |    69 |     0 |
|  5197.902 | [N I]    |    68 |  23.8 |
|  5200.257 | [N I]    |    68 |  23.5 |
| 5261.6209 | [Fe II]  |    67 |     0 |
|   5270.40 | [Fe III] |    67 |     0 |
| 5273.3463 | [Fe II]  |    67 |     0 |
|  5298.966 | O I      |    67 |     0 |
|   5411.98 | [Fe III] |    66 |     0 |
|  5517.709 | [Cl III] |    64 |     0 |
|  5537.873 | [Cl III] |    64 |     0 |
|  5554.952 | O I      |    64 |     0 |
| 5577.3387 | [O I]    |    64 |  24.6 |
|   5754.59 | [N II]   |    62 |  24.8 |
|  5875.621 | He I T   |    60 |     0 |
|   5957.56 | Si II    |    60 |     0 |
| 5958.5237 | O I      |    60 |     0 |
|   5978.93 | Si II    |    59 |     0 |
|  6046.376 | O I      |    59 |  24.6 |
|  6300.304 | [O I]    |    56 |  23.7 |
|   6312.06 | [S III]  |    56 |     0 |
|   6347.11 | Si II    |    56 |     0 |
|  6363.776 | [O I]    |    56 |  23.7 |
|   6371.37 | Si II    |    56 |     0 |
|   6548.05 | [N II]   |    54 |  24.3 |
| 6560.9567 | D a      |    54 |     0 |
|   6578.05 | C II     |    54 |     0 |
|   6583.45 | [N II]   |    54 |  23.6 |
| 6678.1517 | He I S   |    53 |     0 |
|  6716.440 | [S II]   |    53 |     0 |
|  6730.816 | [S II]   |    53 |     0 |
| 7002.1244 | O I      |    51 |  24.1 |

Create a python dictionary from the above table, and serialize it in JSON format. 

#+name: write-line-database
#+BEGIN_SRC python :var table=line-data-best :results output
  import json
  linedb = {}
  for wav, species, iorder, jcent in table:
      lineid = "{} {}".format(species, int(wav + 0.5))
      linedb[lineid] = {"wav": wav, "species": species, "iorder": iorder, "jcent": jcent}
  with open("line-database.json", "w") as f:
      json.dump(linedb, f, indent=4)
#+END_SRC

#+RESULTS: write-line-database

JSON treats all strings as unicode, which we don't really want.  This can be worked around by defining a custom =object_hook= but that is a bit [[http://stackoverflow.com/questions/956867/how-to-get-string-objects-instead-unicode-ones-from-json-in-python/6633651][complicated]].  Easier to just read it as YAML since YAML is a superset of JSON.  

#+BEGIN_SRC python :results verbatim 
import yaml
return yaml.load(open("line-database.json"))
#+END_SRC

#+RESULTS:
: {'[N II] 6548': {'jcent': 24.3, 'wav': 6548.05, 'species': '[N II]', 'iorder': 54}, '[N I] 5200': {'jcent': 23.5, 'wav': 5200.257, 'species': '[N I]', 'iorder': 68}, 'O I 7002': {'jcent': 24.1, 'wav': 7002.107, 'species': 'O I', 'iorder': 51}, '[N II] 6583': {'jcent': 23.6, 'wav': 6583.45, 'species': '[N II]', 'iorder': 54}, '[O I] 5577': {'jcent': 24.6, 'wav': 5577.3387, 'species': '[O I]', 'iorder': 64}, '[N I] 5198': {'jcent': 23.8, 'wav': 5197.902, 'species': '[N I]', 'iorder': 68}, '[O I] 6364': {'jcent': 23.7, 'wav': 6363.776, 'species': '[O I]', 'iorder': 56}, 'O I 6046': {'jcent': 24.6, 'wav': 6046.376, 'species': 'O I', 'iorder': 59}, '[O I] 6300': {'jcent': 23.7, 'wav': 6300.304, 'species': '[O I]', 'iorder': 56}, '[N II] 5755': {'jcent': 24.8, 'wav': 5754.59, 'species': '[N II]', 'iorder': 62}}



****** Metal Collisional lines

******* [O I] lines


Van Hoof

| .LAB.WAVL.ANG.AIR. | .SPC. | TT | .CONFIGURATION. | TERM. | J_i.J_k | ..A_ki.. | .TPF. | LEVEL.ENERGY..CM^-1 | .REF... |
|--------------------+-------+----+-----------------+-------+---------+----------+-------+---------------------+---------|
|          5577.3387 | [O I] | E2 | 2s2.2p4-2s2.2p4 | 1D-1S |     2-0 | 1.26E+00 |    15 |   15867.86-33792.58 | ASD     |
|           6300.304 | [O I] | M1 | 2s2.2p4-2s2.2p4 | 3P-1D |     2-2 | 6.48E-03 |    15 |       0.00-15867.86 | ASD     |
|           6363.776 | [O I] | M1 | 2s2.2p4-2s2.2p4 | 3P-1D |     1-2 | 2.10E-03 |    15 |     158.26-15867.86 | ASD     |
|           6391.733 | [O I] | E2 | 2s2.2p4-2s2.2p4 | 3P-1D |     0-2 | 6.18E-07 |    15 |     226.98-15867.86 | ASD     |


NIST

|------------+------------+------+----------+------+--------------------------+------------------------+------------------------+------+---------+------+---+----+-------------+-------|
| Observed   |       Ritz | Rel. |      Aki | Acc. | Ei           Ek          | Lower level            | Upper level            | Type | TP      | Line |   |    |             |       |
| Wavelength | Wavelength | Int. |     s^-1 |      | (cm-1)       (cm-1)      | ---------------------- | ---------------------- |      | Ref.    | Ref. |   |    |             |       |
| Air  (Å)   |   Air  (Å) | (?)  |          |      |                          | Conf.                  | Term                   |    J | Conf.   | Term | J |    |             |       |
|------------+------------+------+----------+------+--------------------------+------------------------+------------------------+------+---------+------+---+----+-------------+-------|
|            |            |      |          |      |                          |                        |                        |      |         |      |   |    |             |       |
| 5577.34    |   5577.339 | 120  | 1.26e+00 | B+   | 15867.862   -  33792.583 | 2s2.2p4                | 1D                     |    2 | 2s2.2p4 |   1S | 0 | E2 | T4539,T5081 | L3760 |
|            |   6300.304 |      | 2.11e-05 | C+   | 0.000   -  15867.862     | 2s2.2p4                | 3P                     |    2 | 2s2.2p4 |   1D | 2 | E2 | T4539,T5081 |       |
|            |   6300.304 |      | 5.63e-03 | B+   | 0.000   -  15867.862     | 2s2.2p4                | 3P                     |    2 | 2s2.2p4 |   1D | 2 | M1 | T4539,T5081 |       |
|            |   6363.776 |      | 3.39e-06 | C+   | 158.265   -  15867.862   | 2s2.2p4                | 3P                     |    1 | 2s2.2p4 |   1D | 2 | E2 | T4539,T5081 |       |
|            |   6363.776 |      | 1.82e-03 | B+   | 158.265   -  15867.862   | 2s2.2p4                | 3P                     |    1 | 2s2.2p4 |   1D | 2 | M1 | T4539,T5081 |       |
|            |            |      |          |      |                          |                        |                        |      |         |      |   |    |             |       |
|            |   6391.733 |      | 8.60e-07 | B+   | 226.977   -  15867.862   | 2s2.2p4                | 3P                     |    0 | 2s2.2p4 |   1D | 2 | E2 | T4539,T5081 |       |
|------------+------------+------+----------+------+--------------------------+------------------------+------------------------+------+---------+------+---+----+-------------+-------|




******* [N II] lines

NIST

|------------+------------+------+----------+------+----------------------+------------------------+------------------------+------+---------+------+---+----+-------+---|
| Observed   |       Ritz | Rel. |      Aki | Acc. | Ei           Ek      | Lower level            | Upper level            | Type | TP      | Line |   |    |       |   |
| Wavelength | Wavelength | Int. |     s^-1 |      | (cm-1)       (cm-1)  | ---------------------- | ---------------------- |      | Ref.    | Ref. |   |    |       |   |
| Air  (Å)   |   Air  (Å) | (?)  |          |      |                      | Conf.                  | Term                   |    J | Conf.   | Term | J |    |       |   |
|------------+------------+------+----------+------+----------------------+------------------------+------------------------+------+---------+------+---+----+-------+---|
|            |            |      |          |      |                      |                        |                        |      |         |      |   |    |       |   |
|            |    5754.59 |      | 1.14e+00 | C    | 15316.2   -  32688.8 | 2s2.2p2                | 1D                     |    2 | 2s2.2p2 |   1S | 0 | E2 | T7333 |   |
|            |    6527.23 |      | 5.25e-07 | D    | 0.0   -  15316.2     | 2s2.2p2                | 3P                     |    0 | 2s2.2p2 |   1D | 2 | E2 | T7333 |   |
|            |    6548.05 |      | 9.84e-04 | D    | 48.7   -  15316.2    | 2s2.2p2                | 3P                     |    1 | 2s2.2p2 |   1D | 2 | M1 | T7333 |   |
|            |    6548.05 |      | 9.22e-07 | D    | 48.7   -  15316.2    | 2s2.2p2                | 3P                     |    1 | 2s2.2p2 |   1D | 2 | E2 | T7333 |   |
|            |    6583.45 |      | 8.65e-06 | D    | 130.8   -  15316.2   | 2s2.2p2                | 3P                     |    2 | 2s2.2p2 |   1D | 2 | E2 | T7333 |   |
|            |            |      |          |      |                      |                        |                        |      |         |      |   |    |       |   |
|            |    6583.45 |      | 2.91e-03 | D    | 130.8   -  15316.2   | 2s2.2p2                | 3P                     |    2 | 2s2.2p2 |   1D | 2 | M1 | T7333 |   |
|------------+------------+------+----------+------+----------------------+------------------------+------------------------+------+---------+------+---+----+-------+---|




******* [S II] lines

|------------+------------+------+----------+------+---------------------+------------------------+------------------------+------+---------+------+-----+----+----------+-------------------|
| Observed   |       Ritz | Rel. |      Aki | Acc. | Ei           Ek     | Lower level            | Upper level            | Type | TP      | Line |     |    |          |                   |
| Wavelength | Wavelength | Int. |     s^-1 |      | (cm-1)       (cm-1) | ---------------------- | ---------------------- |      | Ref.    | Ref. |     |    |          |                   |
| Air  (Å)   |   Air  (Å) | (?)  |          |      |                     | Conf.                  | Term                   | J    | Conf.   | Term | J   |    |          |                   |
|------------+------------+------+----------+------+---------------------+------------------------+------------------------+------+---------+------+-----+----+----------+-------------------|
|            |            |      |          |      |                     |                        |                        |      |         |      |     |    |          |                   |
|            |   6716.440 |      | 1.39e-05 | E'   | 0.00   -  14884.73  | 3s2.3p3                | 4S*                    | 3/2  | 3s2.3p3 | 2D*  | 5/2 | M1 | T3186c85 |                   |
| 6716.440   |   6716.440 |      | 1.88e-04 | C    | 0.00   -  14884.73  | 3s2.3p3                | 4S*                    | 3/2  | 3s2.3p3 | 2D*  | 5/2 | E2 | T3186c85 | L3452,L6318,L6289 |
|            |   6730.816 |      | 1.21e-04 | C    | 0.00   -  14852.94  | 3s2.3p3                | 4S*                    | 3/2  | 3s2.3p3 | 2D*  | 3/2 | E2 | T3186c85 |                   |
| 6730.815   |   6730.816 |      | 5.63e-04 | D    | 0.00   -  14852.94  | 3s2.3p3                | 4S*                    | 3/2  | 3s2.3p3 | 2D*  | 3/2 | M1 | T3186c85 | L3452,L6318,L6289 |
|------------+------------+------+----------+------+---------------------+------------------------+------------------------+------+---------+------+-----+----+----------+-------------------|


******* [S III] lines

|------------+------------+------+----------+------+----------------------+------------------------+------------------------+------+---------+------+---+----+----------+-------|
| Observed   | Ritz       | Rel. | Aki      | Acc. | Ei           Ek      | Lower level            | Upper level            | Type | TP      | Line |   |    |          |       |
| Wavelength | Wavelength | Int. | s^-1     |      | (cm-1)       (cm-1)  | ---------------------- | ---------------------- |      | Ref.    | Ref. |   |    |          |       |
| Air  (Å)   | Air  (Å)   | (?)  |          |      |                      | Conf.                  | Term                   | J    | Conf.   | Term | J |    |          |       |
|------------+------------+------+----------+------+----------------------+------------------------+------------------------+------+---------+------+---+----+----------+-------|
|            |            |      |          |      |                      |                        |                        |      |         |      |   |    |          |       |
| 6312.06    | 6312.06    |      | 2.08e+00 | B+   | 11322.7   -  27161.0 | 3s2.3p2                | 1D                     | 2    | 3s2.3p2 | 1S   | 0 | E2 | T7942c84 | L3452 |
|------------+------------+------+----------+------+----------------------+------------------------+------------------------+------+---------+------+---+----+----------+-------|



******* [Cl III] lines
:LOGBOOK:
CLOCK: [2013-04-26 Fri 19:51]--[2013-04-26 Fri 23:17] =>  3:26
:END:
:PROPERTIES:
:ID:       059F129A-524D-4712-A4A7-72DD546A9842
:END:

+ Note that thee lines are almost invisible in the denser proplyds
  + Which makes them good for investigating the extinction by the proplyd
  + For instance by comparison with [S III] and C III
  + It honestly looks as though there is no extinction at all

|------------+----------+------+--------+----------+---------+-------+-----+---------+-------+-----+------+------|
|       Ritz |      Aki | Acc. |     Ei |       Ek |         |       |     |         |       |     |      |      |
| Wavelength |     s^-1 |      | (cm-1) |   (cm-1) |         |       | .   |         |       |     |      |      |
|   Air  (Å) |          |      |        |          | Conf_{i}   | Term_{i} | J_{i}  | Conf_{k}   | Term_{k} | J_{k}  | Type | Ref  |
|------------+----------+------+--------+----------+---------+-------+-----+---------+-------+-----+------+------|
|            |          |      |        |          |         |       |     |         |       |     |      |      |
|   5517.709 | 1.46e-04 | C    |   0.00 | 18118.43 | 3s2.3p3 | 4S*   | 3/2 | 3s2.3p3 | 2D*   | 5/2 | M1   | T761 |
|   5517.709 |  8.6e-04 | D    |   0.00 | 18118.43 | 3s2.3p3 | 4S*   | 3/2 | 3s2.3p3 | 2D*   | 5/2 | E2   | T761 |
|   5537.873 |  6.5e-03 | C    |   0.00 | 18052.46 | 3s2.3p3 | 4S*   | 3/2 | 3s2.3p3 | 2D*   | 3/2 | M1   | T761 |
|   5537.873 |  5.5e-04 | D    |   0.00 | 18052.46 | 3s2.3p3 | 4S*   | 3/2 | 3s2.3p3 | 2D*   | 3/2 | E2   | T761 |
|------------+----------+------+--------+----------+---------+-------+-----+---------+-------+-----+------+------|

Get the data from van Hoof as well since the A values give a funny value for the line ratio in the high density limit.  


| LAB WAVL ANG AIR | SPECTRUM | TT | CONFIGURATION   | TERM    | J_i J_k   |     A_ki | TPF | REF |
|------------------+----------+----+-----------------+---------+-----------+----------+-----+-----|
|          5517.72 | [Cl III] | M1 | 3s2.3p3-3s2.3p3 | 4So-2Do | 3/2 - 5/2 | 1.46E-04 | ASD | 006 |
|          5537.89 | [Cl III] | M1 | 3s2.3p3-3s2.3p3 | 4So-2Do | 3/2 - 3/2 | 6.50E-03 | ASD | 006 |


******* [Fe III] lines

+ The strongest is 4881
+ Followed by 5270
+ All the others are very weak

|------------+------------+------+---------+------+----------------------+-----------------------+-----------------------+------+-------+------+---+----+------+---|
| Observed   |       Ritz | Rel. |     Aki | Acc. | Ei           Ek      |           Lower level |           Upper level | Type |    TP | Line |   |    |      |   |
| Wavelength | Wavelength | Int. |    s^-1 |      | (cm-1)       (cm-1)  | --------------------- | --------------------- |      |  Ref. | Ref. |   |    |      |   |
| Air  (Å)   |   Air  (Å) | (?)  |         |      |                      |                 Conf. |                  Term |    J | Conf. | Term | J |    |      |   |
|------------+------------+------+---------+------+----------------------+-----------------------+-----------------------+------+-------+------+---+----+------+---|
|            |            |      |         |      |                      |                       |                       |      |       |      |   |    |      |   |
|            |    4607.03 |      | 3.8e-02 | D    | 0.0   -  21699.9     |                   3d6 |                    5D |    4 |   3d6 | 3F2  | 3 | M1 | T461 |   |
|            |    4658.05 |      | 4.4e-01 | D    | 0.0   -  21462.2     |                   3d6 |                    5D |    4 |   3d6 | 3F2  | 4 | M1 | T461 |   |
|            |    4667.01 |      | 2.6e-02 | D    | 436.2   -  21857.2   |                   3d6 |                    5D |    3 |   3d6 | 3F2  | 2 | M1 | T461 |   |
|            |    4701.53 |      | 2.7e-01 | D    | 436.2   -  21699.9   |                   3d6 |                    5D |    3 |   3d6 | 3F2  | 3 | M1 | T461 |   |
|            |    4733.91 |      | 1.0e-01 | D    | 738.9   -  21857.2   |                   3d6 |                    5D |    2 |   3d6 | 3F2  | 2 | M1 | T461 |   |
|            |            |      |         |      |                      |                       |                       |      |       |      |   |    |      |   |
|            |    4754.69 |      | 8.1e-02 | D    | 436.2   -  21462.2   |                   3d6 |                    5D |    3 |   3d6 | 3F2  | 4 | M1 | T461 |   |
|            |    4769.43 |      | 8.7e-02 | D    | 738.9   -  21699.9   |                   3d6 |                    5D |    2 |   3d6 | 3F2  | 3 | M1 | T461 |   |
|            |    4777.68 |      | 4.9e-02 | D    | 932.4   -  21857.2   |                   3d6 |                    5D |    1 |   3d6 | 3F2  | 2 | M1 | T461 |   |
|            |    4881.00 |      | 4.8e-03 | D    | 0.0   -  20481.9     |                   3d6 |                    5D |    4 |   3d6 | 3H   | 4 | M1 | T461 |   |
|            |    4930.54 |      | 6.7e-01 | D    | 932.4   -  21208.5   |                   3d6 |                    5D |    1 |   3d6 | 3P2  | 0 | M1 | T461 |   |
|            |            |      |         |      |                      |                       |                       |      |       |      |   |    |      |   |
|            |    5011.26 |      | 5.3e-01 | D    | 738.9   -  20688.4   |                   3d6 |                    5D |    2 |   3d6 | 3P2  | 1 | M1 | T461 |   |
|            |    5084.77 |      | 9.1e-02 | D    | 1027.3   -  20688.4  |                   3d6 |                    5D |    0 |   3d6 | 3P2  | 1 | M1 | T461 |   |
|            |    5270.40 |      | 4.0e-01 | D    | 436.2   -  19404.8   |                   3d6 |                    5D |    3 |   3d6 | 3P2  | 2 | M1 | T461 |   |
|            |    5411.98 |      | 3.8e-02 | D    | 932.4   -  19404.8   |                   3d6 |                    5D |    1 |   3d6 | 3P2  | 2 | M1 | T461 |   |
|            |     6096.3 |      | 9.6e-02 | D    | 19404.8   -  35803.7 |                   3d6 |                   3P2 |    2 |   3d6 | 1D2  | 2 | M1 | T461 |   |
|------------+------------+------+---------+------+----------------------+-----------------------+-----------------------+------+-------+------+---+----+------+---|





******* [Fe II] lines

+ 5273 and 5262 look like fluorescence (very weak)
+ 5159 might be a doublet with separation 10 km/s
  + This is much less than the 46 km/s between 5158.7771 and 5158.0006
  + We are looking for something around 5158.60
    + There are Ni II and O I lines, but in both case I can't find any evidence of other lines of the same multiplet
+ 4815 is very weak and affected by order overlap

| .LAB.WAVL.ANG.AIR. | ..SPC.. | TT | ..TERM... | ..J_i - J_k.. | ..A_ki.. | .TPF. | LEVEL.ENERGY..CM^-1 | .REF... |
|--------------------+---------+----+-----------+---------------+----------+-------+---------------------+---------|
|          4814.5342 | [Fe II] | E2 | a4F-b4F   | 9/2 - 9/2     |          |       | 1872.57 - 22637.21  | ASD     |
|          5158.0006 | [Fe II] | E2 | a4F-b4P   | 7/2 - 3/2     |          |       | 2430.10 - 21812.06  | ASD     |
|          5158.7771 | [Fe II] | E2 | a4F-a4H   | 9/2 - 13/2    | 4.40E-01 | ASD   | 1872.57 - 21251.61  | ASD     |
|          5261.6209 | [Fe II] | E2 | a4F-a4H   | 7/2 - 11/2    | 3.10E-01 | ASD   | 2430.10 - 21430.36  | ASD     |
|          5273.3463 | [Fe II] | E2 | a4F-b4P   | 9/2 - 5/2     |          |       | 1872.57 - 20830.58  | ASD     |


******* [O III] lines

|------------+----------+------+-----------------------+------------------------+------------------------+------+-------------------|
|       Ritz |      Aki | Acc. | Ei           Ek       | Lower level            | Upper level            | Type | TP                |
| Wavelength |     s^-1 |      | (cm-1)       (cm-1)   | ---------------------- | ---------------------- |      | Ref.              |
|   Air  (Å) |          |      |                       | Conf.    Term  J       | Conf.    Term  J       |      |                   |
|------------+----------+------+-----------------------+------------------------+------------------------+------+-------------------|
|            |          |      |                       |                        |                        |      |                   |
|   4931.227 | 2.41e-06 | C+   | 0.000   -  20273.27   | 2s2.2p2  3P    0       | 2s2.2p2  1D    2       | E2   | T4010,T4899,T4026 |
|   4958.911 | 6.21e-03 | B    | 113.178   -  20273.27 | 2s2.2p2  3P    1       | 2s2.2p2  1D    2       | M1   | T4010,T4899,T4026 |
|   4958.911 | 4.57e-06 | C+   | 113.178   -  20273.27 | 2s2.2p2  3P    1       | 2s2.2p2  1D    2       | E2   | T4899             |
|   5006.843 | 1.81e-02 | B    | 306.174   -  20273.27 | 2s2.2p2  3P    2       | 2s2.2p2  1D    2       | M1   | T4010,T4899,T4026 |
|   5006.843 | 3.52e-05 | C+   | 306.174   -  20273.27 | 2s2.2p2  3P    2       | 2s2.2p2  1D    2       | E2   | T4899             |
|------------+----------+------+-----------------------+------------------------+------------------------+------+-------------------|


****** Metal Fluorescent lines





******* Maintaining a database of multiplet lines 
#+name: update-multiplet-database
#+BEGIN_SRC python :var label="O_I_6046" :var table=OI-6046-multiplet-data :results output
import json
import os
try:
    db = json.load(open("multiplet-database.json"))
except IOError:
    db = {}

data = {"J_i": [], "J_k": [], "Wavelength": [], "A_ki": []}
print table
for row in table[1:]:
    if row[0] != "":
       data["J_i"].append(row[0]) 
       data["J_k"].append(row[1]) 
       data["Wavelength"].append(row[2]) 
       data["A_ki"].append(float(row[3])) 

db[label] = data
with open("multiplet-database.json.TMP", "w") as f:
    json.dump(db, f, indent=2)
os.rename("multiplet-database.json.TMP", "multiplet-database.json")
#+END_SRC

#+RESULTS:

#+RESULTS: update-multiplet-database
: [['J_i', 'J_k', 'Wav', 'A_ki', 'I', 'dV', 'I dV**2'], [1, 1, 6046.233, '1.04E+06', 0.3324808, -7.09, 16.71], [2, 1, 6046.438, '1.74E+06', 0.556266, 3.07, 5.24], [0, 1, 6046.495, '3.48E+05', 0.1112532, 5.9, 3.87], ['', '', 6046.376, 3128000, 1.0, 0.0, 5.08]]


******* [N I] lines

Data from NIST

|------------+------------+------+----------+------+-----------------------+--------------------------------+--------------------------------+------+---------+------+-----+----+-------+---|
| Observed   |       Ritz | Rel. |      Aki | Acc. | Ei           Ek       | Lower level                    | Upper level                    | Type | TP      | Line |     |    |       |   |
| Wavelength | Wavelength | Int. |     s^-1 |      | (cm-1)       (cm-1)   | ------------------------------ | ------------------------------ |      | Ref.    | Ref. |     |    |       |   |
| Air  (Å)   |   Air  (Å) | (?)  |          |      |                       | Conf.                          | Term                           | J    | Conf.   | Term | J   |    |       |   |
|------------+------------+------+----------+------+-----------------------+--------------------------------+--------------------------------+------+---------+------+-----+----+-------+---|
|            |            |      |          |      |                       |                                |                                |      |         |      |     |    |       |   |
|            |   5197.902 |      | 1.60e-05 | B    | 0.000   -   19233.177 | 2s2.2p3                        | 4S*                            | 3/2  | 2s2.2p3 | 2D*  | 3/2 | M1 | T7370 |   |
|            |   5197.902 |      | 4.34e-06 | B    | 0.000   -   19233.177 | 2s2.2p3                        | 4S*                            | 3/2  | 2s2.2p3 | 2D*  | 3/2 | E2 | T7370 |   |
|            |   5200.257 |      | 9.71e-07 | B    | 0.000   -   19224.464 | 2s2.2p3                        | 4S*                            | 3/2  | 2s2.2p3 | 2D*  | 5/2 | M1 | T7370 |   |
|            |   5200.257 |      | 6.59e-06 | B    | 0.000   -   19224.464 | 2s2.2p3                        | 4S*                            | 3/2  | 2s2.2p3 | 2D*  | 5/2 | E2 | T7370 |   |
|------------+------------+------+----------+------+-----------------------+--------------------------------+--------------------------------+------+---------+------+-----+----+-------+---|


******* O I lines

The strongest multiplets observed are 
+ 7002 in order 51
+ 6046 in order 59


******** O I 6046 multiplet
This is a triplet, where all 3 components have the same upper level. 

Data from van Hoof: 
| LAB WAVL ANG AIR |    DLAM | SPECTRUM | TT | CONFIGURATION                     | TERM   | J_{i} -  J_{k} |      A_{ki} | TPF | LEVEL ENERGY     CM^{-1} | REF |
|------------------+---------+----------+----+-----------------------------------+--------+----------+----------+-----+-----------------------+-----|
|         6046.233 | 3.3E-03 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).6s | 3P-3So | 1 - 1    | 1.04E+06 |   3 | 88630.59 - 105165.23  | ASD |
|         6046.438 | 3.3E-03 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).6s | 3P-3So | 2 - 1    | 1.74E+06 |   3 | 88630.59 - 105165.23  | ASD |
|         6046.495 | 3.3E-03 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).6s | 3P-3So | 0 - 1    | 3.48E+05 |   3 | 88631.30 - 105165.23  | ASD |
|------------------+---------+----------+----+-----------------------------------+--------+----------+----------+-----+-----------------------+-----|

Data from NIST:

| Obs wav  | Theo wav  |      A_{ki} | Conf_{1}         | Term_{1} | J_{1} | Conf_{2}         | Term_{2} | J_{2} |
|----------+-----------+----------+---------------+-------+----+---------------+-------+----|
| 6 046.23 | 6 046.233 | 1.05e+06 | 2s22p3(4S°)3p | 3P    |  1 | 2s22p3(4S°)6s | 3S°   |  1 |
| 6 046.44 | 6 046.438 | 1.75e+06 | 2s22p3(4S°)3p | 3P    |  2 | 2s22p3(4S°)6s | 3S°   |  1 |
| 6 046.49 | 6 046.495 | 3.50e+05 | 2s22p3(4S°)3p | 3P    |  0 | 2s22p3(4S°)6s | 3S°   |  1 |

These are pretty identical.  We will use the theoretical wavelengths: 

#+name: OI-6046-multiplet-data
| J_i | J_k |      Wav |     A_ki |         I |    dV | I dV**2 |
|-----+-----+----------+----------+-----------+-------+---------|
|   1 |   1 | 6046.233 | 1.04E+06 | 0.3324808 | -7.09 |   16.71 |
|   2 |   1 | 6046.438 | 1.74E+06 | 0.5562660 |  3.07 |    5.24 |
|   0 |   1 | 6046.495 | 3.48E+05 | 0.1112532 |  5.90 |    3.87 |
|-----+-----+----------+----------+-----------+-------+---------|
|     |     | 6046.376 | 3128000. | 1.0000000 |  0.00 |    5.08 |
#+TBLFM: $5=$-1/@II$4;f7::$6=$c ($3 - @II$3)/@II$3 $km ; f2::$7=$5 $6**2 ;f2::@5$3=@I..@II @I$5..@II$5; f3::@5$4=vsum(@I..@II)::@5$7=sqrt(vsum(@I..@II));f2

#+call: update-multiplet-database(label="O_I_6046", table=OI-6046-multiplet-data) :results output

#+RESULTS: update-multiplet-database(label="O_I_6046", table=OI-6046-multiplet-data):results output


********* Pumping line: O I 951-953

+ 11u    2s22p3(4So)6s 3So             LS   Ref ZSM77=BZ91=WFD96                                  

| Mult    | Vacuum Wav |    Elow |        Eup | gl | gu |        A |        f | Log gf | Log wf |
| No.     |        (A) |  (cm-1) |     (cm-1) |    |    |    (s-1) |          |        |    (A) |
|---------+------------+---------+------------+----+----+----------+----------+--------+--------|
|         |   952.9413 | 226.977 | 105165.232 |  1 |  3 | 3.85E+06 | 1.57E-03 | -2.803 |  0.176 |
|         |   952.3178 | 158.265 | 105165.232 |  3 |  3 | 1.16E+07 | 1.57E-03 | -2.326 |  0.176 |
|         |   950.8846 |      0. | 105165.232 |  5 |  3 | 1.94E+07 | 1.58E-03 | -2.103 |  0.176 |
|---------+------------+---------+------------+----+----+----------+----------+--------+--------|
| MltMean |    951.590 |   77.97 |  105165.23 |  9 |  3 | 3.48E+07 | 1.57E-03 | -1.849 |  0.176 |
|---------+------------+---------+------------+----+----+----------+----------+--------+--------|


******** O I 7002 multiplet
+ This is a sextuplet: 3p ^{3}P_{0,1,2} - 4d ^{3}D_{1,2,3}
+ The main splitting (0.3 Ang) is between the J_{i} = 1 components and the J_{i} = 0,2 components
+ Within each of these, the splitting is only 0.03 to 0.08 Ang

Data from van Hoof

| LAB WAVL ANG AIR |    DLAM | SPECTRUM | TT | CONFIGURATION                     | TERM   | J_i -  J_k |     A_ki | TPF | LEVEL ENERGY     CM^ 1 | REF |
|------------------+---------+----------+----+-----------------------------------+--------+------------+----------+-----+------------------------+-----|
|         7001.899 | 4.4E-03 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).4d | 3P-3Do | 1 - 1      | 1.39E+06 |   3 | 88630.59 - 102908.49   | ASD |
|         7001.922 | 4.4E-03 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).4d | 3P-3Do | 1 - 2      | 2.50E+06 |   3 | 88630.59 - 102908.44   | ASD |
|         7002.173 | 4.4E-03 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).4d | 3P-3Do | 2 - 1      | 9.26E+04 |   3 | 88631.15 - 102908.49   | ASD |
|         7002.196 | 4.4E-03 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).4d | 3P-3Do | 2 - 2      | 8.33E+05 |   3 | 88631.15 - 102908.44   | ASD |
|         7002.230 | 4.4E-03 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).4d | 3P-3Do | 2 - 3      | 3.33E+06 |   3 | 88631.15 - 102908.37   | ASD |
|         7002.250 | 4.4E-03 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).4d | 3P-3Do | 0 - 1      | 1.85E+06 |   3 | 88631.30 - 102908.49   | ASD |

Data from NIST

|------------+------------+------+----------+------+--------------------------------+---------------------------------+---------------------------------+---------+------------------+------+------+-------+---+----------+-------|
| Observed   |       Ritz | Rel. |      Aki | Acc. | Ei           Ek                | Lower level                     | Upper level                     | gi   gk | Type             | TP   | Line |       |   |          |       |
| Wavelength | Wavelength | Int. |     s^-1 |      | (eV)         (eV)              | ------------------------------- | ------------------------------- |         |                  | Ref. | Ref. |       |   |          |       |
| Air  (Å)   |   Air  (Å) | (?)  |          |      |                                | Conf.                           | Term                            |       J | Conf.            | Term |    J |       |   |          |       |
|------------+------------+------+----------+------+--------------------------------+---------------------------------+---------------------------------+---------+------------------+------+------+-------+---+----------+-------|
|            |            |      |          |      |                                |                                 |                                 |         |                  |      |      |       |   |          |       |
|            |   7001.899 |      | 1.47e+06 | B    | 10.988792     -     12.7590257 | 2s2.2p3.(4S*).3p                | 3P                              |       1 | 2s2.2p3.(4S*).4d | 3D*  |    1 | 3 - 3 |   | T5803,LS |       |
| 7001.92    |   7001.922 | 360  | 2.65e+06 | B    | 10.988792     -     12.7590200 | 2s2.2p3.(4S*).3p                | 3P                              |       1 | 2s2.2p3.(4S*).4d | 3D*  |    2 | 3 - 5 |   | T5803,LS | L3760 |
|            |   7002.173 |      | 9.83e+04 | B    | 10.988861     -     12.7590257 | 2s2.2p3.(4S*).3p                | 3P                              |       2 | 2s2.2p3.(4S*).4d | 3D*  |    1 | 5 - 3 |   | T5803,LS |       |
|            |   7002.196 |      | 8.83e+05 | B    | 10.988861     -     12.7590200 | 2s2.2p3.(4S*).3p                | 3P                              |       2 | 2s2.2p3.(4S*).4d | 3D*  |    2 | 5 - 5 |   | T5803,LS |       |
| 7002.23    |   7002.230 | 450  | 3.53e+06 | B    | 10.988861     -     12.7590115 | 2s2.2p3.(4S*).3p                | 3P                              |       2 | 2s2.2p3.(4S*).4d | 3D*  |    3 | 5 - 7 |   | T5803,LS | L3760 |
|            |            |      |          |      |                                |                                 |                                 |         |                  |      |      |       |   |          |       |
|            |   7002.250 |      | 1.96e+06 | B    | 10.988880     -     12.7590257 | 2s2.2p3.(4S*).3p                | 3P                              |       0 | 2s2.2p3.(4S*).4d | 3D*  |    1 | 1 - 3 |   | T5803,LS |       |
|------------+------------+------+----------+------+--------------------------------+---------------------------------+---------------------------------+---------+------------------+------+------+-------+---+----------+-------|

+ Mean wavelength comes out as 7002.1244
  + I assume that the populations of the upper levels are proportional to their statistical weights: (2 J_{k} + 1)

#+name: OI-7002-multiplet-data
| J_i | J_k |         Wav |     A_ki | A_ki (2 J_k + 1) |         I |    dV | I dV**2 |
|-----+-----+-------------+----------+------------------+-----------+-------+---------|
|   1 |   1 |    7001.899 | 1.39E+06 |           4.17e6 | 0.0834534 | -9.65 |    7.77 |
|   1 |   2 |    7001.922 | 2.50E+06 |           1.25e7 | 0.2501601 | -8.67 |   18.80 |
|   2 |   1 |    7002.173 | 9.26E+04 |           2.78e5 | 0.0055636 |  2.08 |    0.02 |
|   2 |   2 |    7002.196 | 8.33E+05 |           4.17e6 | 0.0834534 |  3.07 |    0.79 |
|   2 |   3 |    7002.230 | 3.33E+06 |           2.33e7 | 0.4662984 |  4.52 |    9.53 |
|   0 |   1 |    7002.250 | 1.85E+06 |           5.55e6 | 0.1110711 |  5.38 |    3.21 |
|-----+-----+-------------+----------+------------------+-----------+-------+---------|
|     |     | 7002.124395 | 9.9956e6 |         4.9968e7 | 1.0000000 |  0.00 |    6.33 |
#+TBLFM: $5=(2 $2 + 1) $4 ; s3::$6=$5/@II$5;f7::$7=$c ($3 - @II$3)/@II$3 $km ; f2::$8=$6 $7**2 ;f2::@8$3=@I..@II @I$6..@II$6; f6::@8$4=vsum(@I..@II); s7::@8$5=vsum(@I..@II); s7::@8$8=sqrt(vsum(@I..@II));f2

#+call: update-multiplet-database(label="O_I_7002", table=OI-7002-multiplet-data) :results output

#+RESULTS: update-multiplet-database(label="O_I_7002", table=OI-7002-multiplet-data):results output



********* What happens if we analyze separately the sub-components of each group?
+ 4 red components

| J_i | J_k |         Wav |     A_ki | A_ki (2 J_k + 1) |         I |    dV | I dV**2 |
|-----+-----+-------------+----------+------------------+-----------+-------+---------|
|   2 |   1 |    7002.173 | 9.26E+04 |           2.78e5 | 0.0083488 | -2.35 |    0.05 |
|   2 |   2 |    7002.196 | 8.33E+05 |           4.17e6 | 0.1252327 | -1.37 |    0.24 |
|   2 |   3 |    7002.230 | 3.33E+06 |           2.33e7 | 0.6997417 |  0.09 |  5.7e-3 |
|   0 |   1 |    7002.250 | 1.85E+06 |           5.55e6 | 0.1666767 |  0.95 |    0.15 |
|-----+-----+-------------+----------+------------------+-----------+-------+---------|
|     |     | 7002.227900 | 6.1056e6 |         3.3298e7 | 1.0000000 |  0.00 |    0.67 |
#+TBLFM: $5=(2 $2 + 1) $4 ; s3::$6=$5/@II$5;f7::$7=$c ($3 - @II$3)/@II$3 $km ; f2::$8=$6 $7**2 ;f2::@6$3=@I..@II @I$6..@II$6; f6::@6$4=vsum(@I..@II); s7::@6$5=vsum(@I..@II); s7::@6$8=sqrt(vsum(@I..@II));f2

+ 2 blue components
| J_i | J_k |         Wav |     A_ki | A_ki (2 J_k + 1) |         I |    dV | I dV**2 |
|-----+-----+-------------+----------+------------------+-----------+-------+---------|
|   1 |   1 |    7001.899 | 1.39E+06 |           4.17e6 | 0.2501500 | -0.74 |    0.14 |
|   1 |   2 |    7001.922 | 2.50E+06 |           1.25e7 | 0.7498500 |  0.25 |    0.05 |
|-----+-----+-------------+----------+------------------+-----------+-------+---------|
|     |     | 7001.916247 |   3.89e6 |          1.667e7 | 1.0000000 |  0.00 |    0.44 |
#+TBLFM: $5=(2 $2 + 1) $4 ; s3::$6=$5/@II$5;f7::$7=$c ($3 - @II$3)/@II$3 $km ; f2::$8=$6 $7**2 ;f2::@4$3=@I..@II @I$6..@II$6; f6::@4$4=vsum(@I..@II); s7::@4$5=vsum(@I..@II); s7::@4$8=sqrt(vsum(@I..@II));f2

So this looks OK.  The sigmas of the two groupings are only about 0.5 km/s, which is much smaller than the 6 km/s of the multiplet as a whole. 

********* Pumping line: O I 972-974

Mult    Air Wavelength Vacuum    Elow       Eup     gl gu     A       Gamma       f      Log gf Log wf  Error 
 No.      (A)         (A)       (cm-1)     (cm-1)           (s-1)     (s-1)                      (A)    (dex) 

10u    2s22p3(4So)4d 3Do             LS   Ref BZ91,HBGV91b,WFD96                                
MltMean             972.475     77.97  102908.42     9 15  5.84E+07            1.38E-02  -0.906  1.128
                    973.8852   226.977 102908.489    1  3  3.23E+07            1.38E-02  -1.861  1.128       
                    973.2343   158.265 102908.443    3  5  4.37E+07            1.03E-02  -1.508  1.003       
                    973.2339   158.265 102908.489    3  3  2.43E+07            3.45E-03  -1.985  0.526       
                    971.7382     0.    102908.374    5  7  5.85E+07            1.16E-02  -1.237  1.052       
                    971.7376     0.    102908.443    5  5  1.46E+07            2.07E-03  -1.985  0.304       
                    971.7371     0.    102908.489    5  3  1.63E+06            1.38E-04  -3.161 -0.872       


		    




******** O I 5959 multiplet

+ This one is a sextuplet, just like 7002 but from 5d instead of 4d 

|------------+------------+------+----------+------+---------------------------+---------------------------------+---------------------------------+------+------------------+------+---+---+---------+-------|
|   Observed |       Ritz | Rel. |      Aki | Acc. | Ei           Ek           | Lower level                     | Upper level                     | Type | TP               | Line |   |   |         |       |
| Wavelength | Wavelength | Int. |     s^-1 |      | (cm-1)       (cm-1)       | ------------------------------- | ------------------------------- |      | Ref.             | Ref. |   |   |         |       |
|   Air  (Å) |   Air  (Å) | (?)  |          |      |                           | Conf.                           | Term                            |    J | Conf.            | Term | J |   |         |       |
|------------+------------+------+----------+------+---------------------------+---------------------------------+---------------------------------+------+------------------+------+---+---+---------+-------|
|            |            |      |          |      |                           |                                 |                                 |      |                  |      |   |   |         |       |
|    5958.39 |   5958.386 | 160* | 3.78e+05 | C+   | 88630.587   -  105409.008 | 2s2.2p3.(4S*).3p                | 3P                              |    1 | 2s2.2p3.(4S*).5d | 3D*  | 1 |   | T5713LS | L3760 |
|    5958.39 |   5958.386 | 160* | 6.80e+05 | C+   | 88630.587   -  105409.008 | 2s2.2p3.(4S*).3p                | 3P                              |    1 | 2s2.2p3.(4S*).5d | 3D*  | 2 |   | T5713LS | L3760 |
|    5958.58 |   5958.584 | 190* | 2.27e+05 | C+   | 88631.146   -  105409.008 | 2s2.2p3.(4S*).3p                | 3P                              |    2 | 2s2.2p3.(4S*).5d | 3D*  | 2 |   | T5713LS | L3760 |
|    5958.58 |   5958.584 | 190* | 2.52e+04 | C    | 88631.146   -  105409.008 | 2s2.2p3.(4S*).3p                | 3P                              |    2 | 2s2.2p3.(4S*).5d | 3D*  | 1 |   | T5713LS | L3760 |
|    5958.58 |   5958.584 | 190* | 9.06e+05 | C+   | 88631.146   -  105409.008 | 2s2.2p3.(4S*).3p                | 3P                              |    2 | 2s2.2p3.(4S*).5d | 3D*  | 3 |   | T5713LS | L3760 |
|            |   5958.640 |      | 5.04e+05 | C+   | 88631.303   -  105409.008 | 2s2.2p3.(4S*).3p                | 3P                              |    0 | 2s2.2p3.(4S*).5d | 3D*  | 1 |   | T5713LS |       |
|------------+------------+------+----------+------+---------------------------+---------------------------------+---------------------------------+------+------------------+------+---+---+---------+-------|


| J_i | J_k |         Wav |     A_ki | A_ki (2 J_k + 1) |         I |    dV | I dV**2 |
|-----+-----+-------------+----------+------------------+-----------+-------+---------|
|   1 |   1 |    5958.386 | 3.78e+05 |           1.13e6 | 0.0831151 | -6.93 |    3.99 |
|   1 |   2 |    5958.386 | 6.80e+05 |            3.4e6 | 0.2500809 | -6.93 |   12.01 |
|   2 |   2 |    5958.584 | 2.27e+05 |           1.14e6 | 0.0838507 |  3.04 |    0.77 |
|   2 |   1 |    5958.584 | 2.52e+04 |           7.56e4 | 0.0055606 |  3.04 |    0.05 |
|   2 |   3 |    5958.584 | 9.06e+05 |           6.34e6 | 0.4663273 |  3.04 |    4.31 |
|   0 |   1 |    5958.640 | 5.04e+05 |           1.51e6 | 0.1110653 |  5.85 |    3.80 |
|-----+-----+-------------+----------+------------------+-----------+-------+---------|
|     |     | 5958.523651 | 2.7202e6 |        1.35956e7 | 1.0000000 |  0.00 |    4.99 |
#+TBLFM: $5=(2 $2 + 1) $4 ; s3::$6=$5/@II$5;f7::$7=$c ($3 - @II$3)/@II$3 $km ; f2::$8=$6 $7**2 ;f2::@8$3=@I..@II @I$6..@II$6; f6::@8$4=vsum(@I..@II); s7::@8$5=vsum(@I..@II); s7::@8$8=sqrt(vsum(@I..@II));f2


******** O I 5555 multiplet

+ Again they all share an upper level

|------------+------------+------+----------+------+---------------------------+---------------------------------+---------------------------------+------+------------------+------+---+---+---------+---|
| Observed   |       Ritz | Rel. |      Aki | Acc. | Ei           Ek           | Lower level                     | Upper level                     | Type | TP               | Line |   |   |         |   |
| Wavelength | Wavelength | Int. |     s^-1 |      | (cm-1)       (cm-1)       | ------------------------------- | ------------------------------- |      | Ref.             | Ref. |   |   |         |   |
| Air  (Å)   |   Air  (Å) | (?)  |          |      |                           | Conf.                           | Term                            |    J | Conf.            | Term | J |   |         |   |
|------------+------------+------+----------+------+---------------------------+---------------------------------+---------------------------------+------+------------------+------+---+---+---------+---|
|            |            |      |          |      |                           |                                 |                                 |      |                  |      |   |   |         |   |
|            |   5554.832 |      | 5.83e+05 | C+   | 88630.587   -  106627.934 | 2s2.2p3.(4S*).3p                | 3P                              |    1 | 2s2.2p3.(4S*).7s | 3S*  | 1 |   | T5713LS |   |
|            |   5555.004 |      | 9.71e+05 | C+   | 88631.146   -  106627.934 | 2s2.2p3.(4S*).3p                | 3P                              |    2 | 2s2.2p3.(4S*).7s | 3S*  | 1 |   | T5713LS |   |
|            |   5555.053 |      | 1.94e+05 | C+   | 88631.303   -  106627.934 | 2s2.2p3.(4S*).3p                | 3P                              |    0 | 2s2.2p3.(4S*).7s | 3S*  | 1 |   | T5713LS |   |
|------------+------------+------+----------+------+---------------------------+---------------------------------+---------------------------------+------+------------------+------+---+---+---------+---|


| J_i | J_k |      Wav |     A_ki |         I |    dV | I dV**2 |
|-----+-----+----------+----------+-----------+-------+---------|
|   1 |   1 | 5554.832 | 5.83e+05 | 0.3335240 | -6.48 |   14.00 |
|   2 |   1 | 5555.004 | 9.71e+05 | 0.5554920 |  2.81 |    4.39 |
|   0 |   1 | 5555.053 | 1.94e+05 | 0.1109840 |  5.45 |    3.30 |
|-----+-----+----------+----------+-----------+-------+---------|
|     |     | 5554.952 | 1748000. | 1.0000000 |  0.00 |    4.66 |
#+TBLFM: $5=$-1/@II$4;f7::$6=$c ($3 - @II$3)/@II$3 $km ; f2::$7=$5 $6**2 ;f2::@5$3=@I..@II @I$5..@II$5; f3::@5$4=vsum(@I..@II)::@5$7=sqrt(vsum(@I..@II));f2


******** O I 5299 multiplet

+ All share an upper level, so easy peasy

|------------+------------+------+----------+------+---------------------------+---------------------------------+---------------------------------+------+------------------+------+---+---+---------+---|
| Observed   |       Ritz | Rel. |      Aki | Acc. | Ei           Ek           | Lower level                     | Upper level                     | Type | TP               | Line |   |   |         |   |
| Wavelength | Wavelength | Int. |     s^-1 |      | (cm-1)       (cm-1)       | ------------------------------- | ------------------------------- |      | Ref.             | Ref. |   |   |         |   |
| Air  (Å)   |   Air  (Å) | (?)  |          |      |                           | Conf.                           | Term                            |    J | Conf.            | Term | J |   |         |   |
|------------+------------+------+----------+------+---------------------------+---------------------------------+---------------------------------+------+------------------+------+---+---+---------+---|
|            |            |      |          |      |                           |                                 |                                 |      |                  |      |   |   |         |   |
|            |   5298.887 |      | 3.58e+05 | C+   | 88630.587   -  107497.224 | 2s2.2p3.(4S*).3p                | 3P                              |    1 | 2s2.2p3.(4S*).8s | 3S*  | 1 |   | T5713LS |   |
|            |   5299.044 |      | 5.96e+05 | C+   | 88631.146   -  107497.224 | 2s2.2p3.(4S*).3p                | 3P                              |    2 | 2s2.2p3.(4S*).8s | 3S*  | 1 |   | T5713LS |   |
|            |   5299.088 |      | 1.19e+05 | C    | 88631.303   -  107497.224 | 2s2.2p3.(4S*).3p                | 3P                              |    0 | 2s2.2p3.(4S*).8s | 3S*  | 1 |   | T5713LS |   |
|------------+------------+------+----------+------+---------------------------+---------------------------------+---------------------------------+------+------------------+------+---+---+---------+---|


| J_i | J_k |      Wav |     A_ki |         I |    dV | I dV**2 |
|-----+-----+----------+----------+-----------+-------+---------|
|   1 |   1 | 5298.887 | 3.58e+05 | 0.3336440 | -6.17 |   12.70 |
|   2 |   1 | 5299.044 | 5.96e+05 | 0.5554520 |  2.72 |    4.11 |
|   0 |   1 | 5299.088 | 1.19e+05 | 0.1109040 |  5.20 |    3.00 |
|-----+-----+----------+----------+-----------+-------+---------|
|     |     | 5298.996 | 1073000. | 1.0000000 |  0.00 |    4.45 |
#+TBLFM: $5=$-1/@II$4;f7::$6=$c ($3 - @II$3)/@II$3 $km ; f2::$7=$5 $6**2 ;f2::@5$3=@I..@II @I$5..@II$5; f3::@5$4=vsum(@I..@II)::@5$7=sqrt(vsum(@I..@II));f2




******* Co I line
+ We take the 5146.749 component only, since it has a much higher A value
+ However, there is a hint of a doublet structure, although the splitting is only about 10 km/s
  + This is much less that the 34 km/s between the 5146.161 and 5146.749 components
  + Peter has a lot more lines around here, including more Co I lines and some O I lines, so maybe it is one of those

|------------+------------+------+---------+------+------------------------+------------------------------------------+------------------------------------------+------+--------------------------+-------+-----+---+-------+-------|
| Observed   |       Ritz | Rel. |     Aki | Acc. | Ei           Ek        | Lower level                              | Upper level                              | Type | TP                       | Line  |     |   |       |       |
| Wavelength | Wavelength | Int. |    s^-1 |      | (cm-1)       (cm-1)    | ---------------------------------------- | ---------------------------------------- |      | Ref.                     | Ref.  |     |   |       |       |
| Air  (Å)   |   Air  (Å) | (?)  |         |      |                        | Conf.                                    | Term                                     | J    | Conf.                    | Term  | J   |   |       |       |
|------------+------------+------+---------+------+------------------------+------------------------------------------+------------------------------------------+------+--------------------------+-------+-----+---+-------+-------|
|            |            |      |         |      |                        |                                          |                                          |      |                          |       |     |   |       |       |
|            |   5146.161 |      | 9.2e+03 | D    | 14036.28   -  33462.83 | 3p6.3d7.4s2                              | a 4P                                     | 3/2  | 3p6.3d7.(4F).4s.4p.(3P*) | z 2D* | 5/2 |   | T4223 |       |
| 5146.74    |   5146.749 | 35   | 1.5e+07 | B    | 28777.27   -  48201.60 | 3p6.3d7.(4F).4s.4p.(3P*)                 | z 4F*                                    | 7/2  | 3p6.3d7.4s.(5F).5s       | f 4F  | 7/2 |   | T4223 | L3475 |
|            |   5149.779 |      | 2.2e+05 | D    | 14036.28   -  33449.18 | 3p6.3d7.4s2                              | a 4P                                     | 3/2  | 3p6.3d8.(3F).4p          | y 4D* | 1/2 |   | T4223 |       |
|------------+------------+------+---------+------+------------------------+------------------------------------------+------------------------------------------+------+--------------------------+-------+-----+---+-------+-------|



******* Si II lines

+ The 6347 line is the strongest, with the 6371 being half as bright
  + There is a Cr I line at 6370.81 that might be contaminating 6371, but the other two lines from the same upper level are not seen (6369.67, 6374.51)
  + Same goes for all other candidate contaminating lines
+ 5979 is also about half as bright as 6347, then 5958 exactly half as bright again
+ The 5041,5056 lines are even weaker yet, with the added complication that 5056 has two components, separated by 0.34 Ang = 20 km/s
+ The wavelength accuracy seems a bit low: 0.01 Ang difference between observed and theoretical, which is 0.5 km/s

|------------+------------+------+----------+------+-------------------------+-----------------------+-----------------------+------+-----------+-------|
|   Observed |       Ritz | Rel. |      Aki | Acc. | Ei           Ek         | Lower level           | Upper level           | Type | TP        | Line  |
| Wavelength | Wavelength | Int. |     s^-1 |      | (cm-1)       (cm-1)     | --------------------- | --------------------- |      | Ref.      | Ref.  |
|   Air  (Å) |   Air  (Å) |  (?) |          |      |                         | Conf.   Term  J       | Conf.   Term  J       |      |           |       |
|------------+------------+------+----------+------+-------------------------+-----------------------+-----------------------+------+-----------+-------|
|            |            |      |          |      |                         |                       |                       |      |           |       |
|    5041.03 |   5041.024 | 1000 | 7.00e+07 | B    | 81191.34   -  101023.05 | 3s2.4p  2P*   1/2     | 3s2.4d  2D    3/2     |      | T7222     | L3541 |
|    5055.98 |   5055.984 | 1000 | 1.45e+08 | B    | 81251.32   -  101024.35 | 3s2.4p  2P*   3/2     | 3s2.4d  2D    5/2     |      | T7222     | L3541 |
|            |   5056.317 |      | 2.10e+07 | B    | 81251.32   -  101023.05 | 3s2.4p  2P*   3/2     | 3s2.4d  2D    3/2     |      | T6570     |       |
|            |            |      |          |      |                         |                       |                       |      |           |       |
|    5957.56 |    5957.56 |  500 | 5.60e+07 | B+   | 81191.34   -  97972.09  | 3s2.4p  2P*   1/2     | 3s2.5s  2S    1/2     |      | T6570     | L3541 |
|    5978.93 |    5978.93 |  500 | 1.13e+08 | B+   | 81251.32   -  97972.09  | 3s2.4p  2P*   3/2     | 3s2.5s  2S    1/2     |      | T6570     | L3541 |
|            |            |      |          |      |                         |                       |                       |      |           |       |
|    6347.10 |    6347.11 | 1000 | 5.84e+07 | B+   | 65500.47   -  81251.32  | 3s2.4s  2S    1/2     | 3s2.4p  2P*   3/2     |      | c22,T7222 | L3541 |
|    6371.36 |    6371.37 | 1000 | 6.80e+07 | C+   | 65500.47   -  81191.34  | 3s2.4s  2S    1/2     | 3s2.4p  2P*   1/2     |      | c22,T7222 | L3541 |
|            |            |      |          |      |                         |                       |                       |      |           |       |
|            |            |      |          |      |                         |                       |                       |      |           |       |
|------------+------------+------+----------+------+-------------------------+-----------------------+-----------------------+------+-----------+-------|


****** Recombination lines



******* He I



******** Singlets

+ 5048 is very weak and looks like it is contaminated with something, most likely O I 5047.8

|------------+--------------+------+------------+------+---------------------------------------+-----------------------+-----------------------+------+-------+------+---+----+----------+--------|
| Observed   | Ritz         | Rel. |        Aki | Acc. | Ei           Ek                       | Lower level           | Upper level           | Type | TP    | Line |   |    |          |        |
| Wavelength | Wavelength   | Int. |       s^-1 |      | (cm-1)       (cm-1)                   | --------------------- | --------------------- |      | Ref.  | Ref. |   |    |          |        |
| Air  (Å)   | Air  (Å)     | (?)  |            |      |                                       | Conf.                 | Term                  |    J | Conf. | Term | J |    |          |        |
|------------+--------------+------+------------+------+---------------------------------------+-----------------------+-----------------------+------+-------+------+---+----+----------+--------|
|            |              |      |            |      |                                       |                       |                       |      |       |      |   |    |          |        |
|            | 4920.6127012 |      |  6.219e+01 | AA   | [171134.896946]   - [191451.89746084] | 1s.2p                 | 1P*                   |    1 | 1s.4f | 1F*  | 3 | E2 | T3908    |        |
| 4921.9313  | 4921.9310128 | 20   | 1.9863e+07 | AAA  | [171134.896946]   - [191446.4557405]  | 1s.2p                 | 1P*                   |    1 | 1s.4d | 1D   | 2 |    | T8636c73 | L14926 |
|------------+--------------+------+------------+------+---------------------------------------+-----------------------+-----------------------+------+-------+------+---+----+----------+--------|

|------------+--------------+------+------------+------+-------------------------------------+-----------------------+-----------------------+------+-------+------+---+---+----------+--------|
| Observed   | Ritz         | Rel. | Aki        | Acc. | Ei           Ek                     | Lower level           | Upper level           | Type | TP    | Line |   |   |          |        |
| Wavelength | Wavelength   | Int. | s^-1       |      | (cm-1)       (cm-1)                 | --------------------- | --------------------- |      | Ref.  | Ref. |   |   |          |        |
| Air  (Å)   | Air  (Å)     | (?)  |            |      |                                     | Conf.                 | Term                  | J    | Conf. | Term | J |   |          |        |
|------------+--------------+------+------------+------+-------------------------------------+-----------------------+-----------------------+------+-------+------+---+---+----------+--------|
|            |              |      |            |      |                                     |                       |                       |      |       |      |   |   |          |        |
| 5015.6783  | 5015.6779810 | 100  | 1.3372e+07 | AAA  | [166277.440141]   - [186209.364940] | 1s.2s                 | 1S                    | 0    | 1s.3p | 1P*  | 1 |   | T8636c73 | L14926 |
|------------+--------------+------+------------+------+-------------------------------------+-----------------------+-----------------------+------+-------+------+---+---+----------+--------|

|------------+-------------+------+------------+------+-------------------------------------+-----------------------+-----------------------+------+-------+------+---+---+----------+-----------|
| Observed   | Ritz        | Rel. | Aki        | Acc. | Ei           Ek                     | Lower level           | Upper level           | Type | TP    | Line |   |   |          |           |
| Wavelength | Wavelength  | Int. | s^-1       |      | (cm-1)       (cm-1)                 | --------------------- | --------------------- |      | Ref.  | Ref. |   |   |          |           |
| Air  (Å)   | Air  (Å)    | (?)  |            |      |                                     | Conf.                 | Term                  | J    | Conf. | Term | J |   |          |           |
|------------+-------------+------+------------+------+-------------------------------------+-----------------------+-----------------------+------+-------+------+---+---+----------+-----------|
|            |             |      |            |      |                                     |                       |                       |      |       |      |   |   |          |           |
| 5047.738   | 5047.738543 | 10   | 6.7712e+06 | AAA  | [171134.896946]   - [190940.226355] | 1s.2p                 | 1P*                   | 1    | 1s.4s | 1S   | 0 |   | T8636c73 | L14925c72 |
|------------+-------------+------+------------+------+-------------------------------------+-----------------------+-----------------------+------+-------+------+---+---+----------+-----------|

|------------+-------------+------+------------+------+--------------------------------------+-----------------------+-----------------------+------+-------+------+---+---+----------+------|
| Observed   | Ritz        | Rel. |        Aki | Acc. | Ei           Ek                      | Lower level           | Upper level           | Type | TP    | Line |   |   |          |      |
| Wavelength | Wavelength  | Int. |       s^-1 |      | (cm-1)       (cm-1)                  | --------------------- | --------------------- |      | Ref.  | Ref. |   |   |          |      |
| Air  (Å)   | Air  (Å)    | (?)  |            |      |                                      | Conf.                 | Term                  |    J | Conf. | Term | J |   |          |      |
|------------+-------------+------+------------+------+--------------------------------------+-----------------------+-----------------------+------+-------+------+---+---+----------+------|
|            |             |      |            |      |                                      |                       |                       |      |       |      |   |   |          |      |
| 6678.151   | 6678.151704 | 100  | 6.3705e+07 | AAA  | [171134.896946]   - [186104.9666893] | 1s.2p                 | 1P*                   |    1 | 1s.3d | 1D   | 2 |   | T8636c73 | L366 |
|            | 6679.676834 |      |  1.510e+04 | AA   | [171134.896946]   - [186101.5486891] | 1s.2p                 | 1P*                   |    1 | 1s.3d | 3D   | 2 |   | T8636c73 |      |
|------------+-------------+------+------------+------+--------------------------------------+-----------------------+-----------------------+------+-------+------+---+---+----------+------|


******** Triplets

+ 5876 line has 6 components:
  + Splitting is < 1.4 km/s between 5 of them
  + But the J=1-0 component is 17 km.s to the red
  + In the table above, we put the observed wavelength of the multiplet
|------------+--------------+------+------------+------+---------------------------------------+-----------------------+-----------------------+------+-------+------+---+---+----------+------|
|   Observed |         Ritz | Rel. |        Aki | Acc. | Ei           Ek                       | Lower level           | Upper level           | Type | TP    | Line |   |   |          |      |
| Wavelength |   Wavelength | Int. |       s^-1 |      | (cm-1)       (cm-1)                   | --------------------- | --------------------- |      | Ref.  | Ref. |   |   |          |      |
|   Air  (Å) |     Air  (Å) | (?)  |            |      |                                       | Conf.                 | Term                  |    J | Conf. | Term | J |   |          |      |
|------------+--------------+------+------------+------+---------------------------------------+-----------------------+-----------------------+------+-------+------+---+---+----------+------|
|            |              |      |            |      |                                       |                       |                       |      |       |      |   |   |          |      |
|            | 5874.4338688 |      |  4.310e+03 | AA   | [169086.7664725]   - [186104.9666893] | 1s.2p                 | 3P*                   |    2 | 1s.3d |   1D | 2 |   | T8636c73 |      |
|            | 5874.4602500 |      |  1.232e+04 | AA   | [169086.8428979]   - [186104.9666893] | 1s.2p                 | 3P*                   |    1 | 1s.3d |   1D | 2 |   | T8636c73 |      |
|            | 5875.5986967 |      | 1.9641e+06 | AAA  | [169086.7664725]   - [186101.5928903] | 1s.2p                 | 3P*                   |    2 | 1s.3d |   3D | 1 |   | T8636c73 |      |
|   5875.621 | 5875.6139605 | 500* | 1.7673e+07 | AAA  | [169086.7664725]   - [186101.5486891] | 1s.2p                 | 3P*                   |    2 | 1s.3d |   3D | 2 |   | T8636c73 | L366 |
|   5875.621 | 5875.6148281 | 500* | 7.0708e+07 | AAA  | [169086.7664725]   - [186101.5461767] | 1s.2p                 | 3P*                   |    2 | 1s.3d |   3D | 3 |   | T8636c73 | L366 |
|            |              |      |            |      |                                       |                       |                       |      |       |      |   |   |          |      |
|   5875.621 | 5875.6250884 | 500* | 2.9462e+07 | AAA  | [169086.8428979]   - [186101.5928903] | 1s.2p                 | 3P*                   |    1 | 1s.3d |   3D | 1 |   | T8636c73 | L366 |
|   5875.621 | 5875.6403524 | 500* | 5.3019e+07 | AAA  | [169086.8428979]   - [186101.5486891] | 1s.2p                 | 3P*                   |    1 | 1s.3d |   3D | 2 |   | T8636c73 | L366 |
|            | 5875.9662635 | 100  | 3.9282e+07 | AAA  | [169087.8308131]   - [186101.5928903] | 1s.2p                 | 3P*                   |    0 | 1s.3d |   3D | 1 |   | T8636c73 | L366 |
|------------+--------------+------+------------+------+---------------------------------------+-----------------------+-----------------------+------+-------+------+---+---+----------+------|

******* C II

|------------+------------+------+----------+------+--------------------------+-----------------------+-----------------------+------+--------+------+-----+---+-------+-------|
| Observed   | Ritz       | Rel. | Aki      | Acc. | Ei           Ek          | Lower level           | Upper level           | Type | TP     | Line |     |   |       |       |
| Wavelength | Wavelength | Int. | s^-1     |      | (cm-1)       (cm-1)      | --------------------- | --------------------- |      | Ref.   | Ref. |     |   |       |       |
| Air  (Å)   | Air  (Å)   | (?)  |          |      |                          | Conf.                 | Term                  | J    | Conf.  | Term | J   |   |       |       |
|------------+------------+------+----------+------+--------------------------+-----------------------+-----------------------+------+--------+------+-----+---+-------+-------|
|            |            |      |          |      |                          |                       |                       |      |        |      |     |   |       |       |
| 6578.05    | 6578.05    | 800  | 3.67e+07 | A    | 116537.65   -  131735.52 | 2s2.3s                | 2S                    | 1/2  | 2s2.3p | 2P*  | 3/2 |   | T7194 | L1113 |
|------------+------------+------+----------+------+--------------------------+-----------------------+-----------------------+------+--------+------+-----+---+-------+-------|

***** STARTED From NIST
      :LOGBOOK:
      - State "STARTED"    from "TODO"       [2013-02-24 Sun 19:00]
      :END:

|----------+------------+-------------+------+------------+------+--------------------------------------------+---------+-------+-----+-----------+-------+-----+---------+------+----------+-------|
| SPECTRUM |   Observed |        Ritz | Rel. |        Aki | Acc. | Ei           Ek                            | Lower   | level |     | Upper     | level |     | gi   gk | Type | TP       | Line  |
|          | Wavelength |  Wavelength | Int. |       s^-1 |      | (eV)         (eV)                          | -----   | ----- |   - | -----     | ----  |   - |         |      | Ref.     | Ref.  |
|          |   Air  (Å) |    Air  (Å) | (?)  |            |      |                                            | Conf.   | Term  |   J | Conf.     | Term  |   J |         |      |          |       |
|----------+------------+-------------+------+------------+------+--------------------------------------------+---------+-------+-----+-----------+-------+-----+---------+------+----------+-------|
| Fe III   |            |     4701.53 |      |    2.7e-01 | D    | 0.05408    -     2.69044                   | 3d6     | 5D    |   3 | 3d6       | 3F2   |   3 | 7 - 7   | M1   | T461     |       |
|----------+------------+-------------+------+------------+------+--------------------------------------------+---------+-------+-----+-----------+-------+-----+---------+------+----------+-------|
| He I     |            | 4713.375674 | 4    | 1.0579e+06 | AAA  | [20.96421789026]    -      [23.5939575977] | 1s.2p   | 3P*   |   0 | 1s.4s     | 3S    |   1 | 1 - 3   |      | T8636c73 | L366  |
| Fe III   |            |     4733.91 |      |    1.0e-01 | D    | 0.09161           -        2.70995         | 3d6     | 5D    |   2 | 3d6       | 3F2   |   2 | 5 - 5   | M1   | T461     |       |
| Ar IV    |    4740.20 |     4740.12 | *    |    5.1e-03 | D    | 0.0000            -        2.61490         | 3s2.3p3 | 4S*   | 3/2 | 3s2.3p3   | 2D*   | 3/2 | 4 - 4   | E2   | T761     | L3452 |
| Ar IV    |    4740.20 |     4740.12 | *    |    7.2e-02 | C    | 0.0000            -        2.61490         | 3s2.3p3 | 4S*   | 3/2 | 3s2.3p3   | 2D*   | 3/2 | 4 - 4   | M1   | T761     | L3452 |
| Fe III   |            |     4754.69 |      |    8.1e-02 | D    | 0.05408           -        2.66097         | 3d6     | 5D    |   3 | 3d6       | 3F2   |   4 | 7 - 9   | M1   | T461     |       |
|----------+------------+-------------+------+------------+------+--------------------------------------------+---------+-------+-----+-----------+-------+-----+---------+------+----------+-------|
| Fe III   |            |     4769.43 |      |    8.7e-02 | D    | 0.09161           -       2.69044          | 3d6     | 5D    |   2 | 3d6       | 3F2   |   3 | 5 - 7   | M1   | T461     |       |
|----------+------------+-------------+------+------------+------+--------------------------------------------+---------+-------+-----+-----------+-------+-----+---------+------+----------+-------|
| N II     |    4895.11 |    4895.117 | 285  |   3.04e+06 | D    | 17.877025         -       20.409132        | 2s.2p3  | 1D*   |   2 | 2s2.2p.3p | 1P    |   1 | 5 - 3   |      | T7333    | L3513 |


***** STARTED From Atomic Line List
      :LOGBOOK:
      - State "STARTED"    from "TODO"       [2013-02-24 Sun 19:00]
      :END:

****** Order 76 (4637 -> 4705)


| LAB WAVL ANG AIR |    DLAM | SPECTRUM | TT | CONFIGURATION | TERM   | J_i | J_k | A_ki | TPF | LEVEL ENERGY |    CM^ 1 | REF     |
|------------------+---------+----------+----+---------------+--------+-----+-----+------+-----+--------------+----------+---------|
|          4701.54 | 1.4E-01 | [Fe III] | M1 |       3d6-3d6 | 5D-3F4 |   3 |   3 |      |     |       436.21 | 21699.90 | 029,ASD |

****** Order 75 (4699 -> 4768)
| LAB WAVL ANG AIR |    DLAM | SPECTRUM | TT | CONFIGURATION   | TERM    | J_i | J_k |     A_ki | TPF | LEVEL ENERGY |     CM^ 1 |     REF |
|------------------+---------+----------+----+-----------------+---------+-----+-----+----------+-----+--------------+-----------+---------|
|       4713.13918 | 1.4E-04 | He I     | E1 | 1s.2p-1s.4s     | 3Po-3S  |   2 |   1 | 5.30E+06 |   3 |    169086.87 | 190298.22 |     005 |
|       4713.15616 | 1.4E-04 | He I     | E1 | 1s.2p-1s.4s     | 3Po-3S  |   1 |   1 | 3.18E+06 |   3 |    169086.95 | 190298.22 |     005 |
|       4713.37569 | 1.4E-04 | He I     | E1 | 1s.2p-1s.4s     | 3Po-3S  |   0 |   1 | 1.06E+06 |   3 |    169087.93 | 190298.22 |     005 |
|          4733.90 | 1.4E-01 | [Fe III] | M1 | 3d6-3d6         | 5D-3F4  |   2 |   2 |          |     |       738.88 |  21857.20 | 029,ASD |
|          4740.17 | 2.0E-01 | [Ar IV]  | M1 | 3s2.3p3-3s2.3p3 | 4So-2Do | 3/2 | 3/2 | 7.20E-02 | ASD |         0.00 |  21090.40 |     058 |
|          4754.69 | 1.4E-01 | [Fe III] | M1 | 3d6-3d6         | 5D-3F4  |   3 |   4 |          |     |       436.21 |  21462.20 | 029,ASD |

****** Order 74 (4762 -> 4833)
| LAB WAVL ANG AIR |    DLAM | SPECTRUM | TT | CONFIGURATION                     | TERM     | J_i | J_k | A_ki | TPF | LEVEL ENERGY |     CM^ 1 | REF     |
|------------------+---------+----------+----+-----------------------------------+----------+-----+-----+------+-----+--------------+-----------+---------|
|          4769.43 | 1.4E-01 | [Fe III] | M1 | 3d6-3d6                           | 5D-3F4   | 2   | 3   |      |     |       738.88 |  21699.90 | 029,ASD |
|           4815.1 | 1.5E+00 | O  I]    | E1 | 2s2.2p3.(2Po).3p-2s2.2p3.(2Po).7d | 3D-1Do   | 3   | 2   |      |     |    127282.63 | 148045.00 | ASD     |
|         4815.151 | 2.1E-02 | Fe II]   | E1 | 3d6.(1F).4p-3d6.(5D).5d           | v2Do-6P  | 5/2 | 3/2 |      |     |     83868.45 | 104630.43 | ASD     |
|        4815.1703 | 2.1E-03 | Fe II]   | E1 | 3d6.(3F4).4p-3d6.(5D).4d          | y4Go-e6G | 9/2 | 7/2 |      |     |     63948.79 |  84710.68 | ASD     |

****** Order 73 (4827 -> 4899)
+ This order is dominated by H beta 4861
+ On the blue side of H beta there is basically nothing
  + Just a hint of something very weak around 4843-4845
  + This may be [Fe II] 4843
+ On the red side of H beta we have:
  + 4867: very weak blend of C II and N III 
  + 4881: middling [Fe III]
  + 4890, 4896: two weak [Fe II] lines
    + 4890 is a doublet (separation 0.1 A = 5 km/s)
    + There are also multiple O II, C II, O III recomb lines on the red side of 4890 and on both sides of 4896, but none are definitely detected

| LAB WAVL ANG AIR |    DLAM | SPECTRUM | TT | CONFIGURATION                     | TERM     | J_i     | J_k     |     A_ki | TPF | LEVEL ENERGY |     CM^ 1 | REF     |
|------------------+---------+----------+----+-----------------------------------+----------+---------+---------+----------+-----+--------------+-----------+---------|
|         4843.524 | 1.5E-02 | [Fe II]  | E2 | 3d6.(5D).4s-3d7                   | a6D-a2D2 | 5/2     | 3/2     |          |     |       667.68 |  21308.04 | ASD     |
|         4861.325 | 2.3E-02 | H   I    | E1 | 2*-4*                             | 2-4      | 1/2-3/2 | 1/2-7/2 | 8.41E+06 |   1 |     82259.11 | 102823.90 | 007     |
|         4867.066 | 2.1E-02 | C   II   | E1 | 2s2.4s-2s.2p.(3Po).3s             | 2S-2Po   | 1/2     | 1/2     | 2.18E+06 |  24 |    157234.07 | 177774.59 | ASD     |
|          4867.12 | 2.1E-01 | N   III  | E1 | 2s.2p.(3Po).3p-2s.2p.(3Po).3d     | 4D-4Fo   | 3/2     | 3/2     | 1.73E+07 |   3 |    309691.80 | 330232.10 | ASD     |
|          4881.00 | 1.5E-01 | [Fe III] | M1 | 3d6-3d6                           | 5D-3H    | 4       | 4       | 4.80E-03 | ASD |         0.00 |  20481.90 | 029,ASD |
|        4889.6165 | 2.1E-03 | [Fe II]  | M1 | 3d6.(5D).4s-3d6.(3P4).4s          | a6D-b4P  | 7/2     | 5/2     |          |     |       384.79 |  20830.58 | ASD     |
|         4889.704 | 1.5E-02 | [Fe II]  | E2 | 3d6.(5D).4s-3d7                   | a6D-a2D2 | 3/2     | 3/2     |          |     |       862.61 |  21308.04 | ASD     |
|         4890.093 | 2.1E-02 | C   II]  | E1 | 2s.2p.(3Po).3p-2s.2p.(3Po).3d     | 4D-2Po   | 5/2     | 3/2     | 6.58E+01 |  24 |    181736.05 | 202179.85 | ASD     |
|         4890.698 | 2.1E-02 | O   II]  | E1 | 2s2.2p2.(3P).4s-2s2.2p2.(3P).5p   | 2P-4Do   | 3/2     | 3/2     |          |     |    240517.35 | 260958.62 | ASD     |
|        4890.8559 | 2.1E-03 | O   II   | E1 | 2s2.2p2.(3P).3p-2s2.2p2.(3P).3d   | 4So-4P   | 3/2     | 1/2     | 4.73E+07 |  15 |    212161.88 | 232602.49 | ASD     |
|         4890.859 | 2.1E-02 | O   III  | E1 | 2s2.2p.(2Po).3d-2s.2p2.(4P).3s    | 3Po-3P   | 1       | 0       | 2.34E+06 |   3 |    329583.89 | 350024.49 | 039     |
|          4895.13 | 1.5E-01 | O   II   | E1 | 2s2.2p2.(1D).4p-2s2.2p2.(1D).6s   | 2Do-2D   | 3/2     | 5/2     |          |     |    266624.32 | 287047.10 | ASD     |
|          4895.49 | 1.5E-01 | O   II   | E1 | 2s2.2p2.(1D).4p-2s2.2p2.(1D).6s   | 2Do-2D   | 3/2     | 3/2     |          |     |    266624.32 | 287045.60 | ASD     |
|         4895.558 | 1.5E-02 | [Fe II]  | E2 | 3d6.(5D).4s-3d7                   | a6D-a2H  | 7/2     | 9/2     |          |     |       384.79 |  20805.77 | ASD     |
|         4895.577 | 2.1E-02 | O   II   | E1 | 2s2.2p2.(3P).4d-2s2.2p2.(1D).4f.P | 2D-P[1]o | 3/2     | 1/2     |          |     |    255842.91 | 276263.81 | ASD     |
|         4895.577 | 2.1E-02 | O   II   | E1 | 2s2.2p2.(3P).4d-2s2.2p2.(1D).4f.P | 2D-P[1]o | 3/2     | 3/2     |          |     |    255842.91 | 276263.81 | ASD     |

****** Order 72 (4895 -> 4965)
+ This order is dominated by:
  + 4922: He I
  + 4959: [O III]
+ Other lines blue of He I
  + 4905: another weak [Fe II] line
+ In between He I and [O III]
  + 4925, 4930: extremely weak [Fe III]
  + 4931: weak [O III] (same upper level as 4959, 5007)
  + 4947: extremely weak [Fe II]
+ Other [Fe II] line predicted at 4958 on flank of [O III] but not seen

| LAB WAVL ANG AIR |    DLAM | SPECTRUM | TT | CONFIGURATION            | TERM    | J_i | J_k |     A_ki | TPF | LEVEL ENERGY |     CM^ 1 | REF     |
|------------------+---------+----------+----+--------------------------+---------+-----+-----+----------+-----+--------------+-----------+---------|
|        4905.3391 | 2.1E-03 | [Fe II]  | E2 | 3d7-3d6.(3F4).4s         | a4F-b4F | 7/2 | 7/2 |          |     |      2430.10 |  22810.36 | ASD     |
|       4921.93096 | 2.2E-04 | He  I    | E1 | 1s.2p-1s.4d              | 1Po-1D  |   1 |   2 | 1.99E+07 |   3 |    171135.00 | 191446.56 | 005     |
|          4924.54 | 1.5E-01 | [Fe III] | M1 | 3d6-3d6                  | 5D-3H   |   4 |   5 |          |     |         0.00 |  20300.80 | 029,ASD |
|          4930.54 | 2.2E-01 | [Fe III] | M1 | 3d6-3d6                  | 5D-3P4  |   1 |   0 |          |     |       932.40 |  21208.50 | ASD     |
|         4931.227 | 1.5E-02 | [O  III] | E2 | 2s2.2p2-2s2.2p2          | 3P-1D   |   0 |   2 | 2.32E-06 |  12 |         0.00 |  20273.27 | 039     |
|        4947.3729 | 2.2E-03 | [Fe II]  | E2 | 3d7-3d6.(3F4).4s         | a4F-b4F | 7/2 | 9/2 |          |     |      2430.10 |  22637.21 | ASD     |
|        4958.2206 | 2.2E-03 | [Fe II]  | M1 | 3d6.(5D).4s-3d6.(3P4).4s | a6D-b4P | 5/2 | 5/2 |          |     |       667.68 |  20830.58 | ASD     |
|         4958.911 | 1.6E-02 | [O  III] | M1 | 2s2.2p2-2s2.2p2          | 3P-1D   |   1 |   2 | 6.95E-03 |  12 |       113.18 |  20273.27 | 039     |

****** Order 71 (4963 -> 5037)

+ This order is dominated by [O III] 5007
+ Weak lines on blue side:
  + 4980: O I
  + 4986: [Fe III]
    + blended with sky?
  + 4987: [Fe III]
    + blended with N II?
  + 4995, 5001: extremely weak N II
  + 5005: [Fe II] weak
    + on blue flank of [O III] line
    + there is another [Fe II] at 5007, totally blended with [O III]
+ On red side
  + 5010: [Fe II] extremely weak 
  + 5011: [Fe III] weak
  + 5016: He I
  + 5032: [Fe III] extremely weak

| LAB WAVL ANG AIR |    DLAM | SPECTRUM | TT | CONFIGURATION                      | TERM     | J_i |  J_k |     A_ki | TPF | LEVEL ENERGY |     CM^ 1 | REF     |
|------------------+---------+----------+----+------------------------------------+----------+-----+------+----------+-----+--------------+-----------+---------|
|          4979.95 | 1.6E-01 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).11s | 3P-3So   |   1 |    1 | 1.17E+05 |   3 |     88630.59 | 108705.50 | ASD     |
|          4980.09 | 1.6E-01 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).11s | 3P-3So   |   2 |    1 | 1.96E+05 |   3 |     88631.15 | 108705.50 | ASD     |
|          4980.13 | 1.6E-01 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).11s | 3P-3So   |   0 |    1 | 3.91E+04 |   3 |     88631.30 | 108705.50 | ASD     |
|          4985.87 | 1.6E-01 | [Fe III] | E2 | 3d6-3d6                            | 5D-3H    |   4 |    6 |          |     |         0.00 |  20051.10 | 029,ASD |
|          4987.21 | 1.6E-01 | [Fe III] | M1 | 3d6-3d6                            | 5D-3H    |   3 |    4 |          |     |       436.21 |  20481.90 | 029,ASD |
|         4987.376 | 2.2E-02 | N II     | E1 | 2s2.2p.(2Po).3p-2s2.2p.(2Po).3d    | 3S-3Po   |   1 |    0 | 6.98E+07 |  12 |    168892.01 | 188937.04 | 030     |
|         4994.353 | 2.2E-02 | N II     | E1 | 2s2.2p.(2Po).4p-2s2.2p.(2Po).6s    | 3D-3Po   |   3 |    2 | 1.16E+07 |   3 |    202861.16 | 222878.19 | 030     |
|         4994.360 | 2.2E-02 | N II     | E1 | 2s.2p2.(4P).3s-2s.2p2.(4P).3p      | 5P-5Po   |   2 |    3 | 2.62E+07 |   3 |    205652.72 | 225669.72 | 030     |
|         4994.370 | 2.2E-02 | N II     | E1 | 2s2.2p.(2Po).3p-2s2.2p.(2Po).3d    | 3S-3Po   |   1 |    1 | 7.11E+07 |  12 |    168892.01 | 188908.97 | 030     |
|          4994.90 | 1.6E-01 | N II]    | E1 | 2s2.2p.(2Po).10s-2s.2p2.(4P).4s    | 1Po-5P   |   1 |    2 |          |     |    233820.80 | 253835.62 | 030     |
|         5000.851 | 2.2E-02 | N II     | E1 | 2s2.2p.(2Po).4p-2s2.2p.(2Po).6s    | 3D-3Po   |   1 |    0 | 1.38E+07 |   3 |    202713.92 | 222704.94 | 030     |
|         5001.134 | 2.2E-02 | N II     | E1 | 2s2.2p.(2Po).3p-2s2.2p.(2Po).3d    | 3D-3Fo   |   1 |    2 | 9.64E+07 |  12 |    166521.49 | 186511.38 | 030     |
|         5001.474 | 2.2E-02 | N II     | E1 | 2s2.2p.(2Po).3p-2s2.2p.(2Po).3d    | 3D-3Fo   |   2 |    3 | 1.04E+08 |  12 |    166582.25 | 186570.78 | 030     |
|          5001.62 | 1.6E-01 | N II]    | E1 | 2s.2p2.(4P).4f-2s.2p2.(2D).3d      | 5Go-3D   |   4 |    3 |          |     |    268376.85 | 288364.80 | 030     |
|        5005.5115 | 2.2E-03 | [Fe II]  | E2 | 3d7-3d6.(3F4).4s                   | a4F-b4F  | 5/2 |  7/2 |          |     |      2837.95 |  22810.36 | ASD     |
|        5006.6241 | 2.2E-03 | [Fe II]  | M1 | 3d6.(5D).4s-3d6.(3P4).4s           | a6D-b4P  | 3/2 |  5/2 |          |     |       862.61 |  20830.58 | ASD     |
|         5006.843 | 1.6E-02 | [O III]  | M1 | 2s2.2p2-2s2.2p2                    | 3P-1D    |   2 |    2 | 2.03E-02 |  12 |       306.17 |  20273.27 | 039     |
|         5009.750 | 1.6E-02 | [Fe II]  | E2 | 3d6.(5D).4s-3d7                    | a6D-a2H  | 7/2 | 11/2 |          |     |       384.79 |  20340.30 | ASD     |
|          5011.25 | 1.6E-01 | [Fe III] | M1 | 3d6-3d6                            | 5D-3P4   |   2 |    1 |          |     |       738.88 |  20688.40 | 029,ASD |
|        5015.6776 | 1.6E-03 | He I     | E1 | 1s.2s-1s.3p                        | 1S-1Po   |   0 |    1 | 1.43E+07 |   3 |    166277.54 | 186209.47 | 005     |
|          5032.68 | 1.6E-01 | [Fe III] | E2 | 3d6-3d6                            | 5D-3H    |   3 |    5 |          |     |       436.21 |  20300.80 | 029,ASD |
|        5035.4837 | 2.3E-03 | [Fe II]  | E2 | 3d6.(5D).4s-3d6.(3P4).4s           | a6D-b4P  | 1/2 |  5/2 |          |     |       977.05 |  20830.58 | ASD     |
|        5036.5624 | 2.3E-03 | [Fe II]  | E2 | 3d6.(5D).4s-3d7                    | a6D-a2D2 | 5/2 |  5/2 |          |     |       667.68 |  20516.96 | ASD     |

****** Order 70 (5034 -> 5109)

+ Weak lines only 
+ 5035: [Fe II] not seen
+ 5041: Si II
+ 5048: He I looks double
  + Is it a doublet?
  + Or is it blended with N II or Si II?
+ 5056: Si II is supposedly doublet
+ 5085: [Fe III] extremely weak
  + other [Fe II] and [Fe III] lines not seen 

| LAB WAVL ANG AIR |    DLAM | SPECTRUM | TT | CONFIGURATION                     | TERM     | J_i | J_k |     A_ki | TPF | LEVEL ENERGY |     CM^ 1 | REF |
|------------------+---------+----------+----+-----------------------------------+----------+-----+-----+----------+-----+--------------+-----------+-----|
|        5035.4837 | 2.3E-03 | [Fe II]  | E2 | 3d6.(5D).4s-3d6.(3P4).4s          | a6D-b4P  | 1/2 | 5/2 |          |     |       977.05 |  20830.58 | ASD |
|        5036.5624 | 2.3E-03 | [Fe II]  | E2 | 3d6.(5D).4s-3d7                   | a6D-a2D2 | 5/2 | 5/2 |          |     |       667.68 |  20516.96 | ASD |
|        5039.0826 | 2.3E-03 | [Fe II]  | E2 | 3d7-3d6.(3H).4s                   | a4F-a4H  | 9/2 | 7/2 |          |     |      1872.57 |  21711.92 | ASD |
|         5041.024 | 2.3E-02 | Si II    | E1 | 3s2.4p-3s2.4d                     | 2Po-2D   | 1/2 | 3/2 | 1.18E+08 |   3 |     81191.34 | 101023.05 | ASD |
|          5047.39 | 2.3E-01 | N II]    | E1 | 2s.2p2.(2D).3p-2s.2p2.(4P).8d     | 1Fo-5P   | 3   | 3   |          |     |    269239.60 | 289046.30 | 030 |
|        5047.7384 | 1.6E-03 | He I     | E1 | 1s.2p-1s.4s                       | 1Po-1S   | 1   | 0   | 6.57E+06 |   3 |    171135.00 | 190940.33 | 005 |
|         5049.339 | 2.3E-02 | Si II]   | E1 | 3s.3p.(3Po).3d-3s.3p.(3Po).4p     | 4Fo-4P   | 7/2 | 5/2 |          |     |    114414.58 | 134213.63 | ASD |
|         5049.51? | 1.6E-01 | O II     | E1 | 2s2.2p2.(3P).4f.D-2s2.2p2.(1D).4d | D[2]o-2P | 3/2 | 3/2 |          |     |    255812.73 | 275611.1? | ASD |
|         5049.70? | 1.6E-01 | O II     | E1 | 2s2.2p2.(3P).4f.D-2s2.2p2.(1D).4d | D[2]o-2P | 5/2 | 3/2 |          |     |    255813.47 | 275611.1? | ASD |
|         5055.984 | 2.3E-02 | Si II    | E1 | 3s2.4p-3s2.4d                     | 2Po-2D   | 3/2 | 5/2 | 1.40E+08 |   3 |     81251.32 | 101024.35 | ASD |
|         5056.317 | 2.3E-02 | Si II    | E1 | 3s2.4p-3s2.4d                     | 2Po-2D   | 3/2 | 3/2 | 2.33E+07 |   3 |     81251.32 | 101023.05 | ASD |
|        5083.7304 | 2.3E-03 | [Fe II]  | M1 | 3d6.(5D).4s-3d6.(3F4).4s          | a4D-a2F  | 7/2 | 5/2 |          |     |      7955.30 |  27620.41 | ASD |
|          5084.77 | 2.3E-01 | [Fe III] | M1 | 3d6-3d6                           | 5D-3P4   | 0   | 1   |          |     |      1027.30 |  20688.40 | ASD |
|        5086.5152 | 2.3E-03 | [Fe II]  | E2 | 3d6.(5D).4s-3d7                   | a6D-a2D2 | 3/2 | 5/2 |          |     |       862.61 |  20516.96 | ASD |


****** All Orders

| LAB WAVL ANG AIR |    DLAM | SPECTRUM | TT | CONFIGURATION                      | TERM     |     J_i |     J_k |     A_ki | TPF | LEVEL ENERGY |     CM^ 1 | REF     |
|------------------+---------+----------+----+------------------------------------+----------+---------+---------+----------+-----+--------------+-----------+---------|
|          4701.54 | 1.4E-01 | [Fe III] | M1 | 3d6-3d6                            | 5D-3F4   |       3 |       3 |          |     |       436.21 |  21699.90 | 029,ASD |
|------------------+---------+----------+----+------------------------------------+----------+---------+---------+----------+-----+--------------+-----------+---------|
|       4713.13918 | 1.4E-04 | He I     | E1 | 1s.2p-1s.4s                        | 3Po-3S   |       2 |       1 | 5.30E+06 |   3 |    169086.87 | 190298.22 | 005     |
|       4713.15616 | 1.4E-04 | He I     | E1 | 1s.2p-1s.4s                        | 3Po-3S   |       1 |       1 | 3.18E+06 |   3 |    169086.95 | 190298.22 | 005     |
|       4713.37569 | 1.4E-04 | He I     | E1 | 1s.2p-1s.4s                        | 3Po-3S   |       0 |       1 | 1.06E+06 |   3 |    169087.93 | 190298.22 | 005     |
|          4733.90 | 1.4E-01 | [Fe III] | M1 | 3d6-3d6                            | 5D-3F4   |       2 |       2 |          |     |       738.88 |  21857.20 | 029,ASD |
|          4740.17 | 2.0E-01 | [Ar IV]  | M1 | 3s2.3p3-3s2.3p3                    | 4So-2Do  |     3/2 |     3/2 | 7.20E-02 | ASD |         0.00 |  21090.40 | 058     |
|          4754.69 | 1.4E-01 | [Fe III] | M1 | 3d6-3d6                            | 5D-3F4   |       3 |       4 |          |     |       436.21 |  21462.20 | 029,ASD |
|------------------+---------+----------+----+------------------------------------+----------+---------+---------+----------+-----+--------------+-----------+---------|
|          4769.43 | 1.4E-01 | [Fe III] | M1 | 3d6-3d6                            | 5D-3F4   |       2 |       3 |          |     |       738.88 |  21699.90 | 029,ASD |
|           4815.1 | 1.5E+00 | O  I]    | E1 | 2s2.2p3.(2Po).3p-2s2.2p3.(2Po).7d  | 3D-1Do   |       3 |       2 |          |     |    127282.63 | 148045.00 | ASD     |
|         4815.151 | 2.1E-02 | Fe II]   | E1 | 3d6.(1F).4p-3d6.(5D).5d            | v2Do-6P  |     5/2 |     3/2 |          |     |     83868.45 | 104630.43 | ASD     |
|        4815.1703 | 2.1E-03 | Fe II]   | E1 | 3d6.(3F4).4p-3d6.(5D).4d           | y4Go-e6G |     9/2 |     7/2 |          |     |     63948.79 |  84710.68 | ASD     |
|------------------+---------+----------+----+------------------------------------+----------+---------+---------+----------+-----+--------------+-----------+---------|
|         4843.524 | 1.5E-02 | [Fe II]  | E2 | 3d6.(5D).4s-3d7                    | a6D-a2D2 |     5/2 |     3/2 |          |     |       667.68 |  21308.04 | ASD     |
|         4861.325 | 2.3E-02 | H   I    | E1 | 2*-4*                              | 2-4      | 1/2-3/2 | 1/2-7/2 | 8.41E+06 |   1 |     82259.11 | 102823.90 | 007     |
|         4867.066 | 2.1E-02 | C   II   | E1 | 2s2.4s-2s.2p.(3Po).3s              | 2S-2Po   |     1/2 |     1/2 | 2.18E+06 |  24 |    157234.07 | 177774.59 | ASD     |
|          4867.12 | 2.1E-01 | N   III  | E1 | 2s.2p.(3Po).3p-2s.2p.(3Po).3d      | 4D-4Fo   |     3/2 |     3/2 | 1.73E+07 |   3 |    309691.80 | 330232.10 | ASD     |
|          4881.00 | 1.5E-01 | [Fe III] | M1 | 3d6-3d6                            | 5D-3H    |       4 |       4 | 4.80E-03 | ASD |         0.00 |  20481.90 | 029,ASD |
|        4889.6165 | 2.1E-03 | [Fe II]  | M1 | 3d6.(5D).4s-3d6.(3P4).4s           | a6D-b4P  |     7/2 |     5/2 |          |     |       384.79 |  20830.58 | ASD     |
|         4889.704 | 1.5E-02 | [Fe II]  | E2 | 3d6.(5D).4s-3d7                    | a6D-a2D2 |     3/2 |     3/2 |          |     |       862.61 |  21308.04 | ASD     |
|         4890.093 | 2.1E-02 | C   II]  | E1 | 2s.2p.(3Po).3p-2s.2p.(3Po).3d      | 4D-2Po   |     5/2 |     3/2 | 6.58E+01 |  24 |    181736.05 | 202179.85 | ASD     |
|         4890.698 | 2.1E-02 | O   II]  | E1 | 2s2.2p2.(3P).4s-2s2.2p2.(3P).5p    | 2P-4Do   |     3/2 |     3/2 |          |     |    240517.35 | 260958.62 | ASD     |
|        4890.8559 | 2.1E-03 | O   II   | E1 | 2s2.2p2.(3P).3p-2s2.2p2.(3P).3d    | 4So-4P   |     3/2 |     1/2 | 4.73E+07 |  15 |    212161.88 | 232602.49 | ASD     |
|         4890.859 | 2.1E-02 | O   III  | E1 | 2s2.2p.(2Po).3d-2s.2p2.(4P).3s     | 3Po-3P   |       1 |       0 | 2.34E+06 |   3 |    329583.89 | 350024.49 | 039     |
|          4895.13 | 1.5E-01 | O   II   | E1 | 2s2.2p2.(1D).4p-2s2.2p2.(1D).6s    | 2Do-2D   |     3/2 |     5/2 |          |     |    266624.32 | 287047.10 | ASD     |
|          4895.49 | 1.5E-01 | O   II   | E1 | 2s2.2p2.(1D).4p-2s2.2p2.(1D).6s    | 2Do-2D   |     3/2 |     3/2 |          |     |    266624.32 | 287045.60 | ASD     |
|         4895.558 | 1.5E-02 | [Fe II]  | E2 | 3d6.(5D).4s-3d7                    | a6D-a2H  |     7/2 |     9/2 |          |     |       384.79 |  20805.77 | ASD     |
|         4895.577 | 2.1E-02 | O   II   | E1 | 2s2.2p2.(3P).4d-2s2.2p2.(1D).4f.P  | 2D-P[1]o |     3/2 |     1/2 |          |     |    255842.91 | 276263.81 | ASD     |
|         4895.577 | 2.1E-02 | O   II   | E1 | 2s2.2p2.(3P).4d-2s2.2p2.(1D).4f.P  | 2D-P[1]o |     3/2 |     3/2 |          |     |    255842.91 | 276263.81 | ASD     |
|------------------+---------+----------+----+------------------------------------+----------+---------+---------+----------+-----+--------------+-----------+---------|
|        4905.3391 | 2.1E-03 | [Fe II]  | E2 | 3d7-3d6.(3F4).4s                   | a4F-b4F  |     7/2 |     7/2 |          |     |      2430.10 |  22810.36 | ASD     |
|       4921.93096 | 2.2E-04 | He  I    | E1 | 1s.2p-1s.4d                        | 1Po-1D   |       1 |       2 | 1.99E+07 |   3 |    171135.00 | 191446.56 | 005     |
|          4924.54 | 1.5E-01 | [Fe III] | M1 | 3d6-3d6                            | 5D-3H    |       4 |       5 |          |     |         0.00 |  20300.80 | 029,ASD |
|          4930.54 | 2.2E-01 | [Fe III] | M1 | 3d6-3d6                            | 5D-3P4   |       1 |       0 |          |     |       932.40 |  21208.50 | ASD     |
|         4931.227 | 1.5E-02 | [O  III] | E2 | 2s2.2p2-2s2.2p2                    | 3P-1D    |       0 |       2 | 2.32E-06 |  12 |         0.00 |  20273.27 | 039     |
|        4947.3729 | 2.2E-03 | [Fe II]  | E2 | 3d7-3d6.(3F4).4s                   | a4F-b4F  |     7/2 |     9/2 |          |     |      2430.10 |  22637.21 | ASD     |
|        4958.2206 | 2.2E-03 | [Fe II]  | M1 | 3d6.(5D).4s-3d6.(3P4).4s           | a6D-b4P  |     5/2 |     5/2 |          |     |       667.68 |  20830.58 | ASD     |
|         4958.911 | 1.6E-02 | [O  III] | M1 | 2s2.2p2-2s2.2p2                    | 3P-1D    |       1 |       2 | 6.95E-03 |  12 |       113.18 |  20273.27 | 039     |
|------------------+---------+----------+----+------------------------------------+----------+---------+---------+----------+-----+--------------+-----------+---------|
|          4979.95 | 1.6E-01 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).11s | 3P-3So   |       1 |       1 | 1.17E+05 |   3 |     88630.59 | 108705.50 | ASD     |
|          4980.09 | 1.6E-01 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).11s | 3P-3So   |       2 |       1 | 1.96E+05 |   3 |     88631.15 | 108705.50 | ASD     |
|          4980.13 | 1.6E-01 | O I      | E1 | 2s2.2p3.(4So).3p-2s2.2p3.(4So).11s | 3P-3So   |       0 |       1 | 3.91E+04 |   3 |     88631.30 | 108705.50 | ASD     |
|          4985.87 | 1.6E-01 | [Fe III] | E2 | 3d6-3d6                            | 5D-3H    |       4 |       6 |          |     |         0.00 |  20051.10 | 029,ASD |
|          4987.21 | 1.6E-01 | [Fe III] | M1 | 3d6-3d6                            | 5D-3H    |       3 |       4 |          |     |       436.21 |  20481.90 | 029,ASD |
|         4987.376 | 2.2E-02 | N II     | E1 | 2s2.2p.(2Po).3p-2s2.2p.(2Po).3d    | 3S-3Po   |       1 |       0 | 6.98E+07 |  12 |    168892.01 | 188937.04 | 030     |
|         4994.353 | 2.2E-02 | N II     | E1 | 2s2.2p.(2Po).4p-2s2.2p.(2Po).6s    | 3D-3Po   |       3 |       2 | 1.16E+07 |   3 |    202861.16 | 222878.19 | 030     |
|         4994.360 | 2.2E-02 | N II     | E1 | 2s.2p2.(4P).3s-2s.2p2.(4P).3p      | 5P-5Po   |       2 |       3 | 2.62E+07 |   3 |    205652.72 | 225669.72 | 030     |
|         4994.370 | 2.2E-02 | N II     | E1 | 2s2.2p.(2Po).3p-2s2.2p.(2Po).3d    | 3S-3Po   |       1 |       1 | 7.11E+07 |  12 |    168892.01 | 188908.97 | 030     |
|          4994.90 | 1.6E-01 | N II]    | E1 | 2s2.2p.(2Po).10s-2s.2p2.(4P).4s    | 1Po-5P   |       1 |       2 |          |     |    233820.80 | 253835.62 | 030     |
|         5000.851 | 2.2E-02 | N II     | E1 | 2s2.2p.(2Po).4p-2s2.2p.(2Po).6s    | 3D-3Po   |       1 |       0 | 1.38E+07 |   3 |    202713.92 | 222704.94 | 030     |
|         5001.134 | 2.2E-02 | N II     | E1 | 2s2.2p.(2Po).3p-2s2.2p.(2Po).3d    | 3D-3Fo   |       1 |       2 | 9.64E+07 |  12 |    166521.49 | 186511.38 | 030     |
|         5001.474 | 2.2E-02 | N II     | E1 | 2s2.2p.(2Po).3p-2s2.2p.(2Po).3d    | 3D-3Fo   |       2 |       3 | 1.04E+08 |  12 |    166582.25 | 186570.78 | 030     |
|          5001.62 | 1.6E-01 | N II]    | E1 | 2s.2p2.(4P).4f-2s.2p2.(2D).3d      | 5Go-3D   |       4 |       3 |          |     |    268376.85 | 288364.80 | 030     |
|        5005.5115 | 2.2E-03 | [Fe II]  | E2 | 3d7-3d6.(3F4).4s                   | a4F-b4F  |     5/2 |     7/2 |          |     |      2837.95 |  22810.36 | ASD     |
|        5006.6241 | 2.2E-03 | [Fe II]  | M1 | 3d6.(5D).4s-3d6.(3P4).4s           | a6D-b4P  |     3/2 |     5/2 |          |     |       862.61 |  20830.58 | ASD     |
|         5006.843 | 1.6E-02 | [O III]  | M1 | 2s2.2p2-2s2.2p2                    | 3P-1D    |       2 |       2 | 2.03E-02 |  12 |       306.17 |  20273.27 | 039     |
|         5009.750 | 1.6E-02 | [Fe II]  | E2 | 3d6.(5D).4s-3d7                    | a6D-a2H  |     7/2 |    11/2 |          |     |       384.79 |  20340.30 | ASD     |
|          5011.25 | 1.6E-01 | [Fe III] | M1 | 3d6-3d6                            | 5D-3P4   |       2 |       1 |          |     |       738.88 |  20688.40 | 029,ASD |
|        5015.6776 | 1.6E-03 | He I     | E1 | 1s.2s-1s.3p                        | 1S-1Po   |       0 |       1 | 1.43E+07 |   3 |    166277.54 | 186209.47 | 005     |
|          5032.68 | 1.6E-01 | [Fe III] | E2 | 3d6-3d6                            | 5D-3H    |       3 |       5 |          |     |       436.21 |  20300.80 | 029,ASD |
|        5035.4837 | 2.3E-03 | [Fe II]  | E2 | 3d6.(5D).4s-3d6.(3P4).4s           | a6D-b4P  |     1/2 |     5/2 |          |     |       977.05 |  20830.58 | ASD     |
|        5036.5624 | 2.3E-03 | [Fe II]  | E2 | 3d6.(5D).4s-3d7                    | a6D-a2D2 |     5/2 |     5/2 |          |     |       667.68 |  20516.96 | ASD     |


**** Rest wavelengths of observed lines

| Ion                | lambda | Type     | Order |
|--------------------+--------+----------+-------|
| [Fe III]           |   4702 | C        |    76 |
|--------------------+--------+----------+-------|
| He I               |   4713 | R        |    75 |
| [Fe III]           |   4734 | C        |    75 |
| [Ar IV]            |   4740 | C        |    75 |
| [Fe III]           |   4755 | C        |    75 |
|--------------------+--------+----------+-------|
| [Fe III]           |   4769 |          |    74 |
| [Fe II]            |   4814 | C        |    74 |
|--------------------+--------+----------+-------|
| H I                |   4861 | R        |    73 |
| N III + C II       |   4867 | RR       |    73 |
| [Fe III]           |   4881 | C        |    73 |
| [Fe II]            |   4890 |          |    73 |
| [Fe II]            |   4895 | C        |    73 |
|--------------------+--------+----------+-------|
| [Fe II]            |   4905 |          |    72 |
| He I               |   4922 | R        |    72 |
| O II + [Fe III]    |   4924 | RC       |    72 |
| [Fe III]           |   4930 | C        |    72 |
| [O III]            |   4931 | C        |    72 |
| ?                  |   4948 |          |    72 |
| Artefact           |   4958 |          |    72 |
| [O III]            |   4959 | C        |    72 |
|--------------------+--------+----------+-------|
| O I                |   4980 |          |    71 |
| ?                  |   4983 |          |    71 |
| [Fe III]           |   4985 | C        |    71 |
| ?                  |   4986 | sky?     |    71 |
| [Fe III] + N II    |   4987 | CRF?     |    71 |
| N II               |   4995 | RF?      |    71 |
| N II               |   5001 | R        |    71 |
| [O III]            |   5007 | C        |    71 |
| ? [Cr III]         |   5010 | C        |    71 |
| [Fe III]           |   5011 | C        |    71 |
| He I               |   5016 | R        |    71 |
| [Fe III]           |   5032 |          |    71 |
| ?                  |   5033 | O?       |    71 |
|--------------------+--------+----------+-------|
| [Fe II]            |   5036 |          |    70 |
| Si II              |   5041 | RF       |    70 |
| O II               |   5042 | R        |    70 |
| N II               |   5045 | R        |    70 |
| He I               |   5048 | R        |    70 |
| Si II              |   5056 | RF       |    70 |
| [Fe III]           |   5085 | C        |    70 |
|                    |   5090 |          |    70 |
| ?                  |   5105 | sky ?    |    70 |
|--------------------+--------+----------+-------|
| [Fe II]            |   5112 |          |    69 |
| C II               |   5121 | R        |    69 |
| ? Ca I ?           |   5132 |          |    69 |
| Co I               |   5147 | F        |    69 |
| [Fe II]            |   5159 | C        |    69 |
| Fe II              |   5169 | F        |    69 |
|--------------------+--------+----------+-------|
| [Ar III]           |   5192 | C        |    68 |
| [N I]              |   5198 | F        |    68 |
| [N I]              |   5200 | F        |    68 |
| ?                  |   5251 | O?       |    68 |
|--------------------+--------+----------+-------|
| [Fe II]            |   5262 | C        |    67 |
| [Fe III]           |   5271 | C        |    67 |
| [Fe II]            |   5273 | C        |    67 |
| O I                |   5275 | F        |    67 |
| O I                |   5299 | F        |    67 |
| [Fe II]            |   5334 | C        |    67 |
|--------------------+--------+----------+-------|
| C II               |   5342 |          |    66 |
| [Fe II]            |   5377 | ? Disk   |    66 |
| [Fe III]           |   5412 | C        |    66 |
|--------------------+--------+----------+-------|
| ? S II + [Fe II] ? |   5433 |          |    65 |
| S II               |   5454 |          |    65 |
| N II               |   5495 | R        |    65 |
|--------------------+--------+----------+-------|
| O I                |   5513 | F        |    64 |
| [Cl III]           |   5518 | C        |    64 |
| ? N I ?            |   5519 |          |    64 |
| ? [Fe II] ?        |   5527 | ? Disk   |    64 |
| N II + C II        |   5535 |          |    64 |
| [Cl III]           |   5538 | C        |    64 |
| N II               |   5552 | F?       |    64 |
| O I                |   5555 | F        |    64 |
| [Fe II]            |   5556 | FC?      |    64 |
| [O I]              |   5578 | D        |    64 |
|--------------------+--------+----------+-------|
| N II               |   5667 | RF?      |    63 |
| N II               |   5676 | RF?      |    63 |
|--------------------+--------+----------+-------|
| N II               |   5686 | RF?      |    62 |
| N II               |   5711 | RF?      |    62 |
| ? [Cr III]         |   5714 | C        |    62 |
| Si III             |   5740 | R?       |    62 |
| [Fe II]            |   5747 |          |    62 |
| [N II]             |   5755 | A        |    62 |
|--------------------+--------+----------+-------|
| ? Co I, C I ?      |   5821 |          |    61 |
|--------------------+--------+----------+-------|
| He I               |   5876 | R        |    60 |
| ?                  |   5888 | sky?     |    60 |
| Sky                |   5890 |          |    60 |
| C II               |   5891 | R        |    60 |
| Sky                |   5896 |          |    60 |
| ? Si I ?           |   5906 |          |    60 |
| N II               |   5928 | R        |    60 |
| N II               |   5932 | R        |    60 |
| ? [Co II] ?        |   5933 | A?       |    60 |
| ? C II ?           |   5940 |          |    60 |
| N II               |   5942 |          |    60 |
| N II               |   5952 | R        |    60 |
| ? Fe II, Cu I ?    |   5953 | ?        |    60 |
| Si II              |   5958 | RF       |    60 |
| O I                |   5959 | F        |    60 |
|--------------------+--------+----------+-------|
| Si II              |   5979 | RF       |    59 |
| ? [Cr III] ?       |   5987 |          |    59 |
| [Ni III]           |   6000 | C        |    59 |
| O I                |   6047 | F        |    59 |
|--------------------+--------+----------+-------|
| Ne I               |   6143 | R        |    58 |
| C II               |   6151 | R        |    58 |
|--------------------+--------+----------+-------|
| ?                  |   6236 |          |    57 |
| Sky                |   6258 | sky?     |    57 |
| ? C II ?           |   6259 |          |    57 |
|--------------------+--------+----------+-------|
| [O I]              |   6300 | CD       |    56 |
| sky?               |   6307 | sky      |    56 |
| [S III]            |   6312 | C        |    56 |
| ??                 |   6321 |          |    56 |
| ? Ca I ?           |   6329 | ? sky?   |    56 |
| Si II              |   6347 | RF       |    56 |
| [O I]              |   6364 | CD       |    56 |
| [Ni II]            |   6365 | CF? sky? |    56 |
| Si II              |   6371 | RF       |    56 |
|--------------------+--------+----------+-------|
| C II               |   6462 | R        |    55 |
| sky?               |   6466 | real     |    55 |
| sky?               |   6471 |          |    55 |
| ??                 |   6482 |          |    55 |
| ??                 |   6490 |          |    55 |
| sky?               |   6498 |          |    55 |
|--------------------+--------+----------+-------|
| [N II]             |   6527 | C        |    54 |
| ?                  |   6533 | ?        |    54 |
| [Ni III]           |   6534 | C        |    54 |
| [N II]             |   6548 | C        |    54 |
| [Cr II]            |   6553 | C        |    54 |
| O II               |   6556 | R        |    54 |
| H I                |   6563 | R        |    54 |
| O II               |   6576 | R        |    54 |
| C II               |   6578 | R        |    54 |
| [N II]             |   6584 | C        |    54 |
| ?                  |   6605 |          |    54 |
| ?                  |   6609 |          |    54 |
|--------------------+--------+----------+-------|
| [Ni II]            |   6667 | C        |    53 |
| He I               |   6678 | R        |    53 |
| [Ni III]           |   6682 | C        |    53 |
| [S II]             |   6716 | C        |    53 |
| O II               |   6721 | R        |    53 |
| [S II]             |   6731 | C        |    53 |
| C II               |   6734 | R        |    53 |
| [Cr II]            |   6737 | C?F?     |    53 |
| ?                  |   6738 |          |    53 |
| [Fe IV]            |   6740 | C        |    53 |
|--------------------+--------+----------+-------|
| C II               |   6780 | R        |    52 |
| O II               |   6786 | R        |    52 |
| [Ni II]            |   6791 |          |    52 |
| Artefact           |   6806 | O        |    52 |
| ?                  |   6807 | O?       |    52 |
| [Ni II]            |   6814 | C? sky?  |    52 |
| ?C I/He I?         |   6827 | ? sky?   |    52 |
| [Fe II]            |   6828 | C        |    52 |
| Si II              |   6829 | RF       |    52 |
| sky                |   6834 | sky      |    52 |
| He I               |   6856 | R        |    52 |
|                    |   6861 |          |    52 |
| sky                | 6863/4 | sky      |    52 |
|--------------------+--------+----------+-------|
| O II               |   6910 | R        |    51 |
| ? [Cr IV] ?        |   6916 | C        |    51 |
| He I               |   6934 | R        |    51 |
| ?                  |   6939 | sky      |    51 |
| ?                  |   6949 | sky      |    51 |
| Artefact?          |   6968 | O?       |    51 |
| [Mn II]?           |   6978 | Sky      |    51 |
| He I + ?           |   6989 | R O?     |    51 |
| O I                |   7002 | F        |    51 |
|--------------------+--------+----------+-------|


**** Load new wavelength file
#+BEGIN_SRC sh :results none
xpaset -p ds9 cd $PWD
xpaset -p ds9 file wav0070.fits
#+END_SRC

#+BEGIN_SRC sh :results none
xpaset -p ds9 frame new
#+END_SRC

#+BEGIN_SRC sh :results none
xpaset -p ds9 file ../Keck2/p64-ff.fits
#+END_SRC


**** 2D wavelength calibration by John O'Meara

+ The images are rotated 270 degrees
+ They have cut off 21 pixels on the left edge



***** Fix up the calibration files to match our spectra

+ The O'Meara files have been rotated and have had the overscan strips removed
+ The following script undoes that, so that we can easily align with the science spectra 

#+BEGIN_SRC python :results output
  import numpy as np
  import astropy.io.fits as pyfits
  
  for arcid in ["0011", "0070", "0088", "1055"]:
      hdu, = pyfits.open("Arc_S{}_I.fits".format(arcid))
      # Swap x and y axes and add in margin to new x axis
      nx, ny = hdu.data.shape
      newdata = np.zeros((ny, nx + 255), dtype=float)
      # Convert to linear angstrom scale
      # Not only does the array need transposing, but the new y axis needs flipping
      newdata[:, 21:21+nx] = 10**hdu.data.T[::-1,:]
      pyfits.PrimaryHDU(newdata).writeto("wav{}.fits".format(arcid), clobber=True)
  
#+END_SRC

#+RESULTS:
: WARNING: Overwriting existing file 'wav0011.fits'. [astropy.io.fits.hdu.hdulist]
: WARNING: Overwriting existing file 'wav0070.fits'. [astropy.io.fits.hdu.hdulist]
: WARNING: Overwriting existing file 'wav0088.fits'. [astropy.io.fits.hdu.hdulist]
: WARNING: Overwriting existing file 'wav1055.fits'. [astropy.io.fits.hdu.hdulist]


***** Email from John [2013-01-29 Tue]
: Attached is one of the 4 2-d arc image files in log wavelengths.  You will notice that the orders at large wavelengths are just fine, but because of order overlap, things get very wonky at lower wavelengths (the arc image preserves the order boundaries determined in previous steps).  There's little to be done about this (but I'm cc'ing X in case he has ideas)
: 
: The 4 are the arc files taken during the initial calibrations (11) , and during the night before/after the observations (70,88,1055 with 1055 on night 2).  let me know how (i.e. dropbox, etc) I can get the other files to you (or I can email them individually, as my mail server wont let me do more than one

**** Extracting 1D spectrum of each order for Adal
     CLOCK: [2013-01-03 Thu 22:01]--[2013-01-03 Thu 23:01] =>  1:00

+ First we isolate each order
  + I have made ds9 box regions of each order
    + [[file:Keck1/t70-orders.reg][file:~/Dropbox/KeckProplyd/Keck1/t70-orders.reg]]
+ Now I need to fix the tilts
  + It is about 1 deg for the 1st order and 0.6 deg for the last (26th) order
  + I will interpolate linearly in between
  + Done by hand

#+BEGIN_SRC python :results output
import pyregion
import astropy.io.fits as pyfits
import numpy as np
import matplotlib.pyplot as plt
boxes = pyregion.open("Keck1/t70-orders.reg")
hdu, = pyfits.open("Keck1/t70.fits")
ny, nx = hdu.data.shape
x = np.arange(nx) + 1
filters = boxes.get_filter()
masks = []
orders = []
norders = np.zeros(hdu.data.shape, dtype=int)
for filt, box in zip(filters, boxes):
    m = filt.mask(hdu.data.shape)
    order = box.attr[1]['text'].split()[-1]
    masks.append(m)
    orders.append(order)
    # number of orders that overlap at each pixel
    norders[m] += 1

# Only include the pure strip up the middle of each order
masks = [m & (norders == 1) for m in masks]
for m, order in zip(masks, orders):
    spec = np.where(m, hdu.data, 0.0).sum(axis=0)
    savename = "Keck1/t70-1d-order" + order
    pyfits.PrimaryHDU(data=spec).writeto(savename + ".fits", clobber=True)
    plt.plot(x, spec)
    plt.title("Order " + order)
    plt.xlabel("x (pixels)")
    plt.ylabel("ThAr intensity")
    plt.savefig(savename + ".png")
    plt.clf()
#+END_SRC     

#+RESULTS:
#+begin_example
WARNING: Overwriting existing file 'Keck1/t70-1d-order51.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order52.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order53.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order54.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order55.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order56.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order57.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order58.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order59.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order60.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order61.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order62.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order63.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order64.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order65.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order66.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order67.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order68.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order69.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order70.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order71.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order72.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order73.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order74.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order75.fits'. [astropy.io.fits.hdu.hdulist]
WARNING: Overwriting existing file 'Keck1/t70-1d-order76.fits'. [astropy.io.fits.hdu.hdulist]
#+end_example




*** Conversion to heliocentric velocity
#+BEGIN_SRC python :results output table
  import numpy as np
  import astropy.io.fits as pyfits
  from astropy import coordinates as coord
  from astropy import units as u
  from pyslalib.slalib import sla_dcs2c, sla_evp, sla_rverot, sla_obs
  
  # The following page was very helpful in pointing to the relevant
  # SLALIB routines and how to use them
  # http://star-www.rl.ac.uk/docs/sun67.htx/node230.html

  # prange = range(56, 65) + 
  prange = range(69, 88)
  output = [["Spec", "VHEL", "VGEO", "VHEL + VGEO"]]
  for ii in prange:
      try:
          hdu, = pyfits.open("Keck1/p{:d}.fits".format(ii))
      except IOError:
          continue
      h = hdu.header
      # Object coordinates
      ra = coord.RA(h["RA"], u.hour)
      dec = coord.Dec(h["DEC"], u.degree)
      # Modified Julian Date
      jdate = float(h["MJD"])
      # Sidereal time
      st = coord.Angle((h["ST"]), u.hour)
      
      # line-of-sight unit vector to astronomical object
      k_los = sla_dcs2c(ra.radians, dec.radians)
      
      # Velocity and position of earth in barycentric and heliocentric frames
      # Units are AU and AU/s
      vel_bary, pos_bary, vel_hel, pos_hel = sla_evp(jdate, 2000.0)
      
      # Radial velocity correction (km/s) due to helio-geocentric transformation  
      # Positive when earth is moving away from object
      vcorr_hel = u.AU.to(u.km, -np.dot(vel_hel, k_los))
      
      # Long/lat/altitude of observatory (radians, radians, meters)
      obs_id, obs_name, obs_long, obs_lat, obs_height = sla_obs(0, "KECK1")
      
      # Radial velocity correction (km/s) due to geo-topocentric transformation
      # Positive when observatory is moving away from object
      vcorr_geo = sla_rverot(obs_lat, ra.radians, dec.radians, st.radians)
      
      output.append([ii, vcorr_hel, vcorr_geo, vcorr_hel + vcorr_geo])

  print output
  
#+END_SRC

#+RESULTS:
| Spec |                VHEL |                 VGEO |         VHEL + VGEO |
|   71 | -4.2130362834626265 | -0.07668336480855942 |  -4.289719648271186 |
|   72 |  -4.211930835092862 |  -0.0704268142580986 |  -4.282357649350961 |
|   73 |  -4.205046213600167 | -0.03175826370716095 |  -4.236804477307328 |
|   74 |  -4.198383420351823 | 0.006297547835856676 |  -4.192085872515967 |
|   75 |  -4.194503168266437 |  0.04516759514808655 |  -4.149335573118351 |
|   76 |  -4.188442923653372 |  0.07657043635845184 |   -4.11187248729492 |
|   77 |   -4.18321225618796 |  0.11296249181032181 |  -4.070249764377638 |
|   78 |  -4.177303384272307 |  0.14548268914222717 | -4.0318206951300795 |
|   79 |  -4.167885552875731 |  0.16355958580970764 |  -4.004325967066023 |
|   80 |  -4.165693418116596 |  0.17567287385463715 | -3.9900205442619585 |
|   81 |  -4.162635883803086 |  0.19238993525505066 |  -3.970245948548035 |
|   82 |  -4.160495710081002 |   0.2036283314228058 | -3.9568673786581963 |
|   83 |  -4.177067129665248 |  0.21812443435192108 | -3.9589426953133273 |
|   84 |  -4.173651966827228 |  0.23561424016952515 | -3.9380377266577025 |
|   85 |  -4.169816044768853 |   0.2546401917934418 |  -3.915175852975411 |
|   86 |  -4.150476820956283 |  0.28589820861816406 | -3.8645786123381187 |
|   87 |  -4.148319873582822 |  0.29561203718185425 | -3.8527078364009677 |


*** Remove cosmic rays


**** Fix cosmetic chip defects
:PROPERTIES:
:ID:       cosmetic
:END:
+ Bad columns are:
  + 107-108
  + 983
  + 1149
  + 1152
  + 2028-2029
+ All 1-based
+ This is now all done by [[file:hires-extract/cosmetic.py][file:~/Dropbox/KeckProplyd/hires-extract/cosmetic.py]]
***** Original version of cosmetic touch up
#+BEGIN_SRC python :results output verbatim
import astropy.io.fits as pyfits
hdulist = pyfits.open("Keck1/p84b.fits", mode='update')
data = hdulist[0].data
for i in 983, 1149, 1152:
    data[:, i-1] = 0.5*(data[:, i] + data[:, i-2])
data[:, 106] = 0.5*(data[:, 105] + data[:, 108])
data[:, 107] = 0.5*(data[:, 105] + data[:, 108])
data[:, 2027] = 0.5*(data[:, 2026] + data[:, 2029])
data[:, 2028] = 0.5*(data[:, 2026] + data[:, 2029])
hdulist.flush()
#+END_SRC

#+RESULTS:

**** STARTED Removing CRs from the images
     :PROPERTIES:
     :ID:       E214FDA3-BAC7-4516-B9A5-11E5F6F15B60
     :END:
     :LOGBOOK:
     - State "STARTED"    from "CANCELED"   [2013-04-18 Thu 22:31]
     - State "CANCELED"   from "STARTED"    [2013-04-18 Thu 22:29] \\
       This is now done on the whole chip
     - State "STARTED"    from ""           [2013-03-15 Fri 22:48]
     CLOCK: [2013-03-15 Fri 22:47]--[2013-03-15 Fri 23:47] =>  1:00
     CLOCK: [2013-02-23 Sat 11:04]--[2013-02-23 Sat 11:56] =>  0:52
     CLOCK: [2013-02-22 Fri 20:35]--[2013-02-23 Sat 00:23] =>  3:48
     CLOCK: [2013-02-22 Fri 17:12]--[2013-02-22 Fri 18:47] =>  1:35
     :END:
+ I have modified spotless.py to pack everything into the same FITS file
+ This now works, with the exception of
  + [X] There are some flagged pixels that don't get zapped
    + Need to make it so that any pixels in the badpix.reg file is protected from subsequently being eliminated
    + DONE [2013-03-17 Sun]

#+name: spotless-big-image
#+BEGIN_SRC sh :results verbatim
  cd Keck1
  COMMON_PARS="--output-id cr --multi-hdu --verbose --debug \
      --edge-pars 1.0 0.001 0.01 \
      --allow-shadows --dmax 7"
  SPOTLESS="python $HOME/Work/HST-STIS/spotless/spotless.py"
  OBJ=p84
  $SPOTLESS ${OBJ}b $COMMON_PARS --data-range 10 200 --threshold 200.0 \
            --include-regions-from-file ${OBJ}-badpix.reg \
            --exclude-regions-from-file ${OBJ}-protect.reg
#+END_SRC

#+RESULTS: spotless-big-image
#+begin_example
Warning: HDU 'SCI' not found, using the first one instead
Finding bad pixels by the 'edge' method
Data scaled to range [1.00e+01, 2.00e+02]
Edge detection with Canny method complete
Filling of holes complete
All values higher than 2.00e+02
            also added to bad pixels
WARNING: FITSFixedWarning: 'datfix' made the change 'Changed '05/12/97' to '1997-12-05''. This FITS header contains non-standard content. [astropy.wcs.wcs]
astropy: WARNING: FITSFixedWarning: 'datfix' made the change 'Changed '05/12/97' to '1997-12-05''. This FITS header contains non-standard content.
Regions from p84-protect.reg removed from bad pixels
Regions from p84-badpix.reg added to bad pixels
Number of bad pixels: 57619 (2.443% of total)
Number of distinct bad pixel objects found: 2259
Number of objects skipped:  63
Replacement of bad pixels complete
WARNING: Overwriting existing file 'p84b-cr.fits'. [astropy.io.fits.hdu.hdulist]
astropy: WARNING: Overwriting existing file 'p84b-cr.fits'.
#+end_example


***** Repeat CR removal for other slits

****** 244-440 p85
:PROPERTIES:
:ID:       557B6ED2-7946-4F97-9EF0-C94D6E3F139E
:END: 
#+name: spotless-p85
#+BEGIN_SRC sh :results verbatim
  cd Keck1
  COMMON_PARS="--output-id cr --multi-hdu --verbose --debug \
      --edge-pars 1.0 0.001 0.01 \
      --allow-shadows --dmax 7"
  SPOTLESS="python $HOME/Work/HST-STIS/spotless/spotless.py"
  OBJ=p85
  $SPOTLESS ${OBJ}b $COMMON_PARS --data-range 10 200 --threshold 200.0 \
            --include-regions-from-file ${OBJ}-badpix.reg \
            --exclude-regions-from-file ${OBJ}-protect.reg
#+END_SRC

#+RESULTS: spotless-p85
#+begin_example
Warning: HDU 'SCI' not found, using the first one instead
Finding bad pixels by the 'edge' method
Data scaled to range [1.00e+01, 2.00e+02]
Edge detection with Canny method complete
Filling of holes complete
All values higher than 2.00e+02
            also added to bad pixels
WARNING: FITSFixedWarning: EQUINOX = '2000.0 ' / A floating-point value was expected. [astropy.wcs.wcs]
astropy: WARNING: FITSFixedWarning: EQUINOX = '2000.0 ' / A floating-point value was expected.
WARNING: FITSFixedWarning: 'datfix' made the change 'Changed '05/12/97' to '1997-12-05''. This FITS header contains non-standard content. [astropy.wcs.wcs]
astropy: WARNING: FITSFixedWarning: 'datfix' made the change 'Changed '05/12/97' to '1997-12-05''. This FITS header contains non-standard content.
Regions from p85-protect.reg removed from bad pixels
Regions from p85-badpix.reg added to bad pixels
Number of bad pixels: 66942 (2.839% of total)
Number of distinct bad pixel objects found: 2598
WARNING: RuntimeWarning: invalid value encountered in divide [numpy.core.fromnumeric]
astropy: WARNING: RuntimeWarning: invalid value encountered in divide
Number of objects skipped:  69
Replacement of bad pixels complete
WARNING: Overwriting existing file 'p85b-cr.fits'. [astropy.io.fits.hdu.hdulist]
astropy: WARNING: Overwriting existing file 'p85b-cr.fits'.
#+end_example



*** Continuum fitting and subtraction

*** Nebular line fitting and subtraction
    CLOCK: [2013-03-26 Tue 00:15]--[2013-03-26 Tue 01:15] =>  1:00



**** Example removals from particular lines




***** 1-component fit to O I 6046, 7002
#+BEGIN_SRC sh
 python hires-extract/fit-nebula.py p84-O_I_6046 --extra-suffix dd --min-fraction 0.1 --ylo -7 -4 --yhi 4 7 --ncomp 1 --compA 250.0 25.0 3.5 --linear-components A
#+END_SRC
Two components are not justified here. 

#+BEGIN_EXAMPLE
  A_i0:     246.701881 +/- 5.011774 (2.03%) initial =  250.000000
  A_i1:    -20.379800 +/- 5.943478 (29.16%) initial =  0.000000
  A_i2:    -8.620498 +/- 9.801521 (113.70%) initial =  0.000000
  A_u0:     24.962371 +/- 0.076469 (0.31%) initial =  25.000000
  A_u1:    -1.162732 +/- 0.098975 (8.51%) initial =  0.000000
  A_u2:    fixed
  A_w0:     3.398314 +/- 0.077604 (2.28%) initial =  3.500000
  A_w1:     0.255361 +/- 0.100444 (39.33%) initial =  0.000000
  A_w2:    fixed
#+END_EXAMPLE

#+BEGIN_SRC sh
 python hires-extract/fit-nebula.py p84-O_I_7002 --extra-suffix dd --min-fraction 0.1 --ylo -7 -4 --yhi 4 7 --ncomp 1 --compA 250.0 25.0 3.5 --linear-components A
#+END_SRC

#+BEGIN_EXAMPLE
  A_i0:     220.780285 +/- 5.547695 (2.51%) initial =  250.000000
  A_i1:    -6.273166 +/- 6.568032 (104.70%) initial =  0.000000
  A_i2:    -16.005511 +/- 10.822712 (67.62%) initial =  0.000000
  A_u0:     24.041523 +/- 0.117197 (0.49%) initial =  25.000000
  A_u1:    -1.100816 +/- 0.152447 (13.85%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.248258 +/- 0.118282 (2.78%) initial =  3.500000
  A_w1:     0.395152 +/- 0.153819 (38.93%) initial =  0.000000
  A_w2:    fixed
#+END_EXAMPLE

***** 2-component fit to [Fe II] 5262 and 5159
These are the strongest [Fe II] lines

#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-Fe_II_5262 --min-fraction 0.1 --ylo -6.5 -3  --yhi 3 6.5 --ncomp 2 --compA 100.0 27.0 5.0 --compB 20.0 20.0 4.0 --linear-components AB --linear-intensity-components AB
#+END_SRC

Quite weak overall, but clear signal from the proplyd.  Looks very much like the O I lines, but can't exclude that it looks like [O I] instead. 

#+BEGIN_EXAMPLE
  A_i0:     48.638457 +/- 11.663480 (23.98%) initial =  100.000000
  A_i1:     5.537195 +/- 13.618369 (245.94%) initial =  0.000000
  A_i2:    fixed
  A_u0:     25.915729 +/- 0.369660 (1.43%) initial =  27.000000
  A_u1:    -0.335277 +/- 0.506813 (151.16%) initial =  0.000000
  A_u2:    fixed
  A_w0:     3.057403 +/- 0.417366 (13.65%) initial =  5.000000
  A_w1:     0.650272 +/- 0.508130 (78.14%) initial =  0.000000
  A_w2:    fixed
  B_i0:     29.504840 +/- 12.632341 (42.81%) initial =  20.000000
  B_i1:    -8.821424 +/- 14.871129 (168.58%) initial =  0.000000
  B_i2:    fixed
  B_u0:     17.291966 +/- 2.385376 (13.79%) initial =  20.000000
  B_u1:    -4.465713 +/- 2.750747 (61.60%) initial =  0.000000
  B_u2:    fixed
  B_w0:     5.198313 +/- 1.569177 (30.19%) initial =  4.000000
  B_w1:    -0.636788 +/- 1.868056 (293.36%) initial =  0.000000
  B_w2:    fixed
#+END_EXAMPLE

#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-Fe_II_5159 --min-fraction 0.1 --ylo -6.5 -3  --yhi 3 6.5 --ncomp 2 --compA 100.0 25.0 5.0 --compB 100.0 15.0 4.0 --linear-components AB --linear-intensity-components AB
#+END_SRC

Similar to 5262 except that the nebula has 2 components of roughly equal strength.  The proplyd is slightly stronger than in 5262, but with a strange protruberance upward at 20 km/s, similar to in [S II]

#+BEGIN_EXAMPLE
  A_i0:     114.287558 +/- 15.859890 (13.88%) initial =  100.000000
  A_i1:    -22.209039 +/- 21.054458 (94.80%) initial =  0.000000
  A_i2:    fixed
  A_u0:     25.193362 +/- 0.452794 (1.80%) initial =  25.000000
  A_u1:    -1.121312 +/- 0.597541 (53.29%) initial =  0.000000
  A_u2:    fixed
  A_w0:     3.559321 +/- 0.319019 (8.96%) initial =  5.000000
  A_w1:    -0.237686 +/- 0.429679 (180.78%) initial =  0.000000
  A_w2:    fixed
  B_i0:     133.468256 +/- 16.094084 (12.06%) initial =  100.000000
  B_i1:    -32.183163 +/- 21.347853 (66.33%) initial =  0.000000
  B_i2:    fixed
  B_u0:     15.889837 +/- 0.541187 (3.41%) initial =  15.000000
  B_u1:    -0.416852 +/- 0.719487 (172.60%) initial =  0.000000
  B_u2:    fixed
  B_w0:     4.077155 +/- 0.386683 (9.48%) initial =  4.000000
  B_w1:    -1.000000 +/- 0.224684 (22.47%) initial =  0.000000
  B_w2:    fixed
#+END_EXAMPLE
***** 3-component fit to [Fe III] 4881 and 5270
These are the strongest [Fe III] lines
#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-Fe_III_5270 --min-fraction 0.05 --ylo -6.5 -3  --yhi 3 6.5 --ncomp 3 --compA 300.0 21.0 5.0 --compB 40.0 30.0 4.0 --compC 90.0 6.0 4.0 --linear-components ABC --linear-intensity-components BC
#+END_SRC

The proplyd component is almost totally invisible here.  There is no evidence for any attenuation of the nebular component by the proplyd, which argues for zero effective extinction by the proplyd.  

#+BEGIN_EXAMPLE
  A_i0:     213.581473 +/- 110.854349 (51.90%) initial =  300.000000
  A_i1:     26.330112 +/- 51.642854 (196.14%) initial =  0.000000
  A_i2:     11.616132 +/- 10.008409 (86.16%) initial =  0.000000
  A_u0:     20.087455 +/- 0.338649 (1.69%) initial =  21.000000
  A_u1:    -0.821490 +/- 0.342674 (41.71%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.379886 +/- 0.607356 (13.87%) initial =  5.000000
  A_w1:     0.665576 +/- 0.361576 (54.33%) initial =  0.000000
  A_w2:    fixed
  B_i0:     126.104320 +/- 158.491466 (125.68%) initial =  40.000000
  B_i1:    -29.183598 +/- 66.918015 (229.30%) initial =  0.000000
  B_i2:    fixed
  B_u0:     26.285766 +/- 11.759271 (44.74%) initial =  30.000000
  B_u1:     1.242855 +/- 4.774458 (384.15%) initial =  0.000000
  B_u2:    fixed
  B_w0:     9.283118 +/- 5.333079 (57.45%) initial =  4.000000
  B_w1:    -1.000000 +/- 5.543227 (554.32%) initial =  0.000000
  B_w2:    fixed
  C_i0:     90.827704 +/- 45.282594 (49.86%) initial =  90.000000
  C_i1:    -4.785180 +/- 45.524054 (951.36%) initial =  0.000000
  C_i2:    fixed
  C_u0:     6.162149 +/- 0.794783 (12.90%) initial =  6.000000
  C_u1:    -0.975486 +/- 0.789525 (80.94%) initial =  0.000000
  C_u2:    fixed
  C_w0:     3.978474 +/- 0.701886 (17.64%) initial =  4.000000
  C_w1:    -0.223429 +/- 0.807214 (361.28%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE

#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-Fe_III_4881 --min-fraction 0.05 --ylo -6.5 -3  --yhi 3 6.5 --ncomp 3 --compA 300.0 21.0 5.0 --compB 40.0 30.0 4.0 --compC 90.0 6.0 4.0 --linear-components ABC --linear-intensity-components BC
#+END_SRC

This behaves very similarly to [Fe III] 5270, except that the proplyd is slightly stronger.  Also the 19 km/s component from th nebula is stronger.  Presumably, these are both due to a higher critical density. 

#+BEGIN_EXAMPLE
  A_i0:     312.147807 +/- 56.094261 (17.97%) initial =  300.000000
  A_i1:    -27.151732 +/- 56.034180 (206.37%) initial =  0.000000
  A_i2:    fixed
  A_u0:     18.287310 +/- 0.342468 (1.87%) initial =  21.000000
  A_u1:    -1.064036 +/- 0.343301 (32.26%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.526075 +/- 0.339815 (7.51%) initial =  5.000000
  A_w1:     0.058135 +/- 0.364267 (626.59%) initial =  0.000000
  A_w2:    fixed
  B_i0:     76.142752 +/- 57.433974 (75.43%) initial =  40.000000
  B_i1:     8.125581 +/- 55.426805 (682.13%) initial =  0.000000
  B_i2:    fixed
  B_u0:     29.670903 +/- 5.098998 (17.19%) initial =  30.000000
  B_u1:    -2.853195 +/- 5.294000 (185.55%) initial =  0.000000
  B_u2:    fixed
  B_w0:     6.635257 +/- 3.505915 (52.84%) initial =  4.000000
  B_w1:     1.000000 +/- 3.040318 (304.03%) initial =  0.000000
  B_w2:    fixed
  C_i0:     78.740354 +/- 8.942719 (11.36%) initial =  90.000000
  C_i1:     13.429226 +/- 12.251414 (91.23%) initial =  0.000000
  C_i2:    fixed
  C_u0:     4.612128 +/- 0.481815 (10.45%) initial =  6.000000
  C_u1:    -0.728459 +/- 0.659267 (90.50%) initial =  0.000000
  C_u2:    fixed
  C_w0:     3.753451 +/- 0.451179 (12.02%) initial =  4.000000
  C_w1:     1.000000 +/- 0.637891 (63.79%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE

***** 3-component fit to [Si II] 6371 and 6347
#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-Si_II_6371 --min-fraction 0.05 --ylo -6.5 -3  --yhi 3 6.5 --ncomp 3 --compA 100.0 1.0 5.0 --compB 100.0 13.0 4.0 --compC 100.0 25.0 3.0 --linear-components ABC --linear-intensity-components ABC
#+END_SRC

This has 3 peaks in the nebula, but only a single component from the proplyd, which is clearly fluorescence in neutral gas. 

#+BEGIN_EXAMPLE
  A_i0:     290.230123 +/- 17.835777 (6.15%) initial =  100.000000
  A_i1:     71.868619 +/- 23.398639 (32.56%) initial =  0.000000
  A_i2:    fixed
  A_u0:     2.973816 +/- 0.419507 (14.11%) initial =  1.000000
  A_u1:     0.908382 +/- 0.552200 (60.79%) initial =  0.000000
  A_u2:    fixed
  A_w0:     6.067699 +/- 0.320741 (5.29%) initial =  5.000000
  A_w1:     1.000000 +/- 0.005036 (0.50%) initial =  0.000000
  A_w2:    fixed
  B_i0:     154.232663 +/- 20.563621 (13.33%) initial =  100.000000
  B_i1:    -57.989648 +/- 26.669599 (45.99%) initial =  0.000000
  B_i2:    fixed
  B_u0:     13.988985 +/- 0.248036 (1.77%) initial =  13.000000
  B_u1:    -0.700739 +/- 0.341950 (48.80%) initial =  0.000000
  B_u2:    fixed
  B_w0:     3.640252 +/- 0.318145 (8.74%) initial =  4.000000
  B_w1:    -0.856001 +/- 0.424452 (49.59%) initial =  0.000000
  B_w2:    fixed
  C_i0:     173.633862 +/- 9.100440 (5.24%) initial =  100.000000
  C_i1:     7.511082 +/- 12.170772 (162.04%) initial =  0.000000
  C_i2:    fixed
  C_u0:     24.067825 +/- 0.225362 (0.94%) initial =  25.000000
  C_u1:    -1.713125 +/- 0.302453 (17.66%) initial =  0.000000
  C_u2:    fixed
  C_w0:     3.625906 +/- 0.189324 (5.22%) initial =  3.000000
  C_w1:     0.985997 +/- 0.255264 (25.89%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE

#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-Si_II_6347 --min-fraction 0.05 --ylo -6.5 -3  --yhi 3 6.5 --ncomp 3 --compA 100.0 1.0 5.0 --compB 100.0 13.0 4.0 --compC 100.0 25.0 3.0 --linear-components ABC --linear-intensity-components ABC
#+END_SRC


***** 3-component fit to [Cl III] 5518 and 5538
#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-Cl_III_5518 --min-fraction 0.05 --ylo -7 -4  --yhi 5 7 --ncomp 3 --compA 150.0 17.0 5.0 --compB 60.0 24.0 5.0 --compC 30.0 3.0 3.0 --linear-components ABC
#+END_SRC

Amazingly the 3-component fits work for these weak lines.  5518 has a very weak proplyd component.  5538 is about 3 times stronger. 
#+BEGIN_EXAMPLE
  A_i0:     229.490306 +/- 62.654975 (27.30%) initial =  150.000000
  A_i1:     9.196986 +/- 64.106069 (697.03%) initial =  0.000000
  A_i2:    -14.845364 +/- 17.747496 (119.55%) initial =  0.000000
  A_u0:     11.842465 +/- 0.434826 (3.67%) initial =  17.000000
  A_u1:    -0.802597 +/- 0.542933 (67.65%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.991348 +/- 0.571570 (11.45%) initial =  5.000000
  A_w1:    -0.004530 +/- 0.614274 (13558.66%) initial =  0.000000
  A_w2:    fixed
  B_i0:     71.125443 +/- 121.971215 (171.49%) initial =  60.000000
  B_i1:    -19.215014 +/- 121.532198 (632.49%) initial =  0.000000
  B_i2:     10.623432 +/- 34.865006 (328.19%) initial =  0.000000
  B_u0:     28.749785 +/- 15.231899 (52.98%) initial =  24.000000
  B_u1:     0.934880 +/- 15.388522 (1646.04%) initial =  0.000000
  B_u2:    fixed
  B_w0:     14.999841 +/- 22.663504 (151.09%) initial =  5.000000
  B_w1:     1.000000 +/- 40.976280 (4097.63%) initial =  0.000000
  B_w2:    fixed
  C_i0:     156.854765 +/- 32.182791 (20.52%) initial =  30.000000
  C_i1:     13.396395 +/- 36.560414 (272.91%) initial =  0.000000
  C_i2:    -22.632697 +/- 13.466689 (59.50%) initial =  0.000000
  C_u0:    -1.213344 +/- 0.684414 (56.41%) initial =  3.000000
  C_u1:    -0.177585 +/- 0.868701 (489.18%) initial =  0.000000
  C_u2:    fixed
  C_w0:     4.895860 +/- 0.596430 (12.18%) initial =  3.000000
  C_w1:     0.405327 +/- 0.759959 (187.49%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE

#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-Cl_III_5538 --min-fraction 0.05 --ylo -7 -4  --yhi 5 7 --ncomp 3 --compA 400.0 12.0 5.0 --compB 120.0 29.0 15.0 --compC 300.0 -1.0 5.0 --linear-components ABC
#+END_SRC

#+BEGIN_EXAMPLE
  A_i0:     306.358944 +/- 78.158858 (25.51%) initial =  400.000000
  A_i1:     51.779822 +/- 38.442364 (74.24%) initial =  0.000000
  A_i2:     4.272225 +/- 32.606663 (763.22%) initial =  0.000000
  A_u0:     10.127378 +/- 0.152671 (1.51%) initial =  12.000000
  A_u1:    -0.809687 +/- 0.191110 (23.60%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.789855 +/- 0.357266 (7.46%) initial =  5.000000
  A_w1:     0.338606 +/- 0.283895 (83.84%) initial =  0.000000
  A_w2:    fixed
  B_i0:     208.867442 +/- 96.220420 (46.07%) initial =  120.000000
  B_i1:    -8.005303 +/- 43.876893 (548.10%) initial =  0.000000
  B_i2:    -100.053947 +/- 44.572401 (44.55%) initial =  0.000000
  B_u0:     20.229693 +/- 4.994200 (24.69%) initial =  29.000000
  B_u1:     1.844198 +/- 2.857197 (154.93%) initial =  0.000000
  B_u2:    fixed
  B_w0:     10.029557 +/- 2.846496 (28.38%) initial =  15.000000
  B_w1:     0.999986 +/- 1.990608 (199.06%) initial =  0.000000
  B_w2:    fixed
  C_i0:     168.577567 +/- 17.739455 (10.52%) initial =  300.000000
  C_i1:     2.969445 +/- 13.359829 (449.91%) initial =  0.000000
  C_i2:    -9.594208 +/- 13.564803 (141.39%) initial =  0.000000
  C_u0:    -2.947761 +/- 0.221823 (7.53%) initial = -1.000000
  C_u1:    -0.781509 +/- 0.283710 (36.30%) initial =  0.000000
  C_u2:    fixed
  C_w0:     4.013851 +/- 0.213817 (5.33%) initial =  5.000000
  C_w1:    -0.154327 +/- 0.263887 (170.99%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE

***** 3-component fit to [S III] 6312
#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-S_III_6312 --min-fraction 0.05 --ylo -6.5 -4  --yhi 5 7 --ncomp 3 --compA 1500.0 17.0 5.0 --compB 600.0 24.0 5.0 --compC 300.0 3.0 3.0 --linear-components ABC
#+END_SRC

#+BEGIN_EXAMPLE
  A_i0:     1167.484242 +/- 83.390567 (7.14%) initial =  1500.000000
  A_i1:     281.437227 +/- 91.983270 (32.68%) initial =  0.000000
  A_i2:     7.205063 +/- 37.877514 (525.71%) initial =  0.000000
  A_u0:     13.822799 +/- 0.081963 (0.59%) initial =  17.000000
  A_u1:    -1.270851 +/- 0.100119 (7.88%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.825707 +/- 0.121252 (2.51%) initial =  5.000000
  A_w1:     0.750145 +/- 0.148219 (19.76%) initial =  0.000000
  A_w2:    fixed
  B_i0:     1024.163959 +/- 157.713872 (15.40%) initial =  600.000000
  B_i1:    -216.651717 +/- 165.231890 (76.27%) initial =  0.000000
  B_i2:    -185.580856 +/- 75.362793 (40.61%) initial =  0.000000
  B_u0:     20.310427 +/- 2.270021 (11.18%) initial =  24.000000
  B_u1:     1.724206 +/- 2.622561 (152.10%) initial =  0.000000
  B_u2:    fixed
  B_w0:     12.898025 +/- 1.283855 (9.95%) initial =  5.000000
  B_w1:     1.000000 +/- 2.248425 (224.84%) initial =  0.000000
  B_w2:    fixed
  C_i0:     514.266188 +/- 67.958669 (13.21%) initial =  300.000000
  C_i1:     14.364716 +/- 70.766911 (492.64%) initial =  0.000000
  C_i2:    -38.217241 +/- 33.721211 (88.24%) initial =  0.000000
  C_u0:     0.291566 +/- 0.119763 (41.08%) initial =  3.000000
  C_u1:    -1.332307 +/- 0.153615 (11.53%) initial =  0.000000
  C_u2:    fixed
  C_w0:     3.952087 +/- 0.222030 (5.62%) initial =  3.000000
  C_w1:    -0.146397 +/- 0.245167 (167.47%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE




***** 3-component fit to [O I] 6300
#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-O_I_6300 --min-fraction 0.05 --ylo -6.5 -4  --yhi 4.5 7 --ncomp 3 --compA 1500.0 24.0 5.0 --compB 600.0 15.0 5.0 --compC 300.0 0.0 3.0 --linear-components ABC
#+END_SRC

#+BEGIN_EXAMPLE
  A_i0:     383.980969 +/- 38.285182 (9.97%) initial =  1500.000000
  A_i1:    -171.162034 +/- 48.137464 (28.12%) initial =  0.000000
  A_i2:     10.613149 +/- 24.983113 (235.40%) initial =  0.000000
  A_u0:     24.718429 +/- 0.105012 (0.42%) initial =  24.000000
  A_u1:    -0.571067 +/- 0.136349 (23.88%) initial =  0.000000
  A_u2:    fixed
  A_w0:     3.125304 +/- 0.147522 (4.72%) initial =  5.000000
  A_w1:    -0.108291 +/- 0.190824 (176.21%) initial =  0.000000
  A_w2:    fixed
  B_i0:     1495.789510 +/- 38.983181 (2.61%) initial =  600.000000
  B_i1:    -313.701991 +/- 48.821117 (15.56%) initial =  0.000000
  B_i2:    -280.732365 +/- 33.517008 (11.94%) initial =  0.000000
  B_u0:     20.815295 +/- 0.145766 (0.70%) initial =  15.000000
  B_u1:    -1.058745 +/- 0.190034 (17.95%) initial =  0.000000
  B_u2:    fixed
  B_w0:     6.414119 +/- 0.070888 (1.11%) initial =  5.000000
  B_w1:     0.188354 +/- 0.093032 (49.39%) initial =  0.000000
  B_w2:    fixed
  C_i0:     264.483684 +/- 7.398038 (2.80%) initial =  300.000000
  C_i1:    -26.189151 +/- 8.543009 (32.62%) initial =  0.000000
  C_i2:    -40.478956 +/- 15.025327 (37.12%) initial =  0.000000
  C_u0:    -0.564326 +/- 0.104318 (18.49%) initial =  0.000000
  C_u1:    -0.804304 +/- 0.135263 (16.82%) initial =  0.000000
  C_u2:    fixed
  C_w0:     3.650555 +/- 0.111372 (3.05%) initial =  3.000000
  C_w1:    -0.249520 +/- 0.144201 (57.79%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE
***** 2-component fit to [O I] 5577
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p84-O_I_5577 --min-fraction 0.1 --ylo -6.5 -3 --yhi 3.5 7 --ncomp 2 --compA 500.0 0.5 2.0 --compB 500.0 -0.5 2.0
#+END_SRC
This needs two components to fit the sky line, which is clearly non-Gaussian. 

#+BEGIN_EXAMPLE
  A_i0:     459.882481 +/- 56.405640 (12.27%) initial =  500.000000
  A_i1:    -72.631699 +/- 74.701318 (102.85%) initial =  0.000000
  A_i2:     108.475451 +/- 93.350516 (86.06%) initial =  0.000000
  A_u0:     1.736574 +/- 0.165897 (9.55%) initial =  0.500000
  A_u1:    -0.569695 +/- 0.218833 (38.41%) initial =  0.000000
  A_u2:    -0.247355 +/- 0.269828 (109.08%) initial =  0.000000
  A_w0:     1.500000 +/- 0.192938 (12.86%) initial =  2.000000
  A_w1:    -0.079121 +/- 0.092968 (117.50%) initial =  0.000000
  A_w2:     0.124019 +/- 0.126080 (101.66%) initial =  0.000000
  B_i0:     554.185886 +/- 56.566338 (10.21%) initial =  500.000000
  B_i1:     52.747826 +/- 75.078444 (142.33%) initial =  0.000000
  B_i2:    -92.911807 +/- 93.652561 (100.80%) initial =  0.000000
  B_u0:    -1.400877 +/- 0.169158 (12.08%) initial = -0.500000
  B_u1:    -0.573419 +/- 0.224354 (39.13%) initial =  0.000000
  B_u2:    -0.264670 +/- 0.274991 (103.90%) initial =  0.000000
  B_w0:     1.630705 +/- 0.078173 (4.79%) initial =  2.000000
  B_w1:     0.075377 +/- 0.106167 (140.85%) initial =  0.000000
  B_w2:    -0.148542 +/- 0.133858 (90.11%) initial =  0.000000
#+END_EXAMPLE

***** 3-component fit to [N I] 5198, 5200
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p84-N_I_5198 --min-fraction 0.1  --vrange -30 50 --ylo -6.5 -4 --yhi 4 7 --ncomp 3 --compA 350.0 26.0 5.0 --compB 100.0 18.0 5.0 --compC 100.0 0.0 3.0 --linear-components BC --linear-intensity-components BC
#+END_SRC

#+BEGIN_EXAMPLE
  A_i0:     384.556706 +/- 11.974505 (3.11%) initial =  350.000000
  A_i1:    -55.865660 +/- 14.938556 (26.74%) initial =  0.000000
  A_i2:    -26.159107 +/- 9.440846 (36.09%) initial =  0.000000
  A_u0:     25.824278 +/- 0.056006 (0.22%) initial =  26.000000
  A_u1:    -0.740663 +/- 0.069002 (9.32%) initial =  0.000000
  A_u2:     0.238515 +/- 0.085907 (36.02%) initial =  0.000000
  A_w0:     2.889358 +/- 0.054393 (1.88%) initial =  5.000000
  A_w1:    -0.046863 +/- 0.069156 (147.57%) initial =  0.000000
  A_w2:    -0.202989 +/- 0.087172 (42.94%) initial =  0.000000
  B_i0:     75.115545 +/- 14.049737 (18.70%) initial =  100.000000
  B_i1:    -2.119413 +/- 17.924443 (845.73%) initial =  0.000000
  B_i2:    fixed
  B_u0:     15.957147 +/- 0.995594 (6.24%) initial =  18.000000
  B_u1:    -0.941158 +/- 1.274948 (135.47%) initial =  0.000000
  B_u2:    fixed
  B_w0:     5.174302 +/- 1.126859 (21.78%) initial =  5.000000
  B_w1:     0.999583 +/- 1.456685 (145.73%) initial =  0.000000
  B_w2:    fixed
  C_i0:     32.254849 +/- 4.419037 (13.70%) initial =  100.000000
  C_i1:     7.958886 +/- 5.814262 (73.05%) initial =  0.000000
  C_i2:    fixed
  C_u0:    -0.244224 +/- 0.439529 (179.97%) initial =  0.000000
  C_u1:    -1.511802 +/- 0.577940 (38.23%) initial =  0.000000
  C_u2:    fixed
  C_w0:     2.988438 +/- 0.447323 (14.97%) initial =  3.000000
  C_w1:     0.626415 +/- 0.586772 (93.67%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE

#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p84-N_I_5200 --min-fraction 0.1 --ylo -6.5 -4 --yhi 4 7  --vrange -30 50 --ncomp 3 --compA 200.0 26.0 5.0 --compB 40.0 18.0 5.0 --compC 20.0 0.0 3.0 --linear-components BC --linear-intensity-components BC
#+END_SRC

This has 2 components for the nebula and one weak one for the sky.  The linear and quadratic components are generally very poorly constrained, except for A_i1 and A_u1. 

#+BEGIN_EXAMPLE
  A_i0:     210.627763 +/- 10.893600 (5.17%) initial =  200.000000
  A_i1:    -55.231208 +/- 12.982411 (23.51%) initial =  0.000000
  A_i2:     10.954361 +/- 8.517770 (77.76%) initial =  0.000000
  A_u0:     26.073563 +/- 0.059861 (0.23%) initial =  26.000000
  A_u1:    -0.793144 +/- 0.076945 (9.70%) initial =  0.000000
  A_u2:    -0.040622 +/- 0.139765 (344.06%) initial =  0.000000
  A_w0:     2.715030 +/- 0.084049 (3.10%) initial =  5.000000
  A_w1:    -0.179285 +/- 0.100159 (55.87%) initial =  0.000000
  A_w2:    -0.019571 +/- 0.135368 (691.66%) initial =  0.000000
  B_i0:     97.786440 +/- 13.899554 (14.21%) initial =  40.000000
  B_i1:     36.403635 +/- 16.697512 (45.87%) initial =  0.000000
  B_i2:    fixed
  B_u0:     18.153695 +/- 1.168440 (6.44%) initial =  18.000000
  B_u1:     3.095284 +/- 1.417389 (45.79%) initial =  0.000000
  B_u2:    fixed
  B_w0:     7.535272 +/- 1.287368 (17.08%) initial =  5.000000
  B_w1:     0.922924 +/- 1.674516 (181.44%) initial =  0.000000
  B_w2:    fixed
  C_i0:     25.084114 +/- 4.353772 (17.36%) initial =  20.000000
  C_i1:     1.716733 +/- 5.743252 (334.55%) initial =  0.000000
  C_i2:    fixed
  C_u0:    -0.857475 +/- 0.472182 (55.07%) initial =  0.000000
  C_u1:    -0.826300 +/- 0.621782 (75.25%) initial =  0.000000
  C_u2:    fixed
  C_w0:     2.860753 +/- 0.495820 (17.33%) initial =  3.000000
  C_w1:     0.151373 +/- 0.652796 (431.25%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE



***** 3-component fit to the [N II] 6548 line
#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-N_II_6548 --vrange -20 50 --min-fraction 0.05 --ylo -6.5 -4 --yhi 4 7 --ncomp 3 --compA 7500.0 -1.0 3.5 --compB 25000.0 14.0 4.5 --compC 25000.0 20.0 10.0 --linear-components ABC
#+END_SRC

#+BEGIN_EXAMPLE
  A_i0:     13630.619692 +/- 584.495114 (4.29%) initial =  7500.000000
  A_i1:    -1504.124132 +/- 451.650279 (30.03%) initial =  0.000000
  A_i2:    -2257.333013 +/- 372.386143 (16.50%) initial =  0.000000
  A_u0:    -0.155947 +/- 0.070233 (45.04%) initial = -1.000000
  A_u1:    -0.545073 +/- 0.076113 (13.96%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.159756 +/- 0.080102 (1.93%) initial =  3.500000
  A_w1:    -0.135660 +/- 0.087056 (64.17%) initial =  0.000000
  A_w2:    fixed
  B_i0:     33474.081947 +/- 1289.075300 (3.85%) initial =  25000.000000
  B_i1:    -5397.870078 +/- 944.970572 (17.51%) initial =  0.000000
  B_i2:    -112.523627 +/- 545.756259 (485.01%) initial =  0.000000
  B_u0:     14.843760 +/- 0.032270 (0.22%) initial =  14.000000
  B_u1:    -1.117277 +/- 0.037435 (3.35%) initial =  0.000000
  B_u2:    fixed
  B_w0:     4.556240 +/- 0.058423 (1.28%) initial =  4.500000
  B_w1:    -0.024365 +/- 0.054899 (225.32%) initial =  0.000000
  B_w2:    fixed
  C_i0:     26592.100332 +/- 1876.892857 (7.06%) initial =  25000.000000
  C_i1:     367.914059 +/- 1268.237306 (344.71%) initial =  0.000000
  C_i2:    -11309.490625 +/- 906.866513 (8.02%) initial =  0.000000
  C_u0:     22.437852 +/- 0.837880 (3.73%) initial =  20.000000
  C_u1:    -3.194451 +/- 0.621291 (19.45%) initial =  0.000000
  C_u2:    fixed
  C_w0:     11.132360 +/- 0.387039 (3.48%) initial =  10.000000
  C_w1:     1.000000 +/- 0.005703 (0.57%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE
      
***** 3-component fit to the [N II] 6583 line
There is clearly a problem with the wavelength calibration of this line.  As compared with 5755 and 6548 it is about 1 km/s too blue.  

#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-N_II_6583 --vrange -20 50 --min-fraction 0.05 --ylo -6.5 -4 --yhi 4 7 --ncomp 3 --compA 30000.0 -1.0 3.5 --compB 100000.0 14.0 4.5 --compC 100000.0 20.0 10.0 --linear-components ABC
#+END_SRC

#+BEGIN_EXAMPLE
  A_i0:     58911.923284 +/- 2383.372983 (4.05%) initial =  30000.000000
  A_i1:    -5767.948869 +/- 1854.985614 (32.16%) initial =  0.000000
  A_i2:    -9809.527569 +/- 1514.769392 (15.44%) initial =  0.000000
  A_u0:    -1.582314 +/- 0.062254 (3.93%) initial = -1.000000
  A_u1:    -0.488023 +/- 0.068293 (13.99%) initial =  0.000000
  A_u2:    fixed
  A_w0:     4.007175 +/- 0.074391 (1.86%) initial =  3.500000
  A_w1:    -0.110870 +/- 0.078979 (71.24%) initial =  0.000000
  A_w2:    fixed
  B_i0:     145788.138138 +/- 5086.894051 (3.49%) initial =  100000.000000
  B_i1:    -21247.971513 +/- 4001.973300 (18.83%) initial =  0.000000
  B_i2:     3279.529577 +/- 2153.510226 (65.67%) initial =  0.000000
  B_u0:     13.524685 +/- 0.030850 (0.23%) initial =  14.000000
  B_u1:    -1.022280 +/- 0.034530 (3.38%) initial =  0.000000
  B_u2:    fixed
  B_w0:     4.512029 +/- 0.053703 (1.19%) initial =  4.500000
  B_w1:    -0.033967 +/- 0.051801 (152.51%) initial =  0.000000
  B_w2:    fixed
  C_i0:     116130.259759 +/- 7499.247841 (6.46%) initial =  100000.000000
  C_i1:     560.394034 +/- 5434.562692 (969.78%) initial =  0.000000
  C_i2:    -48883.825298 +/- 3667.603346 (7.50%) initial =  0.000000
  C_u0:     20.854134 +/- 0.776069 (3.72%) initial =  20.000000
  C_u1:    -2.979598 +/- 0.613681 (20.60%) initial =  0.000000
  C_u2:    fixed
  C_w0:     11.302898 +/- 0.353081 (3.12%) initial =  10.000000
  C_w1:     1.000000 +/- 0.302645 (30.26%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE

***** 3-component fit to the [N II] 5755 line
#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-N_II_5755 --vrange -20 50 --min-fraction 0.05 --ylo -6.5 -4 --yhi 4 7 --ncomp 3 --compA 500.0 -2.0 5.0 --compB 1500 15.0 7.0 --compC 500 30.0 10.0 --linear-components ABC
#+END_SRC

#+BEGIN_EXAMPLE
  A_i0:     322.659765 +/- 37.929592 (11.76%) initial =  500.000000
  A_i1:    -38.375671 +/- 30.647467 (79.86%) initial =  0.000000
  A_i2:    -82.887051 +/- 25.233291 (30.44%) initial =  0.000000
  A_u0:    -1.198920 +/- 0.175214 (14.61%) initial = -2.000000
  A_u1:    -0.878677 +/- 0.187820 (21.38%) initial =  0.000000
  A_u2:    fixed
  A_w0:     3.656997 +/- 0.216531 (5.92%) initial =  5.000000
  A_w1:    -0.191406 +/- 0.223767 (116.91%) initial =  0.000000
  A_w2:    fixed
  B_i0:     906.121675 +/- 79.862935 (8.81%) initial =  1500.000000
  B_i1:    -161.457364 +/- 68.079552 (42.17%) initial =  0.000000
  B_i2:     22.789417 +/- 37.768631 (165.73%) initial =  0.000000
  B_u0:     14.309864 +/- 0.100456 (0.70%) initial =  15.000000
  B_u1:    -1.221770 +/- 0.103337 (8.46%) initial =  0.000000
  B_u2:    fixed
  B_w0:     4.404931 +/- 0.145238 (3.30%) initial =  7.000000
  B_w1:    -0.094183 +/- 0.145517 (154.50%) initial =  0.000000
  B_w2:    fixed
  C_i0:     1292.612794 +/- 115.917659 (8.97%) initial =  500.000000
  C_i1:     97.147615 +/- 92.307251 (95.02%) initial =  0.000000
  C_i2:    -606.129283 +/- 63.652124 (10.50%) initial =  0.000000
  C_u0:     19.008873 +/- 0.926548 (4.87%) initial =  30.000000
  C_u1:    -3.097480 +/- 0.806478 (26.04%) initial =  0.000000
  C_u2:    fixed
  C_w0:     10.739073 +/- 0.363123 (3.38%) initial =  10.000000
  C_w1:     0.881345 +/- 0.398673 (45.23%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE


***** 3-component fit to the [S II] 6716 line
Both of the [S II] lines show a strange upward protuberance 

#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-S_II_6716 --vrange -20 50 --min-fraction 0.05 --ylo -6.5 -4 --yhi 4 7 --ncomp 3 --compA 5000.0 -2.0 5.0 --compB 15000 15.0 7.0 --compC 5000 30.0 10.0 --linear-components ABC
#+END_SRC

#+BEGIN_EXAMPLE
  A_i0:     9229.571733 +/- 211.851360 (2.30%) initial =  5000.000000
  A_i1:    -1038.073434 +/- 229.153361 (22.07%) initial =  0.000000
  A_i2:    -469.440586 +/- 162.662050 (34.65%) initial =  0.000000
  A_u0:    -0.990596 +/- 0.066067 (6.67%) initial = -2.000000
  A_u1:    -0.351735 +/- 0.076087 (21.63%) initial =  0.000000
  A_u2:    fixed
  A_w0:     3.962447 +/- 0.057234 (1.44%) initial =  5.000000
  A_w1:    -0.130422 +/- 0.069363 (53.18%) initial =  0.000000
  A_w2:    fixed
  B_i0:     14962.958695 +/- 1022.586478 (6.83%) initial =  15000.000000
  B_i1:    -1529.086544 +/- 1054.107154 (68.94%) initial =  0.000000
  B_i2:     430.660852 +/- 279.913991 (65.00%) initial =  0.000000
  B_u0:     15.452556 +/- 0.042016 (0.27%) initial =  15.000000
  B_u1:    -0.419367 +/- 0.054831 (13.07%) initial =  0.000000
  B_u2:    fixed
  B_w0:     4.322877 +/- 0.098216 (2.27%) initial =  7.000000
  B_w1:    -0.110774 +/- 0.104517 (94.35%) initial =  0.000000
  B_w2:    fixed
  C_i0:     10820.387931 +/- 1222.080922 (11.29%) initial =  5000.000000
  C_i1:    -1299.367291 +/- 1237.651614 (95.25%) initial =  0.000000
  C_i2:    -2145.870764 +/- 381.633953 (17.78%) initial =  0.000000
  C_u0:     23.375414 +/- 1.117883 (4.78%) initial =  30.000000
  C_u1:    -1.558707 +/- 1.179304 (75.66%) initial =  0.000000
  C_u2:    fixed
  C_w0:     9.319445 +/- 0.494774 (5.31%) initial =  10.000000
  C_w1:     0.838783 +/- 0.535706 (63.87%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE

***** 3-component fit to the [S II] 6731 line
#+BEGIN_SRC 
python hires-extract/fit-nebula.py p84-S_II_6731 --vrange -20 50 --min-fraction 0.05 --ylo -6.5 -4 --yhi 4 7 --ncomp 3 --compA 5000.0 -2.0 5.0 --compB 15000 15.0 7.0 --compC 5000 30.0 10.0 --linear-components ABC
#+END_SRC

#+BEGIN_EXAMPLE
 A_i0:     8001.330870 +/- 263.782275 (3.30%) initial =  5000.000000
  A_i1:    -739.146393 +/- 292.862025 (39.62%) initial =  0.000000
  A_i2:    -855.457603 +/- 244.927515 (28.63%) initial =  0.000000
  A_u0:    -0.834951 +/- 0.099851 (11.96%) initial = -2.000000
  A_u1:    -0.270079 +/- 0.118398 (43.84%) initial =  0.000000
  A_u2:    fixed
  A_w0:     3.876933 +/- 0.089771 (2.32%) initial =  5.000000
  A_w1:    -0.047444 +/- 0.111718 (235.47%) initial =  0.000000
  A_w2:    fixed
  B_i0:     22208.419453 +/- 1382.299973 (6.22%) initial =  15000.000000
  B_i1:    -4729.569493 +/- 1238.201281 (26.18%) initial =  0.000000
  B_i2:     329.660959 +/- 439.142920 (133.21%) initial =  0.000000
  B_u0:     15.593279 +/- 0.042627 (0.27%) initial =  15.000000
  B_u1:    -0.412220 +/- 0.061289 (14.87%) initial =  0.000000
  B_u2:    fixed
  B_w0:     4.253302 +/- 0.088740 (2.09%) initial =  7.000000
  B_w1:    -0.199764 +/- 0.086464 (43.28%) initial =  0.000000
  B_w2:    fixed
  C_i0:     15249.536741 +/- 1612.234820 (10.57%) initial =  5000.000000
  C_i1:    -1269.107549 +/- 1410.271885 (111.12%) initial =  0.000000
  C_i2:    -4163.288348 +/- 594.376165 (14.28%) initial =  0.000000
  C_u0:     23.298908 +/- 0.985670 (4.23%) initial =  30.000000
  C_u1:    -2.220318 +/- 0.917362 (41.32%) initial =  0.000000
  C_u2:    fixed
  C_w0:     8.828146 +/- 0.429493 (4.87%) initial =  10.000000
  C_w1:     1.000000 +/- 0.399275 (39.93%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE

***** 3-component fit to He I 6678 singlet, 5876 triplet
#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p84-He_I_S_6678 --vrange -30 60 --min-fraction 0.05 --ylo -6.5 -3.5 --yhi 4.5 6.5 --ncomp 3 --compA 2000.0 5.0 5.0 --compB 3000 15.0 7.0 --compC 1000 30.0 10.0 --linear-components ABC
#+END_SRC

#+BEGIN_EXAMPLE
  A_i0:     1816.668783 +/- 169.122401 (9.31%) initial =  2000.000000
  A_i1:    -435.214759 +/- 169.790363 (39.01%) initial =  0.000000
  A_i2:    -79.416814 +/- 40.435415 (50.92%) initial =  0.000000
  A_u0:     0.059481 +/- 0.151847 (255.29%) initial =  5.000000
  A_u1:    -1.437585 +/- 0.200958 (13.98%) initial =  0.000000
  A_u2:    fixed
  A_w0:     5.627438 +/- 0.142609 (2.53%) initial =  5.000000
  A_w1:    -0.164311 +/- 0.163113 (99.27%) initial =  0.000000
  A_w2:    fixed
  B_i0:     4359.706837 +/- 212.583699 (4.88%) initial =  3000.000000
  B_i1:     791.751017 +/- 203.718997 (25.73%) initial =  0.000000
  B_i2:    -387.756700 +/- 62.338551 (16.08%) initial =  0.000000
  B_u0:     11.093031 +/- 0.333228 (3.00%) initial =  15.000000
  B_u1:    -2.817917 +/- 0.363345 (12.89%) initial =  0.000000
  B_u2:    fixed
  B_w0:     8.728447 +/- 0.234333 (2.68%) initial =  7.000000
  B_w1:     1.000000 +/- 0.633475 (63.35%) initial =  0.000000
  B_w2:    fixed
  C_i0:     894.794430 +/- 76.135108 (8.51%) initial =  1000.000000
  C_i1:    -85.302323 +/- 76.435466 (89.61%) initial =  0.000000
  C_i2:    -423.719200 +/- 39.471263 (9.32%) initial =  0.000000
  C_u0:     33.382614 +/- 0.886178 (2.65%) initial =  30.000000
  C_u1:     2.116505 +/- 0.977575 (46.19%) initial =  0.000000
  C_u2:    fixed
  C_w0:     10.053601 +/- 0.505743 (5.03%) initial =  10.000000
  C_w1:    -0.999411 +/- 0.457573 (45.78%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE

#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p84-He_I_T_5876 --vrange -30 60 --min-fraction 0.05 --ylo -6.5 -3.5 --yhi 4.5 6.5 --ncomp 3 --compA 2000.0 5.0 5.0 --compB 3000 15.0 7.0 --compC 1000 30.0 10.0 --linear-components ABC
#+END_SRC

#+BEGIN_EXAMPLE
  A_i0:     4180.538376 +/- 353.221937 (8.45%) initial =  2000.000000
  A_i1:    -88.194845 +/- 229.324404 (260.02%) initial =  0.000000
  A_i2:    -536.895966 +/- 72.462364 (13.50%) initial =  0.000000
  A_u0:     0.767107 +/- 0.303291 (39.54%) initial =  5.000000
  A_u1:    -1.756785 +/- 0.215249 (12.25%) initial =  0.000000
  A_u2:    fixed
  A_w0:     6.039932 +/- 0.136007 (2.25%) initial =  5.000000
  A_w1:    -0.110045 +/- 0.117102 (106.41%) initial =  0.000000
  A_w2:    fixed
  B_i0:     5268.100894 +/- 626.998125 (11.90%) initial =  3000.000000
  B_i1:     1519.104619 +/- 233.978704 (15.40%) initial =  0.000000
  B_i2:    -302.103114 +/- 166.905132 (55.25%) initial =  0.000000
  B_u0:     13.107029 +/- 0.462105 (3.53%) initial =  15.000000
  B_u1:    -2.087619 +/- 0.352686 (16.89%) initial =  0.000000
  B_u2:    fixed
  B_w0:     7.524247 +/- 0.398987 (5.30%) initial =  7.000000
  B_w1:     1.000000 +/- 0.194065 (19.41%) initial =  0.000000
  B_w2:    fixed
  C_i0:     3066.927520 +/- 412.038250 (13.43%) initial =  1000.000000
  C_i1:    -596.060998 +/- 252.670104 (42.39%) initial =  0.000000
  C_i2:    -1201.155450 +/- 156.187136 (13.00%) initial =  0.000000
  C_u0:     28.434502 +/- 1.670516 (5.87%) initial =  30.000000
  C_u1:     3.342325 +/- 1.091855 (32.67%) initial =  0.000000
  C_u2:    fixed
  C_w0:     12.041216 +/- 0.755960 (6.28%) initial =  10.000000
  C_w1:    -1.000000 +/- 0.014594 (1.46%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE

      
***** 2-component fit to C II 6578

#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p84-C_II_6578 --vrange -30 40 --min-fraction 0.05 --ylo -7 -3.5 --yhi 5.0 6.5 --ncomp 2 --compA 500.0 4.0 6.0 --compB 200.0 17.0 5.0 --linear-components ABC
#+END_SRC

The 3-component fit did not work very well, but 2 components are enough since the data is so noisy.

#+BEGIN_EXAMPLE
  A_i0:     267.794984 +/- 93.251719 (34.82%) initial =  500.000000
  A_i1:     100.968695 +/- 108.991543 (107.95%) initial =  0.000000
  A_i2:     10.880926 +/- 19.633021 (180.44%) initial =  0.000000
  A_u0:     2.416648 +/- 0.400143 (16.56%) initial =  4.000000
  A_u1:    -0.025486 +/- 0.505325 (1982.79%) initial =  0.000000
  A_u2:    fixed
  A_w0:     5.400628 +/- 0.446939 (8.28%) initial =  6.000000
  A_w1:     1.000000 +/- 0.032298 (3.23%) initial =  0.000000
  A_w2:    fixed
  B_i0:     500.837633 +/- 95.417557 (19.05%) initial =  200.000000
  B_i1:    -39.418563 +/- 110.571797 (280.51%) initial =  0.000000
  B_i2:    -139.703575 +/- 23.515616 (16.83%) initial =  0.000000
  B_u0:     12.653753 +/- 1.871426 (14.79%) initial =  17.000000
  B_u1:    -0.418102 +/- 2.266660 (542.13%) initial =  0.000000
  B_u2:    fixed
  B_w0:     8.940756 +/- 0.760180 (8.50%) initial =  5.000000
  B_w1:    -0.029108 +/- 0.903339 (3103.39%) initial =  0.000000
  B_w2:    fixed
#+END_EXAMPLE
***** 3-component fit to [O III] 5007

#+BEGIN_SRC sh
python hires-extract/fit-nebula.py p84-O_III_5007 --vrange -30 60 --min-fraction 0.05 --ylo -6.5 -3.5 --yhi 4.5 7 --ncomp 3 --compA 60000.0 5.0 5.0 --compB 90000 15.0 7.0 --compC 20000 30.0 10.0 --linear-components ABC
#+END_SRC

#+BEGIN_EXAMPLE
  A_i0:     76016.451779 +/- 1429.810212 (1.88%) initial =  60000.000000
  A_i1:     1623.999901 +/- 1700.800802 (104.73%) initial =  0.000000
  A_i2:    -5804.658227 +/- 298.418268 (5.14%) initial =  0.000000
  A_u0:     3.140897 +/- 0.067387 (2.15%) initial =  5.000000
  A_u1:    -1.506976 +/- 0.082709 (5.49%) initial =  0.000000
  A_u2:    fixed
  A_w0:     5.399203 +/- 0.030668 (0.57%) initial =  5.000000
  A_w1:     0.112080 +/- 0.038436 (34.29%) initial =  0.000000
  A_w2:    fixed
  B_i0:     110470.604418 +/- 2121.591492 (1.92%) initial =  90000.000000
  B_i1:     7222.033551 +/- 2383.782921 (33.01%) initial =  0.000000
  B_i2:    -381.210456 +/- 384.571768 (100.88%) initial =  0.000000
  B_u0:     15.454986 +/- 0.074895 (0.48%) initial =  15.000000
  B_u1:    -1.093043 +/- 0.094392 (8.64%) initial =  0.000000
  B_u2:    fixed
  B_w0:     6.873553 +/- 0.078378 (1.14%) initial =  7.000000
  B_w1:     0.129808 +/- 0.090850 (69.99%) initial =  0.000000
  B_w2:    fixed
  C_i0:     19603.195571 +/- 933.070983 (4.76%) initial =  20000.000000
  C_i1:    -1330.236571 +/- 1025.177869 (77.07%) initial =  0.000000
  C_i2:    -4843.229488 +/- 399.903937 (8.26%) initial =  0.000000
  C_u0:     34.469244 +/- 0.508845 (1.48%) initial =  30.000000
  C_u1:     1.405160 +/- 0.578619 (41.18%) initial =  0.000000
  C_u2:    fixed
  C_w0:     9.550060 +/- 0.301653 (3.16%) initial =  10.000000
  C_w1:    -1.000000 +/- 0.326825 (32.68%) initial =  0.000000
  C_w2:    fixed
#+END_EXAMPLE
*** Plotting the results
+ Test of using pywcsgrid2
+ Following closely the first example
#+BEGIN_SRC python :results output
import numpy as np
import astropy.io.fits as pyfits
import astropy.wcs as pywcs
import pywcsgrid2
import matplotlib.pyplot as plt
f = pyfits.open("Stamps/p84-O_III_5007-stamp-nc.fits")
d, h = f[0].data, f[0].header
dp = f["PROP"].data
dn = f["NEB"].data
f_ni = pyfits.open("Stamps/p84-N_I_5200-stamp-nc.fits")
h_ni = f_ni[0].header
dp_ni = f_ni["PROP"].data
f_oi = pyfits.open("Stamps/p84-O_I_5577-stamp-nc.fits")
h_oi = f_oi[0].header
dp_oi = f_oi["PROP"].data
print h
wcs = pywcs.WCS(h)
plt.figure(1, [4,3])
ax = pywcsgrid2.subplot(111, header=h)
plt.tight_layout()
ax.imshow(d**2, origin="low", cmap=plt.cm.gray_r)
cn = ax.contour(dn, 10000*2**(-0.5*np.arange(7)), colors="c", alpha=0.6)
cp = ax.contour(dp, 3000*2**(-0.5*np.arange(7)), colors="y", alpha=0.75)
cp_ni = ax[h_ni].contour(dp_ni, 80*2**(-0.5*np.arange(5)), colors="r", alpha=0.5)
cp_oi = ax[h_oi].contour(dp_oi, 120*2**(-0.5*np.arange(5)), colors="b", alpha=0.5)
cn.collections[0].set_label("[O III] nebula")
cp.collections[0].set_label("[O III] proplyd")
cp_ni.collections[0].set_label("[N I] proplyd")
cp_oi.collections[0].set_label("[O I] proplyd")
KMS = 1000.0 # m/s
def kms2xpix(u, y=0.0):
    u = np.atleast_1d(u)
    coords = np.vstack((u*KMS, [y]*len(u))).T
    return wcs.wcs_sky2pix(coords, 0)[:, 0]
def arcsec2ypix(y, u=0.0):
    y = np.atleast_1d(y)
    coords = np.vstack(([u]*len(y), y)).T
    return wcs.wcs_sky2pix(coords, 0)[:, 1]

ax.plot(kms2xpix(0.0), arcsec2ypix(0.0), "r+", zorder=10)
ax.set_ticklabel2_type("arcsec", scale=1./3600, nbins=8)
ax.set_ticklabel1_type("absval", scale=1./1000, nbins=7)
# ax.add_inner_title(u"[O III] 5007", loc=4)
ax.add_beam_size(3.0, 2.0, 0.0, 1)
ax.set_xlim(*kms2xpix([-30.0, 90.0]))
ax.grid()
ax.legend(loc="lower right", fontsize="x-small")
ax.axis["bottom"].label.set_text(r"$V_{\mathrm{top}}\ \mathrm{(km\,s^{-1})}$")
ax.set_title("244-440 example extracted components", fontsize="x-small")
plt.savefig("pywcsgrid2-test.pdf")
#+END_SRC

#+RESULTS:
: SIMPLE  =                    T / conforms to FITS standard                      BITPIX  =                  -64 / array data type                                NAXIS   =                    2 / number of array dimensions                     NAXIS1  =                   94                                                  NAXIS2  =                   36                                                  EXTEND  =                    T                                                  CD1_2   =                  0.0                                                  CD1_1   =    2.123623055516013                                                  CRVAL2  =                  0.0                                                  CRPIX1  =                  0.0                                                  CRPIX2  =                 18.5                                                  CRVAL1  =   -102.0268957229818                                                  CUNIT2  = 'arcsec  '                                                            CUNIT1  = 'km/s    '                                                            CTYPE2  = 'PARAM   '                                                            CTYPE1  = 'VELO    '                                                            CD2_2   =                0.382                                                  CD2_1   =                  0.0                                                  END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
: WARNING: tight_layout : falling back to Agg renderer [matplotlib.tight_layout]

*** Remove bias and divide by flat

#+name: flatfield
#+BEGIN_SRC python :var obs="2/p64" :results output
import pyfits

flat = pyfits.open("Keck1/q110.fits")[0]
obj = pyfits.open("Keck{}.fits".format(obs))[0]

bias = obj.data[:,2080:].mean()

flat.data -= bias
obj.data -= bias
obj.data /= flat.data

obj.writeto("Keck{}-ff.fits".format(obs), output_verify='fix', clobber=True)
#+END_SRC

#+RESULTS: flatfield
: Output verification result:
: HDU 0:    Card 14:          Fixed card to be FITS standard.: DATE-MOD
: Note: PyFITS uses zero-based indexing.
: Overwriting existing file 'Keck2/p64-ff.fits'.

#+call: flatfield("1/p84") :results output

#+RESULTS: flatfield("1/p84"):results output

#+call: flatfield("1/p73")

#+RESULTS: flatfield("1/p73")
: Output verification result:
: HDU 0:    Card 14:          Fixed card to be FITS standard.: DATE-MOD
: Note: PyFITS uses zero-based indexing.

#+call: flatfield("1/p75")

#+RESULTS: flatfield("1/p75")
: Output verification result:
: HDU 0:    Card 14:          Fixed card to be FITS standard.: DATE-MOD
: Note: PyFITS uses zero-based indexing.

#+call: flatfield("1/p74")

#+RESULTS: flatfield("1/p74")
: Output verification result:
: HDU 0:    Card 14:          Fixed card to be FITS standard.: DATE-MOD
: Note: PyFITS uses zero-based indexing.

#+call: flatfield("1/p76")

#+RESULTS: flatfield("1/p76")
: Output verification result:
: HDU 0:    Card 14:          Fixed card to be FITS standard.: DATE-MOD
: Note: PyFITS uses zero-based indexing.

#+call: flatfield("1/p77")

#+RESULTS: flatfield("1/p77")
: <stdin>:11: RuntimeWarning: divide by zero encountered in divide
: Output verification result:
: HDU 0:    Card 14:          Fixed card to be FITS standard.: DATE-MOD
: Note: PyFITS uses zero-based indexing.

#+call: flatfield("1/p87")

#+RESULTS: flatfield("1/p87")
: Output verification result:
: HDU 0:    Card 14:          Fixed card to be FITS standard.: DATE-MOD
: Note: PyFITS uses zero-based indexing.

#+call: flatfield("2/jw74")

#+RESULTS: flatfield("2/jw74")
: Output verification result:
: HDU 0:    Card 14:          Fixed card to be FITS standard.: DATE-MOD
: Note: PyFITS uses zero-based indexing.

#+RESULTS: flatfield("2/jw73")
: Output verification result:
: HDU 0:    Card 14:          Fixed card to be FITS standard.: DATE-MOD
: Note: PyFITS uses zero-based indexing.

#+RESULTS: flatfield("2/jw72")
: Output verification result:
: HDU 0:    Card 14:          Fixed card to be FITS standard.: DATE-MOD
: Note: PyFITS uses zero-based indexing.

#+RESULTS: flatfield("1/p80")
: <stdin>:11: RuntimeWarning: divide by zero encountered in divide
: Output verification result:
: HDU 0:    Card 14:          Fixed card to be FITS standard.: DATE-MOD
: Note: PyFITS uses zero-based indexing.

#+RESULTS: flatfield("1/p79")
: <stdin>:11: RuntimeWarning: divide by zero encountered in divide
: Output verification result:
: HDU 0:    Card 14:          Fixed card to be FITS standard.: DATE-MOD
: Note: PyFITS uses zero-based indexing.

#+BEGIN_SRC sh
xpaset -p ds9 frame match image
#+END_SRC

#+RESULTS:


#+BEGIN_SRC python
import pyfits
obj = pyfits.open("Keck2/p64.fits")[0]
obj.verify()
#obj.writeto("Keck2/p64-test.fits")
#+END_SRC

#+RESULTS:
: None




** Initial look at the data

*** DONE Look in SAOimage
    CLOSED: [2012-05-14 Mon 12:13]

*** Position of slits

**** Produce a mosaic image with correct WCS RA-Dec info
     :PROPERTIES:
     :dir:      ~/Work/BobPC/2005
     :END:

The WCS info in the PC mosaic is not correct

#+BEGIN_SRC sh
export PATH=$PATH:~/Source/wcstools-3.8.5/bin
wcshead -ht GO5469PCf658.fits
#+END_SRC

#+RESULTS:
| filename                 | naxis1 | naxis2 | ctype1   | ctype2   | crval1       | crval2       | system   | crpix1  | crpix2  | cdelt1  | cdelt2  | crota2   |
| ------------------------ | ------ | ------ | -------- | -------- | -------      | -------      | -------- | ------- | ------- | ------- | ------- | -------  |
| GO5469PCf658.fits        | 1336   | 2064   | RA---TAN | DEC--TAN | 05:35:16.298 | -05:23:16.78 | FK5      | 371.0   | 363.5   | -0.0452 | 0.0452  | 224.4714 |

We will correct it using the known position of HST 12 (173-341), which is a very small proplyd near our targets. 

Bally et al 1998 Table 3 has coordinates for 173-341:

| RA |    |        | Dec |    |       |   RA(deg) |   Dec(deg) |
| 05 | 35 | 17.279 | -05 | 23 | 41.97 | 83.821996 | -5.3949917 |
|    |    |        |     |    |       |           |            |
#+TBLFM: $7=15 $1 + (15/60) $2 + (15/3600) $3::$8=$4 - $5/60 - $6/3600




+ [X] Fix the mosaic files: 

0.1 arcsec in degrees is 0.1 /3600 = 2.77777777778e-5 
#+BEGIN_SRC sh :results output
export PATH=$PATH:~/Source/wcstools-3.8.5/bin
sethead -nv GO5469PCf???.fits CRVAL1=83.821996 CRVAL2=-5.3949917 CRPIX1=811 CRPIX2=987
sethead -nv mosaicf???-fix.fits CRVAL1=83.821996 CRVAL2=-5.3949917 CRPIX1=1812.5 CRPIX2=2697.5 CD1_1=-2.77777777778e-5 CD2_2=2.77777777778e-5 CTYPE1='RA---TAN' CTYPE2='DEC--TAN'
#+END_SRC

#+RESULTS:
#+begin_example
CRVAL1 = 83.821996
CRVAL2 = -5.3949917
CRPIX1 = 811
CRPIX2 = 987
GO5469PCf502e.fits: rewritten successfully.

CRVAL1 = 83.821996
CRVAL2 = -5.3949917
CRPIX1 = 811
CRPIX2 = 987
GO5469PCf547e.fits: rewritten successfully.

CRVAL1 = 83.821996
CRVAL2 = -5.3949917
CRPIX1 = 811
CRPIX2 = 987
GO5469PCf631e.fits: rewritten successfully.

CRVAL1 = 83.821996
CRVAL2 = -5.3949917
CRPIX1 = 811
CRPIX2 = 987
GO5469PCf656e.fits: rewritten successfully.

CRVAL1 = 83.821996
CRVAL2 = -5.3949917
CRPIX1 = 811
CRPIX2 = 987
GO5469PCf658e.fits: rewritten successfully.

CRVAL1 = 83.821996
CRVAL2 = -5.3949917
CRPIX1 = 811
CRPIX2 = 987
GO5469PCf673e.fits: rewritten successfully.

CRVAL1 = 83.821996
CRVAL2 = -5.3949917
CRPIX1 = 1812.5
CRPIX2 = 2697.5
CD1_1 = -2.77777777778e-5
CD2_2 = 2.77777777778e-5
CTYPE1 = RA---TAN
CTYPE2 = DEC--TAN
mosaicf502-fixe.fits: rewritten successfully.

CRVAL1 = 83.821996
CRVAL2 = -5.3949917
CRPIX1 = 1812.5
CRPIX2 = 2697.5
CD1_1 = -2.77777777778e-5
CD2_2 = 2.77777777778e-5
CTYPE1 = RA---TAN
CTYPE2 = DEC--TAN
mosaicf656-fixe.fits: rewritten successfully.

CRVAL1 = 83.821996
CRVAL2 = -5.3949917
CRPIX1 = 1812.5
CRPIX2 = 2697.5
CD1_1 = -2.77777777778e-5
CD2_2 = 2.77777777778e-5
CTYPE1 = RA---TAN
CTYPE2 = DEC--TAN
mosaicf658-fixe.fits: rewritten successfully.

#+end_example

+ [X] Move the =mosaicf???-fixe.fits= files to =~/Dropbox/KeckProplyd/HST=

#+BEGIN_SRC sh
mv mosaicf???-fixe.fits ~/Dropbox/KeckProplyd/HST
#+END_SRC

#+RESULTS:

#+BEGIN_SRC sh :results output
export PATH=$PATH:~/Source/wcstools-3.8.5/bin
sethead -nv mos-scat-a0.03.fits CRVAL1=83.821996 CRVAL2=-5.3949917 CRPIX1=1812.5 CRPIX2=2697.5 CD1_1=-2.77777777778e-5 CD2_2=2.77777777778e-5 CTYPE1='RA---TAN' CTYPE2='DEC--TAN'
mv mos-scat-a0.03e.fits ~/Dropbox/KeckProplyd/HST
#+END_SRC

#+RESULTS:
#+begin_example
CRVAL1 = 83.821996
CRVAL2 = -5.3949917
CRPIX1 = 1812.5
CRPIX2 = 2697.5
CD1_1 = -2.77777777778e-5
CD2_2 = 2.77777777778e-5
CTYPE1 = RA---TAN
CTYPE2 = DEC--TAN
mos-scat-a0.03e.fits: rewritten successfully.

#+end_example


**** View the RGB HST mosaic with slit positions
     :LOGBOOK:
     - Note taken on [2013-02-23 Sat 17:29] \\
       Switched from pysao to the shell command line XPA tool
     :END:
     CLOCK: [2013-02-23 Sat 17:29]--[2013-02-23 Sat 17:43] =>  0:14
  :PROPERTIES:
  :session:  mosaic-ds9
  :results:  output verbatim
  :END:




***** Start up ds9 and delete the frame to start with a blank slate
#+BEGIN_SRC sh
xpaset -p ds9 frame delete all 
#+END_SRC

#+RESULTS:

***** Switch to where the mosaic files are 
#+BEGIN_SRC sh
#xpaset -p ds9 cd HST
xpaget ds9 cd
#+END_SRC

#+RESULTS:
=
/Users/will/Dropbox/KeckProplyd/HST
==
will@slavoj:KeckProplyd$ /Users/will/Dropbox/KeckProplyd/HST
==/Users/will/Dropbox/KeckProplyd/HST=


***** Load the three images
#+BEGIN_SRC sh
xpaset -p ds9 frame new rgb
xpaset -p ds9 rgb channel red
xpaset -p ds9 file mosaicf658-fixe.fits
xpaset -p ds9 scale limits 0 2000
xpaset -p ds9 rgb channel green
xpaset -p ds9 file mosaicf656-fixe.fits
xpaset -p ds9 scale limits 0 2500 
xpaset -p ds9 rgb channel blue
xpaset -p ds9 file mosaicf502-fixe.fits
xpaset -p ds9 scale limits 0 800
#+END_SRC


#+RESULTS:

***** Fix the brightness scaling
#+BEGIN_SRC sh
xpaset -p ds9 rgb channel red
xpaset -p ds9 scale limits 0 2000
xpaset -p ds9 rgb channel green
xpaset -p ds9 scale limits 0 2500 
xpaset -p ds9 rgb channel blue
xpaset -p ds9 scale limits 0 800
#+END_SRC

#+RESULTS:


***** Load the regions
#+BEGIN_SRC sh
xpaset -p ds9 regions -format ds9 load Keck-slits.reg
#+END_SRC

#+RESULTS:
: 
: ERROR  (DS9:ds9 /var/folders/d2/50_dv7s55fng8lpppdbxrls40000gn/T//DS9_ds9.28332)

*** List of exposures
    CLOCK: [2012-05-24 Thu 10:35]--[2012-05-24 Thu 13:45] =>  3:10

**** Proplyds

***** 177-341
| FILENAME | TARGNAME   |           RA |          DEC | DATE-OBS |          UT | EXPOSURE | DECKNAME | ROTPOSN | AIRMASS |
| p75.fits | ori_177341 | 05:35:17.770 | -05:23:37.30 | 05/12/97 | 11:23:47.14 |      900 | C2       |   225.0 |    1.11 |
| p76.fits | ori_177341 | 05:35:17.400 | -05:23:36.10 | 05/12/97 | 11:40:24.44 |      900 | C2       |   315.0 |    1.12 |
| p59.fits | ori_177341 | 05:35:17.650 | -05:23:41.00 | 06/12/97 | 12:00:31.18 |      300 | C2       |   225.0 |    1.15 |
| p60.fits | ori_177341 | 05:35:17.590 | -05:23:40.10 | 06/12/97 | 12:08:08.03 |      300 | C2       |   135.0 |    1.16 |

***** 170-337
| FILENAME | TARGNAME   |           RA |          DEC | DATE-OBS |          UT | EXPOSURE | DECKNAME | ROTPOSN | AIRMASS |
| p71.fits | ori_170337 | 05:35:16.900 | -05:23:37.00 | 05/12/97 | 10:19:38.12 |       60 | C2       |   241.0 |    1.12 |
| p72.fits | ori_170337 | 05:35:16.880 | -05:23:37.20 | 05/12/97 | 10:22:57.82 |      900 | C2       |  241.01 |    1.12 |
| p73.fits | ori_170337 | 05:35:16.700 | -05:23:37.50 | 05/12/97 | 10:43:22.82 |      900 | C2       |  321.01 |    1.11 |
| p74.fits | ori_170337 | 05:35:16.550 | -05:23:37.10 | 05/12/97 | 11:03:20.61 |      900 | C2       |  443.01 |    1.11 |
| q69.fits | ori_170337 | 05:35:16.970 | -05:23:37.20 | 05/12/97 | 10:03:56.22 |        1 | C2       |  180.01 |    1.14 |
| t70.fits | ori_170337 | 05:35:16.970 | -05:23:37.20 | 05/12/97 | 10:06:32.79 |        1 | C2       |   180.0 |    1.14 |
| p56.fits | ori_170337 | 05:35:16.970 | -05:23:37.20 | 06/12/97 | 11:38:53.32 |      300 | C2       |   241.0 |    1.13 |
| p57.fits | ori_170337 | 05:35:16.920 | -05:23:36.30 | 06/12/97 | 11:46:30.14 |      300 | C2       |   321.0 |    1.13 |
| p58.fits | ori_170337 | 05:35:16.870 | -05:23:36.80 | 06/12/97 | 11:53:09.19 |      300 | C2       |  263.01 |    1.14 |

***** 182-413
| FILENAME | TARGNAME   |           RA |          DEC | DATE-OBS |          UT | EXPOSURE | DECKNAME | ROTPOSN | AIRMASS |
| p77.fits | ori_182413 | 05:35:18.170 | -05:24:12.70 | 05/12/97 | 11:59:58.54 |      900 | C2       |  242.01 |    1.15 |
| p78.fits | ori_182413 | 05:35:18.070 | -05:24:13.60 | 05/12/97 | 12:17:49.77 |      300 | C2       |   242.0 |    1.17 |
| p86.fits | ori_182413 | 05:35:18.280 | -05:24:14.80 | 05/12/97 | 13:43:32.42 |      300 | C2       |   152.0 |    1.48 |
| p87.fits | ori_182413 | 05:35:18.290 | -05:24:15.00 | 05/12/97 | 13:50:22.51 |      900 | C2       |  151.99 |    1.52 |
| t88.fits | ori_182413 | 05:35:18.290 | -05:24:15.00 | 05/12/97 | 14:07:05.42 |        1 | C2       |  151.99 |    1.64 |
| p61.fits | ori_182413 | 05:35:18.160 | -05:24:13.30 | 06/12/97 | 12:16:09.61 |      300 | C2       |  242.01 |    1.18 |
| p62.fits | ori_182413 | 05:35:18.130 | -05:24:12.80 | 06/12/97 | 12:23:45.30 |      300 | C2       |  152.01 |    1.19 |

It looks like the ROTPOSN angle is really PA of the slit

***** 244-440
| FILENAME | TARGNAME   |           RA |          DEC | DATE-OBS |          UT | EXPOSURE | DECKNAME | ROTPOSN | AIRMASS |
| p83.fits | ori_244440 | 05:35:24.420 | -05:24:41.40 | 05/12/97 | 12:59:55.96 |      300 | C2       |  142.01 |    1.28 |
| p84.fits | ori_244440 | 05:35:24.420 | -05:24:41.40 | 05/12/97 | 13:10:40.40 |      600 | C2       |   142.0 |    1.32 |
| p85.fits | ori_244440 | 05:35:24.420 | -05:24:41.40 | 05/12/97 | 13:22:44.32 |      500 | C2       |   232.0 |    1.37 |
| p63.fits | ori_244440 | 05:35:24.330 | -05:24:40.30 | 06/12/97 | 12:32:07.12 |      450 | C2       |   142.0 |    1.21 |
| p64.fits | ori_244440 | 05:35:24.330 | -05:24:40.30 | 06/12/97 | 12:41:28.23 |      450 | C2       |   232.0 |    1.24 |

**** Jets 
***** 150-353
| FILENAME | TARGNAME   |           RA |          DEC | DATE-OBS |          UT | EXPOSURE | DECKNAME | ROTPOSN | AIRMASS |
| p79.fits | ori_150353 | 05:35:15.010 | -05:23:53.20 | 05/12/97 | 12:27:54.89 |      300 | C2       |  371.01 |     1.2 |
| p80.fits | ori_150353 | 05:35:15.010 | -05:23:53.20 | 05/12/97 | 12:34:48.46 |      300 | C3       |   371.0 |    1.21 |
| p81.fits | ori_150353 | 05:35:15.010 | -05:23:52.20 | 05/12/97 | 12:44:28.64 |      300 | C3       |   371.0 |    1.24 |
| p82.fits | ori_150353 | 05:35:15.010 | -05:23:54.20 | 05/12/97 | 12:51:05.46 |      300 | C3       |   371.0 |    1.26 |
| j65.fits | ori_150353 | 05:35:15.010 | -05:23:53.20 | 06/12/97 | 12:51:57.26 |      300 | C3       |  191.01 |    1.27 |
| j66.fits | ori_150353 | 05:35:15.010 | -05:23:52.20 | 06/12/97 | 12:58:34.62 |      300 | C3       |   191.0 |    1.29 |
| j67.fits | ori_150353 | 05:35:15.010 | -05:23:51.20 | 06/12/97 | 13:05:10.24 |      300 | C3       |   191.0 |    1.32 |
| j68.fits | ori_150353 | 05:35:15.010 | -05:23:50.20 | 06/12/97 | 13:11:46.39 |      300 | C3       |   191.0 |    1.34 |
| j69.fits | ori_150353 | 05:35:15.010 | -05:23:54.20 | 06/12/97 | 13:18:20.34 |      300 | C3       |   191.0 |    1.37 |
| j70.fits | ori_150353 | 05:35:15.010 | -05:23:55.20 | 06/12/97 | 13:24:57.89 |      300 | C3       |   191.0 |     1.4 |
| j71.fits | ori_150353 | 05:35:15.010 | -05:23:56.20 | 06/12/97 | 13:31:37.21 |      300 | C3       |   191.0 |    1.44 |

***** 163-357 
| FILENAME  | TARGNAME   |           RA |          DEC | DATE-OBS |          UT | EXPOSURE | DECKNAME | ROTPOSN | AIRMASS |
| je75.fits | ori_163357 | 05:35:16.310 | -05:23:57.50 | 06/12/97 | 14:03:54.97 |      300 | C3       |   191.0 |    1.65 |
| je76.fits | ori_163357 | 05:35:16.310 | -05:23:54.50 | 06/12/97 | 14:10:33.74 |      300 | C3       |   191.0 |     1.7 |

***** 137-349
| FILENAME  | TARGNAME   |           RA |          DEC | DATE-OBS |          UT | EXPOSURE | DECKNAME | ROTPOSN | AIRMASS |
| jw72.fits | ori_137349 | 05:35:13.700 | -05:23:53.20 | 06/12/97 | 13:42:19.73 |      300 | C3       |   191.0 |     1.5 |
| jw73.fits | ori_137349 | 05:35:13.700 | -05:23:50.20 | 06/12/97 | 13:48:56.29 |      300 | C3       |  190.99 |    1.54 |
| jw74.fits | ori_137349 | 05:35:13.700 | -05:23:56.20 | 06/12/97 | 13:55:41.86 |      300 | C3       |   191.0 |    1.58 |

**** Star th 1 C
| FILENAME | TARGNAME    |           RA |          DEC | DATE-OBS |          UT | EXPOSURE | DECKNAME | ROTPOSN | AIRMASS |
| t55.fits | ori_theta1c | 05:35:16.440 | -05:23:23.00 | 06/12/97 | 11:34:57.92 |        1 | C2       |  195.83 |    1.12 |

**** Grab relevant FITS headers
#+BEGIN_SRC sh
HEADERS="OBJECT RA DEC DATE-OBS UT EXPOSURE DECKNAME ROTPOSN AIRMASS" 
~/Source/wcstools-3.8.5/bin/gethead -hb Keck[12]/*.fits $HEADERS
#+END_SRC

#+RESULTS:
| FILENAME     | OBJECT              |           RA |          DEC | DATE-OBS |          UT | EXPOSURE | DECKNAME | ROTPOSN | AIRMASS |
| bias.fits    | Quartz              | 22:56:00.000 | +00:00:37.40 | 05/12/97 | 01:04:58.24 |        1 | C2       |     0.0 |   13.37 |
| p71.fits     | PPL15               | 05:35:16.900 | -05:23:37.00 | 05/12/97 | 10:19:38.12 |       60 | C2       |   241.0 |    1.12 |
| p72.fits     | PPL15               | 05:35:16.880 | -05:23:37.20 | 05/12/97 | 10:22:57.82 |      900 | C2       |  241.01 |    1.12 |
| p73.fits     | PPL15               | 05:35:16.700 | -05:23:37.50 | 05/12/97 | 10:43:22.82 |      900 | C2       |  321.01 |    1.11 |
| p74.fits     | PPL15               | 05:35:16.550 | -05:23:37.10 | 05/12/97 | 11:03:20.61 |      900 | C2       |  443.01 |    1.11 |
| p75.fits     | Ori_177341          | 05:35:17.770 | -05:23:37.30 | 05/12/97 | 11:23:47.14 |      900 | C2       |   225.0 |    1.11 |
| p76.fits     | Ori_177341          | 05:35:17.400 | -05:23:36.10 | 05/12/97 | 11:40:24.44 |      900 | C2       |   315.0 |    1.12 |
| p77.fits     | Ori_182413          | 05:35:18.170 | -05:24:12.70 | 05/12/97 | 11:59:58.54 |      900 | C2       |  242.01 |    1.15 |
| p78.fits     | Ori_182413          | 05:35:18.070 | -05:24:13.60 | 05/12/97 | 12:17:49.77 |      300 | C2       |   242.0 |    1.17 |
| p79.fits     | Ori_150353          | 05:35:15.010 | -05:23:53.20 | 05/12/97 | 12:27:54.89 |      300 | C2       |  371.01 |     1.2 |
| p80.fits     | Ori_150353          | 05:35:15.010 | -05:23:53.20 | 05/12/97 | 12:34:48.46 |      300 | C3       |   371.0 |    1.21 |
| p81.fits     | Ori_150353          | 05:35:15.010 | -05:23:52.20 | 05/12/97 | 12:44:28.64 |      300 | C3       |   371.0 |    1.24 |
| p82.fits     | Ori_150353          | 05:35:15.010 | -05:23:54.20 | 05/12/97 | 12:51:05.46 |      300 | C3       |   371.0 |    1.26 |
| p83.fits     | Ori_244440          | 05:35:24.420 | -05:24:41.40 | 05/12/97 | 12:59:55.96 |      300 | C2       |  142.01 |    1.28 |
| p84.fits     | Ori_244440          | 05:35:24.420 | -05:24:41.40 | 05/12/97 | 13:10:40.40 |      600 | C2       |   142.0 |    1.32 |
| p85.fits     | Ori_244440          | 05:35:24.420 | -05:24:41.40 | 05/12/97 | 13:22:44.32 |      500 | C2       |   232.0 |    1.37 |
| p86.fits     | Ori_182413          | 05:35:18.280 | -05:24:14.80 | 05/12/97 | 13:43:32.42 |      300 | C2       |   152.0 |    1.48 |
| p87.fits     | Ori_182413          | 05:35:18.290 | -05:24:15.00 | 05/12/97 | 13:50:22.51 |      900 | C2       |  151.99 |    1.52 |
| q10.fits     | Quartz              | 22:56:00.000 | +00:00:37.40 | 05/12/97 | 00:57:05.67 |        3 | C2       |     0.0 |   13.37 |
| q110.fits    | Quartz              | 22:56:00.000 | +00:00:37.40 | 05/12/97 | 00:33:15.46 |        3 | C2       |     0.0 |   13.37 |
| q69.fits     | PPL15               | 05:35:16.970 | -05:23:37.20 | 05/12/97 | 10:03:56.22 |        1 | C2       |  180.01 |    1.14 |
| t11.fits     | Quartz              | 22:56:00.000 | +00:00:37.40 | 05/12/97 | 01:00:08.67 |        2 | C2       |     0.0 |   13.37 |
| t12.fits     | Quartz              | 22:56:00.000 | +00:00:37.40 | 05/12/97 | 01:01:59.84 |        1 | C2       |     0.0 |   13.37 |
| t70.fits     | PPL15               | 05:35:16.970 | -05:23:37.20 | 05/12/97 | 10:06:32.79 |        1 | C2       |   180.0 |    1.14 |
| t88.fits     | ThAr                | 05:35:18.290 | -05:24:15.00 | 05/12/97 | 14:07:05.42 |        1 | C2       |  151.99 |    1.64 |
| xxtest.fits  | PPL15               | 05:35:16.900 | -05:23:37.00 | 05/12/97 | 10:19:38.12 |       60 | C2       |   241.0 |    1.12 |
| xxteste.fits | PPL15               | 05:35:16.900 | -05:23:37.00 | 05/12/97 | 10:19:38.12 |       60 | C2       |   241.0 |    1.12 |
| j65.fits     | Ori_150353          | 05:35:15.010 | -05:23:53.20 | 06/12/97 | 12:51:57.26 |      300 | C3       |  191.01 |    1.27 |
| j66.fits     | Ori_150353          | 05:35:15.010 | -05:23:52.20 | 06/12/97 | 12:58:34.62 |      300 | C3       |   191.0 |    1.29 |
| j67.fits     | Ori_150353          | 05:35:15.010 | -05:23:51.20 | 06/12/97 | 13:05:10.24 |      300 | C3       |   191.0 |    1.32 |
| j68.fits     | Ori_150353          | 05:35:15.010 | -05:23:50.20 | 06/12/97 | 13:11:46.39 |      300 | C3       |   191.0 |    1.34 |
| j69.fits     | Ori_150353          | 05:35:15.010 | -05:23:54.20 | 06/12/97 | 13:18:20.34 |      300 | C3       |   191.0 |    1.37 |
| j70.fits     | Ori_150353          | 05:35:15.010 | -05:23:55.20 | 06/12/97 | 13:24:57.89 |      300 | C3       |   191.0 |     1.4 |
| j71.fits     | Ori_150353          | 05:35:15.010 | -05:23:56.20 | 06/12/97 | 13:31:37.21 |      300 | C3       |   191.0 |    1.44 |
| je75.fits    | Ori_163357          | 05:35:16.310 | -05:23:57.50 | 06/12/97 | 14:03:54.97 |      300 | C3       |   191.0 |    1.65 |
| je76.fits    | Ori_163357          | 05:35:16.310 | -05:23:54.50 | 06/12/97 | 14:10:33.74 |      300 | C3       |   191.0 |     1.7 |
| jw72.fits    | Ori_137349          | 05:35:13.700 | -05:23:53.20 | 06/12/97 | 13:42:19.73 |      300 | C3       |   191.0 |     1.5 |
| jw73.fits    | Ori_137349          | 05:35:13.700 | -05:23:50.20 | 06/12/97 | 13:48:56.29 |      300 | C3       |  190.99 |    1.54 |
| jw74.fits    | Ori_137349          | 05:35:13.700 | -05:23:56.20 | 06/12/97 | 13:55:41.86 |      300 | C3       |   191.0 |    1.58 |
| p56.fits     | Ori_170337,,_PA=151 | 05:35:16.970 | -05:23:37.20 | 06/12/97 | 11:38:53.32 |      300 | C2       |   241.0 |    1.13 |
| p57.fits     | Ori_170377          | 05:35:16.920 | -05:23:36.30 | 06/12/97 | 11:46:30.14 |      300 | C2       |   321.0 |    1.13 |
| p58.fits     | Ori_170377          | 05:35:16.870 | -05:23:36.80 | 06/12/97 | 11:53:09.19 |      300 | C2       |  263.01 |    1.14 |
| p59.fits     | Ori_177341          | 05:35:17.650 | -05:23:41.00 | 06/12/97 | 12:00:31.18 |      300 | C2       |   225.0 |    1.15 |
| p60.fits     | Ori_177341          | 05:35:17.590 | -05:23:40.10 | 06/12/97 | 12:08:08.03 |      300 | C2       |   135.0 |    1.16 |
| p61.fits     | Ori_177341          | 05:35:18.160 | -05:24:13.30 | 06/12/97 | 12:16:09.61 |      300 | C2       |  242.01 |    1.18 |
| p62.fits     | Ori_182413          | 05:35:18.130 | -05:24:12.80 | 06/12/97 | 12:23:45.30 |      300 | C2       |  152.01 |    1.19 |
| p63.fits     | Ori_244440          | 05:35:24.330 | -05:24:40.30 | 06/12/97 | 12:32:07.12 |      450 | C2       |   142.0 |    1.21 |
| p64-ff.fits  | Ori_244440          | 05:35:24.330 | -05:24:40.30 | 06/12/97 | 12:41:28.23 |      450 | C2       |   232.0 |    1.24 |
| p64.fits     | Ori_244440          | 05:35:24.330 | -05:24:40.30 | 06/12/97 | 12:41:28.23 |      450 | C2       |   232.0 |    1.24 |
| t55.fits     | ThAr                | 05:35:16.440 | -05:23:23.00 | 06/12/97 | 11:34:57.92 |        1 | C2       |  195.83 |    1.12 |

*** Identify the lines
    CLOCK: [2012-05-24 Thu 09:56]--[2012-05-24 Thu 10:35] =>  0:39

Lines that we detect in at least one spectrum (from [[file:Keck2/all-lines.reg][all-lines.reg]])

**** Nebular lines

+ Key to Type:
  + C :: Collisional
    + A :: Auroral
  + R :: Recombination
  + F :: Fluorescence
  + D :: Dissociation
  + O :: Order leakage artefact


| Ion                | lambda | Type     |
|--------------------+--------+----------|
| [Fe III]           |   4702 | C        |
| He I               |   4713 | R        |
| [Fe III]           |   4734 | C        |
| [Ar IV]            |   4740 | C        |
| [Fe III]           |   4755 | C        |
| [Fe III]           |   4769 |          |
| [Fe II]            |   4814 | C        |
| H I                |   4861 | R        |
| N III + C II       |   4867 | RR       |
| [Fe III]           |   4881 | C        |
| [Fe II]            |   4890 |          |
| N II               |   4895 | R        |
| [Fe II]            |   4905 |          |
| He I               |   4922 | R        |
| O II + [Fe III]    |   4924 | RC       |
| [Fe III]           |   4930 | C        |
| [O III]            |   4931 | C        |
| ?                  |   4948 |          |
| Artefact           |   4958 |          |
| [O III]            |   4959 | C        |
| O I                |   4980 |          |
| ?                  |   4983 |          |
| [Fe III]           |   4985 | C        |
| ?                  |   4986 | sky?     |
| [Fe III] + N II    |   4987 | CRF?     |
| N II               |   4995 | RF?      |
| N II               |   5001 | R        |
| [O III]            |   5007 | C        |
| ? [Cr III]         |   5010 | C        |
| [Fe III]           |   5011 | C        |
| He I               |   5016 | R        |
| [Fe III]           |   5032 |          |
| ?                  |   5033 | O?       |
| [Fe II]            |   5036 |          |
| Si II              |   5041 | RF       |
| O II               |   5042 | R        |
| N II               |   5045 | R        |
| He I               |   5048 | R        |
| Si II              |   5056 | RF       |
| [Fe III]           |   5085 | C        |
|                    |   5090 |          |
| ?                  |   5105 | sky ?    |
| [Fe II]            |   5112 |          |
| C II               |   5121 | R        |
| ? Ca I ?           |   5132 |          |
| Co I               |   5147 | F        |
| [Fe II]            |   5159 | C        |
| Fe II              |   5169 | F        |
| [Ar III]           |   5192 | C        |
| [N I]              |   5198 | F        |
| [N I]              |   5200 | F        |
| ?                  |   5251 |          |
| [Fe II]            |   5262 | C        |
| [Fe III]           |   5271 | C        |
| [Fe II]            |   5273 | C        |
| O I                |   5275 | F        |
| O I                |   5299 | F        |
| [Fe II]            |   5334 | C        |
| C II               |   5342 |          |
| [Fe II]            |   5377 | ? Disk   |
| [Fe III]           |   5412 | C        |
| ? S II + [Fe II] ? |   5433 |          |
| S II               |   5454 |          |
| N II               |   5495 | R        |
| O I                |   5513 | F        |
| [Cl III]           |   5518 | C        |
| ? N I ?            |   5519 |          |
| ? [Fe II] ?        |   5527 | ? Disk   |
| N II + C II        |   5535 |          |
| [Cl III]           |   5538 | C        |
| N II               |   5552 | F?       |
| O I                |   5555 | F        |
| [Fe II]            |   5556 | FC?      |
| [O I]              |   5578 | D        |
| N II               |   5667 | RF?      |
| N II               |   5676 | RF?      |
| N II               |   5686 | RF?      |
| N II               |   5711 | RF?      |
| ? [Cr III]         |   5714 | C        |
| Si III             |   5740 | R?       |
| [Fe II]            |   5747 |          |
| [N II]             |   5755 | A        |
| ? Co I, C I ?      |   5821 |          |
| He I               |   5876 | R        |
| ?                  |   5888 | sky?     |
| Sky                |   5890 |          |
| C II               |   5891 | R        |
| Sky                |   5896 |          |
| ? Si I ?           |   5906 |          |
| N II               |   5928 | R        |
| N II               |   5932 | R        |
| ? [Co II] ?        |   5933 | A?       |
| ? C II ?           |   5940 |          |
| N II               |   5942 |          |
| N II               |   5952 | R        |
| ? Fe II, Cu I ?    |   5953 | ?        |
| Si II              |   5958 | RF       |
| O I                |   5959 | F        |
| Si II              |   5979 | RF       |
| ? [Cr III] ?       |   5987 |          |
| [Ni III]           |   6000 | C        |
| O I                |   6047 | F        |
| Ne I               |   6143 | R        |
| C II               |   6151 | R        |
| ?                  |   6236 |          |
| Sky                |   6258 | sky?     |
| ? C II ?           |   6259 |          |
| [O I]              |   6300 | CD       |
| sky?               |   6307 | sky      |
| [S III]            |   6312 | C        |
| ??                 |   6321 |          |
| ? Ca I ?           |   6329 | ? sky?   |
| Si II              |   6347 | RF       |
| [O I]              |   6364 | CD       |
| [Ni II]            |   6365 | CF? sky? |
| Si II              |   6371 | RF       |
| C II               |   6462 | R        |
| ??                 |   6466 | real     |
| ??                 |   6471 |          |
| ??                 |   6482 |          |
| ??                 |   6490 |          |
| ??                 |   6498 |          |
| [N II]             |   6527 | C        |
| [Ni III]           |   6534 | C        |
| [N II]             |   6548 | C        |
| [Cr II]            |   6553 | C        |
| O II               |   6556 | R        |
| H I                |   6563 | R        |
| O II               |   6576 | R        |
| C II               |   6578 | R        |
| [N II]             |   6584 | C        |
| ?                  |   6605 |          |
| ?                  |   6609 |          |
| [Ni II]            |   6667 | C        |
| He I               |   6678 | R        |
| [Ni III]           |   6682 | C        |
| [S II]             |   6716 | C        |
| O II               |   6721 | R        |
| [S II]             |   6731 | C        |
| C II               |   6734 | R        |
| [Cr II]            |   6737 | C?F?     |
| ?                  |   6738 |          |
| [Fe IV]            |   6740 | C        |
| C II               |   6780 | R        |
| O II               |   6786 | R        |
| [Ni II]            |   6791 |          |
| Artefact           |   6806 | O        |
| ?                  |   6807 | O?       |
| [Ni II]            |   6814 | C?       |
| ?C I/He I?         |   6827 | ? sky?   |
| [Fe II]            |   6828 | C        |
| Si II              |   6829 | RF       |
| sky                |   6834 | sky      |
| He I               |   6856 | R        |
|                    |   6861 |          |
| sky                | 6863/4 | sky      |
| O II               |   6910 | R        |
| ? [Cr IV] ?        |   6916 | C        |
| He I               |   6934 | R        |
| ?                  |   6939 | sky      |
| ?                  |   6949 | sky      |
| Artefact?          |   6968 | O?       |
| [Mn II]?           |   6978 | Sky      |
| He I + ?           |   6989 | R O?     |
| O I                |   7002 | F        |



+ wavenumber to temperature 
40,000 cm^-1 is about 5ev
60,000 cm^-1 is 2500 AA

**** New lines discovered
     CLOCK: [2013-02-03 Sun 09:19]--[2013-02-03 Sun 09:46] =>  0:27
+ In the red there are some weak lines
  + Only in nebula
  + Not in proplyd
  + Not mentioned in Esteban 2004
+ Does this mean they are sky lines?
+ Possibly Ca I fluorescence, but why not seen from the disk then?
+ Another one might be a [Cr II] line
+ In the blue there is a Ca I line on the blue wing of 4959
  + But is it from the disk or is it stellar?
  + Probably disk since it is narrow and also stellar continuum is very weak in blue.
+ There is an O II recomb line at 4924.529, but it is blended with an [Fe III] line at 4924.50, and it is also extremely weak in the 244-440 spectrum
+ Very weak N II and N III recomb lines. The latter is blended with C II
**** Stellar lines

Broad emission lines seen only in 170-337
 
|--------------+-----------------|
| Fe II        | 5016 Stellar?   |
| Fe II        | 4924 Stellar?   |
| Fe II + Mg I | 5169+71 Stellar |
| Fe II        | 5317 Stellar    |


|------+------------------|
| Na I |          5890+95 |
| Li I | 6708 Absorption? |



*** Comments from [[file:~/Dropbox/notesy/Astro/Keck%20Proplyd%20Spectra.txt][notesy file]]

We can see all sort of interesting lines in the spectra, but the strangest ones are the neutral lines.  

In particular there is a forbidden [O I] 5578 line that has a very odd distribution.  It is not detected at all from the nebula but it is quite strong from the proplyd.   This line also has a strong night sky component, which makes the velocity calibration very easy.  According to the list in Baldwin 2000 the line should be at 0.003 relative to 6678, which is weaker than any of the other lines that we actually detect, so it is not surprising that we don't see it from the nebula.   So what is so special about this line that makes it so strong in the proplyd?  It isn't just 177-341 – we see the same in 244-440, and there it is more extended.  Could it be that it is preferentially produced in the dissociation of OH at the surface of the disk?  This would explain why it is so compact.  This would be excellent if true since it would give us a tool for observing the kinematics of the base of the neutral flow.   

There is also an O I permitted line at 5555 that is weaker than 5578 in the proplyd but is emitted by the nebula too.  Baldwin has it at twice the relative strength of the 5578 line.  In fact Baldwin's Fig 3 shows precisely this line, to illustrate that he can separate the strong night sky component from the nebular component. 

We detect the [N I] pumped lines quite well.  These are noticeably narrower than any of the other lines.   

There are other O I permitted lines at other wavelengths.   For instance, far to the red.  

Recombination lines that we see: 

There is a C II line between 6563 and 6584


Ni I line is blended with O I 6300.  Will this affect our spectra?  Maybe the nickel will be depleted onto dust.   Separation is about 0.03 Å which is about 1 km/s.  Turns out that the Ni line has a lower level with excitation of 4 eV, so it will be very suppressed in emission.   


Comparison of [S III], [Cl III], [Fe III], C II, and Si II.  

These should all come from the doubly ionized zones of lines with low ionization potentials, although the forbidden lines may also come from the singly ionized zones if they fluoresce.   There are interesting differences between these four lines.  Multiple lines are listed from brightest to faintest.  

[S III] 6731 : We will take this as the baseline case.   

[Cl III] 5538, 5518: this is similar to [S III] for the nebula, but is suppresed in the proplyds, presumably due to collisional ionization.  We should be able to get the density from the ratio of the two lines.  The 5518 line has a very weak [N I] 5519 line just next to it, but this is only seen in a few cases.  

[Fe III] 4881, 5271, 5412, 4765, 5011, 4702, 5262, 4734:  Only the first two of these are strong enough to see anything really.   maybe we should add them all together to improve the s/n.  These lines also seem suppressed in the proplyds compared with the nebula.  

C II 6578 : This is presumably a recombination line from the C++ zone.  It is very similar to the [S III] line both in the nebula and in the proplyd.

Si II 6347, 6371, 5058, 5041, 5958 : These seem to be combinations of recombination from the Si++ zone and fluorescence from the Si+ zone.  The two types of line are well separated in velocity.  The proplyd is very weak in the recombination component, although you do see it in the florescence component for 244-440. 


*** More comments on specific lines
    :LOGBOOK:
    - Note taken on [2012-05-15 Tue 10:07] \\
      Things I was writing to Bob, but then decided not to
    :END:

The [N I] lines of course, which are extremely narrow.  Also the auroral [O I] 5577 line and whole load of permitted O I lines, which all look like they are fluoresced (they are all doublets with separation of 0.2 to 0.3 Angstrom, e.g., 7001.92+7002.23).  The 5577 line has a very strong sky component, but this is well separated.  The nebula is not visible at all, but the proplyd can be seen as a bright compact knot to the red of the sky component.  It is spatially more compact in 5577 than in either 6300+6363 or in the permitted lines, which makes me think it might be preferentially produced by the OH dissociation at the surface of the disk.  

There are also interesting comparisons to be made between [S III], [Cl III], [Fe III], permitted C II, and permitted Si II, which all should come from very similar ionization zones, assuming the permitted lines are due to recombination.  In fact, we see clearly that Si II has both a recombination and a fluorescent component from the nebula, which are easily distinguished by their kinematics.  The proplyd is extremely weak (possibly non-existent) in the recombination component of Si II.  With C II, on the other hand, the proplyd is quite strong (similar contrast to in [S III]). 

*** Stellar lines
See broad (3 angstrom) lines in the star spectrum of 170-334.  Turns out they are mainly Mg I and Fe II lines.

  
*** [O I] lines



*** [N II] lines
    |  line |  Prop |   Neb |  Cont | P - C | N - C |
    |-------+-------+-------+-------+-------+-------|
    |  5755 | 33300 | 32864 | 32780 |   520 |    84 |
    |  6584 | 42360 | 39780 | 32800 |  9560 |  6980 |
    | Ratio |       |       |       | 0.054 | 0.012 |
    #+TBLFM: $5=$2 - $4::$6=$3 - $4::@4$5..@4$6=@-2 / @-1 ; f3




*** DONE Share Dropbox folder with Nahiely and Adal
    CLOSED: [2012-05-10 Thu 08:49]


*** Bob's message
: I've located the Keck data.
: The simplest thing for me and certain to contain what you
: need is to put them into my anonymous ftp server.
: These would be the full wavelength range spectra, including
: the quartz lamp and wavelength calibration exposures.
: They are in .imh format, with the .pix files in the same directory.
: Is this what you want?

*** DONE Download files from Bob's ftp server
    CLOSED: [2012-05-09 Wed 22:40]

*** DONE Convert the IRAF files to FITS
    CLOSED: [2012-05-09 Wed 23:48]

**** DONE Install the wcstools package
    CLOSED: [2012-05-09 Wed 22:55]

This has an =i2f= utility that does what we want.

**** DONE Do the conversion
    CLOSED: [2012-05-09 Wed 23:05]

#+BEGIN_SRC sh
I2F=~/Source/wcstools-3.8.5/bin/i2f
for d in Keck1 Keck2; do
    cd $d
    for f in *.imh; do
	$I2F -v $f
    done
    cd -
done
#+END_SRC

#+RESULTS:
| /Users/will/Dropbox/KeckProplyd |
| /Users/will/Dropbox/KeckProplyd |

**** DONE Move all the IRAF files out of the way
    CLOSED: [2012-05-09 Wed 23:48]
They are now in =Originals/= subfolders in each directory

** How to deal with the doublets
   :PROPERTIES:
   :ID:       D7560FBA-D617-49BE-A846-7B45C997D741
   :END:

+ Many of the O I lines are triplets
  + Although they look like doublets since two components are very
    close together
  + for example, this one a 6047:
| Obs wav  | Theo wav  |      A_{ki} | Conf_1        | Term_1 | J_1 | Conf_2        | Term_2 | J_2 |
|----------+-----------+----------+---------------+--------+-----+---------------+--------+-----|
| 6 046.23 | 6 046.233 | 1.05e+06 | 2s22p3(4S°)3p | 3P     |   1 | 2s22p3(4S°)6s | 3S°    |   1 |
| 6 046.44 | 6 046.438 | 1.75e+06 | 2s22p3(4S°)3p | 3P     |   2 | 2s22p3(4S°)6s | 3S°    |   1 |
| 6 046.49 | 6 046.495 | 3.50e+05 | 2s22p3(4S°)3p | 3P     |   0 | 2s22p3(4S°)6s | 3S°    |   1 |

The pumping of this line is very simple.  The upper level can be
excited from the ground state by an FUV photon (950.885 AA), with
transition probability of A_{ki} = 1.94e7 /s.  

The bluer component (1-1) of the triplet is resolved (separation 11
km/s), but the two red components (2-1 and 0-1) are blended
(separation 2.5 km/s).  The relative intensities should be in the
ratio red:blue = 2:1 exactly.  

The ratio of the two red components is 5:1, so that the mean
wavelength is 

(6046.44 + 0.2 6046.49) / 1.2 = 6046.448

and the sigma corresponding to their splitting is 

sqrt(((0.44 - 0.448)**2 + 0.2 (0.49 - 0.448)**2) / 1.2) = 0.0186 AA 
= 0.92 km/s

which is pretty negligible compared with the instrumental width.

** HST10
Yiannis wants to submit a paper in two weeks - can we add anything
from the Keck spectra?


#+CAPTION: Close-up on the neutral oxygen lines from slit p77
#+ATTR_HTML: width="500"
[[./180-331-p77-OIlines.png]]



* Linewidth method for determining the proplyd temperature
  CLOCK: [2012-06-07 Thu 21:25]--[2012-06-07 Thu 21:39] =>  0:14

This section will describe the observational side of this project, where we will:

1. Somehow subtract the nebular background. 
2. Try and measure the velocity moments of the auroral lines and Ha
3. Apply the refined linewidth method to determine the proplyd temperature

The theoretical side will be described in [[file:~/Work/Nahiely/proplyd-cloudy/papers/Linewidth/t-linewidth.org][here]]

* COMMENT Export options
#+TITLE:     keck-revisited.org
#+AUTHOR:    William Henney
#+EMAIL:     whenney@gmail.com
#+DESCRIPTION:
#+KEYWORDS:
#+LANGUAGE:  en
#+OPTIONS:   H:4 num:t toc:t \n:nil @:t ::t |:t ^:{} -:t f:t *:t <:t
#+OPTIONS:   TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc
#+INFOJS_OPT: view:nil toc:nil ltoc:t mouse:underline buttons:0 path:http://orgmode.org/org-info.js
#+EXPORT_SELECT_TAGS: export
#+EXPORT_EXCLUDE_TAGS: noexport
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="wjh-org.css" />
#+LINK_UP:   
#+LINK_HOME: 
#+XSLT:
